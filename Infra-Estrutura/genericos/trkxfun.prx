#INCLUDE "TRKXFUN.CH"
#INCLUDE "PROTHEUS.CH"
#INCLUDE "FWMVCDEF.CH"

/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁProgram   ЁTRKXFUN   Ё Autor Ё Sergio Silveira       Ё Data Ё05/11/2001Ё╠╠
╠╠цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o Ё Programa de Funcoes de restreamento / Drill-Down           Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁRetorno   Ё                                                            Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁParametrosЁ                                                            Ё╠╠
╠╠цддддддддддедддддддддддддддбдддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё   DATA   Ё Programador   ЁManutencao Efetuada                         Ё╠╠
╠╠цддддддддддедддддддддддддддедддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё 04/04/02 Ё Paulo Augusto ЁAlterado para considerar os remitos/Localiz.Ё╠╠
╠╠Ё			 Ё               ЁAcertado o posicionato da NF debaixo do pe- Ё╠╠
╠╠Ё			 Ё               Ёdido qdo houver mais de uma NF(MATRKSCN)    Ё╠╠
╠╠Ё12/04/02	 Ё Paulo Augusto ЁCriacao da funcao MATRKSC9                  Ё╠╠
╠╠юддддддддддадддддддддддддддадддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/

/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFun┤└o    ЁMaRetRoot Ё Autor Ё Sergio Silveira       Ё Data Ё26/10/2001Ё╠╠
╠╠цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤└o Ё Localiza a origem da entidade                              Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁSintaxe   Ё MaRetRoot( ExpC1, ExpC2, @ExpA1, @ExpN1 )                  Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁRetorno   Ё Nil                                                        Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁParametrosЁExpC1: Alias da entidade                                    Ё╠╠
╠╠Ё          ЁExpC2: Chave unica da entidade                              Ё╠╠
╠╠Ё          ЁExpA1: array contendo o caminho ate a origem                Ё╠╠
╠╠Ё          ЁExpN1: Numero maximo de niveis a pesquisar                  Ё╠╠
╠╠Ё          ЁExpN2: Numero da arvore                                     Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё Uso      Ё GENERICO                                                   Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁObservacaoЁ                                                            Ё╠╠
╠╠цддддддддддедддддддддддддддбдддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё   DATA   Ё Programador   ЁManutencao Efetuada                         Ё╠╠
╠╠цддддддддддедддддддддддддддедддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё22/09/2006Ё Conrado Q.    ЁAdicionado localizacao de entidade provindo Ё╠╠
╠╠Ё          Ё               Ёde um apontamento tecnico.                  Ё╠╠
╠╠юддддддддддадддддддддддддддадддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/

Function MaRetRoot( cAlias, cKey, aRoot, nMaxLevel, nLevel, nTree )

LOCAL cCond						// Conteudo da clausula where de uma query
LOCAL cIndexKey					// Utilizado para guardar um IndexKey()
LOCAL cIndTrab    				// Utilizada para armazenar um CriaTrab()
LOCAL cAliasQRY  := ""			// Utilizado para guardar o alias de uma area
LOCAL cQuery     := ""			// Utilizado para guardar a query
LOCAL cTrkSeek   := ""			// Utilizado para o seek vaiavel das chaves de acordo com a filial de entrega
Local cFilialBsk := ""          // Variavel generica com a Filial a ser utilizada de acordo com o processo
Local cKeyCNE    := ""
          
Local nTamFil    := 0
Local nTamContra := 0
Local nTamRevisa := 0
Local nTamMed    := 0
LOCAL lFixoGCT   := .T.
LOCAL lFilEnt	 := TRKFILENT()    

Local lMARETGCT  := ExistBlock("MARETGCT")  
Local lMRTGCT    := .T.
Local lRetMRTGCT := .T.

DEFAULT nLevel      := 0
DEFAULT aRoot       := {}
DEFAULT nMaxLevel   := 1000000
DEFAULT nTree       := 1 

Do Case
	Case cAlias == "SUC"
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Pego o Atendimento                                           Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		SUC->( DbSetOrder( 1 ) )
		If SUC->( DbSeek( xFilial( "SUC" ) + cKey ) )
			If nLevel <= nMaxLevel
				nLevel++
				AAdd( aRoot, { "SUC", SUC->UC_CODIGO, nLevel,nTree } )
				//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
				//Ё Pego as Ocorrencias/Acoes do Atendimento                     Ё
				//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
				If SUD->(DbSeek( xFilial( "SUC" ) + SUC->UC_CODIGO))
					While SUD->( !Eof() .AND. SUC->(xFilial("SUC"))+SUC->UC_CODIGO == SUD->(xFilial("SUD")) + SUD->UD_CODIGO )
                    	If !Empty(SUD->UD_CODFNC)
							AAdd( aRoot, { "QI2", SUC->UC_CODIGO, nLevel, nTree } )
    	                EndIf
						SUD->( dbSkip() )
					End
				 EndIf
				nLevel--
			EndIf
		EndIf

	Case cAlias == "AB7"
		
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Itens da ordem de servico                                    Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		AB7->( DbSetOrder( 1 ) )
		If AB7->( DbSeek( xFilial( "AB7" ) + cKey ) )
			
			If nLevel <= nMaxLevel
			
				nLevel ++ 
				
				AAdd( aRoot, { "AB7", AB7->AB7_NUMOS + AB7->AB7_ITEM, nLevel, nTree } )
				
				//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
				//Ё Analisa origem                                               Ё
				//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
				Do Case
					Case !Empty( AB7->AB7_NRCHAM )
						MaRetRoot( "AB2", AB7->AB7_NRCHAM, @aRoot, @nMaxLevel, @nLevel, nTree )
					Case !Empty( AB7->AB7_NUMORC )
						MaRetRoot( "AB4", AB7->AB7_NUMORC, @aRoot, @nMaxLevel, @nLevel, nTree )
					Case !Empty( AB7->AB7_NUMHDE )
						MaRetRoot( "ABL", AB7->AB7_NUMHDE, @aRoot, @nMaxLevel, @nLevel, nTree )
					Otherwise
						ABI->( DbSetOrder( 2 ) )
						If ABI->( DbSeek( xFilial( "ABI" ) + cKey ) )
							MaRetRoot( "ABI", ABI->ABI_PROJET + ABI->ABI_ITEM, @aRoot, @nMaxLevel, @nLevel, nTree )
						EndIf
				EndCase
				
				nLevel--
				
			EndIf
			
		EndIf
		
	Case cAlias == "AB2"
		
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Itens do chamado tecnico                                     Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		AB2->( DbSetOrder( 1 ) )
		If AB2->( DbSeek( xFilial( "AB2" ) + cKey ) )
			
			If nLevel <= nMaxLevel                                            
			
				nLevel++
				
				AAdd( aRoot, { "AB2", AB2->AB2_NRCHAM + AB2->AB2_ITEM, nLevel, nTree } )
				
				//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
				//Ё Analisa origem                                               Ё
				//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
				AB1->( DbSetOrder( 1 ) )
				AB1->( DbSeek( xFilial( "AB1" ) + AB2->AB2_NRCHAM ) )
				
				Do Case
					Case !Empty( AB1->AB1_NUMTMK )
						//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
						//Ё Chamado call center                                          Ё
						//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
						MaRetRoot( "AB1", AB1->AB1_NRCHAM, @aRoot, @nMaxLevel, @nLevel, nTree )
				EndCase
				
				nLevel--
				
			EndIf
			
		EndIf
		
	Case cAlias == "AB1"
		
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Itens do chamado tecnico                                     Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		AB1->( DbSetOrder( 1 ) )
		If AB1->( DbSeek( xFilial( "AB1" ) + cKey ) )
			
			If nLevel <= nMaxLevel
			
				nLevel++
				
				AAdd( aRoot, { "AB1", AB1->AB1_NRCHAM, nLevel, nTree } )
				
				Do Case
					Case !Empty( AB1->AB1_NUMTMK )
						//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
						//Ё Atendimento telemarketing                                    Ё
						//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
						MaRetRoot( "SUC", AB1->AB1_NUMTMK, @aRoot, @nMaxLevel, @nLevel, nTree )
				EndCase
				
				nLevel--
				
			EndIf
			
		EndIf
		
		
	Case cAlias == "SUC"
		
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Atendimento telemarketing                                    Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		SUC->( DbSetOrder( 1 ) )
		If SUC->( DbSeek( xFilial( "SUC" ) + cKey ) )
		
			If nLevel <= nMaxLevel
				nLevel++
				AAdd( aRoot, { "SUC", SUC->UC_CODIGO, nLevel, nTree } )
				nLevel--
			EndIf
		EndIf
		
	Case cAlias == "AB4"
		
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Itens do orcamento tecnico                                   Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		AB4->( DbSetOrder( 1 ) )
		If AB4->( DbSeek( xFilial( "AB4" ) + cKey ) )
			
			If nLevel <= nMaxLevel
			
				nLevel++
				
				AAdd( aRoot, { "AB4", AB4->AB4_NUMORC + AB4->AB4_ITEM, nLevel, nTree } )
				
				//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
				//Ё Analisa origem                                               Ё
				//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
				Do Case
					Case !Empty( AB4->AB4_NRCHAM )
						//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
						//Ё Chamado tecnico                                              Ё
						//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
						MaRetRoot( "AB2", AB4->AB4_NRCHAM, @aRoot, @nMaxLevel, @nLevel, nTree )
										Otherwise
						//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
						//Ё Apontamento tecnico                                          Ё
						//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
						                                          
						cAliasQry := GetNextAlias() 
					
						cQuery := "" 
						
						cQuery += "SELECT AB9_FILIAL, AB9_NUMOS 
						cQuery += "FROM " + RetSqlName("AB9") + " "
						cQuery += "WHERE " 
						cQuery += "AB9_FILIAL='" + xFilial("AB9") + "' AND "
						cQuery += "AB9_NUMORC='" + AB4->AB4_NUMORC + "' AND "
						cQuery += "D_E_L_E_T_=' ' "
							                                    
						cQuery := ChangeQuery( cQuery ) 
						
						dbUseArea( .T., "TOPCONN", TcGenQry(,,cQuery), cAliasQry, .F., .T. ) 
						
						If !( cAliasQry )->( Eof() )
							MaRetRoot( "AB9", (cAliasQry)->AB9_NUMOS, @aRoot, @nMaxLevel, @nLevel, nTree )
						EndIf	
						
						( cAliasQry )->( dbCloseArea() )
				EndCase
				
				nLevel--
				
			EndIf
			
		EndIf
		
	Case cAlias == "AB9"
		
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Itens do atendimento da OS                                   Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		AB9->( DbSetOrder( 1 ) )
		If AB9->( DbSeek( xFilial( "AB9" ) + cKey ) )
			
			If nLevel <= nMaxLevel
			
				nLevel++
				
				AAdd( aRoot, { "AB9", AB9->AB9_NUMOS, nLevel, nTree } )
				
				//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
				//Ё Analisa origem                                               Ё
				//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
				Do Case
					Case !Empty( AB9->AB9_NUMOS )
						MaRetRoot( "AB7", AB9->AB9_NUMOS, @aRoot, @nMaxLevel, @nLevel, nTree )
				EndCase
				
				nLevel--
				
			EndIf
			
		EndIf
		
	Case cAlias == "ABL"
		
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Atendimento / Fila de Help desk                              Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		ABL->( DbSetOrder( 2 ) )
		If ABL->( DbSeek( xFilial( "ABL" ) + cKey ) )
			
			If nLevel <= nMaxLevel                           
			
				nLevel++
				
				AAdd( aRoot, { "ABL", ABL->ABL_SEQUEN, nLevel, nTree } )
				
				//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
				//Ё Analisa origem                                               Ё
				//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
				MaRetRoot( "AB2", ABL->ABL_NRCHAM, @aRoot, @nMaxLevel, @nLevel, nTree )
				
				nLevel--
				
			EndIf
			
		EndIf
		
	Case cAlias == "ABK"
		
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Atendimento / Help desk                                      Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		ABK->( DbSetOrder( 1 ) )
		If ABK->( DbSeek( xFilial( "ABK" ) + cKey ) )
			
			If nLevel <= nMaxLevel
			
				nLevel++
				
				AAdd( aRoot, { "ABK", ABK->ABK_NRCHAM + ABK->ABK_SEQ, nLevel, nTree } )
				
				//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
				//Ё Analisa origem                                               Ё
				//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
				MaRetRoot( "ABL", ABK->ABK_NRCHAM, @aRoot, @nMaxLevel, @nLevel, nTree )
				
				nLevel--
				
			EndIf
			
		EndIf
		
	Case cAlias == "ABI"
		
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Itens do projeto                                             Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		ABI->( DbSetOrder( 1 ) )
		If ABI->( DbSeek( xFilial( "ABI" ) + cKey ) )
			If nLevel <= nMaxLevel
				nLevel++
				AAdd( aRoot, { "ABI", ABI->ABI_PROJET + ABI->ABI_ITEM, nLevel,nTree } )
				nLevel--
			EndIf
		EndIf
		
	Case cAlias == "ABB"
		
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Agendamento                                                  Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		ABB->( DbSetOrder( 1 ) )
		If ABB->( DbSeek( xFilial( "ABB" ) + cKey ) )
			
			If nLevel <= nMaxLevel
			
				nLevel++
				
				AAdd( aRoot, { "ABB", cKey, nLevel,nTree } )
				//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
				//Ё Analisa origem                                               Ё
				//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
				If !Empty( ABB->ABB_NUMOS )
					MaRetRoot( "AB7", ABB->ABB_NUMOS, @aRoot, @nMaxLevel, @nLevel,nTree )
				EndIf
				
				nLevel--
				
			EndIf
			
		EndIf
		
	Case cAlias == "SC2"
		
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Ordem de Producao                                            Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		SC2->( DbSetOrder( 1 ) )
		If SC2->( DbSeek( xFilial( "SC2" ) + cKey ) )
			
			If nLevel <= nMaxLevel
			
				nLevel++
				
				AAdd( aRoot, { "SC2",SC2->(C2_NUM+C2_ITEM+C2_SEQUEN+C2_ITEMGRD), nLevel,nTree } )
				
				//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
				//Ё Analisa origem                                               Ё
				//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
				If !Empty(SC2->C2_PEDIDO+SC2->C2_ITEMPV)
					//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
					//Ё Pedido de Venda - Sigafat                                    Ё
					//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
					MaRetRoot( "SC6",SC2->C2_PEDIDO+SC2->C2_ITEMPV,@aRoot,@nMaxLevel, @nLevel,nTree )
				EndIf
				
				nLevel--
			EndIf
			
		EndIf
		
	Case cAlias == "SC6"
		
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Itens do pedido de venda                                     Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		SC6->( DbSetOrder( 1 ) )
		If SC6->( DbSeek( xFilial( "SC6" ) + cKey ) )
			
			If nLevel <= nMaxLevel
			
				nLevel++
				
				AAdd( aRoot, { "SC6", SC6->C6_NUM + SC6->C6_ITEM, nLevel,nTree } )
				
				//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
				//Ё Analisa origem                                               Ё
				//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
				Do Case
					Case !Empty( SC6->C6_NUMOS )
						//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
						//Ё Ordem de Servico - Sigatec                                   Ё
						//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
						MaRetRoot( "AB7", Left( SC6->C6_NUMOS, Len( AB7->AB7_NUMOS + AB7->AB7_ITEM ) ), @aRoot, @nMaxLevel, @nLevel,nTree )
					Case !Empty( SC6->C6_NUMOSFA )
						//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
						//Ё Ordem de Servico - Fabricante                                Ё
						//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
						MaRetRoot( "AB7", Left( SC6->C6_NUMOSFA, Len( AB7->AB7_NUMOS + AB7->AB7_ITEM ) ), @aRoot, @nMaxLevel, @nLevel,nTree )
					Case !Empty( SC6->C6_NUMORC )
						//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
						//Ё Orcamento de Venda                                           Ё
						//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
						MaRetRoot( "SCK", SC6->C6_NUMORC, @aRoot, @nMaxLevel, @nLevel,nTree )
					Case !Empty( SC6->C6_CONTRT )
						//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
						//Ё Contrato de servicos                                         Ё
						//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
						If SC6->C6_TPCONTR == "1"
							MaRetRoot( "AAN", SC6->C6_CONTRT + SC6->C6_ITCONTR, @aRoot, @nMaxLevel, @nLevel,nTree )
						ElseIf SC6->C6_TPCONTR == "2"
							MaRetRoot( "AAO", SC6->C6_CONTRT + SC6->C6_ITCONTR, @aRoot, @nMaxLevel, @nLevel,nTree )
						EndIf
					Case !Empty( SC6->C6_CONTRAT )
						MaRetRoot( "ADB", SC6->C6_CONTRAT + SC6->C6_ITEMCON, @aRoot, @nMaxLevel, @nLevel,nTree )
					Case !Empty( SC6->C6_ITEMED )
						//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
						//Ё Posiciona no cabecalho do pedido de venda                    Ё
						//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
						SC5->( dbSetOrder( 1 ) )
						If	SC5->( DbSeek( xFilial("SC5") + SC6->C6_NUM ) )
							//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
							//Ё Medicao                                                      Ё
							//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
							CNE->( dbSetOrder( 4 ) )
							CNE->(dbSeek(xFilial("CNE")+SC5->C5_MDNUMED +"ZZZ",.T.))
							CNE->(dbSkip(-1))
							cKeyCNE := IIF(FWModeAccess("CNE")=="E",SC5->C5_FILIAL,xFilial("CNE")) + SC5->C5_MDCONTR + CNE->CNE_REVISA + SC5->C5_MDNUMED + SC6->C6_ITEMED
							
							MaRetRoot( "CNE", cKeyCNE , @aRoot, @nMaxLevel, @nLevel,nTree )
						EndIf
					Otherwise
						//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
						//Ё Verifica se algum projeto criou este item de pedido          Ё
						//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
						ABI->( DbSetOrder( 3 ) )
						If ABI->( DbSeek( xFilial( "ABI" ) + SC6->C6_NUM + SC6->C6_ITEM ) )
							MaRetRoot( "ABI", ABI->ABI_PROJET + ABI->ABI_ITEM, @aRoot, @nMaxLevel, @nLevel,nTree )
						EndIf
						
						//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
						//Ё Verifica se algum atendimento de TELEMARKETING criou este item de pedido  Ё
						//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
						SUB->( DbSetOrder( 3 ) )
						If SUB->( DbSeek( xFilial( "SUB" ) + SC6->C6_NUM + SC6->C6_ITEM ) )
							MaRetRoot( "SUB", SUB->UB_NUM + SUB->UB_ITEM, @aRoot, @nMaxLevel, @nLevel,nTree )
						EndIf
						
				EndCase
				
				nLevel--
				
			EndIf
			
		EndIf
		
	Case cAlias == "SD2"
		
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Itens do pedido de venda                                     Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		SD2->( DbSetOrder( 3 ) )
		If SD2->( DbSeek( xFilial( "SD2" ) + cKey ) )
			
			If nLevel <= nMaxLevel
				
				nLevel++
				
				AAdd( aRoot, { "SD2", cKey, nLevel,nTree } )
				
				//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
				//Ё Analisa origem                                               Ё
				//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
				Do Case
					Case !Empty( SD2->D2_PEDIDO ) .And. !Empty( SD2->D2_ITEMPV )
						//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
						//Ё Pedido de Venda                                              Ё
						//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
						MaRetRoot( "SC6", SD2->D2_PEDIDO + SD2->D2_ITEMPV, @aRoot, @nMaxLevel, @nLevel,nTree )
				EndCase
				
				nLevel--
				
			EndIf
			
		EndIf

	Case cAlias == "SCR"
		
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Liberacao de Pedido de Compras                               Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		SCR->( DbSetOrder( 1 ) )
		If lFilEnt
			cTrkSeek:= cKey
		Else
			cTrkSeek:= xFilial( "SCR" ) + cKey 	   		
		EndIf
	
		If SCR->( DbSeek (cTrkSeek) )
			If nLevel <= nMaxLevel
			
				nLevel++
				
				AAdd( aRoot, { "SCR", cKey, nLevel,nTree  } )
				If lFilEnt
					MaRetRoot( "SC7", SCR->CR_FILIAL + SCR->CR_NUM, @aRoot, @nMaxLevel, @nLevel,nTree )
				Else
			   		MaRetRoot( "SC7", SCR->CR_NUM, @aRoot, @nMaxLevel, @nLevel,nTree )
				EndIf
				
				nLevel--
				
			EndIf
		EndIf

	Case cAlias == "SC7"
		
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Pedido de Compras                                            Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		If lFilEnt
			SC7->( DbSetOrder( 14 ) )
			cTrkSeek:= cKey
		Else			
			SC7->( DbSetOrder( 1 ) ) 
			cTrkSeek:= xFilial( "SC7" ) + cKey 
		EndIf
        
        If SC7->( DbSeek ( cTrkSeek ))
			
			If nLevel <= nMaxLevel
			
				nLevel++
				
				AAdd( aRoot, { "SC7", cKey, nLevel,nTree } )
				
				//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
				//Ё Analisa origem                                               Ё
				//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
				Do Case
					Case !Empty( SC7->C7_NUMCOT )
						//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
						//Ё Cotacao                                                      Ё
						//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддыAdmin	
						If lFilEnt
							MaRetRoot( "SC8", IIF(FWModeAccess("SC8")=="E",xFilial("SC8"),SC7->C7_FILIAL) + SC7->C7_NUMCOT + SC7->C7_PRODUTO + SC7->C7_FORNECE + SC7->C7_LOJA + SC7->C7_NUM + SC7->C7_ITEM, @aRoot, @nMaxLevel, @nLevel,nTree )
						Else					
							MaRetRoot( "SC8", SC7->C7_NUMCOT + SC7->C7_PRODUTO + SC7->C7_FORNECE + SC7->C7_LOJA + SC7->C7_NUM + SC7->C7_ITEM, @aRoot, @nMaxLevel, @nLevel,nTree )
						EndIf
					Case !Empty( SC7->C7_NUMSC )
						//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
						//Ё Solicitacao de Compras / Autorizacao de entrega              Ё
						//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
						If SC7->C7_TIPO == 1 .Or. SC7->C7_TIPO == 3 
							If lFilEnt   
								If !Empty(SC7->C7_FISCORI)
									If !FWModeAccess("SC1")=="E"
									    cFilialBsk:=IIF(FWModeAccess("SC1")=="C",xFilial("SC1",SC7->C7_FISCORI),SC7->C7_FISCORI)
									Else
									    cFilialBsk:=xFilial("SC1",SC7->C7_FISCORI)
									EndIf
								Else
								    If !FWModeAccess("SC1")=="E"
									    cFilialBsk:=IIF(FWModeAccess("SC1")=="C",xFilial("SC1"),SC7->C7_FILIAL)
									Else
									    cFilialBsk:=xFilial("SC1")
									EndIf
								EndIf
							    
								MaRetRoot( "SC1", cFilialBsk + SC7->C7_NUMSC + SC7->C7_ITEMSC, @aRoot, @nMaxLevel, @nLevel,nTree )
							Else
								MaRetRoot( "SC1", SC7->C7_NUMSC + SC7->C7_ITEMSC, @aRoot, @nMaxLevel, @nLevel,nTree )
							EndIf
						Else
							If lFilEnt
								MaRetRoot( "SC3", IIF(FWModeAccess("SC3")=="E",SC7->C7_FILIAL,xFilial("SC3")) + SC7->C7_NUMSC + SC7->C7_ITEMSC, @aRoot, @nMaxLevel, @nLevel,nTree )
							Else
								MaRetRoot( "SC3", SC7->C7_NUMSC + SC7->C7_ITEMSC, @aRoot, @nMaxLevel, @nLevel,nTree )
							EndIf
						EndIf 
					Case !Empty( SC7->C7_MEDICAO ) .And. !Empty( SC7->C7_ITEMED )  
			     		//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
						//Ё Ponto de entrada na execucao da arvore originada do GestЦo de Contratos     Ё
						//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды      
						If lMARETGCT
							lMRTGCT := ExecBlock( "MARETGCT", .f., .f.,{cKeyCNE,aRoot,nMaxLevel,nLevel,nTree} )     
							
							If ValType(lMRTGCT)=="L"   
								lRetMRTGCT:= lMRTGCT
							EndIf
						EndIf
	
						If lRetMRTGCT
							//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
							//Ё Medicao                                                      Ё
							//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
							cKeyCNE := SC7->C7_CONTRA + SC7->C7_CONTREV + SC7->C7_MEDICAO + SC7->C7_ITEMED
							If lFilEnt
								MaRetRoot( "CNE", IIF(FWModeAccess("CNE")=="E",SC7->C7_FILIAL,xFilial("CNE")) + cKeyCNE, @aRoot, @nMaxLevel, @nLevel,nTree )
							Else
								MaRetRoot( "CNE",  cKeyCNE, @aRoot, @nMaxLevel, @nLevel,nTree )
							EndIf 
						EndIf
						
				EndCase
				
				nLevel--
				
			EndIf
			
		EndIf

	Case cAlias == "SC1"
		
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Solicitacoes de Compra                                       Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		SC1->( DbSetOrder( 1 ) ) 
		If lFilEnt
			cTrkSeek:= cKey
		Else
			cTrkSeek:= xFilial( "SC1" ) + cKey 
		EndIf		
		
		If  SC1->( DbSeek (cTrkSeek) )
		
			If nLevel <= nMaxLevel
			
				nLevel++
				
				AAdd( aRoot, { "SC1", cKey, nLevel,nTree } )  
				
				nLevel--
				
			EndIf
			
		EndIf

	Case cAlias == "SC3"
		
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Contrato de Parceria                                         Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		SC3->( DbSetOrder( 1 ) )
		If lFilEnt 
			cTrkSeek:= cKey 
		Else
			cTrkSeek:= xFilial( "SC3" ) + cKey 
		EndIf        
		
		If SC3->( DbSeek (cTrkSeek) )
			
			If nLevel <= nMaxLevel
			
				nLevel++
				
				AAdd( aRoot, { "SC3", cKey, nLevel,nTree  } )
				
				nLevel--
				
			EndIf
			
		EndIf

	Case cAlias == "SC8"
		
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Cotacoes de Compra                                           Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		SC8->( DbSetOrder( 3 ) )
		If lFilEnt 
			cTrkSeek:= cKey
		Else	
			cTrkSeek:= xFilial( "SC8" ) + cKey
		EndIf		

		If SC8->( DbSeek (cTrkSeek) )
			
			If nLevel <= nMaxLevel
			
				nLevel++
				
				AAdd( aRoot, { "SC8", cKey, nLevel,nTree } )
				
				//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
				//Ё Analisa origem                                               Ё
				//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
				Do Case
					Case !Empty( SC8->C8_NUMSC ) .AND. !Empty( SC8->C8_ITEMSC )
					   
						cAliasQry := GetNextAlias() 
					
						cQuery := "" 
						
						If lFilEnt
							cQuery += "SELECT C1_FILIAL,C1_NUM,C1_ITEM FROM " + RetSqlName( "SC1" ) + " "
							cQuery += "WHERE " 
							If FWModeAccess("SC1") == "E"  .And. FWModeAccess("SC8") == "E" 
								cQuery += "C1_FILIAL='"  + SC8->C8_FILIAL   + "' AND "
							Else
								cQuery += "C1_FILIAL='"  + xFilial( "SC1" ) + "' AND "								
							EndIf
							cQuery += "C1_COTACAO='" + SC8->C8_NUM      + "' AND "
							cQuery += "C1_PRODUTO='" + SC8->C8_PRODUTO  + "' AND "
							cQuery += "C1_IDENT='"   + SC8->C8_IDENT  + "' AND "							
							cQuery += "D_E_L_E_T_=' ' "
							cQuery += "ORDER BY C1_FILIAL,C1_NUM,C1_ITEM" 															
						Else
							cQuery += "SELECT C1_NUM,C1_ITEM FROM " + RetSqlName( "SC1" ) + " "
							cQuery += "WHERE " 
							cQuery += "C1_FILIAL='"  + xFilial( "SC1" ) + "' AND "
							cQuery += "C1_COTACAO='" + SC8->C8_NUM      + "' AND "
							cQuery += "C1_PRODUTO='" + SC8->C8_PRODUTO  + "' AND "
							cQuery += "C1_IDENT='"   + SC8->C8_IDENT  + "' AND "							
							cQuery += "D_E_L_E_T_=' ' "
							cQuery += "ORDER BY C1_NUM,C1_ITEM" 		
						EndIf
							                                    
						cQuery := ChangeQuery( cQuery ) 
						
						dbUseArea( .T., "TOPCONN", TcGenQry(,,cQuery), cAliasQry, .F., .T. ) 
						
						If lFilEnt
							While !( cAliasQry )->( Eof() )
								MaRetRoot( "SC1", ( cAliasQRY )->C1_FILIAL + ( cAliasQRY )->C1_NUM + ( cAliasQRY )->C1_ITEM, @aRoot, @nMaxLevel, @nLevel,nTree )
								nTree++
								( cAliasQry )->( dbSkip() ) 																
							End        
						Else
							While !( cAliasQry )->( Eof() )
								MaRetRoot( "SC1", ( cAliasQRY )->C1_NUM + ( cAliasQRY )->C1_ITEM, @aRoot, @nMaxLevel, @nLevel,nTree )
								nTree++
								( cAliasQry )->( dbSkip() ) 																
							End	
						EndIf
						
						( cAliasQry )->( dbCloseArea() )
						dbSelectArea( "SC1" )  
					
				EndCase                          
				
				nLevel--
				
			EndIf
			
		EndIf

	Case cAlias == "SD1"
		
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Itens de nota de entrada                                     Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		SD1->( DbSetOrder( 1 ) )
		If SD1->( DbSeek( xFilial( "SD1" ) + cKey ) )
			
			If nLevel <= nMaxLevel
			
				nLevel++
				
				If lFilEnt
					AAdd( aRoot, { "SD1", xFilial("SD1") + cKey, nLevel,nTree } )
				Else
					AAdd( aRoot, { "SD1", cKey, nLevel,nTree } )
				EndIf
				
				//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
				//Ё Analisa origem                                               Ё
				//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
				Do Case
					Case !Empty( SD1->D1_PEDIDO ) .AND. !Empty( SD1->D1_ITEMPC )
						//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
						//Ё Pedido de Compra                                             Ё
						//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
						If lFilEnt
							MaRetRoot( "SC7", SC7->(xFilEnt(xFilial("SC7"))) + SD1->D1_PEDIDO + SD1->D1_ITEMPC, @aRoot, @nMaxLevel, @nLevel,nTree )
						Else
							MaRetRoot( "SC7", SD1->D1_PEDIDO + SD1->D1_ITEMPC, @aRoot, @nMaxLevel, @nLevel,nTree )
						EndIf
					Case cPaisLoc<>"BRA" .AND. !Empty(SD1->D1_REMITO)
						//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
						//Ё Remito de Compra                                             Ё
						//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
						MaRetRoot( "SD1", SD1->D1_REMITO + SD1->D1_SERIREM + SD1->D1_FORNECE + SD1->D1_LOJA + SD1->D1_COD + SD1->D1_ITEMREM, @aRoot, @nMaxLevel, @nLevel,nTree )
				EndCase
				
				//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
				//Ё Verifica se o item foi devolvido                             Ё
				//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
			
				cAliasQry := GetNextAlias()
						
				cQuery := ""
						
				cQuery += "SELECT D2_FILIAL,D2_DOC,D2_SERIE,D2_CLIENTE,D2_LOJA,D2_COD,D2_ITEM " 
				cQuery += "FROM " + RetSqlName( "SD2" ) + " "
				cQuery += "WHERE "
				cQuery += "D2_FILIAL='"  + xFilial( "SD2" ) + "' AND "
				cQuery += "D2_NFORI ='" + SD1->D1_DOC + "' AND "
				cQuery += "D2_SERIORI ='" + SD1->D1_SERIE + "' AND "
				cQuery += "D2_ITEMORI ='" + SD1->D1_ITEM + "' AND "
				cQuery += "D2_CLIENTE ='" + SD1->D1_FORNECE + "' AND "
				cQuery += "D2_LOJA ='" + SD1->D1_LOJA + "' AND "
				cQuery += "D_E_L_E_T_=' ' "
						
				cQuery := ChangeQuery( cQuery )
						
				dbUseArea( .T., "TOPCONN", TcGenQry( ,,cQuery ), cAliasQry, .F., .T. )
					
				While !( cAliasQry )->( Eof() )   
					nTree++	
					MaRetRoot("SD2",(cAliasQry)->D2_DOC+(cAliasQry)->D2_SERIE+(cAliasQry)->D2_CLIENTE+;
					(cAliasQry)->D2_LOJA+(cAliasQry)->D2_COD+(cAliasQry)->D2_ITEM, @aRoot, @nMaxLevel, @nLevel,nTree)
					( cAliasQry )->( dbSkip() )
				End
						
				(cAliasQry)->(dbCloseArea())
				dbSelectArea("SD2")
				
				nLevel--
				
			EndIf
			
		EndIf
		
	Case cAlias == "SCK"
		
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Itens do orcamento                                           Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		
		If nLevel <= nMaxLevel
		
			nLevel++
			SCK->( DbSetOrder( 1 ) )
			If SCK->( DbSeek( xFilial( "SCK" ) + cKey ) )
				AAdd( aRoot, { "SCK", SCK->CK_NUM + SCK->CK_ITEM, nLevel,nTree } )
				
				cIndTrab  := CriaTrab( , .F. )
				cIndexKey := AD1->( IndexKey() )
				
				cCond     := ""
				cCond     += "AD1_FILIAL=='" + xFilial( "AD1" ) + "' .AND. "
				cCond     += "AD1_NUMORC=='" + SCK->CK_NUM      + "'"
				
				IndRegua( "AD1", cIndTrab, cIndexKey, , cCond )
				
				AD1->( dbGoTop() )
				
				While !AD1->( Eof() )
					MaRetRoot( "AD1", AD1->AD1_NROPOR, @aRoot, @nMaxLevel, @nLevel,nTree )
					AD1->( dbSkip() )
				End
				
				RetIndex( "AD1" )
				
			EndIf
			
			nLevel--
		EndIf
		
	Case cAlias == "AAN"
		
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Itens do contrato de servico - parceria                      Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		If nLevel <= nMaxLevel
		    nLevel++
			
			AAN->( DbSetOrder( 1 ) )
			If AAN->( DbSeek( xFilial( "AAN" ) + cKey ) )
				AAdd( aRoot, { "AAN", cKey, nLevel,nTree } )
			EndIf    
			
			nLevel--
		EndIf
		
	Case cAlias == "AAO"
		
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Itens do contrato de servico - WMS                           Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		If nLevel <= nMaxLevel
			nLevel++
			AAO->( DbSetOrder( 1 ) )
			If AAO->( DbSeek( xFilial( "AAO" ) + cKey ) )
				AAdd( aRoot, { "AAO", cKey, nLevel,nTree } )
			EndIf
			nLevel--
		EndIf

	Case cAlias == "ADB"
		
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Itens do contrato de parceria - Venda                        Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		If nLevel <= nMaxLevel
			nLevel++
			ADB->( DbSetOrder( 1 ) )
			If ADB->( DbSeek( xFilial( "ADB" ) + cKey ) )
				AAdd( aRoot, { "ADB", cKey, nLevel,nTree } )
			EndIf
			nLevel--
		EndIf
		
	Case cAlias == "AD1"
		
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Itens do contrato de servico - WMS                           Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		If nLevel <= nMaxLevel
			nLevel++
			AD1->( DbSetOrder( 1 ) )
			If AD1->( DbSeek( xFilial( "AD1" ) + cKey ) )
				AAdd( aRoot, { "AD1", cKey, nLevel,nTree } )
			EndIf
			nLevel--
		EndIf                                         
		
	Case cAlias == "ADY"
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Proposta Comercial                                           Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		If nLevel <= nMaxLevel
			nLevel++
			ADY->( DbSetOrder( 1 ) )
			If ADY->( DbSeek( xFilial( "ADY" ) + cKey ) )
				AAdd( aRoot, { "ADY", cKey, nLevel,nTree } )
			EndIf
			nLevel--
		EndIf                                         

	Case cAlias == "AAH"
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Contrato de Manutencao                                       Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		If nLevel <= nMaxLevel
			nLevel++
			AAH->( DbSetOrder( 6 ) )
			If AAH->( DbSeek( xFilial( "AAH" ) + cKey ) )
				AAdd( aRoot, { "AAH", cKey, nLevel,nTree } )
			EndIf
			nLevel--
		EndIf                                         

	Case cAlias == "AAA"
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Grupo de Cobertura                                           Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		If nLevel <= nMaxLevel
			nLevel++
			AAA->( DbSetOrder( 1 ) )
			If AAA->( DbSeek( xFilial( "AAA" ) + cKey ) )
				AAdd( aRoot, { "AAA", cKey, nLevel,nTree } )
			EndIf
			nLevel--
		EndIf                                         

	Case cAlias == "AAM"
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Contrato de Servicos                                         Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		If nLevel <= nMaxLevel
			nLevel++
			AAM->( DbSetOrder( 3 ) )
			If AAM->( DbSeek( xFilial( "AAM" ) + cKey ) )
				AAdd( aRoot, { "AAM", cKey, nLevel,nTree } )
			EndIf
			nLevel--
		EndIf                                         

	Case cAlias == "SUB"
		
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Itens do atendimento do telemarketing                        Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		If nLevel <= nMaxLevel
			nLevel++
			SUB->( DbSetOrder( 1 ) )
			If SUB->( DbSeek( xFilial( "SUB" ) + cKey ) )
				AAdd( aRoot, { "SUB", cKey, nLevel,nTree } )
			EndIf                                 
			nLevel--
		EndIf

	Case cAlias == "SA1"	
		
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Cadastro de Cliente -> Procura pelo Prospect                 Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		
		If nLevel <= nMaxLevel
			nLevel++

			SA1->( DbSetOrder( 1 ) )
			If SA1->( DbSeek( xFilial( "SA1" ) + cKey ) )
			
				AAdd( aRoot, { "SA1", SA1->A1_COD+SA1->A1_LOJA, nLevel,nTree } )				
			
				SUS->( DbSetOrder( 5 ) ) 
				If SUS->( DbSeek( xFilial( "SUS" ) + cKey ) )         
					MaRetRoot( "SUS", SUS->US_COD + SUS->US_LOJA, @aRoot, @nMaxLevel, @nLevel,nTree )
				EndIf	
			EndIf
			nLevel--
					
		Endif

	Case cAlias == "SUS"	

		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Cadastro de Prospect -> Procura pelo Suspect                 Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		If nLevel <= nMaxLevel
			nLevel++

			SUS->( DbSetOrder( 1 ) )
			If SUS->( DbSeek( xFilial( "SUS" ) + cKey ) )
			
				AAdd( aRoot, { "SUS", SUS->US_COD+SUS->US_LOJA, nLevel,nTree } )				
			
				ACH->( DbSetOrder( 4 ) ) 
				If ACH->( DbSeek( xFilial( "ACH" ) + cKey ) )         
					MaRetRoot( "ACH", ACH->ACH_CODIGO, @aRoot, @nMaxLevel, @nLevel,nTree )
				EndIf	
			EndIf	
			nLevel--	
		Endif

	Case cAlias == "ACH"	
		
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Cadastro de Suspect -> Origem                                Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		ACH->( DbSetOrder( 1 ) )
		If ACH->( DbSeek( xFilial( "ACH" ) + cKey ) )
			If nLevel <= nMaxLevel                                             
				nLevel++
				AAdd( aRoot, { "ACH", ACH->ACH_CODIGO+ACH->ACH_LOJA,nLevel,nTree } )
				nLevel--
			Endif
		Endif 
		
	Case cAlias == "CNE"
		
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Item da medicao                                              Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		cTrkSeek:= cKey
        
		
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Obtem o alias devido a recursividade                                   Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		cAliasQry := GetNextAlias()
		
		nTamFil    := Iif(lFilEnt,Len( CNE->CNE_FILIAL ),0)+1
		NTamContra := Iif(lFilEnt,Len( CNE->CNE_FILIAL ),0)+Len( CNE->CNE_CONTRA )+1
		NTamRevisa := Iif(lFilEnt,Len( CNE->CNE_FILIAL ),0)+Len( CNE->CNE_CONTRA )+Len( CNE->CNE_REVISA )+1
		NTamMed    := Iif(lFilEnt,Len( CNE->CNE_FILIAL ),0)+Len( CNE->CNE_CONTRA )+Len( CNE->CNE_REVISA )+Len( CNE->CNE_NUMMED )+1
		cQuery := ""
		cQuery += "SELECT CNE_NUMMED, CNE_CONTRA, CNE_ITEM, CNE_NUMERO, CNE_REVISA FROM "+RetSqlName("CNE")+" CNE "
		cQuery += "WHERE "
		If(lFilEnt)
			cQuery += "CNE_FILIAL='" + Substr(cTrkSeek,  1          , Len( CNE->CNE_FILIAL )) + "' AND "
		Else
			cQuery += "CNE_FILIAL='" + xFilial( "CNE" ) + "' AND "
		EndIf
		
		cQuery += "CNE_CONTRA='" + Substr(cTrkSeek,  nTamFil    , Len( CNE->CNE_CONTRA )) + "' AND "
		cQuery += "CNE_REVISA='" + Substr(cTrkSeek,  nTamContra, Len( CNE->CNE_REVISA )) + "' AND "  
		cQuery += "CNE_NUMMED='" + Substr(cTrkSeek,  nTamRevisa, Len( CNE->CNE_NUMMED )) + "' AND " 
		cQuery += "CNE_ITEM  ='" + Substr(cTrkSeek,  nTamMed    , Len( CNE->CNE_ITEM  ) ) + "' AND "		
		cQuery += "CNE.D_E_L_E_T_=' ' "
		cQuery += "ORDER BY " + SqlOrder( CNE->( IndexKey() ) )
		
		cQuery := ChangeQuery( cQuery )
		
		dbUseArea( .T., "TOPCONN", TcGenQry( ,, cQuery ), cAliasQry, .F., .T. )
	        
		If !( cAliasQry )->( Eof() ) 
			
			If nLevel <= nMaxLevel
			
				nLevel++
				
				AAdd( aRoot, { "CNE", cKey, nLevel,nTree } )

				//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
				//Ё Verifica tipo do contrato                                    Ё
				//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
				CN9->( DbSetOrder(1) )
				If CN9->( DbSeek( xFilial("CN9") + ( cAliasQRY )->CNE_CONTRA + ( cAliasQRY )->CNE_REVISA ) )
					CN1->( DbSetOrder(1) )
					If CN1->( DbSeek( xFilial("CN1") + CN9->CN9_TPCTO ) )
						lFixoGCT := Empty( CN1->CN1_CTRFIX ) .OR. (CN1->CN1_CTRFIX == "1")
					EndIf
				EndIf

				//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
				//Ё Analisa origem                                               Ё
				//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
				Do Case
					Case !Empty( ( cAliasQRY )->CNE_NUMERO )
						//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
						//Ё Planilhas                                                    Ё
						//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
						MaRetRoot( "CNB", ( cAliasQRY )->CNE_CONTRA + ( cAliasQRY )->CNE_REVISA + ( cAliasQRY )->CNE_NUMERO + StrZero( Val( ( cAliasQRY )->CNE_ITEM ), Len( CNB->CNB_ITEM ) ), @aRoot, @nMaxLevel, @nLevel,nTree )
					Case !lFixoGCT
						//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
						//Ё Contrato                                                     Ё
						//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
						MaRetRoot( "CN9", ( cAliasQRY )->CNE_CONTRA + ( cAliasQRY )->CNE_REVISA, @aRoot, @nMaxLevel, @nLevel,nTree )
				EndCase
				
				nLevel--
				
			EndIf
			
		EndIf            
		
	   ( cAliasQry )->( dbCloseArea())  
	   
	
	Case cAlias == "CNB"
      
		CNB->( DbSetOrder( 1 ) ) 
		
		If CNB->( DbSeek( xFilial( "CNB" ) + cKey ) ) 
			
			If nLevel <= nMaxLevel
			
				nLevel++
				
				AAdd( aRoot, { "CNB", cKey, nLevel,nTree } )
				
				//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
				//Ё Analisa origem                                               Ё
				//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
				If !Empty( CNB->CNB_NUMSC + CNB->CNB_ITEMSC )
					//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
					//Ё Solicitacao de compras                                       Ё
					//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
					If lFilEnt
						MaRetRoot( "SC1", CNB->CNB_FILORI + CNB->CNB_NUMSC + CNB->CNB_ITEMSC, @aRoot, @nMaxLevel, @nLevel,nTree )
					Else
						MaRetRoot( "SC1", CNB->CNB_NUMSC + CNB->CNB_ITEMSC, @aRoot, @nMaxLevel, @nLevel,nTree )
					EndIf
				EndIf
				
				nLevel--
				
			EndIf
			
		EndIf
		
	Case cAlias == "CN9"
      	cAliasQry := GetNextAlias()
      	
		CN9->( DbSetOrder( 1 ) ) 
		If lFilEnt 
			cTrkSeek:= cKey
		Else	
			cTrkSeek:= xFilial( "CN9" ) + cKey
		EndIf
		If CN9->( DbSeek( cTrkSeek ) )
			
			If nLevel <= nMaxLevel
			
				nLevel++
				AAdd( aRoot, { "CN9", cKey, nLevel,nTree } )
				
				cQuery := " SELECT "
				cQuery += " 	CNB.CNB_NUMSC, "
				cQuery += " 	CNB.CNB_ITEMSC, "
				cQuery += " 	SC1.C1_COTACAO, "
				cQuery += " 	CNB.CNB_PRODUT, "
				cQuery += " 	CNA.CNA_FORNEC, "
				cQuery += " 	CNA.CNA_LJFORN "
				cQuery += " FROM " + RetSqlName("CN9") + " CN9  "
				cQuery += " 	INNER JOIN " + RetSqlName("CNA") + " CNA ON "
				cQuery += " 		CN9_NUMERO = CNA_CONTRA AND "
				cQuery += " 		CN9_REVISA = CNA_REVISA "
				cQuery += " 	INNER JOIN " + RetSqlName("CNB") + "  CNB ON "
				cQuery += " 		CNA_CONTRA = CNB_CONTRA AND "
				cQuery += " 		CNA_REVISA = CNB_REVISA AND "
				cQuery += " 		CNA_NUMERO = CNB_NUMERO "
				cQuery += " 	INNER JOIN " + RetSqlName("SC1") + " SC1 ON "
				cQuery += " 		CNB.CNB_NUMSC = SC1.C1_NUM AND "
				cQuery += " 		CNB.CNB_ITEMSC = SC1.C1_ITEM	 "
				cQuery += " WHERE  "
				cQuery += " 	CN9_NUMERO = "+ CN9->CN9_NUMERO + " AND "		
				cQuery += "   CN9.D_E_L_E_T_=' ' AND "
				cQuery += "   CNA.D_E_L_E_T_=' ' AND "
				cQuery += "   CNB.D_E_L_E_T_=' ' AND "
				cQuery += "   SC1.D_E_L_E_T_=' ' "
				
		
				cQuery := ChangeQuery( cQuery )
		
				dbUseArea( .T., "TOPCONN", TcGenQry( ,, cQuery ), cAliasQry, .F., .T. )
	        
				If !( cAliasQry )->( Eof() ) 
					MaRetRoot( "SC8", xFilial("SC8")+( cAliasQry )->C1_COTACAO + ( cAliasQry )->CNB_PRODUT + ( cAliasQry )->CNA_FORNEC + ( cAliasQry )->CNA_LJFORN/*+ SC7->C7_NUM + SC7->C7_ITEM*/,@aRoot,@nMaxLevel, @nLevel,nTree )
				Endif
					
				nLevel--
				
			EndIf
			
		EndIf

	OtherWise
		Aviso( STR0001, STR0002 + cAlias, { STR0003 } )  //"Aviso","Nao existe localizador para a entidade ","Ok"
EndCase

Return( Nil )

/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFun┤└o    ЁMaConvRootЁ Autor Ё Sergio Silveira       Ё Data Ё12/12/2001Ё╠╠
╠╠цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤└o Ё Obtem origens de cabecalho a partir das origens de item    Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁSintaxe   Ё ExpA1 := MaConvRoot( ExpA2 )                               Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁRetorno   Ё ExpA1 -> Array contendo as entidades de inicio header      Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁParametrosЁ ExpA1 -> Array contendo as entidades de inicio itens       Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё Uso      Ё GENERICO                                                   Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁObservacaoЁ                                                            Ё╠╠
╠╠юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/

Function MaConvRoot( aEnt )

LOCAL aNewEnt   := {}
LOCAL aParc     := {}

LOCAL cEntidade := ""

LOCAL nLoop     := 0

//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Percorre as entidades ja existentes                          Ё
//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
For nLoop := 1 to Len( aEnt )
	
	cEntidade := aEnt[ nLoop, 1 ]
	
	aParc := {}
	
	Do Case
		Case cEntidade == "SCK"
			aParc := { "SCJ", Left( aEnt[ nLoop, 2 ], 6 ), aEnt[ nLoop, 3 ] }
		Case cEntidade == "SC6"
			aParc := { "SC5", Left( aEnt[ nLoop, 2 ], 6 ), aEnt[ nLoop, 3 ] }
		Case cEntidade == "SUB"
			aParc := { "SUA", Left( aEnt[ nLoop, 2 ], 6 ), aEnt[ nLoop, 3 ] }
		Case cEntidade == "SD2"
			aParc := { "SF2", Left( aEnt[ nLoop, 2 ], Len( aEnt[ nLoop, 2 ] ) - 2 ),aEnt[ nLoop, 3 ] }
		Case cEntidade == "SD1"
			aParc := { "SF1", Left( aEnt[ nLoop, 2 ], Len( aEnt[ nLoop, 2 ] ) - 4 ),aEnt[ nLoop, 3 ] }
		Case cEntidade == "SC7"
			aParc := { "SC7H", Left( aEnt[ nLoop, 2 ], Len( aEnt[ nLoop, 2 ] ) - 4 ),aEnt[ nLoop, 3 ] }
		Case cEntidade == "SC1"
			aParc := { "SC1H", Left( aEnt[ nLoop, 2 ], Len( aEnt[ nLoop, 2 ] ) - 4 ),aEnt[ nLoop, 3 ] }
		Case cEntidade == "SC3"
			aParc := { "SC3H", Left( aEnt[ nLoop, 2 ], Len( aEnt[ nLoop, 2 ] ) - 4 ),aEnt[ nLoop, 3 ] }
		Case cEntidade == "SC8"
			aParc := { "SC8H", Left( aEnt[ nLoop, 2 ], Len( SC8->C8_NUM ) ) ,aEnt[ nLoop, 3 ] }
		Case cEntidade == "CNB"
			aParc := { "CNA", Left( aEnt[ nLoop, 2 ], Len( aEnt[ nLoop, 2 ] ) - Len( CNB->CNB_ITEM ) ) ,aEnt[ nLoop, 3 ] }
		Case cEntidade == "CNE"
			aParc := { "CND", Left( aEnt[ nLoop, 2 ], Len( aEnt[ nLoop, 2 ] ) - Len( CNE->CNE_ITEM ) ) ,aEnt[ nLoop, 3 ] }
		Case cEntidade == "CN9"
			aParc := { "CN9H", Left( aEnt[ nLoop, 2 ], Len( aEnt[ nLoop, 2 ] ) ) ,aEnt[ nLoop, 3 ] }
			
	EndCase
	
	
	//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//Ё Verifica se ja existe esta entidade                          Ё
	//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
	If !Empty( aParc )
		If Empty( AScan( aNewEnt, { |x| x[1] == aParc[1] .And. x[2] == aParc[2] } ) )
			AAdd( aNewEnt, AClone( aParc ) )
		EndIf
	EndIf
	
Next nLoop

Return( aNewEnt )

/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFuncao    Ё MATRKAB2 Ё Autor Ё Sergio Silveira       Ё Data Ё27/09/2000Ё╠╠
╠╠цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o Ё Monta as pastas dos chamados tecnicos                      Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁSintaxe   Ё MATRKAB2( ExpC1, @ExpO1, [ ExpC2 ], @ExpN1, [ ExpN2 ] )    Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁRetorno   Ё Nenhum                                                     Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁParametrosЁ ExpC1 -> Chave de pesquisa                                 Ё╠╠
╠╠Ё          Ё ExpO1 -> Objeto Tree                                       Ё╠╠
╠╠Ё          Ё ExpC2 -> String a adicionar ao texto do item ( tree )      Ё╠╠
╠╠Ё          Ё ExpN1 -> Nivel                                             Ё╠╠
╠╠Ё          Ё ExpN2 -> Nivel maximo                                      Ё╠╠
╠╠цддддддддддедддддддддддддддбдддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё   DATA   Ё Programador   ЁManutencao Efetuada                         Ё╠╠
╠╠цддддддддддедддддддддддддддедддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё05/07/2006Ё Cleber M.     ЁBops 101209: Alterada a ordem para montar   Ё╠╠
╠╠Ё          Ё               Ёprimeiro o Orcam. (AB4) e depois a OS (AB7) Ё╠╠
╠╠юддддддддддадддддддддддддддадддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/

Function MATRKAB2(	cNrCham,	oTree,	cAddString,		nLevel,;
					nMaxLevel,	lItem,	cTreeID	)

Local cImageAB2   := ""									// Imagem do arquivo AB2

//здддддддддддддддддддддддддддддддддддддддддддддддд©
//ЁVariaveis usadas em Integracoes                 Ё
//юдддддддддддддддддддддддддддддддддддддддддддддддды

DEFAULT nMaxLevel := 1000000
DEFAULT cTreeID   := "000001" 

cAddString := If( ValType( cAddString ) == "C", cAddString, "" )

AB2->( DbSetOrder( 1 ) )
If AB2->( DbSeek( xFilial( "AB2" ) + cNrCham ) )
	
	nLevel++
	
	If nLevel <= nMaxLevel
		
		cImageAB2 := MaEntImage( "AB2", 1 )
		
		oTree:AddItem( Pad( STR0004 + Transform( cNrCham, "@R XXXXXXXX/XX" ) + cAddString, 100 ),; //"Chamado/Item - "
		Pad( "AB2-" + cNrCham, 50 ) + cTreeID,cImageAB2,cImageAB2,,,nLevel)
		oTree:TreeSeek( Pad( "AB2-" + cNrCham, 50 ) + cTreeID )
		
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Analisa destino                                              Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		Do Case
			Case !Empty( AB2->AB2_NUMORC )
				MATRKAB4( AB2->AB2_NUMORC, @oTree, , @nLevel, nMaxLevel, ,cTreeID )
			Case !Empty( AB2->AB2_NUMOS )
				MATRKAB7( AB2->AB2_NUMOS, @oTree, , @nLevel, nMaxLevel, ,cTreeID )
			Case !Empty( AB2->AB2_NUMHDE )
				MATRKABL( AB2->AB2_NUMHDE, @oTree, , @nLevel, nMaxLevel, ,cTreeID )
		EndCase
		
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Verifica as FNCs geradas no QNC                              Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		oTree:TreeSeek( Pad( "AB2-" + cNrCham, 50 ))
       	If !Empty(AB2->AB2_CODFNC)
			MATRKQI2( AB2->AB2_CODFNC + AB2->AB2_FNCREV, @oTree, , @nLevel, nMaxLevel,,cTreeID, "TEC", "AB2-" + cNrCham )
		EndIf  
		
	EndIf
	
	nLevel--
	
EndIf
oTree:Refresh()  
oTree:Show()
Return( .T. )

/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFuncao    Ё MATRKABI Ё Autor Ё Sergio Silveira       Ё Data Ё27/09/2000Ё╠╠
╠╠цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o Ё Monta as pastas dos projetos                               Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁSintaxe   Ё MATRKABI( ExpC1, @ExpO1, [ ExpC2 ], @ExpN1, [ ExpN2 ] )    Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁRetorno   Ё Nenhum                                                     Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁParametrosЁ ExpC1 -> Chave de pesquisa                                 Ё╠╠
╠╠Ё          Ё ExpO1 -> Objeto Tree                                       Ё╠╠
╠╠Ё          Ё ExpC2 -> String a adicionar ao texto do item ( tree )      Ё╠╠
╠╠Ё          Ё ExpN1 -> Nivel                                             Ё╠╠
╠╠Ё          Ё ExpN2 -> Nivel maximo                                      Ё╠╠
╠╠цддддддддддедддддддддддддддбдддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё   DATA   Ё Programador   ЁManutencao Efetuada                         Ё╠╠
╠╠цддддддддддедддддддддддддддедддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё          Ё               Ё                                            Ё╠╠
╠╠юддддддддддадддддддддддддддадддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/

Function MATRKABI( cProjet, oTree, cAddString, nLevel, nMaxLevel, lItem, cTreeID )

Local cImageABI   := ""

DEFAULT nMaxLevel := 1000000
DEFAULT cTreeID   := "000001" 

ABI->( DbSetOrder( 1 ) )
If ABI->( DbSeek( xFilial( "ABI" ) + cProjet ) )
	
	nLevel++
	
	If nLevel <= nMaxLevel
		
		cAddString := If( ValType( cAddString ) == "C", cAddString, "" )
		
		oTree:TreeSeek( "ABI-" )
		
		cImageABI := MaEntImage( "ABI", 1 )
		
		oTree:AddItem( Pad( STR0005 + Transform( cProjet,"@R XXXXXX/XX" ) + ; //"Projeto/Item - "
		If( !Empty( cAddString ), " - " + STR0006 + cAddString, "" ), 100 ),; //" - Cliente : "
		Pad( "ABI-" + cProjet, 50 )+cTreeID,cImageABI,cImageABI,,,nLevel)
		
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Analisa destino                                              Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Geracao de OS                                                Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		If !Empty( ABI->ABI_NUMOS )
			oTree:TreeSeek( Pad( "ABI-" + cProjet, 50 )+cTreeID )
			MATRKAB7( ABI->ABI_NUMOS, @oTree, , @nLevel, nMaxLevel,,cTreeID )
		EndIf
		
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Geracao de pedido de venda                                   Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		If !Empty( ABI->ABI_NUMPV + ABI->ABI_ITEMPV )
			oTree:TreeSeek( Pad( "ABI-" + cProjet, 50 ) )
			MATRKSC6( ABI->ABI_NUMPV + ABI->ABI_ITEMPV, @oTree, , @nLevel, nMaxLevel,,cTreeID )
		EndIf
		
	EndIf
	
	nLevel--
		
EndIf
	
Return( .T. )
	
/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFuncao    Ё MATRKAB7 Ё Autor Ё Sergio Silveira       Ё Data Ё27/09/2000Ё╠╠
╠╠цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o Ё Monta as pastas da OS                                      Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁSintaxe   Ё MATRKAB7( ExpC1, @ExpO1, [ ExpC2 ], @ExpN1, [ ExpN2 ] )    Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁRetorno   Ё Nenhum                                                     Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁParametrosЁ ExpC1 -> Chave de pesquisa                                 Ё╠╠
╠╠Ё          Ё ExpO1 -> Objeto Tree                                       Ё╠╠
╠╠Ё          Ё ExpC2 -> String a adicionar ao texto do item ( tree )      Ё╠╠
╠╠Ё          Ё ExpN1 -> Nivel                                             Ё╠╠
╠╠Ё          Ё ExpN2 -> Nivel maximo                                      Ё╠╠
╠╠цддддддддддедддддддддддддддбдддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё   DATA   Ё Programador   ЁManutencao Efetuada                         Ё╠╠
╠╠цддддддддддедддддддддддддддедддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё          Ё               Ё                                            Ё╠╠
╠╠юддддддддддадддддддддддддддадддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/

Function MATRKAB7( cNumOs, oTree, cAddString, nLevel, nMaxLevel, lItem, cTreeID )

LOCAL cNumLaudo  := ""
LOCAL cAgenda    := ""
LOCAL cReq       := ""
LOCAL cImageAB7  := ""
LOCAL cImageAB9  := ""
LOCAL cImageABF  := ""
LOCAL cImageABB  := ""
LOCAL cQuery     := ""
LOCAL cAliasQry  := ""
DEFAULT nMaxLevel := 1000000
DEFAULT cTreeID   := "000001" 

cAddString := If( ValType( cAddString ) == "C", cAddString, "" )

AB7->( DbSetOrder( 1 ) )
If AB7->( DbSeek( xFilial( "AB7" ) + cNumOs ) )
	
	nLevel++
	
	If nLevel <= nMaxLevel
		
		cImageAB7 := MaEntImage( "AB7", 1 )
		
		oTree:AddItem( Pad( STR0007 + Transform( cNumOs, "@R XXXXXX/XX" ) + ; //"O.S./Item - "
		cAddString,100), Pad( "AB7-" + cNumOs, 50 ) + cTreeID,cImageAB7,cImageAB7,,,nLevel) //  //" - Cliente : "
		
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Se existem laudos, cria as ocorrencias                                 Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		               
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Obtem o alias devido a recursividade                                   Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		cAliasQry := GetNextAlias()
		
		cQuery := ""
		cQuery += "SELECT AB9_NUMOS, AB9_CODTEC, AB9_SEQ, AB9_NUMORC FROM "+RetSqlName("AB9")+" AB9 "
		cQuery += "WHERE "
		cQuery += "AB9_FILIAL='"  + xFilial( "AB9" ) + "' AND "
		cQuery += "AB9_NUMOS='"   + cNumOs           + "' AND "
		cQuery += "AB9.D_E_L_E_T_<>'*' "
		cQuery += "ORDER BY " + SqlOrder( AB9->( IndexKey() ) )
		
		cQuery := ChangeQuery( cQuery )
		
		dbUseArea( .T., "TOPCONN", TcGenQry( ,, cQuery ), cAliasQry, .F., .T. )
		
		If Alias() == cAliasQry
			oTree:TreeSeek( Pad( "AB7-" + cNumOs, 50 ) + cTreeID )
			cImageAB9 := MaEntImage( "AB9", 1 )
			
			While !Eof()
				
				cNumLaudo := AB9_NUMOS + AB9_CODTEC + AB9_SEQ
				
				MATRKAB9( cNumLaudo, @oTree, , @nLevel, nMaxLevel, , cTreeID )
				oTree:TreeSeek( Pad( "AB7-" + cNumOs, 50 ) + cTreeID )
				
				dbSelectArea( cAliasQry )
				dbSkip()
			End
			dbCloseArea()
			dbSelectArea( "AB9" )
		EndIf
			
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Se existem pedidos de venda, cria as ocorrencias                       Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		
		cAliasQry := GetNextAlias()
		
		cQuery := ""
		cQuery += "SELECT AB8_NUMPV, AB8_NUMPVF, AB8_NUMOS, AB8_ITEM FROM "+RetSqlName("AB8")+" AB8 "
		cQuery += "WHERE "
		cQuery += "AB8_FILIAL='"  + xFilial( "AB8" ) + "' AND "
		cQuery += "AB8_NUMOS='"   + AB7->AB7_NUMOS   + "' AND "
		cQuery += "AB8_ITEM='"    + AB7->AB7_ITEM    + "' AND "
		cQuery += "(AB8_NUMPV<>'" + Space(Len(AB8->AB8_NUMPV)) + "' OR "
		cQuery += "AB8_NUMPVF<>'"+ Space(Len(AB8->AB8_NUMPVF)) + "') AND "
		cQuery += "AB8.D_E_L_E_T_<>'*' "
		cQuery += "ORDER BY AB8_NUMPV, AB8_NUMPVF"
		
		cQuery := ChangeQuery( cQuery )
		
		dbUseArea( .T., "TOPCONN", TcGenQry( ,, cQuery ), cAliasQry, .F., .T. )
		
		If Alias() == cAliasQry
			oTree:TreeSeek( Pad( "AB7-" + cNumOs, 50 ) + cTreeID  )
			While !( cAliasQry )->( Eof() )
				
				If !Empty( cPedido := ( cAliasQry )->AB8_NUMPV )
					MATRKSC6( cPedido, @oTree, , @nLevel, nMaxLevel,, cTreeID ) //" - Cliente : "
					oTree:TreeSeek( Pad( "AB7-" + cNumOs, 50 )+cTreeID )
				EndIf
				
				If !Empty( cPedido := ( cAliasQry )->AB8_NUMPVF )
					MATRKSC6( cPedido, @oTree, , @nLevel, nMaxLevel,, cTreeID ) //" - Cliente : "
					oTree:TreeSeek( Pad( "AB7-" + cNumOs, 50 )+cTreeID )
				EndIf
				
				( cAliasQry )->( dbSkip() )
			End
			( cAliasQry )->( dbCloseArea() )
			dbSelectArea( "AB8" )
		EndIf
			
		nLevel++
		
		If nLevel <= nMaxLevel
			
			//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
			//Ё Se existem Requisicoes ao almoxarifado                                 Ё
			//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
				
			ABF->( DbSetOrder( 1 ) )
			cAliasQry := GetNextAlias()
			
			cQuery := ""
			cQuery += "SELECT ABF_NUMOS, ABF_ITEMOS, ABF_SEQRC FROM "+RetSqlName("ABF")+" ABF "
			cQuery += "WHERE "
			cQuery += "ABF_FILIAL='"  + xFilial( "ABF" ) + "' AND "
			cQuery += "ABF_NUMOS='"   + AB7->AB7_NUMOS   + "' AND "
			cQuery += "ABF_ITEMOS='"  + AB7->AB7_ITEM    + "' AND "
			cQuery += "ABF.D_E_L_E_T_<>'*' "
			cQuery += "ORDER BY " + SqlOrder( ABF->( IndexKey() ) )
			
			cQuery := ChangeQuery( cQuery )
			
			dbUseArea( .T., "TOPCONN", TcGenQry( ,, cQuery ), cAliasQry, .F., .T. )
			
			If Alias() == cAliasQry
				
				oTree:TreeSeek( Pad( "AB7-" + cNumOs, 50 )+cTreeID )
				cImageABF := MaEntImage( "ABF", 1 )
				
				While !( Eof() )
					cReq := ABF_NUMOS + ABF_ITEMOS + ABF_SEQRC
					
					oTree:AddItem( Pad( STR0010 + Transform(ABF_SEQRC,"@R XX"), 100 ), Pad( "ABF-" + cReq, 50 )+cTreeID,cImageABF,cImageABF,,,2)   //"Requisicao almoxarifado "
					dbSelectArea( cAliasQry )
					
					dbSkip()
				End
				dbCloseArea()
				dbSelectArea( "AB8" )
			EndIf
				
		EndIf
		
		nLevel--
		
		nLevel++
		
		If nLevel <= nMaxLevel
			
			//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
			//Ё Se existem agendamentos                                                Ё
			//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
				
			ABB->( DbSetOrder( 1 ) )
			cAliasQry := GetNextAlias()
			
			cQuery := ""
			cQuery += "SELECT ABB_NUMOS, ABB_CODTEC, ABB_DTINI FROM "+RetSqlName("ABB")+" ABB "
			cQuery += "WHERE "
			cQuery += "ABB_FILIAL='"  + xFilial( "ABB" ) + "' AND "
			cQuery += "ABB_NUMOS='"   + AB7->AB7_NUMOS   + "' AND "
			cQuery += "ABB.D_E_L_E_T_<>'*' "
			cQuery += "ORDER BY " + SqlOrder( ABB->( IndexKey() ) )
			
			cQuery := ChangeQuery( cQuery )
			
			dbUseArea( .T., "TOPCONN", TcGenQry( ,, cQuery ), cAliasQry, .F., .T. )
			
			TcSetField( cAliasQry, "ABB_DTINI", "D", 8, 0 )
			
			If Alias() == cAliasQry
				oTree:TreeSeek( Pad( "AB7-" + cNumOs, 50 )+cTreeID )
				
				cImageABB := MaEntImage( "ABB", 1 )
				
				While !( Eof() )
					
					cAgenda := ABB_NUMOS + ABB_CODTEC + DToC( ABB_DTINI )
					oTree:AddItem( Pad( STR0011 + ABB_CODTEC + STR0012 + DToC( ABB_DTINI ), 100 ), Pad( "ABB-" + cAgenda, 50 )+cTreeID,cImageABB,cImageABB,,,2)   //"Agenda - Tecnico - "###" / Inicio - "
					
					dbSelectArea( cAliasQry )
					dbSkip()
				End
				dbCloseArea()
				dbSelectArea( "AB8" )
			EndIf
				
		EndIf
		
		nLevel--
		
	EndIf
	
	nLevel--
	
EndIf

Return( .T. )

/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFuncao    Ё MATRKABL Ё Autor Ё Sergio Silveira       Ё Data Ё27/09/2000Ё╠╠
╠╠цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o Ё Monta as pastas da fila de Help Desk                       Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁSintaxe   Ё MATRKABL( ExpC1, @ExpO1, [ ExpC2 ], @ExpN1, [ ExpN2 ] )    Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁRetorno   Ё Nenhum                                                     Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁParametrosЁ ExpC1 -> Chave de pesquisa                                 Ё╠╠
╠╠Ё          Ё ExpO1 -> Objeto Tree                                       Ё╠╠
╠╠Ё          Ё ExpC2 -> String a adicionar ao texto do item ( tree )      Ё╠╠
╠╠Ё          Ё ExpN1 -> Nivel                                             Ё╠╠
╠╠Ё          Ё ExpN2 -> Nivel maximo                                      Ё╠╠
╠╠цддддддддддедддддддддддддддбдддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё   DATA   Ё Programador   ЁManutencao Efetuada                         Ё╠╠
╠╠цддддддддддедддддддддддддддедддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё          Ё               Ё                                            Ё╠╠
╠╠юддддддддддадддддддддддддддадддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/

Function MATRKABL( cNumHD, oTree, cAddString, nLevel, nMaxLevel, lItem, cTreeID )

LOCAL cChaveABK := ""
LOCAL cImageABK := ""
LOCAL cImageABL := ""

DEFAULT nMaxLevel := 1000000
DEFAULT cTreeID   := "000001" 

cAddString := If( ValType( cAddString ) == "C", cAddString, "" )

ABL->( DbSetOrder( 1 ) )
If ABL->( DbSeek( xFilial( "ABL" ) + cNumHD ) )
	
	nLevel++
	
	If nLevel <= nMaxLevel
		
		cImageABL := MaEntImage( "ABL", 1 )
		
		oTree:AddItem( Pad( STR0013 + cNumHd, 100 ), Pad( "ABL-" + cNumHd, 50 )+cTreeID,cImageABL,cImageABL,,,nLevel)  //"Help Desk - "
		If !Empty( ABL->ABL_NUMOS )
			oTree:TreeSeek( Pad( "ABL-" + cNumHd, 50 )+cTreeID )
			MATRKAB7( ABL->ABL_NUMOS, @oTree, , @nLevel, nMaxLevel,,cTreeID )
		EndIf
		
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Se existem atendimentos, cria                                          Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
			
		cQuery := ""
		cQuery += "SELECT ABK_NRCHAM, ABK_SEQ FROM "+RetSqlName("ABK")+" ABK "
		cQuery += "WHERE "
		cQuery += "ABK_FILIAL='"  + xFilial( "ABK" ) + "' AND "
		cQuery += "ABK_NRCHAM='"  + ABL->ABL_NRCHAM  + "' AND "
		cQuery += "ABK.D_E_L_E_T_<>'*' "
		cQuery += "ORDER BY " + SqlOrder( ABK->( IndexKey() ) )
		
		cQuery := ChangeQuery( cQuery )
		
		dbUseArea( .T., "TOPCONN", TcGenQry( ,, cQuery ), "QUERY6", .F., .T. )
		
		If Alias() == "QUERY6"
			oTree:TreeSeek( Pad( "ABL-" + cNumHD, 50 )+cTreeID )
			cImageABK := MaEntImage( "ABK", 1 )
			While !QUERY6->( Eof() )
				cChaveABK := QUERY6->ABK_NRCHAM + QUERY6->ABK_SEQ
				
				MATRKABK( cChaveABK, @oTree, , @nLevel, nMaxLevel,,cTreeID )
				
				QUERY6->( dbSkip() )
			End
			QUERY6->( dbCloseArea() )
			dbSelectArea( "ABK" )
		EndIf
			
	EndIf
	
	nLevel--
	
EndIf

Return( .T. )

/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFuncao    Ё MATRKABK Ё Autor Ё Sergio Silveira       Ё Data Ё01/02/2002Ё╠╠
╠╠цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o Ё Monta as pastas de atendimento de Help Desk                Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁSintaxe   Ё MATRKABK( ExpC1, @ExpO1, [ ExpC2 ], @ExpN1, [ ExpN2 ] )    Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁRetorno   Ё Nenhum                                                     Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁParametrosЁ ExpC1 -> Chave de pesquisa                                 Ё╠╠
╠╠Ё          Ё ExpO1 -> Objeto Tree                                       Ё╠╠
╠╠Ё          Ё ExpC2 -> String a adicionar ao texto do item ( tree )      Ё╠╠
╠╠Ё          Ё ExpN1 -> Nivel                                             Ё╠╠
╠╠Ё          Ё ExpN2 -> Nivel maximo                                      Ё╠╠
╠╠цддддддддддедддддддддддддддбдддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё   DATA   Ё Programador   ЁManutencao Efetuada                         Ё╠╠
╠╠цддддддддддедддддддддддддддедддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё          Ё               Ё                                            Ё╠╠
╠╠юддддддддддадддддддддддддддадддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/

Function MATRKABK( cNrCham, oTree, cAddString, nLevel, nMaxLevel, lItem, cTreeID )

LOCAL cImageABK   := ""

DEFAULT nMaxLevel := 1000000
DEFAULT cTreeID   := "000001" 

ABK->( DbSetOrder( 1 ) )
If ABK->( DbSeek( xFilial( "ABK" ) + cNrCham ) )
	
	nLevel++
	
	If nLevel <= nMaxLevel
		
		cAddString := If( ValType( cAddString ) == "C", cAddString, "" )
		cImageABK  := MaEntImage( "ABK", 1 )
		
		oTree:AddItem( Pad( STR0014 + Transform(cNrCham,"@R XXXXXXXXXX/XX") + ; // "Atendimento Help Desk/Sequencia - "
		cAddString, 100 ), Pad( "ABK-" + cNrCham, 50 ) + cTreeID,cImageABK,cImageABK,,,nLevel)
		
	EndIf
	
	nLevel--
	
EndIf

Return( .T. )

/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFuncao    Ё MATRKAB4 Ё Autor Ё Sergio Silveira       Ё Data Ё27/09/2000Ё╠╠
╠╠цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o Ё Monta as pastas de orcamentos                              Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁSintaxe   Ё MATRKAB4( ExpC1, @ExpO1, [ ExpC2 ], @ExpN1, [ ExpN2 ] )    Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁRetorno   Ё Nenhum                                                     Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁParametrosЁ ExpC1 -> Chave de pesquisa                                 Ё╠╠
╠╠Ё          Ё ExpO1 -> Objeto Tree                                       Ё╠╠
╠╠Ё          Ё ExpC2 -> String a adicionar ao texto do item ( tree )      Ё╠╠
╠╠Ё          Ё ExpN1 -> Nivel                                             Ё╠╠
╠╠Ё          Ё ExpN2 -> Nivel maximo                                      Ё╠╠
╠╠цддддддддддедддддддддддддддбдддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё   DATA   Ё Programador   ЁManutencao Efetuada                         Ё╠╠
╠╠цддддддддддедддддддддддддддедддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё          Ё               Ё                                            Ё╠╠
╠╠юддддддддддадддддддддддддддадддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/

Function MATRKAB4( cNumOrc, oTree, cAddString, nLevel, nMaxLevel, lItem, cTreeID )


LOCAL cImageAB4   := ""

DEFAULT nMaxLevel := 1000000                            
DEFAULT cTreeID   := "000001" 

AB4->( DbSetOrder( 1 ) )
If AB4->( DbSeek( xFilial( "AB4" ) + cNumOrc ) )
	
	nLevel++
	
	If nLevel <= nMaxLevel
		
		cAddString := If( ValType( cAddString ) == "C", cAddString, "" )
		cImageAB4  := MaEntImage( "AB4", 1 )
		
		oTree:AddItem( Pad( STR0015 + Transform( cNumOrc, "@r XXXXXX/XX" ) + ; //"Orcamento/Item - "
		cAddString, 100 ), Pad( "AB4-" + cNumOrc, 50 ) +cTreeID,cImageAB4,cImageAB4,,,nLevel)
		
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Analisa destino                                              Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		If !Empty( AB4->AB4_NUMOS )
			oTree:TreeSeek( Pad( "AB4-" + cNumOrc, 50 )+cTreeID )
			MATRKAB7( AB4->AB4_NUMOS, @oTree, , @nLevel, nMaxLevel,,cTreeID )
		EndIf
		
	EndIf
	
	nLevel--
	
EndIf

Return( .T. )

/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFuncao    Ё MATRKSC2 Ё Autor ЁRodrigo A Sartorio     Ё Data Ё18/11/2002Ё╠╠
╠╠цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o Ё Monta as pastas de Ordem de Producao                       Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁSintaxe   Ё MATRKSC2( ExpC1, @ExpO1, [ ExpC2 ], @ExpN1, [ ExpN2 ] )    Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁRetorno   Ё Nenhum                                                     Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁParametrosЁ ExpC1 -> Chave de pesquisa                                 Ё╠╠
╠╠Ё          Ё ExpO1 -> Objeto Tree                                       Ё╠╠
╠╠Ё          Ё ExpC2 -> String a adicionar ao texto do item ( tree )      Ё╠╠
╠╠Ё          Ё ExpN1 -> Nivel                                             Ё╠╠
╠╠Ё          Ё ExpN2 -> Nivel maximo                                      Ё╠╠
╠╠юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/
Function MATRKSC2( cNumOP, oTree, cAddString, nLevel, nMaxLevel, lItem, cTreeID )
LOCAL cImageSC2 := "",cImageSD3 := ""
LOCAL cPictOp   :=PesqPict("SD3","D3_OP",Len(SD3->D3_OP))
LOCAL aArea     := GetArea()
LOCAL aBackSC2  := SC2->(GetArea())
LOCAL aBackSD3  := SD3->(GetArea())
DEFAULT nMaxLevel := 1000000
DEFAULT cTreeID   := "000001"
SC2->( DbSetOrder( 1 ) )
If SC2->( DbSeek( xFilial( "SC2" ) + cNumOP  ) )
	cImageSC2 := MaEntImage( "SC2", 1 )
	nLevel++
	If nLevel <= nMaxLevel
		cAddString := If( ValType( cAddString ) == "C", cAddString, "" )
		oTree:AddItem( Pad( STR0050 + Transform( cNumOp, cPictOP ) + ;  // "Ordem de Producao "
		cAddString, 100 ), Pad( "SC2-" + cNumOp, 50 )+cTreeID,cImageSC2,cImageSC2,,,nLevel)
	EndIf         
	// Inclui Movimentos internos relacionados a Ordem de Producao
	nLevel++
	If nLevel <= nMaxLevel
		cImageSD3 := MaEntImage( "SD3", 1 )
		dbSelectArea("SD3")	
		dbSeek(xFilial()+cNumOP)
		While !Eof() .And. D3_FILIAL+D3_OP == xFilial()+cNumOP
			If D3_ESTORNO <> "S"
				cAddString := If( ValType( cAddString ) == "C", cAddString, "" )
				oTree:TreeSeek( Pad( "SC2-" + cNumOp, 50 )+cTreeID )
				oTree:AddItem( Pad( STR0051 + SD3->D3_NUMSEQ + ;  // "Movimento Interno "
				cAddString, 100 ), Pad( "SD3-" + SD3->D3_NUMSEQ + Str(SD3->(Recno()),10), 50 ) + cTreeID,cImageSD3,cImageSD3,,,nLevel)
			EndIf
			dbSkip()
		End
	EndIf
	nLevel--
	nLevel--           
EndIf
SC2->(RestArea(aBackSC2))
SD3->(RestArea(aBackSD3))
RestArea(aArea)
RETURN

/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFuncao    Ё MATRKSC6 Ё Autor Ё Sergio Silveira       Ё Data Ё28/11/2001Ё╠╠
╠╠цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o Ё Monta as pastas de itens de pedidos                        Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁSintaxe   Ё MATRKSC6( ExpC1, @ExpO1, [ ExpC2 ], @ExpN1, [ ExpN2 ] )    Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁRetorno   Ё Nenhum                                                     Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁParametrosЁ ExpC1 -> Chave de pesquisa                                 Ё╠╠
╠╠Ё          Ё ExpO1 -> Objeto Tree                                       Ё╠╠
╠╠Ё          Ё ExpC2 -> String a adicionar ao texto do item ( tree )      Ё╠╠
╠╠Ё          Ё ExpN1 -> Nivel                                             Ё╠╠
╠╠Ё          Ё ExpN2 -> Nivel maximo                                      Ё╠╠
╠╠цддддддддддедддддддддддддддбдддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё   DATA   Ё Programador   ЁManutencao Efetuada                         Ё╠╠
╠╠цддддддддддедддддддддддддддедддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё          Ё               Ё                                            Ё╠╠
╠╠юддддддддддадддддддддддддддадддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/

Function MATRKSC6( cNumPed, oTree, cAddString, nLevel, nMaxLevel,lItem,cTreeID )

LOCAL cPedido   := ""
LOCAL cItem     := ""
Local cFilPv    := ""
LOCAL cImageSC6 := ""
LOCAL cImageSC9 := ""
LOCAL cImageSC0 := ""
LOCAL cImageSD2 := ""
LOCAL lRemito	:=.T. 	// Identifica se existe remito ou nao
LOCAL nX		:=1
Local nVlEntcom := OsVlEntCom()
Local aTree	:={}
LOCAL cQuery    := ""
LOCAL cAliasQry := ""

DEFAULT nMaxLevel := 1000000
DEFAULT cTreeID   := "000001"

SC6->( DbSetOrder( 1 ) )
If SC6->( DbSeek( xFilial( "SC6" ) + cNumPed ) )
	
	cPedido   := Left( cNumPed, Len( SD2->D2_PEDIDO ) )
	cItem     := Right( cNumPed, Len( SD2->D2_ITEMPV ) )
	cImageSC6 := MaEntImage( "SC6", 1 )
	
	nLevel++
	
	If nLevel <= nMaxLevel
		
		cAddString := If( ValType( cAddString ) == "C", cAddString, "" )
		
		oTree:AddItem( Pad( STR0009 + Transform( cNumPed, "@r XXXXXX/XX" ) + ;  //"Pedido/Item - "
		cAddString, 100 ), Pad( "SC6-" + cNumPed, 50 )+cTreeID,cImageSC6,cImageSC6,,,nLevel)
		
		If cPaisLoc =="BRA"
			//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
			//Ё Alimenta os itens de notas fiscais deste pedido / item       Ё
			//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
			
			
			cAliasQry := "MTRKSC6SD2"
			
			cQuery := ""
			
			cQuery += "SELECT D2_COD, D2_DOC, D2_SERIE, D2_CLIENTE, D2_LOJA, D2_ITEM "
			cQuery += "FROM " + RetSqlName( "SD2" ) + " "
			cQuery += "WHERE "
			cQuery += "D2_FILIAL='" + xFilial( "SD2" ) + "' AND "
			cQuery += "D2_PEDIDO='" + cPedido          + "' AND "
			cQuery += "D2_ITEMPV='" + cItem            + "' AND "
			cQuery += "D_E_L_E_T_=' ' "
			cQuery += "ORDER BY D2_DOC, D2_SERIE, D2_ITEM"
			
			cQuery := ChangeQuery( cQuery )
			
			dbUseArea( .T., "TOPCONN", TcGenQry( , , cQuery ), cAliasQry, .F., .T. )
			
			oTree:TreeSeek( Pad( "SC6-" + cNumPed, 50 )+cTreeID )
			
			cImageSD2 := MaEntImage( "SD2", 1 )
			
			While !( cAliasQry )->( Eof() )
				
				MATRKSD2( ( cAliasQry )->D2_DOC + ( cAliasQry )->D2_SERIE + ( cAliasQry )->D2_CLIENTE + ( cAliasQry )->D2_LOJA + ( cAliasQry )->D2_COD + ( cAliasQry )->D2_ITEM, @oTree, , @nLevel, nMaxLevel,,cTreeID )
				oTree:TreeSeek( Pad( "SC6-" + cNumPed, 50 )+cTreeID )
				
				( cAliasQry )->( dbSkip() )
			End
			
			//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
			//Ё Exclui a area de trabalho da query                           Ё
			//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
			dbSelectArea( cAliasQry )
			dbCloseArea()
			
			dbSelectArea( "SD2" )
				
		EndIf

		nLevel++
		If nLevel <= nMaxLevel
			
			//здддддддддддддддддддддддддддддддддддддддддддддд©
			//Ё Alimenta as cargas deste pedido / item       Ё
			//юдддддддддддддддддддддддддддддддддддддддддддддды
			
			cAliasQry := "MTRKSC9DAI"
			
			cQuery := ""
			cQuery += "SELECT C9_FILIAL,C9_CARGA, C9_SEQCAR, C9_SEQENT, C9_PEDIDO "
			cQuery += "FROM " + RetSqlName( "SC9" ) + " "
			cQuery += "WHERE "
			cQuery += "C9_FILIAL='" + xFilial( "SC9" ) + "' AND "
			cQuery += "C9_PEDIDO='" + cPedido          + "' AND "
			cQuery += "C9_ITEM='"   + cItem            + "' AND "
			cQuery += "C9_PRODUTO='"+ SC6->C6_PRODUTO  + "' AND "
			cQuery += "C9_CARGA<>'' AND "
			cQuery += "C9_SEQCAR<>'' AND "
			cQuery += "C9_SEQENT<>'' AND "
			cQuery += "D_E_L_E_T_=' ' "
			cQuery += "ORDER BY C9_SEQUEN"
			
			cQuery := ChangeQuery( cQuery )
			
			dbUseArea( .T., "TOPCONN", TcGenQry( , , cQuery ), cAliasQry, .F., .T. )
			
			oTree:TreeSeek( Pad( "SC6-" + cNumPed, 50 )+cTreeID )
			
			cImageSC9 := MaEntImage( "DAI", 1 )
			
			While  !( cAliasQry )->( Eof() )
	
				oTree:TreeSeek( Pad( "SC6-" + cNumPed, 50 )+cTreeID )
				cFilPv := IIf(nVlEntCom==1,"",(cAliasQry)->C9_FILIAL)
				MATRKDAI( (cAliasQry)->C9_CARGA + (cAliasQry)->C9_SEQCAR + (cAliasQry)->C9_SEQENT + (cAliasQry)->C9_PEDIDO + cFilPv, @oTree, , @nLevel, nMaxLevel, NIL, NIL, @aTree,cTreeID )
				( cAliasQry )->( dbSkip() )
			End
			
			//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
			//Ё Exclui a area de trabalho da query                           Ё
			//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
			dbSelectArea( cAliasQry )
			dbCloseArea()
			
			dbSelectArea( "SC9" )
				
		EndIf
		
		nLevel--
		
		nLevel++
		If nLevel <= nMaxLevel
			
			//здддддддддддддддддддддддддддддддддддддддддддддддддд©
			//Ё Alimenta as liberacoes deste pedido / item       Ё
			//юдддддддддддддддддддддддддддддддддддддддддддддддддды
			
			cAliasQry := "MTRKSC6SC9"
			
			cQuery := ""
			If cPaisLoc<>"BRA"
				cQuery += "SELECT C9_PEDIDO, C9_ITEM, C9_SEQUEN, C9_REMITO, C9_SERIREM, C9_CLIENTE, C9_LOJA,C9_PRODUTO, C9_ITEMREM "
			Else
				cQuery += "SELECT C9_PEDIDO, C9_ITEM, C9_SEQUEN "
			EndIf
			cQuery += "FROM " + RetSqlName( "SC9" ) + " "
			cQuery += "WHERE "
			cQuery += "C9_FILIAL='" + xFilial( "SC9" ) + "' AND "
			cQuery += "C9_PEDIDO='" + cPedido          + "' AND "
			cQuery += "C9_ITEM='"   + cItem            + "' AND "
			cQuery += "C9_PRODUTO='"+ SC6->C6_PRODUTO  + "' AND "
			
			cQuery += "D_E_L_E_T_=' ' "
			cQuery += "ORDER BY C9_SEQUEN"
			
			cQuery := ChangeQuery( cQuery )
			
			dbUseArea( .T., "TOPCONN", TcGenQry( , , cQuery ), cAliasQry, .F., .T. )
			
			oTree:TreeSeek( Pad( "SC6-" + cNumPed, 50 )+cTreeID )
			
			cImageSC9 := MaEntImage( "SC9", 1 )
			
			While  !( cAliasQry )->( Eof() )
				
				oTree:TreeSeek( Pad( "SC6-" + cNumPed, 50 )+cTreeID )
				If cPaisLoc<>"BRA"
					MATRKSC9(( cAliasQry )->C9_PEDIDO +( cAliasQry )->C9_ITEM + ( cAliasQry )->C9_SEQUEN+( cAliasQry )->C9_REMITO+( cAliasQry )->C9_SERIREM+( cAliasQry )->C9_CLIENTE+( cAliasQry )->C9_LOJA+( cAliasQry )->C9_PRODUTO+( cAliasQry )->C9_ITEMREM , @oTree, , @nLevel, nMaxLevel,@lRemito,cNumPed ,@aTree)
				Else
					MATRKSC9( ( cAliasQry )->C9_PEDIDO +( cAliasQry )->C9_ITEM + ( cAliasQry )->C9_SEQUEN, @oTree, , @nLevel, nMaxLevel, NIL, NIL, @aTree,cTreeID )
				EndIf
				
				( cAliasQry )->( dbSkip() )
			End
			
			//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
			//Ё Exclui a area de trabalho da query                           Ё
			//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
			dbSelectArea( cAliasQry )
			dbCloseArea()
			
			dbSelectArea( "SC9" )
				
			//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
			//Ё A arvore do SC9 foi criada no final pois da problema em      Ё
			//Ё localizacoes por causa do remito / item da fatura            Ё
			//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
			
			If Len(aTree) >0
				cAddString := If( ValType( cAddString ) == "C", cAddString, "" )
				cImageSC9 := MaEntImage( "SC9", 1 )
				For nX := 1 To Len(aTree)
					oTree:TreeSeek( Pad( "SC6-" + cNumPed, 50 )+cTreeID )
					IF !(oTree:TreeSeek( Pad( "SC9-" + aTree[nX][1]  + aTree[nX][2] + aTree[nX][3], 50 )+cTreeID )  )
						oTree:AddItem( Pad( STR0019 + aTree[nX][3] + ;  //"Liberacao / Sequencia - "
						cAddString, 100 ), Pad( "SC9-" + aTree[nX][1] + aTree[nX][2] + ;
						aTree[nX][3],50 )+cTreeID,cImageSC9,cImageSC9,,,nLevel)
					EndIf
				Next nX
			EndIf
		EndIf
		
		nLevel--
		
		nLevel++
		
		If nLevel <= nMaxLevel
			
			//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
			//Ё Alimenta os itens de reserva deste pedido / item             Ё
			//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
			If !Empty( SC6->C6_RESERVA )
				SC0->( DbSetOrder( 1 ) )
				If SC0->( dbSeek( xFilial( "SC0" ) + SC6->C6_RESERVA ) )
					
					cImageSC0 := MaEntImage( "SC0", 1 )
					oTree:TreeSeek( Pad( "SC6-" + cNumPed, 50 )+cTreeID )
					
					oTree:AddItem( Pad( STR0020 + SC0->C0_NUM + ;  //"Reserva - "
					cAddString, 100 ), Pad( "SC0-" + SC0->C0_NUM, 50 )+cTreeID, cImageSC0,cImageSC0,,,nLevel)
				EndIf
			EndIf
		EndIf
		
		nLevel--
		
		nLevel++
		
		If nLevel <= nMaxLevel
			//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
			//Ё Informacao referente a ordem de producao                     Ё
			//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
			If !Empty( SC6->C6_NUMOP+SC6->C6_ITEMOP )
				oTree:TreeSeek( Pad( "SC6-" + cNumPed, 50 )+cTreeID )
				MATRKSC2(  SC6->C6_NUMOP+SC6->C6_ITEMOP+"001"+Criavar("C2_ITEMGRD",.F.), @oTree, , @nLevel, nMaxLevel,,cTreeID )
			EndIf
		EndIf
	
		nLevel--

	EndIf
	
	nLevel--
	
EndIf

/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFuncao    Ё MATRKSC5 Ё Autor Ё Sergio Silveira       Ё Data Ё28/11/2001Ё╠╠
╠╠цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o Ё Monta as pastas de pedidos                                 Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁSintaxe   Ё MATRKSC5( ExpC1, @ExpO1, [ ExpC2 ], @ExpN1, ExpN2, ExpL1)  Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁRetorno   Ё Nenhum                                                     Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁParametrosЁ ExpC1 -> Chave de pesquisa                                 Ё╠╠
╠╠Ё          Ё ExpO1 -> Objeto Tree                                       Ё╠╠
╠╠Ё          Ё ExpC2 -> String a adicionar ao texto do item ( tree )      Ё╠╠
╠╠Ё          Ё ExpN1 -> Nivel                                             Ё╠╠
╠╠Ё          Ё ExpN2 -> Nivel maximo                                      Ё╠╠
╠╠Ё          Ё ExpL1 -> Indica se deve expandir os itens ou cabecalhos    Ё╠╠
╠╠цддддддддддедддддддддддддддбдддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё   DATA   Ё Programador   ЁManutencao Efetuada                         Ё╠╠
╠╠цддддддддддедддддддддддддддедддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё          Ё               Ё                                            Ё╠╠
╠╠юддддддддддадддддддддддддддадддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/

Function MATRKSC5( cNumPed, oTree, cAddString, nLevel, nMaxLevel, lItem, cTreeID )

LOCAL cImageSC5 := ""
LOCAL cQuery    := ""
LOCAL cAliasQry := ""
Local cRemIni   := ""
Local cRemFim   := ""     
Local cAliasRem := ""

DEFAULT nMaxLevel := 1000000
DEFAULT lItem     := .T.
DEFAULT cTreeID   := "000001"                      

SC5->( DbSetOrder( 1 ) )
If SC5->( DbSeek( xFilial( "SC6" ) + cNumPed ) )
	
	nLevel++
	
	If nLevel <= nMaxLevel
		
		cAddString := If( ValType( cAddString ) == "C", cAddString, "" )
		
		cImageSC5 := MaEntImage( "SC5", 1 )
		
		oTree:AddItem( Pad( STR0034 + Transform( cNumPed, "@r XXXXXX" ) + ;   //"Pedido de Venda - "
		cAddString, 100 ), Pad( "SC5-" + cNumPed, 50 )+cTreeID,cImageSC5,cImageSC5,,,nLevel)
		
		oTree:TreeSeek( Pad( "SC5-" + cNumPed, 50 )+cTreeID )
		
		If lItem
			
			//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
			//Ё Alimenta os itens deste pedido                               Ё
			//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
			
			cAliasQry := GetNextAlias()
			
			cQuery := ""
			
			cQuery += "SELECT C6_NUM, C6_ITEM "
			cQuery += "FROM " + RetSqlName( "SC6" ) + " "
			cQuery += "WHERE "
			cQuery += "C6_FILIAL='" + xFilial( "SC6" ) + "' AND "
			cQuery += "C6_NUM='"    + cNumPed          + "' AND "
			cQuery += "D_E_L_E_T_=' ' "
			cQuery += "ORDER BY C6_NUM, C6_ITEM"
			
			cQuery := ChangeQuery( cQuery )
			
			dbUseArea( .T., "TOPCONN", TcGenQry( , , cQuery ), cAliasQry, .F., .T. )
			
			oTree:TreeSeek( Pad( "SC5-" + cNumPed, 50 )+cTreeID )
			
			While !( cAliasQry )->( Eof() )
				MATRKSC6( ( cAliasQry )->C6_NUM + ( cAliasQry )->C6_ITEM, @oTree, , @nLevel, nMaxLevel,,cTreeID )
				( cAliasQry )->( dbSkip() )
			End
			
			//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
			//Ё Exclui a area de trabalho da query                           Ё
			//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
			dbSelectArea( cAliasQry )
			dbCloseArea()
			
			dbSelectArea( "SC6" )
				
		Else
			
			cAliasQry := GetNextAlias()
			
			cQuery := ""
			If cPaisLoc<>"BRA"
				cQuery += "SELECT D2_CLIENTE, D2_LOJA, D2_DOC, D2_TIPODOC, D2_SERIE, D2_REMITO, D2_SERIREM "
				cQuery += "FROM " + RetSqlName( "SD2" ) + " "
				cQuery += "WHERE "
				cQuery += "D2_FILIAL='" + xFilial( "SD2" ) + "' AND "
				cQuery += "D2_PEDIDO='" + cNumPed          + "' AND "
				cQuery += "D_E_L_E_T_=' ' "
				
				cQuery += "GROUP BY D2_CLIENTE, D2_LOJA, D2_DOC, D2_TIPODOC, D2_SERIE,D2_REMITO, D2_SERIREM "
				cQuery += "ORDER BY D2_CLIENTE, D2_LOJA, D2_TIPODOC DESC, D2_DOC,  D2_SERIE "
				
				cQuery := ChangeQuery( cQuery )					
				
				dbUseArea( .T., "TOPCONN", TcGenQry( , , cQuery ), cAliasQry, .F., .T. )
				
				// Busca Range de Remitos do Pedido, para encontrar as respectivas facturas em cAliasQry1
				cAliasRem := GetNextAlias()
				cQuery    := ""
				cQuery += "SELECT MIN(D2_DOC) REMINI, MAX(D2_DOC) REMMAX "
				cQuery += "FROM " + RetSqlName( "SD2" ) + " "
				cQuery += "WHERE "
				cQuery += "D2_FILIAL='" + xFilial( "SD2" ) + "' AND "
				cQuery += "D2_PEDIDO='" + cNumPed          + "' AND "
				cQuery += "D_E_L_E_T_=' ' "
				
				dbUseArea( .T., "TOPCONN", TcGenQry( , , cQuery ), cAliasRem, .F., .T. )
				cRemIni := REMINI
				cRemFim := REMMAX   
				dbSelectArea( cAliasRem )
				dbCloseArea()
				
				
				cAliasQry1 := GetNextAlias()
				cQuery := ""
				cQuery += "SELECT D2_CLIENTE, D2_LOJA, D2_DOC, D2_TIPODOC, D2_SERIE, D2_REMITO, D2_SERIREM "
				cQuery += "FROM " + RetSqlName( "SD2" ) + " "
				cQuery += "WHERE "
				cQuery += "D2_CLIENTE='" +( cAliasQry )->(D2_CLIENTE)   + "' AND " 
				cQuery += "D2_LOJA='" +( cAliasQry )->(D2_LOJA)   + "' AND " 
				cQuery += "D2_REMITO<>' '" + " AND "
				cQuery += "D2_REMITO>='" + cRemIni   + "' AND "
				cQuery += "D2_REMITO<='" + cRemFim   + "' AND "
				cQuery += "D2_SERIREM='" +( cAliasQry )->(D2_SERIE)   + "' AND "
				cQuery += "D2_TIPODOC<>'" + ( cAliasQry )->(D2_TIPODOC)    + "' AND "
				cQuery += "D_E_L_E_T_=' ' "
				
				cQuery += "GROUP BY D2_CLIENTE, D2_LOJA, D2_DOC, D2_TIPODOC, D2_SERIE,D2_REMITO, D2_SERIREM "
				cQuery += "ORDER BY D2_CLIENTE, D2_LOJA, D2_TIPODOC DESC, D2_DOC,  D2_SERIE "
				
				cQuery := ChangeQuery( cQuery )					
				
				dbUseArea( .T., "TOPCONN", TcGenQry( , , cQuery ), cAliasQry1, .F., .T. )
			Else
				cQuery += "SELECT D2_CLIENTE, D2_LOJA, D2_DOC, D2_SERIE "
				cQuery += "FROM " + RetSqlName( "SD2" ) + " "
				cQuery += "WHERE "
				cQuery += "D2_FILIAL='" + xFilial( "SD2" ) + "' AND "
				cQuery += "D2_PEDIDO='" + cNumPed          + "' AND "
				cQuery += "D_E_L_E_T_=' ' "
				
				cQuery += "GROUP BY D2_CLIENTE, D2_LOJA, D2_DOC, D2_SERIE "
				cQuery += "ORDER BY D2_CLIENTE, D2_LOJA, D2_DOC, D2_SERIE "
				
				cQuery := ChangeQuery( cQuery )					
				
				dbUseArea( .T., "TOPCONN", TcGenQry( , , cQuery ), cAliasQry, .F., .T. )
			EndIf
			
			oTree:TreeSeek( Pad( "SC5-" + cNumPed, 50 )+cTreeID )
			
			While !( cAliasQry )->( Eof() )
				MATRKSF2( ( cAliasQry )->D2_DOC + ( cAliasQry )->D2_SERIE + ;
				( cAliasQry )->D2_CLIENTE + ( cAliasQry )->D2_LOJA, @oTree, , @nLevel, nMaxLevel, .F. )
				oTree:TreeSeek( Pad( "SC5-" + cNumPed, 50 )+cTreeID ) 	    // para colocar as notas debaixo do pedido e nao debaixo da NF
				( cAliasQry )->( dbSkip() )
			End
			
			If cPaisLoc<>"BRA"
				While !( cAliasQry1 )->( Eof() )
					MATRKSF2( ( cAliasQry1 )->D2_DOC + ( cAliasQry1 )->D2_SERIE + ;
					( cAliasQry1 )->D2_CLIENTE + ( cAliasQry1 )->D2_LOJA, @oTree, , @nLevel, nMaxLevel, .F. )
					oTree:TreeSeek( Pad( "SC5-" + cNumPed, 50 )+cTreeID ) 	    // para colocar as notas debaixo do pedido e nao debaixo da NF
					( cAliasQry1 )->( dbSkip() )
				End
			EndIF
			
			//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
			//Ё Exclui a area de trabalho da query                           Ё
			//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
			dbSelectArea( cAliasQry )
			dbCloseArea()
			
			dbSelectArea( "SC5" )
				
		EndIf
		
	EndIf
	
EndIf

Return( .T. )


/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFuncao    Ё MATRKSF2 Ё Autor Ё Sergio Silveira       Ё Data Ё28/11/2001Ё╠╠
╠╠цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o Ё Monta as pastas da nota fiscal de saida ( cabecalho )      Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁSintaxe   Ё MATRKSF2( ExpC1, @ExpO1, [ ExpC2 ], @ExpN1, ExpN2, ExpL1)  Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁRetorno   Ё Nenhum                                                     Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁParametrosЁ ExpC1 -> Chave de pesquisa                                 Ё╠╠
╠╠Ё          Ё ExpO1 -> Objeto Tree                                       Ё╠╠
╠╠Ё          Ё ExpC2 -> String a adicionar ao texto do item ( tree )      Ё╠╠
╠╠Ё          Ё ExpN1 -> Nivel                                             Ё╠╠
╠╠Ё          Ё ExpN2 -> Nivel maximo                                      Ё╠╠
╠╠Ё          Ё ExpL1 -> Indica se deve expandir os itens ou cabecalhos    Ё╠╠
╠╠цддддддддддедддддддддддддддбдддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё   DATA   Ё Programador   ЁManutencao Efetuada                         Ё╠╠
╠╠цддддддддддедддддддддддддддедддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё          Ё               Ё                                            Ё╠╠
╠╠юддддддддддадддддддддддддддадддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/

Function MATRKSF2( cChaveNF, oTree, cAddString, nLevel, nMaxLevel, lItem, cTreeID)

LOCAL cCliente  := ""
LOCAL cLoja     := ""
LOCAL cDoc      := ""
LOCAL cSerie    := ""
LOCAL cPrefixo  := ""
LOCAL cImageSE1 := ""
LOCAL cImageSF2 := ""   
LOCAL cTitulos  := ""
LOCAL cQuery    := ""
LOCAL cAliasQry := ""

DEFAULT nMaxLevel := 1000000
DEFAULT lItem     := .T.
DEFAULT cTreeID   := "000001"

SF2->( DbSetOrder( 1 ) )
If SF2->( DbSeek( xFilial( "SF2" ) + cChaveNF ) )
	
	//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//Ё Separa os componentes da query                               Ё
	//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
	cDoc     := Left( cChaveNF,  Len( SF2->F2_DOC ) )
	cSerie   := SubStr( cChaveNF, Len( cDoc ) + 1, Len( SF2->F2_SERIE ) )
	cCliente := SubStr( cChaveNF, Len( cDoc ) + Len( cSerie ) + 1, Len( SF2->F2_CLIENTE ) )
	cLoja    := SubStr( cChaveNF, Len( cDoc ) + Len( cSerie ) + Len( cCliente ) + 1, Len( SF2->F2_LOJA ) )
	cPrefixo := If(Empty(SF2->F2_PREFIXO),&(SuperGetMv("MV_1DUPREF")),SF2->F2_PREFIXO)
	
	nLevel++
	
	If nLevel <= nMaxLevel
		
		cAddString := If( ValType( cAddString ) == "C", cAddString, "" )
		
		cImageSF2 := MaEntImage( "SF2", 1 )
		
		If cPaisLoc <> "BRA"  .And. ISRemito(1,"SF2->F2_TIPODOC")
			oTree:AddItem( Pad( GetDescRem()+STR0047 + cDoc + "/" + cSerie + ;   //"Remito de saida / Serie - "
			cAddString, 100 ), Pad( "SF2-" + cChaveNF, 50 )+cTreeID, cImageSF2, cImageSF2,,,nLevel)
		Else
			oTree:AddItem( Pad( STR0035 + cDoc + "/" + cSerie + ;   //"Nota fiscal de saida / Serie - "
			cAddString, 100 ), Pad( "SF2-" + cChaveNF, 50 )+cTreeID, cImageSF2, cImageSF2,,,nLevel)
		EndIf
		
		If lItem
			
			//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
			//Ё Alimenta os itens deste pedido                               Ё
			//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
			
			cAliasQry := GetNextAlias()
			
			cQuery := ""
			
			cQuery += "SELECT D2_ITEM "
			cQuery += "FROM " + RetSqlName( "SD2" ) + " "
			cQuery += "WHERE "
			cQuery += "D2_FILIAL='" + xFilial( "SD2" ) + "' AND "
			
			cQuery := ChangeQuery( cQuery )
			
			dbUseArea( .T., "TOPCONN", TcGenQry( , , cQuery ), cAliasQry, .F., .T. )
			
			oTree:TreeSeek( Pad( "SC5-" + cChaveNF, 50 )+cTreeID )
			
			cImageSD2 := MaEntImage( "SD2", 1 )
			
			While !( cAliasQry )->( Eof() )
				
				If cPaisLoc <> "BRA"  .And. ISRemito(1,"SF2->F2_TIPODOC")
					//"Remito/Serie/Item - "
					oTree:AddItem( Pad( GetDescRem() + ( cAliasQry )->D2_DOC + "/" + ( cAliasQry )->D2_SERIE + "/" + ( cAliasQry )->D2_ITEM + ;
					cAddString, 100 ), Pad( "SD2-" + ( cAliasQry )->D2_DOC + ( cAliasQry )->D2_SERIE + ( cAliasQry )->D2_CLIENTE + ;
					( cAliasQry )->D2_LOJA + ( cAliasQry )->D2_ITEM, 50 ) + cTreeID,cImageSD2,cImageSD2,,,nLevel)
				Else
					//"N.F./Serie/Item - "
					oTree:AddItem( Pad( STR0018 +( cAliasQry )->D2_DOC + "/" + ( cAliasQry )->D2_SERIE + "/" + ( cAliasQry )->D2_ITEM + ;
					cAddString, 100 ), Pad( "SD2-" + ( cAliasQry )->D2_DOC + ( cAliasQry )->D2_SERIE + ( cAliasQry )->D2_CLIENTE + ;
					( cAliasQry )->D2_LOJA + ( cAliasQry )->D2_ITEM, 50 )+cTreeID,cImageSD2,cImageSD2,,,nLevel)
				EndIf
				
				( cAliasQry )->( dbSkip() )
			End
			
			//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
			//Ё Exclui a area de trabalho da query                           Ё
			//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
			dbSelectArea( cAliasQry )
			dbCloseArea()
			
			dbSelectArea( "SC6" )
				
		Else
			
			//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
			//Ё Alimenta os titulos desta NF                                 Ё
			//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
			
			nLevel++
			
			If nLevel <= nMaxLevel
				
				cAliasQry := GetNextAlias()
				
				cQuery := ""
				
				cQuery += "SELECT E1_PREFIXO,E1_NUM,E1_PARCELA,E1_CLIENTE,E1_LOJA,E1_TIPO "
				cQuery += "FROM " + RetSqlName( "SE1" ) + " "
				cQuery += "WHERE "
				cQuery += "E1_FILIAL='" + xFilial( "SE1" ) + "' AND "
				cQuery += "E1_NUM='"    + cDoc             + "' AND "
				cQuery += "E1_PREFIXO='"+ cPrefixo         + "' AND "
				cQuery += "E1_CLIENTE='"+ cCliente         + "' AND "
				cQuery += "E1_LOJA='"   + cLoja            + "' AND "
				cQuery += "D_E_L_E_T_=' ' "
				
				cQuery := ChangeQuery( cQuery )					
				
				dbUseArea( .T., "TOPCONN", TcGenQry( , , cQuery ), cAliasQry, .F., .T. )
				
				oTree:TreeSeek( Pad( "SF2-" + cChaveNF, 50 )+cTreeID )
				
				cImageSE1 := MaEntImage( "SE1", 1 )
				
				While !( cAliasQry )->( Eof() )
					
					dbSelectArea( cAliasQry )
					cKey := Pad( "SE1-" + E1_PREFIXO + E1_NUM + E1_PARCELA + E1_CLIENTE + E1_LOJA + E1_TIPO, 50 )+cTreeID						
					cTitulos:=E1_PREFIXO + E1_NUM + E1_PARCELA + E1_CLIENTE + E1_LOJA + E1_TIPO
					If aScan(aTitulos,{|x| x[1] == cTitulos })==0
						oTree:AddItem( Pad( STR0036 +; //"Titulo - Cliente/Loja/Prefixo/Numero/Parcela/Tipo - "
						E1_CLIENTE + "/" + E1_LOJA + "/" + E1_PREFIXO + "/" + E1_NUM + "/" + E1_PARCELA + "/" + E1_TIPO, 100 ),;
						Pad( "SE1-" + E1_CLIENTE + E1_LOJA + E1_PREFIXO + E1_NUM + E1_PARCELA + E1_TIPO, 50 )+cTreeID, cImageSE1 ,cImageSE1,,,nLevel)
			
					   	AAdd(aTitulos,{cTitulos})
					EndIf	
					
					(cAliasQry )->( dbSkip() )
					
				End
				
				//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
				//Ё Exclui a area de trabalho da query                           Ё
				//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
				dbSelectArea( cAliasQry )
				dbCloseArea()
				
				dbSelectArea( "SE1" )
				
			EndIf
			nLevel--
			
		EndIf
		
	EndIf
	nLevel--
EndIf

/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFuncao    Ё MATRKSCK Ё Autor Ё Sergio Silveira       Ё Data Ё27/09/2000Ё╠╠
╠╠цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o Ё Monta as pastas dos itens de orcamento                     Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁSintaxe   Ё MATRKSCK( ExpC1, @ExpO1, [ ExpC2 ], @ExpN1, [ ExpN2 ] )    Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁRetorno   Ё Nenhum                                                     Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁParametrosЁ ExpC1 -> Chave de pesquisa                                 Ё╠╠
╠╠Ё          Ё ExpO1 -> Objeto Tree                                       Ё╠╠
╠╠Ё          Ё ExpC2 -> String a adicionar ao texto do item ( tree )      Ё╠╠
╠╠Ё          Ё ExpN1 -> Nivel                                             Ё╠╠
╠╠Ё          Ё ExpN2 -> Nivel maximo                                      Ё╠╠
╠╠цддддддддддедддддддддддддддбдддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё   DATA   Ё Programador   ЁManutencao Efetuada                         Ё╠╠
╠╠цддддддддддедддддддддддддддедддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё          Ё               Ё                                            Ё╠╠
╠╠юддддддддддадддддддддддддддадддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/

Function MATRKSCK( cNumOrc, oTree, cAddString, nLevel, nMaxLevel, lItem, cTreeID )

Local cQuery    := ""
Local cAliasQry := ""

DEFAULT nMaxLevel := 1000000 
DEFAULT cTreeID   := "000001"

cAddString := If( ValType( cAddString ) == "C", cAddString, "" )

SCK->( DbSetOrder( 1 ) )
If SCK->( DbSeek( xFilial( "SCK" ) + cNumOrc ) )
	
	nLevel++
	
	If nLevel <= nMaxLevel
		
		cImageSCK := MaEntImage( "SCK", 1 )
		
		oTree:AddItem( Pad( STR0015 + Transform( cNumOrc, "@R XXXXXX/XX" ) + cAddString, 100 ),;  //"Orcamento/Item - "
		Pad( "SCK-" + cNumOrc, 50 )+cTreeID, cImageSCK,cImageSCK,,,nLevel)
		oTree:TreeSeek( Pad( "SCK-" + cNumOrc, 50 )+cTreeID )
		
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Analisa destino                                              Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		Do Case
			Case !Empty( SCK->CK_NUMPV )
				
				cAliasQry := GetNextAlias()
				
				cQuery := ""
				
				cQuery += "SELECT C6_NUM, C6_ITEM FROM " + RetSqlName( "SC6" ) + " "
				cQuery += "WHERE "
				cQuery += "C6_FILIAL='"  + xFilial( "SC6" ) + "' AND "
				cQuery += "C6_PRODUTO='" + SCK->CK_PRODUTO  + "' AND "
				cQuery += "C6_NUM='"     + SCK->CK_NUMPV    + "' AND "
				cQuery += "C6_NUMORC='"  + SCK->CK_NUM + SCK->CK_ITEM + "' AND "
				cQuery += "D_E_L_E_T_=' '"
				
				cQuery := ChangeQuery( cQuery )
				
				dbUseArea( .T., "TOPCONN", TcGenQry( ,,cQuery ), cAliasQry, .F., .T. )
				
				While !( cAliasQry )->( Eof() )
					MATRKSC6( ( cAliasQry )->C6_NUM + ( cAliasQry )->C6_ITEM, @oTree, , @nLevel, nMaxLevel,, cTreeID )
					( cAliasQry )->( dbSkip() )
				End
					
		EndCase
		
	EndIf
	
	nLevel--
	
EndIf

Return( .T. )

/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFuncao    Ё MATRKSCJ Ё Autor Ё Sergio Silveira       Ё Data Ё28/11/2001Ё╠╠
╠╠цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o Ё Monta as pastas de orcamentos                              Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁSintaxe   Ё MATRKSCJ( ExpC1, @ExpO1, [ ExpC2 ], @ExpN1, ExpN2, ExpL1)  Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁRetorno   Ё Nenhum                                                     Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁParametrosЁ ExpC1 -> Chave de pesquisa                                 Ё╠╠
╠╠Ё          Ё ExpO1 -> Objeto Tree                                       Ё╠╠
╠╠Ё          Ё ExpC2 -> String a adicionar ao texto do item ( tree )      Ё╠╠
╠╠Ё          Ё ExpN1 -> Nivel                                             Ё╠╠
╠╠Ё          Ё ExpN2 -> Nivel maximo                                      Ё╠╠
╠╠Ё          Ё ExpL1 -> Indica se deve expandir os itens ou cabecalhos    Ё╠╠
╠╠цддддддддддедддддддддддддддбдддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё   DATA   Ё Programador   ЁManutencao Efetuada                         Ё╠╠
╠╠цддддддддддедддддддддддддддедддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё          Ё               Ё                                            Ё╠╠
╠╠юддддддддддадддддддддддддддадддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/

Function MATRKSCJ( cNumOrc, oTree, cAddString, nLevel, nMaxLevel, lItem, cTreeID )

LOCAL cImageSCJ := ""

LOCAL cQuery    := ""
LOCAL cAliasQry := ""
DEFAULT nMaxLevel := 1000000
DEFAULT lItem     := .T.
DEFAULT cTreeID   := "000001"

SCJ->( DbSetOrder( 1 ) )
If SCJ->( DbSeek( xFilial( "SCJ" ) + cNumOrc ) )
	
	nLevel++
	
	If nLevel <= nMaxLevel
		
		cAddString := If( ValType( cAddString ) == "C", cAddString, "" )
		cImageSCJ  := MaEntImage( "SCJ", 1 )
		
		oTree:AddItem( Pad( STR0037 + Transform( cNumOrc, "@r XXXXXX" ) + ;   //"Orcamento de Venda - "
		cAddString, 100 ), Pad( "SCJ-" + cNumOrc, 50 ) + cTreeID,cImageSCJ,cImageSCJ,,,nLevel)
		
		If lItem
			
			//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
			//Ё Alimenta os itens deste orcamento                                Ё
			//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
			
			cAliasQry := GetNextAlias()
			
			cQuery := ""
			
			cQuery += "SELECT CK_NUM, CK_ITEM "
			cQuery += "FROM " + RetSqlName( "SCK" ) + " "
			cQuery += "WHERE "
			cQuery += "CK_FILIAL='" + xFilial( "SCK" ) + "' AND "
			cQuery += "CK_NUM='"    + cNumOrc          + "' AND "
			cQuery += "D_E_L_E_T_=' ' "
			cQuery += "ORDER BY CK_NUM, CK_ITEM"
			
			cQuery := ChangeQuery( cQuery )
			
			dbUseArea( .T., "TOPCONN", TcGenQry( , , cQuery ), cAliasQry, .F., .T. )
			
			oTree:TreeSeek( Pad( "SCJ-" + cNumOrc, 50 ) + cTreeID )
			
			While !( cAliasQry )->( Eof() )
				MATRKSCK( ( cAliasQry )->CK_NUM + ( cAliasQry )->CK_ITEM, @oTree, , @nLevel, nMaxLevel, ,cTreeID )
				( cAliasQry )->( dbSkip() )
			End
			
			//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
			//Ё Exclui a area de trabalho da query                           Ё
			//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
			dbSelectArea( cAliasQry )
			dbCloseArea()
			
			dbSelectArea( "SCK" )
				
		Else
			
			cAliasQry := GetNextAlias()
			
			cQuery := ""
			
			cQuery += "SELECT CK_NUMPV "
			cQuery += "FROM " + RetSqlName( "SCK" ) + " "
			cQuery += "WHERE "
			cQuery += "CK_FILIAL='" + xFilial( "SCK" ) + "' AND "
			cQuery += "CK_NUM='"    + cNumOrc          + "' AND "
			cQuery += "D_E_L_E_T_=' ' "
			cQuery += "GROUP BY CK_NUMPV "     
			
			cQuery := ChangeQuery( cQuery )				
			
			dbUseArea( .T., "TOPCONN", TcGenQry( , , cQuery ), cAliasQry, .F., .T. )
			
			oTree:TreeSeek( Pad( "SCJ-" + cNumOrc, 50 )+cTreeID )
			
			While !( cAliasQry )->( Eof() )
				MATRKSC5( ( cAliasQry )->CK_NUMPV, @oTree, , @nLevel, nMaxLevel, .F.,cTreeID)
				( cAliasQry )->( dbSkip() )
			End
			
			//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
			//Ё Exclui a area de trabalho da query                           Ё
			//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
			dbSelectArea( cAliasQry )
			dbCloseArea()
			
			dbSelectArea( "SCK" )
				
		EndIf
		
	EndIf
	
EndIf


/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFuncao    Ё MATRKAD1 Ё Autor Ё Sergio Silveira       Ё Data Ё27/09/2000Ё╠╠
╠╠цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o Ё Monta as pastas da oportunidade de venda                   Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁSintaxe   Ё MATRKAD1( ExpC1, @ExpO1, [ ExpC2 ], @ExpN1, [ ExpN2 ] )    Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁRetorno   Ё Nenhum                                                     Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁParametrosЁ ExpC1 -> Chave de pesquisa                                 Ё╠╠
╠╠Ё          Ё ExpO1 -> Objeto Tree                                       Ё╠╠
╠╠Ё          Ё ExpC2 -> String a adicionar ao texto do item ( tree )      Ё╠╠
╠╠Ё          Ё ExpN1 -> Nivel                                             Ё╠╠
╠╠Ё          Ё ExpN2 -> Nivel maximo                                      Ё╠╠
╠╠цддддддддддедддддддддддддддбдддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё   DATA   Ё Programador   ЁManutencao Efetuada                         Ё╠╠
╠╠цддддддддддедддддддддддддддедддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё          Ё               Ё                                            Ё╠╠
╠╠юддддддддддадддддддддддддддадддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/

Function MATRKAD1( cNumOpor, oTree, cAddString, nLevel, nMaxLevel, lItem, cTreeID )

LOCAL cImageAD1   := ""
LOCAL cQuery      := ""
LOCAL cAliasQry   := ""

DEFAULT nMaxLevel := 1000000
DEFAULT cTreeID   := "000001"

cAddString := If( ValType( cAddString ) == "C", cAddString, "" )

AD1->( DbSetOrder( 1 ) )
If AD1->( DbSeek( xFilial( "AD1" ) + cNumOpor ) )
	
	nLevel++
	
	If nLevel <= nMaxLevel
		
		cImageAD1 := MaEntImage( "AD1", 1 )
		
		oTree:AddItem( Pad( STR0022 + Transform( cNumOpor, "@R XXXXXX" ) + cAddString, 100 ),;  //"Oportunidade de Venda - "
		Pad( "AD1-" + cNumOpor, 50 )+cTreeID, cImageAD1, cImageAD1,,,nLevel)
		oTree:TreeSeek( Pad( "AD1-" + cNumOpor, 50 )+cTreeID )
		
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Analisa destino                                              Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		Do Case
			Case !Empty( AD1->AD1_NUMORC ) .AND. SuperGetMv( "MV_FATPROP" ) <> "P"
				//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
				//Ё Orcamento de Venda                                           Ё
				//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
				
				cAliasQry := GetNextAlias()
				
				cQuery := ""
				
				cQuery += "SELECT CK_NUM,CK_ITEM FROM " + RetSqlName( "SCK" ) + " "
				cQuery += "WHERE "
				cQuery += "CK_FILIAL='" + xFilial( "SCK" ) + "' AND "
				cQuery += "CK_NUM='"    + AD1->AD1_NUMORC  + "' AND "
				cQuery += "D_E_L_E_T_=' ' "
				cQuery += "ORDER BY CK_ITEM"
				
				cQuery := ChangeQuery( cQuery )
				
				dbUseArea( .T., "TOPCONN", TcGenQry( ,, cQuery ), cAliasQry, .F., .T. )
				
				While !( cAliasQry )->( Eof() )
					MATRKSCK( ( cAliasQry )->CK_NUM + ( cAliasQry )->CK_ITEM, @oTree, , @nLevel, nMaxLevel, , cTreeID )
					( cAliasQry )->( dbSkip() )
				End
				
				//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
				//Ё Exclui a area de trabalho da query                           Ё
				//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
				( cAliasQry )->( dbCloseArea() )
				dbSelectArea( "SCK" )
					
		EndCase

		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Proposta Comercial                                           Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		If SuperGetMv( "MV_FATPROP" ) == "P"
			MATRKADY( AD1->AD1_PROPOS, @oTree, , @nLevel, nMaxLevel, , cTreeID )		
		EndIf
	EndIf
	
	nLevel--
	
EndIf

Return( .T. )


/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFuncao    Ё MATRKAAN Ё Autor Ё Sergio Silveira       Ё Data Ё27/09/2000Ё╠╠
╠╠цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o Ё Monta as pastas dos itens de contrato de parceria          Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁSintaxe   Ё MATRKAAN( ExpC1, @ExpO1, [ ExpC2 ], @ExpN1, [ ExpN2 ] )    Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁRetorno   Ё Nenhum                                                     Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁParametrosЁ ExpC1 -> Chave de pesquisa                                 Ё╠╠
╠╠Ё          Ё ExpO1 -> Objeto Tree                                       Ё╠╠
╠╠Ё          Ё ExpC2 -> String a adicionar ao texto do item ( tree )      Ё╠╠
╠╠Ё          Ё ExpN1 -> Nivel                                             Ё╠╠
╠╠Ё          Ё ExpN2 -> Nivel maximo                                      Ё╠╠
╠╠цддддддддддедддддддддддддддбдддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё   DATA   Ё Programador   ЁManutencao Efetuada                         Ё╠╠
╠╠цддддддддддедддддддддддддддедддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё          Ё               Ё                                            Ё╠╠
╠╠юддддддддддадддддддддддддддадддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/

Function MATRKAAN( cContPar, oTree, cAddString, nLevel, nMaxLevel, lItem, cTreeID )

LOCAL cImageAAN  := ""
LOCAL cQuery     := ""
LOCAL cAliasQry  := ""

DEFAULT nMaxLevel := 1000000
DEFAULT cTreeID   := "000001"

cAddString := If( ValType( cAddString ) == "C", cAddString, "" )

AAN->( DbSetOrder( 1 ) )
If AAN->( DbSeek( xFilial( "AAN" ) + cContPar ) )
	
	nLevel++
	
	If nLevel <= nMaxLevel
		
		cImageAAN := MaEntImage( "AAN", 1 )
		
		oTree:AddItem( Pad( STR0023 + Transform( cContPar, "@R 999999999999999/99" ) + ; //"O.S./Item - " //"Contrato parceria / Item - "
		If( !Empty( cAddString ), " - " + STR0006 + cAddString, "" ),100), Pad( "AAN-" + cContPar, 50 )+cTreeID, cImageAAN, cImageAAN ,,,nLevel)
		
		oTree:TreeSeek( Pad( "AAN-" + cContPar, 50 )+cTreeID )
		
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Se existem itens de pedidos , cria as ocorrencias                      Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Obtem o alias devido a recursividade                                   Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		cAliasQry := GetNextAlias()
		
		cQuery := ""
		cQuery += "SELECT C6_NUM, C6_ITEM FROM "+RetSqlName("SC6")+" SC6 "
		cQuery += "WHERE "
		cQuery += "C6_FILIAL='"  + xFilial( "SC6" ) + "' AND "
		cQuery += "C6_CONTRT='"  + AAN->AAN_CONTRT  + "' AND "
		cQuery += "C6_ITCONTR='" + AAN->AAN_ITEM    + "' AND "
		cQuery += "C6_TPCONTR='1' AND "
		cQuery += "D_E_L_E_T_<>'*' "
		cQuery += "ORDER BY C6_NUM, C6_ITEM"
		
		cQuery := ChangeQuery( cQuery )
		
		dbUseArea( .T., "TOPCONN", TcGenQry( , , cQuery ), cAliasQry, .F., .T. )
		
		While !( cAliasQry )->( Eof() )
			MATRKSC6( ( cAliasQry )->C6_NUM + ( cAliasQry )->C6_ITEM, @oTree, , @nLevel, nMaxLevel,,cTreeID)
			( cAliasQry )->( dbSkip() )
			oTree:TreeSeek( Pad( "AAN-" + cContPar, 50 )+cTreeID )
			
		End
		
		( cAliasQRY )->( dbCloseArea() )
		dbSelectArea( "SC6" )
			
	EndIf
	
	nLevel--
	
EndIf

Return( .T. )

/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFuncao    Ё MATRKAAO Ё Autor Ё Sergio Silveira       Ё Data Ё27/09/2000Ё╠╠
╠╠цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o Ё Monta as pastas dos itens de contrato de WMS               Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁSintaxe   Ё MATRKAAO( ExpC1, @ExpO1, [ ExpC2 ], @ExpN1, [ ExpN2 ] )    Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁRetorno   Ё Nenhum                                                     Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁParametrosЁ ExpC1 -> Chave de pesquisa                                 Ё╠╠
╠╠Ё          Ё ExpO1 -> Objeto Tree                                       Ё╠╠
╠╠Ё          Ё ExpC2 -> String a adicionar ao texto do item ( tree )      Ё╠╠
╠╠Ё          Ё ExpN1 -> Nivel                                             Ё╠╠
╠╠Ё          Ё ExpN2 -> Nivel maximo                                      Ё╠╠
╠╠цддддддддддедддддддддддддддбдддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё   DATA   Ё Programador   ЁManutencao Efetuada                         Ё╠╠
╠╠цддддддддддедддддддддддддддедддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё          Ё               Ё                                            Ё╠╠
╠╠юддддддддддадддддддддддддддадддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/

Function MATRKAAO( cContWMS, oTree, cAddString, nLevel, nMaxLevel, lItem,cTreeID )

LOCAL cImageAAO  := ""
LOCAL cQuery     := ""
LOCAL cAliasQry  := ""

DEFAULT nMaxLevel := 1000000
DEFAULT cTreeID   := "000001"

cAddString := If( ValType( cAddString ) == "C", cAddString, "" )

AAO->( DbSetOrder( 1 ) )
If AAO->( DbSeek( xFilial( "AAO" ) + cContWMS ) )
	
	nLevel++
	
	If nLevel <= nMaxLevel
		
		cImageAAO := MaEntImage( "AAO", 1 )
		
		oTree:AddItem( Pad( STR0024 + Transform( cContWMS, "@R 999999999999999/99" ) + ; //"O.S./Item - " //"Contrato WMS / Item - "
		If( !Empty( cAddString ), " - " + STR0006 + cAddString, "" ),100), Pad( "AAO-" + cContWMS, 50 )+cTreeID, cImageAAO, cImageAAO ,,,nLevel)
		
		oTree:TreeSeek( Pad( "AAO-" + cContWMS, 50 )+cTreeID )
		
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Se existem itens de pedidos , cria as ocorrencias                      Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Obtem o alias devido a recursividade                                   Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		cAliasQry := GetNextAlias()
		
		cQuery := ""
		cQuery += "SELECT C6_NUM, C6_ITEM FROM "+RetSqlName("SC6")+" SC6 "
		cQuery += "WHERE "
		cQuery += "C6_FILIAL='"  + xFilial( "SC6" ) + "' AND "
		cQuery += "C6_CONTRT='"  + AAO->AAO_CONTRT  + "' AND "
		cQuery += "C6_ITCONTR='" + AAO->AAO_ITEM    + "' AND "
		cQuery += "C6_TPCONTR='2' AND "
		cQuery += "D_E_L_E_T_<>'*' "
		cQuery += "ORDER BY C6_NUM, C6_ITEM"
		
		cQuery := ChangeQuery( cQuery )
		
		dbUseArea( .T., "TOPCONN", TcGenQry( , , cQuery ), cAliasQry, .F., .T. )
		
		While !( cAliasQry )->( Eof() )
			MATRKSC6( ( cAliasQry )->C6_NUM + ( cAliasQry )->C6_ITEM, @oTree, , @nLevel, nMaxLevel,,cTreeID)
			( cAliasQry )->( dbSkip() )
			oTree:TreeSeek( Pad( "AAO-" + cContWMS, 50 )+cTreeID )
			
		End
		
		( cAliasQRY )->( dbCloseArea() )
		dbSelectArea( "SC6" )
			
	EndIf
	
	nLevel--
	
EndIf

Return( .T. )

/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFuncao    Ё MATRKSD2 Ё Autor Ё Sergio Silveira       Ё Data Ё28/11/2001Ё╠╠
╠╠цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o Ё Monta as pastas de itens de NF de saida                    Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁSintaxe   Ё MATRKSD2( ExpC1, @ExpO1, [ ExpC2 ], @ExpN1, [ ExpN2 ] )    Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁRetorno   Ё Nenhum                                                     Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁParametrosЁ ExpC1 -> Chave de pesquisa                                 Ё╠╠
╠╠Ё          Ё ExpO1 -> Objeto Tree                                       Ё╠╠
╠╠Ё          Ё ExpC2 -> String a adicionar ao texto do item ( tree )      Ё╠╠
╠╠Ё          Ё ExpN1 -> Nivel                                             Ё╠╠
╠╠Ё          Ё ExpN2 -> Nivel maximo                                      Ё╠╠
╠╠цддддддддддедддддддддддддддбдддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё   DATA   Ё Programador   ЁManutencao Efetuada                         Ё╠╠
╠╠цддддддддддедддддддддддддддедддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё          Ё               Ё                                            Ё╠╠
╠╠юддддддддддадддддддддддддддадддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/

Function MATRKSD2( cKeyNF, oTree, cAddString, nLevel, nMaxLevel,lItem,cTreeID )

LOCAL cImageSD2 := ""
LOCAL cDoc      := ""
LOCAL cSerie    := ""
LOCAL cItem     := ""
LOCAL cPic      := ""

DEFAULT nMaxLevel := 1000000
DEFAULT cTreeID   := "000001"

nLevel++

If nLevel <= nMaxLevel
	
	SD2->( DbSetOrder( 3 ) )
	If SD2->( DbSeek( xFilial( "SD2" ) + cKeyNF ) )
		
		cPic      := "@R "
		
		cDoc      := Left( cKeyNF, Len( SD2->D2_DOC ) )
		cPic      += Replicate( "X", Len( cDoc ) ) + "/"
		cSerie    := SubStr( cKeyNF, Len( cDoc ) + 1, Len( SD2->D2_SERIE ) )
		cPic      += Replicate( "X", Len( cSerie ) )	 + "/"
		cItem     := Right( cKeyNF, Len( SD2->D2_ITEM ) )
		cPic      += Replicate( "X", Len( cItem ) )
		
		cImageSD2 := MaEntImage( "SD2", 1 )
		
		cAddString := If( ValType( cAddString ) == "C", cAddString, "" )
		
		If cPaisLoc <> "BRA"  .And. ISRemito(1,"SD2->D2_TIPODOC")
			oTree:AddItem( Pad( GetDescRem() + Transform( cDoc + cSerie + ; //"Remito/Serie/Item - "
			cItem, cPic ) + cAddString, 100 ), Pad( "SD2-" + cKeyNF, 50 )+cTreeID,cImageSD2,cImageSD2,,,nLevel)
		Else
			oTree:AddItem( Pad( STR0038 + Transform( cDoc + cSerie + ; //"Nota fiscal/Serie/Item - "
			cItem, cPic ) + cAddString, 100 ), Pad( "SD2-" + cKeyNF, 50 )+cTreeID,cImageSD2,cImageSD2,,,nLevel)
		EndIf
		
	EndIf
	
EndIf

nLevel--

Return(.T.)

/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFuncao    Ё MATRKAB9 Ё Autor Ё Sergio Silveira       Ё Data Ё09/01/2002Ё╠╠
╠╠цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o Ё Monta as pastas de itens de atendimentos da OS             Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁSintaxe   Ё MATRKAB9( ExpC1, @ExpO1, [ ExpC2 ], @ExpN1, [ ExpN2 ] )    Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁRetorno   Ё Nenhum                                                     Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁParametrosЁ ExpC1 -> Chave de pesquisa                                 Ё╠╠
╠╠Ё          Ё ExpO1 -> Objeto Tree                                       Ё╠╠
╠╠Ё          Ё ExpC2 -> String a adicionar ao texto do item ( tree )      Ё╠╠
╠╠Ё          Ё ExpN1 -> Nivel                                             Ё╠╠
╠╠Ё          Ё ExpN2 -> Nivel maximo                                      Ё╠╠
╠╠цддддддддддедддддддддддддддбдддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё   DATA   Ё Programador   ЁManutencao Efetuada                         Ё╠╠
╠╠цддддддддддедддддддддддддддедддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё          Ё               Ё                                            Ё╠╠
╠╠юддддддддддадддддддддддддддадддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/

Function MATRKAB9( cKeyLaudo, oTree, cAddString, nLevel, nMaxLevel,lItem,cTreeID )

LOCAL cImageAB9 := ""
LOCAL cNumOrc   := ""
Local cAliasABC := "ABC"
Local cQuery := ""
Local lQuery    := .F.   

DEFAULT nMaxLevel := 1000000
DEFAULT cTreeID   := "000001"

nLevel++

If nLevel <= nMaxLevel
	
	AB9->( DbSetOrder( 1 ) )
	If AB9->( DbSeek( xFilial( "AB9" ) + cKeyLaudo ) )
		
		cImageAB9 := MaEntImage( "AB9", 1 )
		
		cAddString := If( ValType( cAddString ) == "C", cAddString, "" )
		
		oTree:AddItem( Pad( STR0008 + AB9->AB9_CODTEC + "/" + AB9->AB9_SEQ, 100 ), Pad( "AB9-" + cKeyLaudo, 50 )+cTreeID,cImageAB9,cImageAB9,,,2)  //"Laudo - "
		
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Verifica as FNCs geradas no QNC                              Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
	    nLevel++
		oTree:TreeSeek( Pad( "AB9-" + cKeyLaudo, 50 ))
       	If !Empty(AB9->AB9_CODFNC)
			MATRKQI2( AB9->AB9_CODFNC + AB9->AB9_FNCREV, @oTree, , @nLevel, nMaxLevel,,cTreeID, "TEC")
			oTree:TreeSeek( Pad( "QI2-" + AB9->AB9_CODFNC + AB9->AB9_FNCREV, 50 ))
			oTree:SetFocus()                                   
			oTree:PTCollapse()
		EndIf  
		nLevel--
		
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Cria os orcamentos criados pelos laudos                                Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		cNumOrc := AB9->AB9_NUMORC
		
		If !Empty( cNumOrc )
			AB4->( DbSetOrder( 1 ) )
			If AB4->( DbSeek( xFilial( "AB4" ) + cNumOrc ) )
				oTree:TreeSeek( Pad( "AB9-" + cKeyLaudo, 50 )+cTreeID )
				MATRKAB4( AB4->AB4_NUMORC + AB4->AB4_ITEM, @oTree, cAddString , @nLevel, nMaxLevel,,cTreeID )
				
			EndIf
		EndIf
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Verifica as despesas financeiras                                       Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		dbSelectArea("ABC")
		DbSetOrder(1)

		cAliasABC := "MATRKABC"
		lQuery    := .T.
		cQuery := "SELECT ABC_FILIAL,ABC_NUMOS,ABC_CODTEC,ABC_SEQ,ABC_ITEM "
		cQuery += "FROM "+RetSqlName("ABC")+" ABC "
		cQuery += "WHERE ABC.ABC_FILIAL='"+xFilial("ABC")+"' AND "
		cQuery += "ABC.ABC_NUMOS='"+AB9->AB9_NUMOS+"' AND "
		cQuery += "ABC.ABC_CODTEC='"+AB9->AB9_CODTEC+"' AND "
		cQuery += "ABC.ABC_SEQ='"+AB9->AB9_SEQ+"' AND "
		cQuery += "ABC.D_E_L_E_T_=' ' "
		cQuery += "ORDER BY "+SqlOrder(ABC->(IndexKey()))
		
		cQuery := ChangeQuery(cQuery)
		
		dbUseArea(.T.,"TOPCONN",TcGenQry(,,cQuery),cAliasABC)
			
		While !Eof() .And. xFilial("ABC") == (cAliasABC)->ABC_FILIAL .And.;
			AB9->AB9_NUMOS == (cAliasABC)->ABC_NUMOS .And.;
			AB9->AB9_CODTEC == (cAliasABC)->ABC_CODTEC .And.;
			AB9->AB9_SEQ == (cAliasABC)->ABC_SEQ
			
			oTree:TreeSeek( Pad( "AB9-" + cKeyLaudo, 50 )+cTreeID )
			MATRKABC( (cAliasABC)->ABC_NUMOS + (cAliasABC)->ABC_CODTEC + (cAliasABC)->ABC_SEQ + (cAliasABC)->ABC_ITEM, @oTree, cAddString , @nLevel, nMaxLevel,,cTreeID )
			
			dbSelectArea(cAliasABC)
			dbSkip()
		End
		If lQuery
			dbSelectArea(cAliasABC)
			dbCloseArea()
			dbSelectArea("ABC")
		EndIf
		
	EndIf
	
EndIf

nLevel--

Return()


/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFuncao    Ё MATRKSUB Ё Autor Ё Sergio Silveira       Ё Data Ё18/07/2002Ё╠╠
╠╠цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o Ё Monta as pastas dos itens de orcamento / Telemarketing     Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁSintaxe   Ё MATRKSUB( ExpC1, @ExpO1, [ ExpC2 ], @ExpN1, [ ExpN2 ] )    Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁRetorno   Ё .T.                                                        Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁParametrosЁ ExpC1 -> Chave de pesquisa                                 Ё╠╠
╠╠Ё          Ё ExpO1 -> Objeto Tree                                       Ё╠╠
╠╠Ё          Ё ExpC2 -> String a adicionar ao texto do item ( tree )      Ё╠╠
╠╠Ё          Ё ExpN1 -> Nivel                                             Ё╠╠
╠╠Ё          Ё ExpN2 -> Nivel maximo                                      Ё╠╠
╠╠цддддддддддедддддддддддддддбдддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё   DATA   Ё Programador   ЁManutencao Efetuada                         Ё╠╠
╠╠цддддддддддедддддддддддддддедддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё          Ё               Ё                                            Ё╠╠
╠╠юддддддддддадддддддддддддддадддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/

Function MATRKSUB( cNumOrc, oTree, cAddString, nLevel, nMaxLevel,lItem,cTreeID )

Local aArea     := {}
Local cImageSUB := ""

DEFAULT nMaxLevel := 1000000
DEFAULT cTreeID   := "000001"

cAddString := If( ValType( cAddString ) == "C", cAddString, "" )

SUB->( DbSetOrder( 1 ) )
If SUB->( DbSeek( xFilial( "SUB" ) + cNumOrc ) )
	
	nLevel++
	
	If nLevel <= nMaxLevel
		
		cImageSUB := MaEntImage( "SUB", 1 )
		
		oTree:AddItem( Pad( STR0043 + Transform( cNumOrc, "@R XXXXXX/XX" ) + cAddString, 100 ),;  // "Atendimento televendas / item"
		Pad( "SUB-" + cNumOrc, 50 )+cTreeID, cImageSUB,cImageSUB,,,nLevel)
		oTree:TreeSeek( Pad( "SUB-" + cNumOrc, 50 )+cTreeID )
		
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Analisa destino                                              Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		SC6->( DbSetOrder( 1 ) )
		If SC6->( DbSeek( xFilial( "SC6" ) + SUB->UB_NUMPV + SUB->UB_ITEMPV ) )
			aArea := SC6->( GetArea() )
			MATRKSC6( SC6->C6_NUM + SC6->C6_ITEM, @oTree, , @nLevel, nMaxLevel,,cTreeID )
			SC6->( RestArea( aArea ) )
		EndIf
		
	EndIf
	
	nLevel--
	
EndIf

Return( .T. )


/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFuncao    Ё MATRKSUA Ё Autor Ё Sergio Silveira       Ё Data Ё18/07/2002Ё╠╠
╠╠цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o Ё Monta as pastas de cabecalho de orcamentos - Televendas    Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁSintaxe   Ё MATRKSUA( ExpC1, @ExpO1, [ ExpC2 ], @ExpN1, ExpN2, ExpL1)  Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁRetorno   Ё .T.                                                        Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁParametrosЁ ExpC1 -> Chave de pesquisa                                 Ё╠╠
╠╠Ё          Ё ExpO1 -> Objeto Tree                                       Ё╠╠
╠╠Ё          Ё ExpC2 -> String a adicionar ao texto do item ( tree )      Ё╠╠
╠╠Ё          Ё ExpN1 -> Nivel                                             Ё╠╠
╠╠Ё          Ё ExpN2 -> Nivel maximo                                      Ё╠╠
╠╠Ё          Ё ExpL1 -> Indica se deve expandir os itens ou cabecalhos    Ё╠╠
╠╠цддддддддддедддддддддддддддбдддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё   DATA   Ё Programador   ЁManutencao Efetuada                         Ё╠╠
╠╠цддддддддддедддддддддддддддедддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё          Ё               Ё                                            Ё╠╠
╠╠юддддддддддадддддддддддддддадддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/

Function MATRKSUA( cNumOrc, oTree, cAddString, nLevel, nMaxLevel, lItem,cTreeID)

LOCAL cImageSUA := ""
LOCAL cQuery    := ""
LOCAL cAliasQry := ""

DEFAULT nMaxLevel := 1000000
DEFAULT lItem     := .T.
DEFAULT cTreeID   := "000001"


SUA->( DbSetOrder( 1 ) )
If SUA->( DbSeek( xFilial( "SUA" ) + cNumOrc ) )
	
	nLevel++
	
	If nLevel <= nMaxLevel
		
		cAddString := If( ValType( cAddString ) == "C", cAddString, "" )
		cImageSUA  := MaEntImage( "SUA", 1 )
		
		oTree:AddItem( Pad( STR0044 + Transform( cNumOrc, "@r XXXXXX" ) + ; // "Atendimento televendas - "
		cAddString, 100 ), Pad( "SUA-" + cNumOrc, 50 )+cTreeID,cImageSUA,cImageSUA,,,nLevel)
		
		If lItem
			
			//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
			//Ё Alimenta os itens deste orcamento                            Ё
			//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
			
			cAliasQry := GetNextAlias()
			
			cQuery := ""
			
			cQuery += "SELECT UB_NUM, UB_ITEM "
			cQuery += "FROM " + RetSqlName( "SUB" ) + " "
			cQuery += "WHERE "
			cQuery += "UB_FILIAL='" + xFilial( "SUB" ) + "' AND "
			cQuery += "UB_NUM='"    + cNumOrc          + "' AND "
			cQuery += "D_E_L_E_T_=' ' "
			cQuery += "ORDER BY UB_NUM, UB_ITEM"
			
			cQuery := ChangeQuery( cQuery )
			
			dbUseArea( .T., "TOPCONN", TcGenQry( , , cQuery ), cAliasQry, .F., .T. )
			
			oTree:TreeSeek( Pad( "SUA-" + cNumOrc, 50 )+cTreeID )
			
			While !( cAliasQry )->( Eof() )
				MATRKSUB( ( cAliasQry )->UB_NUM + ( cAliasQry )->UB_ITEM, @oTree, , @nLevel, nMaxLevel,,cTreeID)
				( cAliasQry )->( dbSkip() )
			End
			
			//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
			//Ё Exclui a area de trabalho da query                           Ё
			//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
			dbSelectArea( cAliasQry )
			dbCloseArea()
			
			dbSelectArea( "SUB" )
				
		Else
			
			//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
			//Ё Usa o SUB para localizar o pedidos gerado pelo SUA           Ё
			//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
			
			cAliasQry := GetNextAlias()
			
			cQuery := ""
			
			cQuery += "SELECT UB_NUMPV "
			cQuery += "FROM " + RetSqlName( "SUB" ) + " "
			cQuery += "WHERE "
			cQuery += "UB_FILIAL='" + xFilial( "SUB" ) + "' AND "
			cQuery += "UB_NUM='"    + cNumOrc          + "' AND "
			cQuery += "D_E_L_E_T_=' ' "
			cQuery += "GROUP BY UB_NUMPV "
			
			cQuery := ChangeQuery( cQuery )				
			
			dbUseArea( .T., "TOPCONN", TcGenQry( , , cQuery ), cAliasQry, .F., .T. )
			
			oTree:TreeSeek( Pad( "SUA-" + cNumOrc, 50 )+cTreeID)
			
			While !( cAliasQry )->( Eof() )
				MATRKSC5( ( cAliasQry )->UB_NUMPV, @oTree, , @nLevel, nMaxLevel, .F.,cTreeID )
				( cAliasQry )->( dbSkip() )
			End
			
			//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
			//Ё Exclui a area de trabalho da query                           Ё
			//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
			dbSelectArea( cAliasQry )
			dbCloseArea()
			
			dbSelectArea( "SUB" )
				
		EndIf
		
	EndIf
	
EndIf

Return( .T. )


/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFuncao    Ё MATRKSUC Ё Autor Ё Sergio Silveira       Ё Data Ё19/08/2002Ё╠╠
╠╠цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o Ё Monta as pastas do telemarketing ( cabecalho )             Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁSintaxe   Ё MATRKSUC( ExpC1, @ExpO1, [ ExpC2 ], @ExpN1, ExpN2, ExpL1)  Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁRetorno   Ё Nenhum                                                     Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁParametrosЁ ExpC1 -> Chave de pesquisa                                 Ё╠╠
╠╠Ё          Ё ExpO1 -> Objeto Tree                                       Ё╠╠
╠╠Ё          Ё ExpC2 -> String a adicionar ao texto do item ( tree )      Ё╠╠
╠╠Ё          Ё ExpN1 -> Nivel                                             Ё╠╠
╠╠Ё          Ё ExpN2 -> Nivel maximo                                      Ё╠╠
╠╠Ё          Ё ExpL1 -> Indica se deve expandir os itens ou cabecalhos    Ё╠╠
╠╠цддддддддддедддддддддддддддбдддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё   DATA   Ё Programador   ЁManutencao Efetuada                         Ё╠╠
╠╠цддддддддддедддддддддддддддедддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё          Ё               Ё                                            Ё╠╠
╠╠юддддддддддадддддддддддддддадддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/

Function MATRKSUC( cTlmk, oTree, cAddString, nLevel, nMaxLevel, lItem, cTreeID )

LOCAL cImageSUC   := "" 								// Imagem ultilizada para representar o Item de Atendimento
//здддддддддддддддддддддддддддддддддддддддддддддддд©
//ЁVariaveis usadas em Integracoes                 Ё
//юдддддддддддддддддддддддддддддддддддддддддддддддды

DEFAULT nMaxLevel := 1000000
DEFAULT lItem     := .T.
DEFAULT cTreeID   := "000001"

SUC->( DbSetOrder( 1 ) )
If SUC->( DbSeek( xFilial( "SUC" ) + cTlmk ) )
	
	nLevel++
	
	If nLevel <= nMaxLevel
		
		cAddString := If( ValType( cAddString ) == "C", cAddString, "" )
		
		cImageSUC := MaEntImage( "SUC", 1 )
		
		oTree:AddItem( Pad( STR0045  + Transform( cTlmk, "@r XXXXXX" ) + ;    //"Atendimento Telemarketing  - "
		cAddString, 100 ), Pad( "SUC-" + cTlmk, 50 )+cTreeID,cImageSUC,cImageSUC,,,nLevel)
		
		oTree:TreeSeek( Pad( "SUC-" + cTlmk, 50 )+cTreeID )
		
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Verifica se gerou chamado no Field Service                   Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		AB1->( DbSetOrder( 5 ) )
		If AB1->( DbSeek( xFilial( "AB1" ) + cTlmk ) )
			MATRKAB1( AB1->AB1_NRCHAM, @oTree, , @nLevel, nMaxLevel,,cTreeID )
		EndIf
		
		oTree:TreeSeek( Pad( "SUC-" + cTlmk, 50 )+cTreeID )
		
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Verifica as FNCs geradas no QNC                              Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		If SUD->(DbSeek( xFilial( "SUC" ) + SUC->UC_CODIGO))
			While SUD->( !Eof() .AND. SUC->(xFilial("SUC"))+SUC->UC_CODIGO == SUD->(xFilial("SUD")) + SUD->UD_CODIGO )
        	       	If !Empty(SUD->UD_CODFNC)
					MATRKQI2( SUD->UD_CODIGO, @oTree, , @nLevel, nMaxLevel,,cTreeID )
					Exit
  	  			EndIf
				SUD->( dbSkip() )
			End
		EndIf		
	EndIf
	
EndIf

Return( .T. )

/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFuncao    Ё MATRKAB1 Ё Autor Ё Sergio Silveira       Ё Data Ё19/08/2002Ё╠╠
╠╠цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o Ё Monta as pastas do chamado tecnico (Header) - Field ServiceЁ╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁSintaxe   Ё MATRKAB1( ExpC1, @ExpO1, [ ExpC2 ], @ExpN1, ExpN2, ExpL1)  Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁRetorno   Ё Nenhum                                                     Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁParametrosЁ ExpC1 -> Chave de pesquisa                                 Ё╠╠
╠╠Ё          Ё ExpO1 -> Objeto Tree                                       Ё╠╠
╠╠Ё          Ё ExpC2 -> String a adicionar ao texto do item ( tree )      Ё╠╠
╠╠Ё          Ё ExpN1 -> Nivel                                             Ё╠╠
╠╠Ё          Ё ExpN2 -> Nivel maximo                                      Ё╠╠
╠╠Ё          Ё ExpL1 -> Indica se deve expandir os itens ou cabecalhos    Ё╠╠
╠╠цддддддддддедддддддддддддддбдддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё   DATA   Ё Programador   ЁManutencao Efetuada                         Ё╠╠
╠╠цддддддддддедддддддддддддддедддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё          Ё               Ё                                            Ё╠╠
╠╠юддддддддддадддддддддддддддадддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/

Function MATRKAB1( cChamado, oTree, cAddString, nLevel, nMaxLevel, lItem, cTreeID )

LOCAL cQuery      := ""
LOCAL cAliasQry   := ""
LOCAL cImageAB1   := ""

DEFAULT nMaxLevel := 1000000
DEFAULT lItem     := .T.
DEFAULT cTreeID   := "000001"

AB1->( DbSetOrder( 1 ) )
If AB1->( DbSeek( xFilial( "AB1" ) + cChamado ) )
	
	nLevel++
	
	If nLevel <= nMaxLevel
		
		cAddString := If( ValType( cAddString ) == "C", cAddString, "" )
		
		cImageAB1 := MaEntImage( "AB1", 1 )
		
		oTree:AddItem( Pad( STR0046  + Transform( cChamado, "@r XXXXXXXX" ) + ;    //"Chamado Tecnico - "
		cAddString, 100 ), Pad( "AB1-" + cChamado, 50 )+cTreeID,cImageAB1,cImageAB1,,,nLevel)
		
		oTree:TreeSeek( Pad( "AB1-" + cChamado, 50 )+cTreeID )
		
		If lItem
			
			//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
			//Ё Alimenta os itens deste chamado                              Ё
			//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
			
			cAliasQry := GetNextAlias()
			
			cQuery := ""
			
			cQuery += "SELECT AB2_NRCHAM, AB2_ITEM "
			cQuery += "FROM " + RetSqlName( "AB2" ) + " "
			cQuery += "WHERE "
			cQuery += "AB2_FILIAL='" + xFilial( "AB2" ) + "' AND "
			cQuery += "AB2_NRCHAM='" + cChamado         + "' AND "
			cQuery += "D_E_L_E_T_=' ' "
			cQuery += "ORDER BY AB2_NRCHAM, AB2_ITEM"
			
			cQuery := ChangeQuery( cQuery )
			
			dbUseArea( .T., "TOPCONN", TcGenQry( , , cQuery ), cAliasQry, .F., .T. )
			
			While !( cAliasQry )->( Eof() )
				MATRKAB2( ( cAliasQry )->AB2_NRCHAM + ( cAliasQry )->AB2_ITEM, @oTree, , @nLevel, nMaxLevel,,cTreeID )
				oTree:TreeSeek( Pad( "AB1-" + cChamado, 50 )+cTreeID )
				( cAliasQry )->( dbSkip() )
			End
			
			//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
			//Ё Exclui a area de trabalho da query                           Ё
			//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
			dbSelectArea( cAliasQry )
			dbCloseArea()
			
			dbSelectArea( "AB2" )
				
		EndIf
		
	EndIf
	
	nLevel--
	
EndIf

Return( .T. )


/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFuncao    Ё MATRKSA1 Ё Autor Ё Marcelo Kotaki        Ё Data Ё17/11/2003Ё╠╠
╠╠цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o Ё Monta as pastas do cadastro de Cliente                     Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁSintaxe   Ё MATRKSA1( ExpC1, @ExpO1, [ ExpC2 ], @ExpN1, ExpN2, ExpL1)  Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁRetorno   Ё .T.                                                        Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁParametrosЁ ExpC1 -> Chave de pesquisa                                 Ё╠╠
╠╠Ё          Ё ExpO1 -> Objeto Tree                                       Ё╠╠
╠╠Ё          Ё ExpC2 -> String a adicionar ao texto do item ( tree )      Ё╠╠
╠╠Ё          Ё ExpN1 -> Nivel                                             Ё╠╠
╠╠Ё          Ё ExpN2 -> Nivel maximo                                      Ё╠╠
╠╠Ё          Ё ExpL1 -> Indica se deve expandir os itens ou cabecalhos    Ё╠╠
╠╠цддддддддддедддддддддддддддбдддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё   DATA   Ё Programador   ЁManutencao Efetuada                         Ё╠╠
╠╠цддддддддддедддддддддддддддедддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё          Ё               Ё                                            Ё╠╠
╠╠юддддддддддадддддддддддддддадддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/

Function MATRKSA1( cCodigo, oTree, cAddString, nLevel, nMaxLevel, lItem, cTreeID )

Local cImageSA1 := ""

DEFAULT nMaxLevel := 3     
DEFAULT cTreeID   := "000001"

DbSelectarea("SA1")
DbSetOrder(1)		
If DbSeek( xFilial( "SA1" ) + cCodigo ) 

	nLevel++
	
	If nLevel <= nMaxLevel
		
		cAddString := SA1->A1_NOME
		cImageSA1  := MaEntImage( "SA1", 1 )
		//"Cadastro de Cliente - Codigo: "		"Loja: " " Nome: "
		oTree:AddItem( Pad( STR0059 + SUBSTR(ALLTRIM(cCodigo),1,6) + STR0060 + SUBSTR(ALLTRIM(cCodigo),6,2) + STR0061 + cAddString, 100 ), Pad( "SA1-" + cCodigo, 50 )+cTreeID,cImageSA1,cImageSA1,,,nLevel)
		
		oTree:TreeSeek( Pad( "SA1-" + cCodigo, 50 )+cTreeID )
	Endif     
	
	nLevel--
Endif

Return( .T. )

/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFuncao    Ё MATRKSUS Ё Autor Ё Marcelo Kotaki        Ё Data Ё17/11/2003Ё╠╠
╠╠цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o Ё Monta as pastas do cadastro de Prospect                    Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁSintaxe   Ё MATRKSUS( ExpC1, @ExpO1, [ ExpC2 ], @ExpN1, ExpN2, ExpL1)  Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁRetorno   Ё .T.                                                        Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁParametrosЁ ExpC1 -> Chave de pesquisa                                 Ё╠╠
╠╠Ё          Ё ExpO1 -> Objeto Tree                                       Ё╠╠
╠╠Ё          Ё ExpC2 -> String a adicionar ao texto do item ( tree )      Ё╠╠
╠╠Ё          Ё ExpN1 -> Nivel                                             Ё╠╠
╠╠Ё          Ё ExpN2 -> Nivel maximo                                      Ё╠╠
╠╠Ё          Ё ExpL1 -> Indica se deve expandir os itens ou cabecalhos    Ё╠╠
╠╠цддддддддддедддддддддддддддбдддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё   DATA   Ё Programador   ЁManutencao Efetuada                         Ё╠╠
╠╠цддддддддддедддддддддддддддедддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё          Ё               Ё                                            Ё╠╠
╠╠юддддддддддадддддддддддддддадддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/

Function MATRKSUS( cCodigo, oTree, cAddString, nLevel, nMaxLevel, lItem, cTreeID )

Local cImageSUS := ""
Local cChaveSA1 := ""

DEFAULT nMaxLevel := 1000000
DEFAULT cTreeID   := "000001"

DbSelectarea("SUS")
DbSetOrder(1)		
If DbSeek( xFilial( "SUS" ) + cCodigo ) 

	nLevel++
	
	If nLevel <= nMaxLevel
		
		cAddString := SUS->US_NOME
		cImageSUS  := MaEntImage( "SUS", 1 )
		// "Cadastro de Prospect - Codigo: " " Loja: " " Nome: "
		oTree:AddItem( Pad( STR0062 + SUS->US_COD + STR0060 + SUS->US_LOJA + STR0061 + cAddString, 100 ), Pad( "SUS-" + cCodigo, 50 ),cImageSUS,cImageSUS,,,nLevel)
		
		oTree:TreeSeek( Pad( "SUS-" + cCodigo, 50 )+cTreeID )

		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Analisa destino                                              Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды

		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Verifica se o Cliente desse Prospect                         Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		If !Empty(SUS->US_CODCLI) .AND. !Empty(SUS->US_LOJACLI)
			cChaveSA1 := SUS->US_CODCLI+SUS->US_LOJACLI
			SA1->( DbSetOrder( 1 ) )
			If SA1->( DbSeek( xFilial( "SA1" ) + cChaveSA1 ) )
				MATRKSA1( cChaveSA1, @oTree, , @nLevel, nMaxLevel,,cTreeID)
			Endif
		Endif
	Endif
	
	nLevel--
Endif

Return( .T. )

/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFuncao    Ё MATRKACH Ё Autor Ё Marcelo Kotaki        Ё Data Ё17/11/2003Ё╠╠
╠╠цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o Ё Monta as pastas do cadastro de Suspect                     Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁSintaxe   Ё MATRKACH( ExpC1, @ExpO1, [ ExpC2 ], @ExpN1, ExpN2, ExpL1)  Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁRetorno   Ё .T.                                                        Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁParametrosЁ ExpC1 -> Chave de pesquisa                                 Ё╠╠
╠╠Ё          Ё ExpO1 -> Objeto Tree                                       Ё╠╠
╠╠Ё          Ё ExpC2 -> String a adicionar ao texto do item ( tree )      Ё╠╠
╠╠Ё          Ё ExpN1 -> Nivel                                             Ё╠╠
╠╠Ё          Ё ExpN2 -> Nivel maximo                                      Ё╠╠
╠╠Ё          Ё ExpL1 -> Indica se deve expandir os itens ou cabecalhos    Ё╠╠
╠╠цддддддддддедддддддддддддддбдддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё   DATA   Ё Programador   ЁManutencao Efetuada                         Ё╠╠
╠╠цддддддддддедддддддддддддддедддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё          Ё               Ё                                            Ё╠╠
╠╠юддддддддддадддддддддддддддадддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/

Function MATRKACH( cCodigo, oTree, cAddString, nLevel, nMaxLevel, lItem, cTreeID )

Local cImageACH := ""
Local cChavePro	:= ""

DEFAULT nMaxLevel := 1000000
DEFAULT cTreeID   := "000001"

DbSelectarea("ACH")
DbSetOrder(1)		
If DbSeek( xFilial( "ACH" ) + cCodigo ) 

	nLevel++
	
	If nLevel <= nMaxLevel
		
		cAddString := ACH->ACH_RAZAO
		cImageACH  := MaEntImage( "ACH", 1 )
		// "Cadastro de Suspect - Codigo: "
		oTree:AddItem( Pad( STR0063 + SUBSTR(ALLTRIM(cCodigo),1,6) + STR0060 + SUBSTR(ALLTRIM(cCodigo),6,2) + STR0061 + cAddString, 100 ), Pad( "ACH-" + cCodigo, 50 ),cImageACH,cImageACH,,,nLevel)
		
		oTree:TreeSeek( Pad( "ACH-" + cCodigo, 50 )+cTreeID )

		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Analisa destino                                              Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Verifica se ja existe o Prospect desse Suspect               Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		If !Empty(ACH->ACH_CODPRO) .AND. !Empty(ACH->ACH_LOJPRO)
			cChavePro := ACH->ACH_CODPRO+ACH->ACH_LOJPRO
			SUS->( DbSetOrder( 1 ) )
			If SUS->( DbSeek( xFilial( "SUS" ) + cChavePro ) )
				MATRKSUS( cChavePro, @oTree, , @nLevel, nMaxLevel,,cTreeID )
			Endif	
		Endif
	Endif
	
	nLevel--
Endif

Return( .T. )


/*/
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFuncao    ЁMaMakeViewЁ Autor Ё Sergio Silveira       Ё Data Ё25/10/2001Ё╠╠
╠╠цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o Ё Dispara os visualizadores padrao para cada entidade        Ё╠╠
╠╠Ё          Ё A tabela deve estar posionada no registro desejado         Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁSintaxe   Ё ExpL1 := MaMakeView( ExpC1 )                               Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁRetorno   Ё ExpL1 -> Indica se existe visualizador para a entidade     Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁParametrosЁ ExpC1 -> Alias da entidade                                 Ё╠╠
╠╠цддддддддддедддддддддддддддбдддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё   DATA   Ё Programador   ЁManutencao Efetuada                         Ё╠╠
╠╠цддддддддддедддддддддддддддедддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё02/03/2007ЁNorbert Waage  ЁAlteracao do vetor aRotina criado para a    Ё╠╠
╠╠Ё          Ё               Ёrotina TK271CallCenter. O aRotina so possuiaЁ╠╠
╠╠Ё          Ё               Ё1 item para a chamada da funcao e ocasionavaЁ╠╠
╠╠Ё          Ё               Ёerro na GetDados em uma subrotina do TMKA271Ё╠╠
╠╠юддддддддддадддддддддддддддадддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
/*/
Function MaMakeView( cAlias )
Local aArea      := GetArea()
Local aRotBack,cCadBack
Local aUserView  := { { "", { || .T. } } }
Local aCopAcols  := {}
Local aCopaHeader:= {}
Local lRet       := .T.
Local cSeekSF2   := ""
Local cFiltroBKP := "" 

Local nBack

If Type( "N" ) == "N"
	nBack := n
	n     := 1
EndIf

//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Caso exista, faz uma copia do aRotina                    Ё
//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
If Type( "aRotina" ) == "A"
	aRotBack := AClone( aRotina )
EndIf

//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Caso exista, faz uma copia do cCadastro                  Ё
//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
If Type( "cCadastro" ) == "C"
	cCadBack := cCadastro
EndIf

//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Carrega o array de visualizadores definidos pelo usuario Ё
//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
If ExistBlock( "MAUSVIEW" )
	aUserView := ExecBlock( "MAUSVIEW", .f., .f. )
EndIf

//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Verifica se existe um visualizador do usuario para esta entidade Ё
//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
If Empty( nScan := AScan( aUserView, { |x| x[1] == cAlias } ) )
	Do Case
		Case cAlias == "AB1"
			TECA300( "At300Visua" )
		Case cAlias == "AB3"
			TECA400( "At400Visua" )
		Case cAlias == "AB6"
			TECA450( "At450Visua" )
		Case cAlias == "AB9"
			aRotina := 	{ { STR0017,"At460Visua" , 0 , 2 } }
			At460Visua( "AB9", AB9->( Recno() ), 1 )
		Case cAlias == "ABK"
			TECA310( "At310Visua" )
		Case cAlias == "ABL"
			TECA320( "AxVisual" )
		Case cAlias == "ABH"
			TECA700( "AT700Visua" )
		Case cAlias == "SC2"
			cCadastro := Alltrim(STR0050) 
			AxVisual( "SC2", SC2->( Recno() ), 1 )
		Case cAlias == "SC5"
			cCadastro := STR0016	 //"Atualizacao de Pedidos de Venda"
			aRotina := { {  STR0017,"A410Visual",0,2 } }  //"Visualizar"
			A410Visual("SC5", SC5->( Recno() ), 1 )
		Case cAlias == "ABF"
			cCadastro := ""
			aRotina := { {  STR0017,"AT470Visua",0,2 } }  //"Visualizar"
			AT470Visua("ABF", ABF->( Recno() ), 1 )
		Case cAlias == "ABB"
			Atc050Age( "AB6", AB6->( Recno() ), 1 )
		Case cAlias == "ADA"
			cCadastro := "Contrato de Parceria - Venda"
			aRotina := { {  "Visualizar","Ft400Alter",0,2 } }  //"Visualizar"
			Ft400Alter("ADA",ADA->( Recno() ),1)
		Case cAlias == "SD2"
			If cPaisLoc == "BRA"
				aRotina := {{ "", "AxPesqui", 2 },{ "" ,"a920NFSAI", 0, 2}}
				A920NFSAI( "SD2", SD2->( Recno() ), 2 )
			Else
				SF2->( DbSetOrder( 2 ) )
				cSeekSF2:=SD2->D2_FILIAL+SD2->D2_CLIENTE+SD2->D2_LOJA+SD2->D2_DOC+SD2->D2_SERIE
				If SF2->( dbSeek( cSeekSF2 ) )
					VisualNfRem( "SF2", SF2->( Recno() ) )
				EndIf
			Endif
		Case cAlias == "SD3"
			cCadastro := Alltrim(STR0051) //"Movimento Interno "
			AxVisual( "SD3", SD3->( Recno() ), 1 )
		Case cAlias == "SC9"
			AxVisual( "SC9", SC9->( Recno() ), 1 )
		Case cAlias == "AAM"
			aRotina := { { STR0017,"At250Manut",0,2} }
			At250Manut( "AAM", AAM->( Recno() ), 1 )
		Case cAlias == "SCJ"
     		cCadastro	:=  STR0124 	//"OrГamentos de Venda"
			aRotina := { {  STR0017,"A415Visual",0,2 } }  //"Visualizar"
			A415Visual("SCJ", SCJ->( Recno() ), 1 )

		Case cAlias == "ADY"
	       cCadastro	:=  STR0123 //proposta comercial
			AxVisual( "ADY", ADY->( Recno() ), 1, , ,cCadastro )
		Case cAlias == "AAH"
			cCadastro := ""
			aRotina := { {  STR0017,"At200Manut",0,2 } }  //"Visualizar"
			At200Manut( "AAH", AAH->( Recno() ), 1 )

		Case cAlias == "AAM"
			cCadastro := ""
			aRotina := { {  STR0017,"At250Manut",0,2 } }  //"Visualizar"
			At250Manut( "AAM", AAM->( Recno() ), 2 )

		Case cAlias == "AAA"
			cCadastro := ""
			aRotina := { {  STR0017,"At230Visu",0,2 } }  //"Visualizar"
			At230Visu( "AAA", AAA->( Recno() ), 1 )

		Case cAlias == "AD1"
			aRotina := { { "", "AxPesqui", 2 },;
			{ STR0017,"Ft300Alter",0,2} }
			Ft300Alter( "AD1", AD1->( Recno() ), 2 )
		Case cAlias == "SC0"
			aRotina := { { "", "AxPesqui", 0, 1 },{ STR0017,"A430Visual",0,2 } }  //"Visualizar"
			A430Visual("SC0", SC0->( Recno() ), 2 )
		Case cAlias == "SE1"
			FINA040(NIL,2) 
		Case cAlias == "SE2"
			FINA050( NIL,NIL,2 ) 
		Case cAlias == "SCN"
			// foi necessario guardar o aHeader e o Acols pois o programa A462Visual
			// cria essas mesma variaveis com conteudos diferentes
			aCopAcols:= Acols
			aCopaHeader:=aHeader
			aRotina := { { "", "AxPesqui", 0, 1 },{ STR0017,"A462Visual",0,2 } }  //"Visualizar"
			A462Visual("SCN", SCN->( Recno() ), 2 )
			Acols:=aCopAcols
			aHeader := aCopaHeader
		Case cAlias == "SUA"
			TkGetTipoAte("2")//Seta a abertura da tela de atendimento somente para Televendas
			cCadastro := STR0042 //"Atualizacao de Televendas"   
			aRotina := { { "", "AxPesqui", 0, 1 },{ STR0017  ,"TK271CallCenter" ,0,2 },{"","TK271CallCenter" ,0,3} }  	//Visualizar
			TK271CallCenter("SUA", SUA->( Recno() ) , 2 )
		Case cAlias == "SC1"
			If SC1->C1_TIPO == 2
				MATA113(NIL,NIL,2) 
			Else
				MATA110(NIL,NIL,2) 
			EndIf
		Case cAlias == "SC7"
			Mata120(If(cAlias="SC7",1,2),,, 2 )
		Case cAlias == "SC3"
			Mata125(NIL,NIL,2)
		Case cAlias == "SCR"       
			cCadastro := STR0017 
			aRotina := { {  STR0017,"AxVisual",0,2 } }  //"Visualizar"
			AxVisual("SCR", SCR->( Recno() ), 1 )
		Case cAlias == "SC8"
            Mata160(NIL,2,.T.)
		Case cAlias == "SD1"
			cFiltroBKP:= SF1->(dbFilter())
			SF1->(dbClearFilter())
			SF1->( DbSetOrder( 1 ) )
	   		cSeekSF1:=xFilial("SF1")+SD1->D1_DOC+SD1->D1_SERIE+SD1->D1_FORNECE+SD1->D1_LOJA
			If SF1->( dbSeek( cSeekSF1 ) )
				If cPaisLoc == "BRA"
					aRotina := {{ STR0017 ,"A103NFiscal", 0, 2}}
					A103NFiscal( "SF1", SF1->( Recno() ), 1 )
				Else
					VisualNfRem( "SF1", SF1->( Recno() ) )
				Endif
			EndIf      
			If !Empty(cFiltroBkp)
				SF1->(dbSetFilter({||&cFiltroBkp},cFiltroBkp))
			EndIF	
		Case cAlias == "SA1"  // Cadastro de Clientes
			aRotina := { { STR0017,"A030Visual",0,2 } }  //"Visualizar"
			A030Visual("SA1", SA1->( Recno() ), 1 )

		Case cAlias == "SUS"  // Cadastro de Prospect
			aRotina := { { STR0017,"AxVisual",0,2 } }    //"Visualizar"
			AxVisual("SUS", SUS->( Recno() ), 1 )

		Case cAlias == "ACH"  // Cadastro de Suspect
			aRotina := { { STR0017,"AxVisual",0,2 } }    //"Visualizar"
			AxVisual("ACH", ACH->( Recno() ), 1 )
		Case cAlias == "DAK"
			cCadastro := STR0070 //"Montagem de Carga - Visualizar"
			aRotina := { { "", "AxPesqui", 2 },;
						{ STR0017,"Os200Visual",0,2} }
			Os200Visual("DAK",DAK->(Recno()),2)
			
		Case cAlias == "CNA"
			cCadastro := "Cadastro de Planilhas - VISUALIZAR"  // "Cadastro de Planilhas - VISUALIZAR" 
			aRotina := 	{ 	{ "", "AxPesqui"  , 0, 1},;//"Pesquisar"
								{ STR0017, "CN200Manut", 0, 2} }//"Visualizar"
			FWExecView(STR0017,If(CN9->CN9_ESPCTR == "1","CNTA300","CNTA301"),MODEL_OPERATION_VIEW,,{|| .T.})//"Visualizar"
		Case cAlias == "CND" 

			CNTA120( NIL, NIL, 2, "cn130manut" )
			
		Case cAlias == "CN9" 
			aRotina := 	{ 	{ "", "AxPesqui"  , 0, 1},;//"Pesquisar"
								{ STR0017, "CN100Manut", 0, 2} }//"Visualizar"
			FWExecView(STR0017,If(CN9->CN9_ESPCTR == "1","CNTA300","CNTA301"),MODEL_OPERATION_VIEW,,{|| .T.})//"Visualizar"
			
		Otherwise
			lRet := .F.
	EndCase
Else
	//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//Ё Dispara o visualizador do usuario                                Ё
	//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
	Eval( aUserView[ nScan, 2 ] )
EndIf

//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Restaura o aRotina                                               Ё
//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
If ValType( aRotBack ) == "A"
	aRotina := AClone( aRotBack )
EndIf

//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Caso exista, faz uma copia do cCadastro                  Ё
//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
If Type( "cCadBack" ) == "C"
	cCadastro := cCadBack
EndIf

If ValType( nBack ) == "N"
	n := nBack
EndIf

RestArea( aArea )

Return( lRet )

/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFuncao    ЁMaPrepViewЁ Autor Ё Sergio Silveira       Ё Data Ё27/09/2000Ё╠╠
╠╠цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o Ё Prepara a chamada dos visualizadores a partir do tree do   Ё╠╠
╠╠Ё          Ё Tracker padrao                                             Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁSintaxe   Ё ExpL1 := MaPrepView( ExpO1 )                               Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁRetorno   Ё ExpL1 -> Indica se foi possivel preparar / disparar o      Ё╠╠
╠╠Ё          Ё visualizador.                                              Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁParametrosЁ ExpO1 -> Objeto Tree                                       Ё╠╠
╠╠цддддддддддедддддддддддддддбдддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё   DATA   Ё Programador   ЁManutencao Efetuada                         Ё╠╠
╠╠цддддддддддедддддддддддддддедддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё          Ё               Ё                                            Ё╠╠
╠╠юддддддддддадддддддддддддддадддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/

Function MaPrepView(oTree)

LOCAL aArea     := GetArea()
LOCAL aAreaBkp	:= {}
LOCAL cFiltroSF1:= ""
LOCAL cChave    := oTree:GetCargo()
LOCAL cAlias    := Left( cChave, 3 )
Local cFilBack  := cFilAnt
LOCAL lRet      := .T.
LOCAL lFilEnt	:= TRKFILENT()	
LOCAL nTamChave := 0

PRIVATE aRotina

INCLUI := .F.
ALTERA := .F.

Do Case
	Case cAlias == "AB2" .Or. cAlias == "AB1"
		AB1->( DbSetOrder( 1 ) )
		If AB1->( DbSeek( xFilial( "AB1" ) + SubStr( cChave, 5, 8 ) ) )
			lRet := MaMakeView( "AB1" )
		EndIf
	Case cAlias == "AB4"
		AB3->( DbSetOrder( 1 ) )
		If AB3->( DbSeek( xFilial( "AB3" ) + SubStr( cChave, 5, 6 ) ) )
			lRet := MaMakeView( "AB3" )
		EndIf
	Case cAlias == "AB7"
		AB6->( DbSetOrder( 1 ) )
		If AB6->( DbSeek( xFilial( "AB6" ) + SubStr( cChave, 5, 6 ) ) )
			lRet := MaMakeView( "AB6" )
		EndIf
	Case cAlias == "AB9"
		AB9->( DbSetOrder( 1 ) )
		If AB9->( DbSeek( xFilial( "AB9" ) + Substr( cChave, 5, 16 ) ) )
			lRet := MaMakeView( "AB9" )
		EndIf
	Case cAlias == "ABK"
		ABK->( DbSetOrder( 1 ) )
		If ABK->( DbSeek( xFilial( "ABK" ) + Substr( cChave, 5, 12 ) ) )
			lRet := MaMakeView( "ABK" )
		EndIf
	Case cAlias == "ABL"
		ABL->( DbSetOrder( 1 ) )
		If ABL->( DbSeek( xFilial( "ABL" ) + Substr( cChave, 5, 10 ) ) )
			lRet := MaMakeView( "ABL" )
		EndIf
	Case cAlias == "ABI"
		ABH->( DbSetOrder( 1 ) )
		If ABH->( DbSeek( xFilial( "ABH" ) + Substr( cChave, 5, 6 ) ) )
			lRet := MaMakeView( "ABH" )
		EndIf
	Case cAlias == "SC2" 
		SC2->( DbSetOrder( 1 ) )
		If SC2->( DbSeek( xFilial( "SC2" ) + Substr( cChave, 5, Len(SD3->D3_OP) ) ) )
			lRet := MaMakeView( "SC2" )
		EndIf
	Case cAlias == "SC6" .Or. cAlias == "SC5"
		SC5->( DbSetOrder( 1 ) )
		If SC5->( DbSeek( xFilial( "SC5" ) + Substr( cChave, 5, 6 ) ) )
			lRet := MaMakeView( "SC5" )
		EndIf

	Case cAlias == "CN9" .Or. cAlias == "N9H"  
		
		cCadastro := STR0114 // "Contratos" 
	
		CN9->( DbSetOrder( 1 ) )
		If CN9->( DbSeek( xFilial( "CN9" ) + Substr( cChave, 5, Len( CN9->CN9_REVISA + CN9->CN9_NUMERO ) ) ) )
			lRet := MaMakeView( "CN9" )
		EndIf

	Case cAlias == "CNA" .Or. cAlias == "CNB"
	
		nTamChave := Len( CNA->CNA_CONTRA + CNA->CNA_REVISA + CNA->CNA_NUMERO )
		CNA->( DbSetOrder( 1 ) )
		If CNA->( DbSeek( xFilial( "CNA" ) + Substr( cChave, 5,  24 ) ) )
			lRet := MaMakeView( "CNA" )
		EndIf
		
	Case cAlias == "CND" .Or. cAlias == "CNE"
	
		nTamChave := Len( CND->CND_CONTRA + CND->CND_REVISA + CND->CND_NUMERO + CND->CND_NUMMED )
		CND->( DbSetOrder( 1 ) )
		If CND->( DbSeek( xFilial( "CND" ) + Substr( cChave, 5, 30 ) ) )
			lRet := MaMakeView( "CND" )
		EndIf
		
	Case cAlias == "ADA" .Or. cAlias == "ADB"
		ADA->( DbSetOrder( 1 ) )
		If ADA->( DbSeek( xFilial( "ADA" ) + Substr( cChave, 5, 6 ) ) )
			lRet := MaMakeView( "ADA" )
		EndIf
	Case cAlias == "ABF"
		ABF->( DbSetOrder( 1 ) )
		If ABF->( DbSeek( xFilial( "ABF" ) + Substr( cChave, 5, 10 ) ) )
			lRet := MaMakeView( "ABF" )
		EndIf
	Case cAlias == "ABB"
		AB6->( DbSetOrder( 1 ) )
		If AB6->( DbSeek( xFilial( "AB6" ) + SubStr( cChave, 5, 6 ) ) )
			lRet := MaMakeView( "ABB" )
		EndIf
	Case cAlias == "SD2" .Or. cAlias == "SF2"
		SD2->( DbSetOrder( 3 ) )
		nTamChave := Len( SD2->D2_DOC + SD2->D2_SERIE + SD2->D2_CLIENTE + SD2->D2_LOJA )
		If SD2->( DbSeek( xFilial( "SD2" ) + SubStr( cChave, 5, nTamChave ) ) )
			lRet := MaMakeView( "SD2" )
		EndIf
	Case cAlias == "SD3"
		SD3->(dbGoto(Val(Substr(cChave,5+Len(SD3->D3_NUMSEQ),10))))
		lRet := MaMakeView( "SD3" )
	Case cAlias == "SC9"
		cCadastro := STR0025  //"Liberacao"
		
		nTamChave := Len( SC9->C9_PEDIDO + SC9->C9_ITEM + SC9->C9_SEQUEN )
		SC9->( DbSetOrder( 1 ) )
		If SC9->( DbSeek( xFilial( "SC9" ) + SubStr( cChave, 5, nTamChave ) ) )
			lRet := MaMakeView( "SC9" )
		EndIf
	Case cAlias == "SCK"	.Or. cAlias == "SCJ"
		SCJ->( DbSetOrder( 1 ) )
		If SCJ->( DbSeek( xFilial( "SCJ" ) + SubStr( cChave, 5, 6 ) ) )
			lRet := MaMakeView( "SCJ" )
		EndIf

	Case cAlias == "ADY"
		nTamChave := Len( ADY->( ADY_PROPOS + ADY_PREVIS )  )
		ADY->( DbSetOrder( 1 ) )
		If ADY->( DbSeek( xFilial( "ADY" ) + SubStr( cChave, 5, nTamChave ) ) )
			lRet := MaMakeView( "ADY" )
		EndIf

	Case cAlias == "AAH"
		nTamChave := Len( AAH->AAH_CONTRT  )
		AAH->( DbSetOrder( 1 ) )
		If AAH->( DbSeek( xFilial( "AAH" ) + SubStr( cChave, 5, nTamChave ) ) )
			lRet := MaMakeView( "AAH" )
		EndIf

	Case cAlias == "AAM"
		nTamChave := Len( AAM->AAM_CONTRT  )
		AAM->( DbSetOrder( 1 ) )
		If AAM->( DbSeek( xFilial( "AAM" ) + SubStr( cChave, 5, nTamChave ) ) )
			lRet := MaMakeView( "AAM" )
		EndIf

	Case cAlias == "AAA"
		nTamChave := Len( AAA->AAA_CODGRP  )
		AAA->( DbSetOrder( 1 ) )
		If AAA->( DbSeek( xFilial( "AAA" ) + SubStr( cChave, 5, nTamChave ) ) )
			lRet := MaMakeView( "AAA" )
		EndIf

	Case cAlias == "AD1"
		AD1->( DbSetOrder( 1 ) )
		If AD1->( DbSeek( xFilial( "AD1" ) + SubStr( cChave, 5, 6 ) ) )
			lRet := MaMakeView( "AD1" )
		EndIf
	Case cAlias == "AAN"	.Or. cAlias == "AAO" .Or. cAlias == "AAP"
		AAM->( DbSetOrder( 1 ) )
		nTamChave := Len( AAM->AAM_CONTRT )
		If AAM->( DbSeek( xFilial( "AAM" ) + SubStr( cChave, 5, nTamChave ) ) )
			lRet := MaMakeView( "AAM" )
		EndIf
	Case cAlias == "SC0"
		SC0->( DbSetOrder( 1 ) )
		nTamChave := Len( SC0->C0_NUM )
		If SC0->( DbSeek( xFilial( "SC0" ) + SubStr( cChave, 5, nTamChave ) ) )
			lRet := MaMakeView( "SC0" )
		EndIf
	Case cAlias == "SE1"
		SE1->( DbSetOrder( 2 ) )
		nTamChave := Len( SE1->E1_CLIENTE + SE1->E1_LOJA + SE1->E1_PREFIXO + SE1->E1_NUM + SE1->E1_PARCELA + SE1->E1_TIPO )
		If SE1->( DbSeek( xFilial( "SE1" ) + SubStr( cChave, 5, nTamChave ) ) )
			lRet := MaMakeView( "SE1" )
		EndIf
	Case cAlias == "SE2"
		If lFilEnt
			SE2->( DbSetOrder( 6 ) )
			nTamChave := Len( SE2->E2_FILIAL + SE2->E2_FORNECE + SE2->E2_LOJA + SE2->E2_PREFIXO + SE2->E2_NUM + SE2->E2_PARCELA )
			If SE2->( DbSeek( SubStr( cChave, 5, nTamChave ) ) )
	            cFilBack := cFilAnt
	            cFilAnt  := SE2->E2_FILIAL
				lRet := MaMakeView( "SE2" )
	            cFilAnt := cFilBack
			EndIf
		Else
			SE1->( DbSetOrder( 2 ) )
			nTamChave := Len( SE2->E2_FORNECE + SE2->E2_LOJA + SE2->E2_PREFIXO + SE2->E2_NUM + SE2->E2_PARCELA )
			If SE2->( DbSeek( xFilial( "SE2" ) + SubStr( cChave, 5, nTamChave ) ) )
				lRet := MaMakeView( "SE2" )
			EndIf
		EndIf  
	Case cAlias == "SCN"
		nTamChave :=  Len( SCN->CN_REMITO + SCN->CN_ITEM)
		SCN->( DbSetOrder(1 ) )  // Pesquisa por remito
		If SCN->( DbSeek( xFilial( "SCN" ) + SubStr( cChave, 5 + Len(SCN->CN_PEDIDO + SCN->CN_ITEMPED + SCN->CN_CLIENTE + SCN->CN_LOJA),nTamChave) )  )
			lRet := MaMakeView( "SCN" )
		EndIf
	Case cAlias == "SUA" .Or. cAlias == "SUB"
		nTamChave :=  Len( SUA->UA_NUM)
		SUA->( DbSetOrder(1 ) )  // Pesquisa por Atendimento - Televendas
		If SUA->( DbSeek( xFilial( "SUA" ) + SubStr( cChave, 5,nTamChave) )  )
			lRet := MaMakeView( "SUA" )
		EndIf
	Case cAlias == "SC1"
		SC1->( DbSetOrder( 1 ) )
		If lFilEnt
			If SC1->( DbSeek( Substr( cChave, 5, (TamSx3('C1_FILIAL')[1] + TamSx3('C1_NUM')[1]) )))
	            cFilBack := cFilAnt
	            cFilAnt  := SC1->C1_FILIAL
				lRet := MaMakeView( "SC1" )
	            cFilAnt := cFilBack
			EndIf
		Else
			If SC1->( DbSeek( xFilial( "SC1" ) + Substr( cChave, 5, 6 ) ) )
				lRet := MaMakeView( "SC1" )
			EndIf
		EndIf
	Case cAlias == "SC3"
		SC3->( DbSetOrder( 1 ) )
		If lFilEnt
			If SC3->( DbSeek( Substr( cChave, 5, (TamSx3('C3_FILIAL')[1] + TamSx3('C3_NUM')[1])) ) )
	            cFilBack := cFilAnt
	            cFilAnt  := SC3->C3_FILIAL
				lRet := MaMakeView( "SC3" )
	            cFilAnt := cFilBack
			EndIf
		Else
			If SC3->( DbSeek( xFilial( "SC3" ) + Substr( cChave, 5, 6 ) ) )
				lRet := MaMakeView( "SC3" )
			EndIf		
		EndIf
	Case cAlias == "SC7"
		If lFilEnt
			SC7->( DbSetOrder( 14 ) )
			If SC7->( DbSeek( Substr( cChave, 5, (TamSx3('C7_FILIAL')[1] + TamSx3('C7_NUM')[1]) ) ) )
	            cFilBack := cFilAnt
	            cFilAnt  := SC7->C7_FILIAL
				lRet := MaMakeView( "SC7" )
	            cFilAnt := cFilBack
			EndIf
		Else
			SC7->( DbSetOrder( 1 ) )
			If SC7->( DbSeek( xFilial( "SC7" ) + Substr( cChave, 5, 6 ) ) )
				lRet := MaMakeView( "SC7" )
			EndIf		
		EndIf
	Case cAlias == "SCR"
		If lFilEnt
			SCR->( DbSetOrder( 2 ) )    
			cChave := Substr(cChave,5,4) + Pad(Substr(cChave,9,6),Len(SCR->CR_NUM))+Substr(cChave,15,6)
			If SCR->( DbSeek(cChave) )
	            cFilBack := cFilAnt
	            cFilAnt  := SCR->CR_FILIAL
				lRet := MaMakeView( "SCR" )
	            cFilAnt := cFilBack
			EndIf 
		Else
	   		SCR->( DbSetOrder( 1 ) )
			If SCR->( DbSeek( xFilial( "SCR" ) + Substr( cChave, 5, 8 ) ) )
				lRet := MaMakeView( "SCR" )
			EndIf		
		EndIf
	Case cAlias == "SC8"
		SC8->( DbSetOrder( 1 ) )
		If lFilEnt
			nTamChave := Len( SC8->C8_FILIAL ) + Len( SC8->C8_NUM )  
	 		If SC8->( DbSeek(  Substr( cChave, 5, nTamChave ) ) )
	            cFilBack := cFilAnt
	            cFilAnt  := SC8->C8_FILIAL
				lRet := MaMakeView( "SC8" )
	            cFilAnt := cFilBack
			EndIf
		Else
			nTamChave := Len( SC8->C8_NUM )
	 		If SC8->( DbSeek( xFilial( "SC8" ) + Substr( cChave, 5, nTamChave ) ) )
				lRet := MaMakeView( "SC8" )
			EndIf		
		EndIf
	Case cAlias == "SD1" .Or. cAlias == "SF1"
		SD1->( DbSetOrder( 1 ) )                    
		If cPaisLoc == "BRA" .And. lFilEnt
			nTamChave := Len( SD1->D1_FILIAL + SD1->D1_DOC + SD1->D1_SERIE + SD1->D1_FORNECE + SD1->D1_LOJA )
			If SD1->( DbSeek( SubStr( cChave, 5, nTamChave ) ) )
	            cFilBack := cFilAnt
	            cFilAnt  := SD1->D1_FILIAL
	            SF1->(DbSetOrder(1))
	   	        SF1->(dbSeek(SD1->D1_FILIAL+SD1->D1_DOC+SD1->D1_SERIE+SD1->D1_FORNECE+SD1->D1_LOJA))
				lRet := MaMakeView( "SD1" )
	            cFilAnt := cFilBack
			EndIf                                   
		Else
			aAreaBkp:= GetArea()
			DbSelectArea("SF1")
			DbSetOrder(1)
			cFiltroSF1:= DbFilter()
			DbClearFilter()
			nTamChave := Len( SD1->D1_DOC + SD1->D1_SERIE + SD1->D1_FORNECE + SD1->D1_LOJA )
			If SD1->( DbSeek( xFilial( "SD1" ) + SubStr( cChave, 5, nTamChave ) ) )
            	SF1->(DbSetOrder(1))
   	    	    SF1->(dbSeek(xFilial("SF1")+SD1->D1_DOC+SD1->D1_SERIE+SD1->D1_FORNECE+SD1->D1_LOJA))
				lRet := MaMakeView( "SD1" )
			EndIf
			If !Empty(cFiltroSF1)
			   DbSetFilter ({|| &cFiltroSF1},cFiltroSF1)
			EndIf
			RestArea(aAreaBkp)
        EndIf    
	Case cAlias == "SA1"
		nTamChave :=  Len(SA1->A1_COD)+Len(SA1->A1_LOJA)
		SA1->( DbSetOrder( 1 ) )
		If SA1->( DbSeek( xFilial( "SA1" ) + SubStr( cChave, 5,nTamChave) )  )
			lRet := MaMakeView( "SA1" )
		Endif

	Case cAlias == "SUS"
		nTamChave :=  Len( SUS->US_COD)+Len(SUS->US_LOJA)
		SUS->( DbSetOrder( 1 ) )
		If SUS->( DbSeek( xFilial( "SUS" ) + SubStr( cChave, 5,nTamChave) )  )
			lRet := MaMakeView( "SUS" )
		Endif

	Case cAlias == "ACH"
		nTamChave := Len(ACH->ACH_CODIGO)+Len(ACH->ACH_LOJA)
		ACH->( DbSetOrder( 1 ) )
		If ACH->( DbSeek( xFilial( "ACH" ) + SubStr( cChave, 5,nTamChave) )  )
			lRet := MaMakeView( "ACH" )
		Endif
	Case cAlias == "DAI"
		nTamChave := Len(DAK->DAK_COD)+Len(DAK->DAK_SEQCAR)	
		DAK->( DbSetOrder( 1 ) )
		If DAK->( DbSeek( xFilial( "DAK" ) + Substr( cChave, 5, nTamChave ) ) )
			lRet := MaMakeView( "DAK" )
		EndIf
	Otherwise
		lRet := .F.
EndCase

RestArea( aArea )

Return( lRet )

/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFuncao    ЁMaTrkShow Ё Autor Ё Sergio Silveira       Ё Data Ё06/12/2001Ё╠╠
╠╠цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o Ё Monta a tela de visualizacao do tracker                    Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁSintaxe   Ё MaTrkShow( ExpA1 )                                         Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁRetorno   Ё .T.                                                        Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁParametrosЁ ExpO1 -> Objeto Tree                                       Ё╠╠
╠╠цддддддддддедддддддддддддддбдддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё   DATA   Ё Programador   ЁManutencao Efetuada                         Ё╠╠
╠╠цддддддддддедддддддддддддддедддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё          Ё               Ё                                            Ё╠╠
╠╠юддддддддддадддддддддддддддадддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/

Function MaTrkShow( aEnt )

Local aSize       := MsAdvSize( .F. )
Local aObjects    := {}
Local aUsButtons  := {}
Local aPosObj1    := {}

Local cGet1       := Space( 3 )
Local cGet2       := Space( 3 )

Local nTpRastUp   := 1
Local nTpRastDown := 1
Local nLoop       := 0

Local oDlg
Local oTree
Local oMenuTree
Local oPanel
Local oBmp1
Local oBmp2
Local oBmp3
Local oBmp4
Local oRast
Local oSair
Local oGet1
Local oGet2

Local oRad3
Local nNivel

PRIVATE aTitulos  := {}

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Ponto de entrada para a criacao de botoes de usuario                Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
If ExistBlock( "MATRKBUT" )
	aUsButtons := ExecBlock( "MATRKBUT", .F., .F. )
EndIf
                

aObjects := {}
AAdd( aObjects, { 100, 100, .T., .T. } )
AAdd( aObjects, { 130, 100, .F., .T., .T. } )

aInfo    := { aSize[ 1 ], aSize[ 2 ], aSize[ 3 ], aSize[ 4 ], 3, 3 }
aPosObj1 := MsObjSize( aInfo, aObjects, .T., .T. )

DEFINE MSDIALOG oDlg FROM	aSize[7],0 TO aSize[6],aSize[5] TITLE STR0026 OF oMainWnd PIXEL //"System Tracker"
	oTree := DbTree():New(aPosObj1[1,1],aPosObj1[1,2],aPosObj1[1,3],aPosObj1[1,4], oDlg,,,.T.)
	
	oTree:lShowHint := .F.
	
	MENU oMenuTree POPUP
	MENUITEM STR0017 Action MaPrepView(oTree) //"Visualizar"
	MENUITEM STR0033 ACTION MaTrkDisp( @oTree, aEnt, If( nTpRastUp == 1, Nil, Val( cGet1 ) ), If( nTpRastDown == 1, Nil, Val( cGet2 ) ) ) // "Rastear"
	MENUITEM STR0032 ACTION oDlg:End() // "Abandonar"
	ENDMENU
	
	oTree:bRClicked   := { |oObject,nx,ny| oMenuTree:Activate( nX, nY - 145, oObject ) }
	
	@ aPosObj1[2,1], aPosObj1[2,2] MSPANEL oPanel PROMPT "" SIZE aPosObj1[2,3],aPosObj1[2,4] OF oDlg CENTERED LOWERED
	
	@ 5, 5 TO 45, 125 of oPanel PROMPT STR0027  PIXEL //"Niveis para cima"
	@ 50,5 TO 90, 125 of oPanel PROMPT STR0028 PIXEL  //"Niveis para baixo"
	@ 95,5 TO 135, 125 of oPanel PROMPT STR0115 PIXEL  //"Detalhamento Total"
	
	nTpRastUp   := 1
	nTpRastDown := 1
	
	@ 018, 010 RADIO oRad1 VAR nTpRastUp   ITEMS STR0029,STR0030 ON CLICK MaTrkChang( oGet1, nTpRastUp, oBmp1, oBmp2 )   SIZE 40,10 PIXEL OF oPanel //"Ilimitado"###"Limitado a "
	@ 063, 010 RADIO oRad2 VAR nTpRastDown ITEMS STR0029,STR0030 ON CLICK MaTrkChang( oGet2, nTpRastDown, oBmp3, oBmp4 ) SIZE 40,10 PIXEL OF oPanel //"Ilimitado"###"Limitado a "
	
	@ 28, 52 MSGET oGet1 VAR cGet1 PICTURE "999" VALID Val(cGet1) >= 0 OF oPanel SIZE 20, 8 PIXEL
	
	@ 55, 148 BTNBMP oBmp1 RESNAME "VCUP"   ACTION ( cGet1 := Str( Val( cGet1 ) + 1, 3 ) )  SIZE 15, 10 OF oPanel PIXEL ADJUST
	@ 66, 148 BTNBMP oBmp2 RESNAME "VCDOWN" ACTION ( cGet1 := If( Val( cGet1 ) > 0, Str( Val( cGet1 ) - 1, 3 ), cGet1 ) )  SIZE 15, 10 OF oPanel PIXEL ADJUST
	
	@ 29, 86 SAY STR0031 OF oPanel SIZE 20, 8 PIXEL  //"niveis"
	
	@ 73, 52 MSGET oGet2 VAR cGet2 PICTURE "999" VALID Val(cGet2) >= 0 OF oPanel SIZE 20, 8 PIXEL
	
	@ 145, 148 BTNBMP oBmp3 RESNAME "VCUP"   ACTION ( cGet2 := Str( Val( cGet2 ) + 1, 3 ) )  SIZE 15, 10 OF oPanel PIXEL  ADJUST BORDER
	@ 156, 148 BTNBMP oBmp4 RESNAME "VCDOWN" ACTION ( cGet2 := If( Val( cGet2 ) > 0, Str( Val( cGet2 ) - 1, 3 ), cGet2 ) )  SIZE 15, 10 OF oPanel PIXEL  ADJUST BORDER
	
	@ 74, 86 SAY STR0031 OF oPanel SIZE 20, 8 PIXEL  //"niveis"
	
	@ 140, 42 BUTTON oSair PROMPT STR0032 SIZE 040,12 ACTION oDlg:End() OF oPanel PIXEL  //"Abandonar"
	@ 140, 85 BUTTON oRast PROMPT STR0033  SIZE 040,012 FONT oDlg:oFont ACTION ;  //"Rastrear"
	MaTrkDisp( @oTree, aEnt, If( nTpRastUp == 1, Nil, Val( cGet1 ) ), If( nTpRastDown == 1, Nil, Val( cGet2 ) ),nNivel ) PIXEL OF oPanel
	
	@ 110, 010 RADIO oRad3 VAR nNivel ITEMS STR0116,STR0117 SIZE 40,10 PIXEL OF oPanel //"Sim / NЦo"
	
	//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//Ё Efetua a criacao dos botoes de usuario                              Ё
	//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
	If ValType( aUsButtons ) == "A"
		If !Empty( aUsButtons )
			For nLoop := 1 To Len( aUsButtons )
				TButton():New( 95 + nLoop * 15, 85,AllTrim(aUsButtons[nLoop,1]),;
				oPanel,aUsButtons[ nLoop, 2 ],40,12,,oDlg:oFont,.F.,.T.,.F.,,.F.,,,.F.)
			Next nLoop
		EndIf
	EndIf
	
	MaTrkChang( oGet1, nTpRastUp, oBmp1, oBmp2 )
	MaTrkChang( oGet2, nTpRastDown, oBmp3, oBmp4 )
	
ACTIVATE MSDIALOG oDlg

Return( .t. )

/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFuncao    ЁMaTrkDisp Ё Autor Ё Sergio Silveira       Ё Data Ё06/12/2001Ё╠╠
╠╠цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o Ё Dispara o tracker para uma ou mais entidades               Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁSintaxe   Ё MaTrkDisp( ExpO1, ExpA1, ExpN1, ExpN2 )                    Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁRetorno   Ё .T.                                                        Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁParametrosЁ ExpO1 -> Objeto Tree                                       Ё╠╠
╠╠Ё          Ё ExpA1 -> Array contendo os elementos a rastrear            Ё╠╠
╠╠Ё          Ё     Estrutura:                                             Ё╠╠
╠╠Ё          Ё        1 - C - Alias da tabela                             Ё╠╠
╠╠Ё          Ё        2 - C - Chave unica de relacionamento               Ё╠╠
╠╠Ё          Ё ExpN1 -> Numero de niveis a subir                          Ё╠╠
╠╠Ё          Ё ExpN2 -> Numero de niveis a descer                         Ё╠╠
╠╠Ё          Ё ExpN3 -> Detalhamento Total                                Ё╠╠
╠╠Ё          Ё          1=Sim   /  2=NЦo  								  Ё╠╠
╠╠цддддддддддедддддддддддддддбдддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё   DATA   Ё Programador   ЁManutencao Efetuada                         Ё╠╠
╠╠цддддддддддедддддддддддддддедддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё          Ё               Ё                                            Ё╠╠
╠╠юддддддддддадддддддддддддддадддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/

Function MaTrkDisp( oTree, aEnt, xLevelUp, xLevelDown, xNivel  )

LOCAL aRoot      := {}
LOCAL aRootTot   := {}
LOCAL aRootEnd   := {}
LOCAL aTreeNivel := {}

LOCAL bBlock     := { || .T. }    

LOCAL cTreeID    := "" 

LOCAL nLevel     := 0
LOCAL nLevelDown := 0
LOCAL nLoop      := 0
LOCAL nLoop2     := 0
LOCAL nScan      := 0 

PRIVATE _aFatLoc := {}
PRIVATE _aRemLoc := {}

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Percorre as entidades a serem rastreadas                                    Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды

For nLoop := 1 to Len( aEnt )
	
	aRoot := {}
	MaRetRoot( aEnt[nLoop,1], aEnt[nLoop,2 ], @aRoot, xLevelUp, 0 )
	
	//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//Ё Localiza os eventos de maior nivel ( eventos de inicio ) por arvore         Ё
	//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
	   
	aTreeNivel := {}
	
	For nLoop2 := 1 to Len( aRoot ) 
		If Empty( nScan := AScan( aTreeNivel, { |x| x[1] == aRoot[nLoop2,4] } ) ) 
			AAdd( aTreeNivel, { aRoot[nLoop2,4], aRoot[nLoop2, 3], nLoop2 } ) 
		Else                                    
			If aRoot[ nLoop2, 3 ] > aTreeNivel[ nScan, 2 ]
				aTreeNivel[ nScan, 2 ] := aRoot[ nLoop2, 3 ]
				aTreeNivel[ nScan, 3 ] := nLoop2 
			EndIf 	 				
		EndIf  
	Next nLoop2 			
	
	For nLoop2 := 1 To Len( aTreeNivel ) 
		aRootEnd := AClone( aRoot[ aTreeNivel[nLoop2,3] ] )
		
		//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Elimina os eventos duplicados                                               Ё
		//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		If Empty( AScan( aRootTot, { |x| x[1] == aRootEnd[1] .And. x[2] == aRootEnd[2] } ) )
			AAdd( aRootEnd, Len( aRoot ) )
			AAdd( aRootTot, AClone( aRootEnd ) )
		EndIf
		
	Next nLoop2 
	
Next nLoop

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Limpa o Tree                                                                Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
oTree:BeginUpdate()
oTree:Reset()
oTree:EndUpdate()

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Obtem os eventos de inicio para as arvores de cabecalho                     Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
aRootHead := MaConvRoot( aRootTot )

If xNivel == 1 
	AEval( aRootHead, { |x| AAdd( aRootTot, { x[1], x[2], x[3], .F. } ) } )
Endif

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Ordena os eventos de inicio                                                 Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
aSort( aRootTot,,, { |x,y| y[1] + y[2] > x[1] + x[2] } )

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Dispara os trackers dos eventos de inicio, passando o tree como referencia  Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
oTree:BeginUpdate()

For nLoop := 1 To Len( aRootTot )
	
	//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//Ё Posiciona na raiz do tree                                                   Ё
	//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
	oTree:TreeSeek( "" )
	oTree:CurrentNodeId := ""
	
	nLevel := 0
	
	nLevelDown := Nil
	
	If ValType( xLevelDown ) == "N"
		nLevelDown := xLevelDown + aRootTot[ nLoop, 3 ]
	EndIf
	
	lItem := .T.
	
	If Len( aRootTot[ nLoop ] ) > 3
		lItem := .F.
	EndIf         

	//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//Ё Inicializa o identificador da arvore                                        Ё
	//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
	cTreeID := StrZero( nLoop, 6 ) 
	                             
	//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//Ё Dispara a funcao de tracker adequada                                        Ё
	//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
	bBlock := &( "{ || MATRK" + aRootTot[ nLoop, 1 ] + "( aRootTot[ nLoop,2 ], @oTree, ,@nLevel, nLevelDown, lItem, cTreeID ) } " )
	Eval( bBlock )
	
	
		
Next nLoop

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Posiciona na entidade de referencia                                         Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
oTree:TreeSeek( aEnt[1,1] + "-" + aEnt[1,2] )

oTree:EndUpdate()

oTree:Refresh() 

Return( .T. )

/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFuncao    ЁMaTrkChangЁ Autor Ё Sergio Silveira       Ё Data Ё06/12/2001Ё╠╠
╠╠цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o Ё Funcao a ser executada quando da mudanca de tipo de busca  Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁSintaxe   Ё MaTrkChang( ExpO1, ExpN1, ExpO2, ExpO3 )                   Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁRetorno   Ё .T.                                                        Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁParametrosЁ ExpO1 -> Objeto Get                                        Ё╠╠
╠╠Ё          Ё ExpN1 -> Tipo de rastro - 1 - Ilimitado / 2 - Limitado     Ё╠╠
╠╠Ё          Ё ExpO2 -> Objeto seta para cima                             Ё╠╠
╠╠Ё          Ё ExpO3 -> Objeto seta para baixo                            Ё╠╠
╠╠цддддддддддедддддддддддддддбдддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё   DATA   Ё Programador   ЁManutencao Efetuada                         Ё╠╠
╠╠цддддддддддедддддддддддддддедддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё          Ё               Ё                                            Ё╠╠
╠╠юддддддддддадддддддддддддддадддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/

Static Function MaTrkChange( oGet, nTipoRast, oBmp1, oBmp2 )

If nTipoRast == 1
	oGet:Disable()
	oBmp1:Disable()
	oBmp2:Disable()
Else
	oGet:Enable()
	oBmp1:Enable()
	oBmp2:Enable()
EndIf

Return( .T. )

/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFuncao    ЁMaEntImageЁ Autor Ё Sergio Silveira       Ё Data Ё13/12/2001Ё╠╠
╠╠цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o Ё Devolve a imagem padrao para cada entidade / Tipo          Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁSintaxe   Ё ExpC1 := MaEntImage( ExpC2, ExpN1 )                        Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁRetorno   Ё ExpC1 -> Nome da imagem                                    Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁParametrosЁ ExpC1 -> Alias                                             Ё╠╠
╠╠Ё          Ё ExpN1 -> Tipo de imagem                                    Ё╠╠
╠╠цддддддддддедддддддддддддддбдддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё   DATA   Ё Programador   ЁManutencao Efetuada                         Ё╠╠
╠╠цддддддддддедддддддддддддддедддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё          Ё               Ё                                            Ё╠╠
╠╠юддддддддддадддддддддддддддадддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/

Function MaEntImage( cAlias, nTipo )

Local aImages := {}
Local aNames  := {}

Local cImage  := ""

AAdd( aImages, { "SC0", { "PMSEDT3" } } )
AAdd( aImages, { "SC1", { "FOLDER11"} } )
AAdd( aImages, { "SC2", { "PMSEDT3" } } )
AAdd( aImages, { "SC3", { "FOLDER11"} } )
AAdd( aImages, { "SC5", { "PMSEDT3" } } )
AAdd( aImages, { "SC6", { "PMSEDT3" } } )
AAdd( aImages, { "SC7", { "FOLDER5" } } )
AAdd( aImages, { "SC8", { "FOLDER7" } } )
AAdd( aImages, { "SC9", { "PMSEDT3" } } )
AAdd( aImages, { "SCR", { "FOLDER10"} } )
AAdd( aImages, { "SCN", { "PMSEDT1" } } )
AAdd( aImages, { "SE1", { "PMSEDT2" } } )
AAdd( aImages, { "SE2", { "PMSEDT2" } } )
AAdd( aImages, { "SCJ", { "PMSEDT1" } } )
AAdd( aImages, { "SCK", { "PMSEDT1" } } )
AAdd( aImages, { "SUC", { "PMSEDT1" } } )
AAdd( aImages, { "SUA", { "PMSEDT1" } } )
AAdd( aImages, { "SUB", { "PMSEDT1" } } )
AAdd( aImages, { "SF1", { "PMSEDT4" } } )
AAdd( aImages, { "SF2", { "PMSEDT4" } } )
AAdd( aImages, { "SD1", { "PMSEDT4" } } )
AAdd( aImages, { "SD2", { "PMSEDT4" } } )
AAdd( aImages, { "SD3", { "PMSEDT4" } } )
AAdd( aImages, { "AB2", { "FOLDER5"  } } )
AAdd( aImages, { "AB1", { "FOLDER5"  } } )
AAdd( aImages, { "ABI", { "FOLDER7"  } } )
AAdd( aImages, { "AB9", { "FOLDER10" } } )
AAdd( aImages, { "AAN", { "FOLDER10" } } )
AAdd( aImages, { "AAO", { "FOLDER10" } } )
AAdd( aImages, { "ABF", { "FOLDER10" } } )
AAdd( aImages, { "ABB", { "FOLDER10" } } )
AAdd( aImages, { "AB7", { "FOLDER10" } } )
AAdd( aImages, { "ABL", { "FOLDER12" } } )
AAdd( aImages, { "ABK", { "FOLDER12" } } )
AAdd( aImages, { "AB4", { "FOLDER14" } } )
AAdd( aImages, { "ADB", { "FOLDER10" } } )
AAdd( aImages, { "AD1", { "FOLDER10" } } )
AAdd( aImages, { "SA1", { "PMSEDT3" } } )
AAdd( aImages, { "SUS", { "PMSEDT2" } } )
AAdd( aImages, { "ACH", { "PMSEDT1" } } )
AAdd( aImages, { "DAI", { "FOLDER10" } } )
AAdd( aImages, { "CN9", { "FOLDER5" } } )
AAdd( aImages, { "CNA", { "FOLDER12" } } )
AAdd( aImages, { "CND", { "FOLDER14" } } )
AAdd( aImages, { "CNB", { "FOLDER12" } } )
AAdd( aImages, { "CNE", { "FOLDER14" } } )
AAdd( aImages, { "ADY", { "FOLDER10"  } } )
AAdd( aImages, { "AAH", { "FOLDER10"  } } )
AAdd( aImages, { "AAM", { "FOLDER10"  } } )
AAdd( aImages, { "AAA", { "PMSEDT1" } } )

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Identificadores utilizados  na integracao com o Controle de Nao-Conformidades Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
// Inicio
AAdd( aImages, { "QI2",   { "UPDWARNING" } } )
AAdd( aImages, { "FNC00", { "BMPUSER" } } )
AAdd( aImages, { "FNC01", { "BMPCONS" } } )
AAdd( aImages, { "FNC02", { "BMPPARAM" } } )
AAdd( aImages, { "FNC03", { "BMPTABLE" } } )  
AAdd( aImages, { "FNC04", { "BMPCALEN" } } ) 
AAdd( aImages, { "FNC05", { "BMPCPO" } } ) 
AAdd( aImages, { "FNC06", { "NEXT" } } ) 
AAdd( aImages, { "FNC07", { "FOLDER9" } } ) 
AAdd( aImages, { "FNC08", { "COLINC" } } ) 
AAdd( aImages, { "FNC09", { "BUDGET" } } )           
AAdd( aImages, { "FNC10", { "BMPGROUP" } } )           
AAdd( aImages, { "FNC11", { "BTPESQ" } } ) 
// Fim

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Ponto de entrada para a modificacao do array                                Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
If ExistBlock( "MAENTIMG" )
	aImages := ExecBlock( "MAENTIMG", .F., .F., { aImages } )
EndIf

If !Empty( nScan := AScan( aImages, { |x| x[1] == cAlias } ) )
	
	aNames := aImages[ nScan, 2 ]
	If Len( aNames ) >= nTipo
		cImage := aNames[ nTipo ]
	EndIf
	
EndIf

Return( cImage )


/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFuncao    Ё MATRKSCN Ё Autor Ё Paulo Augusto         Ё Data Ё04/04/2002Ё╠╠
╠╠цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o Ё Monta as pastas do Remito                                  Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁSintaxe   Ё MATRKSCN( ExpC1, @ExpO1, [ ExpC2 ], @ExpN1, ExpN2, ExpL1)  Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁRetorno   Ё Nenhum                                                     Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁParametrosЁ ExpC1 -> Chave de pesquisa                                 Ё╠╠
╠╠Ё          Ё ExpO1 -> Objeto Tree                                       Ё╠╠
╠╠Ё          Ё ExpC2 -> String a adicionar ao texto do item ( tree )      Ё╠╠
╠╠Ё          Ё ExpN1 -> Nivel                                             Ё╠╠
╠╠Ё          Ё ExpN2 -> Nivel maximo                                      Ё╠╠
╠╠Ё          Ё ExpL1 -> Indica se deve expandir os itens ou cabecalhos    Ё╠╠
╠╠цддддддддддедддддддддддддддбдддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё   DATA   Ё Programador   ЁManutencao Efetuada                         Ё╠╠
╠╠цддддддддддедддддддддддддддедддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё          Ё               Ё                                            Ё╠╠
╠╠юддддддддддадддддддддддддддадддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/

Function MATRKSCN( cChaveNF, oTree, cAddString, nLevel, nMaxLevel, lItem, cTreeID )

LOCAL cQuery    	:= ""
LOCAL cAliasQry 	:= ""
LOCAL cDoc      	:= ""
LOCAL cItemPed    	:= ""
LOCAL cCliente  	:= ""
LOCAL cLoja     	:= ""
LOCAL cRemito   	:= ""
LOCAL cItemRem  	:= ""
LOCAL cSerie		:= ""
LOCAL cNumNota  	:= ""
LOCAL cSerieRem		:= ""
LOCAL cChaveRem		:= ""
LOCAL cImageSCN 	:= ""
DEFAULT nMaxLevel 	:= 1000000
DEFAULT lItem     	:= .T.
DEFAULT cTreeID   := "000001"
//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Separa os componentes da query                               Ё
//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
cDoc     	:= Left  ( cChaveNF,  Len( SCN->CN_PEDIDO ) )
cItemPed	:= SubStr( cChaveNF,  Len( cDoc ) + 1, Len( SCN->CN_ITEMPED ) )
cCliente	:= SubStr( cChaveNF,  Len( cDoc ) + Len( cItemPed ) + 1, Len( SCN->CN_CLIENTE ) )
cLoja    	:= SubStr( cChaveNF,  Len( cDoc ) + Len( cItemPed ) + Len( cCliente ) + 1, Len( SCN->CN_LOJA ) )
cRemito	 	:= SubStr( cChaveNF,  Len( cDoc ) + Len( cItemPed ) + Len( cCliente ) + Len( cLoja )+1,Len(SCN->CN_REMITO) )
cItemRem 	:= SubStr( cChaveNF,  Len( cDoc ) + Len( cItemPed ) + Len( cCliente ) + Len( cLoja )+ Len(cRemito)+1,Len(SCN->CN_ITEM) )
cSerie   	:= SubStr( cChaveNF,  Len( cDoc ) + Len( cItemPed ) + Len( cCliente ) + Len( cLoja )+ Len(cRemito)+ Len(cItemRem)+1,Len(SCN->CN_SERIENF) )
cNumNota 	:= SubStr( cChaveNF,  Len( cDoc ) + Len( cItemPed ) + Len( cCliente ) + Len( cLoja )+ Len(cRemito)+ Len(cItemRem)+Len(cSerie)+1,Len(SCN->CN_NFISCAL) )
cSerieRem	:= SubStr( cChaveNF,  Len( cDoc ) + Len( cItemPed ) + Len( cCliente ) + Len( cLoja )+ Len(cRemito)+ Len(cItemRem)+Len(cSerie)+Len(cNumNota)+1,Len(SCN->CN_SERIE) )
cChaveRem	:= SubStr( cChaveNF,1,Len( cDoc ) + Len( cItemPed ) + Len( cCliente ) + Len( cLoja )+ Len(cRemito)+ Len(cItemRem))
If nLevel <= nMaxLevel
	
	cAddString := If( ValType( cAddString ) == "C", cAddString, "" )
	
	cImageSCN := MaEntImage( "SCN", 1 )
	
	IF !(oTree:TreeSeek( Pad( "SCN-" + cChaveRem, 50 ) + cTreeID )  )
		oTree:AddItem( Pad( Rtrim( RetTitle("CN_REMITO") )+ " / " + Rtrim( RetTitle("CN_SERIE") )+ " / " + Rtrim( RetTitle("CN_ITEM") ) + " - " +Transform( cRemito , PesqPict("SCN","CN_REMITO")) +" / "+Transform( cSerieRem , PesqPict("SCN","CN_SERIE"))+ " / "+ Transform(cItemRem,PesqPict("SCN","CN_ITEM"))+;
		cAddString, 100 ), Pad( "SCN-" + cChaveRem, 50 ) + cTreeID, cImageSCN, cImageSCN,,,nLevel)
	EndIf
	
	//здддддддддддддддддддддддддддддддддддд©
	//Ё Alimenta os itens deste Remito     Ё
	//юдддддддддддддддддддддддддддддддддддды
	
	cAliasQry := GetNextAlias()
	
	cQuery := ""
	
	cQuery += "SELECT  D2_DOC, D2_SERIE ,D2_CLIENTE ,D2_LOJA ,D2_COD ,D2_ITEM,D2_REMITO,D2_ITEMREM "
	cQuery += "FROM " + RetSqlName( "SD2" ) + " "
	cQuery += "WHERE "
	cQuery += "D2_FILIAL='"		+ xFilial( "SD2" ) 	+ "' AND "
	cQuery += "D2_DOC='" 		+ cNumNota          + "' AND "
	cQuery += "D2_SERIE='" 		+ cSerie      		+ "' AND "
	cQuery += "D2_CLIENTE='"	+ cCliente      	+ "' AND "
	cQuery += "D2_LOJA='" 		+ cLoja       		+ "' AND "
	cQuery += "D2_REMITO='"		+ cRemito       	+ "' AND "
	cQuery += "D2_ITEMREM='"	+ cItemRem       	+ "' AND "
	cQuery += "D_E_L_E_T_=' ' "
	cQuery := ChangeQuery( cQuery )
	dbUseArea( .T., "TOPCONN", TcGenQry( , , cQuery ), cAliasQry, .F., .T. )
	While !( cAliasQry )->( Eof() )
		oTree:TreeSeek( Pad( "SCN-" + cChaveRem, 50 )+cTreeID )
		MATRKSD2(( cAliasQry )->D2_DOC + ( cAliasQry )->D2_SERIE + ( cAliasQry )->D2_CLIENTE + ( cAliasQry )->D2_LOJA + ( cAliasQry )->D2_COD + ( cAliasQry )->D2_ITEM, @oTree, , @nLevel, nMaxLevel,,cTreeID )
		( cAliasQry )->( dbSkip() )
	End
	//зддддддддддддддддддддддддддддддддддддддддд©
	//Ё Exclui a area de trabalho da query      Ё
	//юддддддддддддддддддддддддддддддддддддддддды
	dbSelectArea( cAliasQry )
	dbCloseArea()
	dbSelectArea( "SD2" )
EndIf
Return()

/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFuncao    Ё MATRKSC8 Ё Autor Ё Aline Correa do Vale  Ё Data Ё03/06/2003Ё╠╠
╠╠цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o Ё Monta as pastas de Cotacoes                                Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁSintaxe   Ё MATRKSC8( ExpC1, @ExpO1, [ ExpC2 ], @ExpN1, ExpN2, ExpL1)  Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁRetorno   Ё Nenhum                                                     Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁParametrosЁ ExpC1 -> Chave de pesquisa                                 Ё╠╠
╠╠Ё          Ё ExpO2 -> Objeto Tree                                       Ё╠╠
╠╠Ё          Ё ExpC3 -> String a adicionar ao texto do item ( tree )      Ё╠╠
╠╠Ё          Ё ExpN4 -> Nivel                                             Ё╠╠
╠╠Ё          Ё ExpN5 -> Nivel maximo                                      Ё╠╠
╠╠Ё          Ё ExpL6 -> Indica se deve expandir os itens ou cabecalhos    Ё╠╠
╠╠Ё          Ё ExpC7 -> Numero do pedido de venda                         Ё╠╠
╠╠Ё          Ё ExpA8 -> Array utilizado pelos remitos                     Ё╠╠
╠╠цддддддддддедддддддддддддддбдддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё   DATA   Ё Programador   ЁManutencao Efetuada                         Ё╠╠
╠╠цддддддддддедддддддддддддддедддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё          Ё               Ё                                            Ё╠╠
╠╠юддддддддддадддддддддддддддадддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/

Function MATRKSC8( cChaveCot, oTree, cAddString, nLevel, nMaxLevel, lItem,cTreeID)

Local cTrkSeek	:= ""
Local lFilEnt	:= TRKFILENT()	
LOCAL cQuery    := ""
LOCAL cAliasQry := ""
DEFAULT nMaxLevel := 1000000
DEFAULT cTreeID   := "000001"

SC8->( DbSetOrder( 3 ) )
If lFilEnt
	cTrkSeek:= cChaveCot
Else
	cTrkSeek:=  xFilial( "SC8" ) + cChaveCot
EndIf                         

If SC8->( DbSeek (cTrkSeek) )
	
	nLevel++
	
	If nLevel <= nMaxLevel
		
		cAddString := If( ValType( cAddString ) == "C", cAddString, "" )
		
		cImageSC8 := MaEntImage( "SC8", 1 )
		If lFilEnt
			oTree:AddItem( Pad( STR0052 + Transform( SC8->C8_NUM + SC8->C8_ITEM, "@R "+REPLICATE("X",TAMSX3("C8_NUM")[1])+"/"+REPLICATE("X",TAMSX3("C8_ITEM")[1])) + ;   //"Cotacao - "
			cAddString, 100 ), Pad( "SC8-" + SC8->C8_FILIAL + SC8->C8_NUM + SC8->C8_FORNECE + SC8->C8_LOJA + SC8->C8_ITEM, 50 )+cTreeID,cImageSC8,cImageSC8,,,nLevel)
			oTree:TreeSeek( Pad( "SC8-" + SC8->C8_FILIAL + SC8->C8_NUM + SC8->C8_FORNECE + SC8->C8_LOJA + SC8->C8_ITEM, 50 )+cTreeID )
		Else	
			oTree:AddItem( Pad( STR0052 + Transform( SC8->C8_NUM + SC8->C8_ITEM,  "@R "+REPLICATE("X",TAMSX3("C8_NUM")[1])+"/"+REPLICATE("X",TAMSX3("C8_ITEM")[1])) + ;   //"Cotacao - "
			cAddString, 100 ), Pad( "SC8-" + SC8->C8_NUM + SC8->C8_FORNECE + SC8->C8_LOJA + SC8->C8_ITEM, 50 )+cTreeID,cImageSC8,cImageSC8,,,nLevel)
			oTree:TreeSeek( Pad( "SC8-" + SC8->C8_NUM + SC8->C8_FORNECE + SC8->C8_LOJA + SC8->C8_ITEM, 50 )+cTreeID )
	  	EndIf
	
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Alimenta os itens deste pedido                               Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		
		cAliasQry := GetNextAlias()
		
		cQuery := ""
		If SC8->C8_TPDOC == '1'
			If lFilEnt
				cQuery += "SELECT C7_FILENT,C7_FILIAL, C7_NUM, C7_ITEM "
				cQuery += "FROM " + RetSqlName( "SC7" ) + " "
				cQuery += "WHERE "
				If ( FWModeAccess("SC7")=="E" .And. FWModeAccess("SC8")=="C" ).Or.( FWModeAccess("SC7")=="C" .And. FWModeAccess("SC8")=="E" )
					cQuery += "C7_NUMCOT='" + SC8->C8_NUM + "' AND "				
				Else
					cQuery += "C7_FILIAL='" + SC8->C8_FILIAL + "' AND "
				EndIf
			Else
				cQuery += "SELECT C7_NUM, C7_ITEM "
				cQuery += "FROM " + RetSqlName( "SC7" ) + " "
				cQuery += "WHERE "
				cQuery += "C7_FILIAL='" + xFilial( "SC7" ) + "' AND "
			EndIf
				cQuery += "C7_NUM='"    + SC8->C8_NUMPED   + "' AND "
				cQuery += "C7_ITEM='"   + SC8->C8_ITEMPED  + "' AND "
				cQuery += "D_E_L_E_T_=' ' "
				cQuery += "ORDER BY C7_NUM, C7_ITEM"
			
			cQuery := ChangeQuery( cQuery )
			
			dbUseArea( .T., "TOPCONN", TcGenQry( , , cQuery ), cAliasQry, .F., .T. )
			
			If lFilEnt
				oTree:TreeSeek( Pad( "SC8-" + SC8->C8_FILIAL + SC8->C8_NUM + SC8->C8_FORNECE + SC8->C8_LOJA + SC8->C8_ITEM, 50 )+cTreeID )
			Else
				oTree:TreeSeek( Pad( "SC8-" + SC8->C8_NUM + SC8->C8_FORNECE + SC8->C8_LOJA + SC8->C8_ITEM, 50 )+cTreeID )			
			EndIf
			
			If !( cAliasQry )->( Eof() )
				If lFilEnt
					MATRKSC7( ( cAliasQry )->C7_FILENT + ( cAliasQry )->C7_NUM + ( cAliasQry )->C7_ITEM, @oTree, , @nLevel, nMaxLevel,,cTreeID, 1)
				Else
					MATRKSC7( ( cAliasQry )->C7_NUM + ( cAliasQry )->C7_ITEM, @oTree, , @nLevel, nMaxLevel,,cTreeID, 1)
				EndIf
				( cAliasQry )->( dbSkip() )
			EndIf
		Else
			//--Tratamento para contratos
			cQuery += "SELECT CN9_NUMERO,CN9_REVISA  "
			cQuery += "FROM " + RetSqlName( "CN9" ) + " "
			cQuery += "WHERE "
			cQuery += "CN9_FILIAL='" + xFilial( "CN9" ) + "' AND "
			cQuery += "CN9_NUMERO='"    + SC8->C8_NUMCON   + "' AND "
			cQuery += "D_E_L_E_T_=' ' "
								
			cQuery := ChangeQuery( cQuery )
			
			dbUseArea( .T., "TOPCONN", TcGenQry( , , cQuery ), cAliasQry, .F., .T. )
			
			//If lFilEnt
				//oTree:TreeSeek( Pad( "SC8-" + SC8->C8_FILIAL + SC8->C8_NUM + SC8->C8_FORNECE + SC8->C8_LOJA + SC8->C8_ITEM, 50 )+cTreeID )
			//Else
				oTree:TreeSeek( Pad( "SC8-" + SC8->C8_NUM + SC8->C8_FORNECE + SC8->C8_LOJA + SC8->C8_ITEM, 50 )+cTreeID )			
			//EndIf
			
			If !( cAliasQry )->( Eof() )
				//If lFilEnt
					//MATRKSC7( ( cAliasQry )->C7_FILENT + ( cAliasQry )->C7_NUM + ( cAliasQry )->C7_ITEM, @oTree, , @nLevel, nMaxLevel,,cTreeID, 1)
				//Else
					//MATRKSC7( ( cAliasQry )->C7_NUM + ( cAliasQry )->C7_ITEM, @oTree, , @nLevel, nMaxLevel,,cTreeID, 1)
				//EndIf
				MATRKCN9( ( cAliasQry )->CN9_NUMERO + ( cAliasQry )->CN9_REVISA, @oTree, , @nLevel, nMaxLevel,,cTreeID, 1)
				( cAliasQry )->( dbSkip() )
			EndIf
			
		Endif
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Exclui a area de trabalho da query                           Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		dbSelectArea( cAliasQry )
		dbCloseArea()
		
		dbSelectArea( "SC8" )
			
	EndIf
	
EndIf

Return( .T. )
/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFuncao    Ё MATRKSC9 Ё Autor Ё Paulo Augusto         Ё Data Ё12/04/2002Ё╠╠
╠╠цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o Ё Monta as pastas da Liberacao de Pedido                     Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁSintaxe   Ё MATRKSC9( ExpC1, @ExpO1, [ ExpC2 ], @ExpN1, ExpN2, ExpL1)  Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁRetorno   Ё Nenhum                                                     Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁParametrosЁ ExpC1 -> Chave de pesquisa                                 Ё╠╠
╠╠Ё          Ё ExpO2 -> Objeto Tree                                       Ё╠╠
╠╠Ё          Ё ExpC3 -> String a adicionar ao texto do item ( tree )      Ё╠╠
╠╠Ё          Ё ExpN4 -> Nivel                                             Ё╠╠
╠╠Ё          Ё ExpN5 -> Nivel maximo                                      Ё╠╠
╠╠Ё          Ё ExpL6 -> Indica se deve expandir os itens ou cabecalhos    Ё╠╠
╠╠Ё          Ё ExpC7 -> Numero do pedido de venda                         Ё╠╠
╠╠Ё          Ё ExpA8 -> Array utilizado pelos remitos                     Ё╠╠
╠╠цддддддддддедддддддддддддддбдддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё   DATA   Ё Programador   ЁManutencao Efetuada                         Ё╠╠
╠╠цддддддддддедддддддддддддддедддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё          Ё               Ё                                            Ё╠╠
╠╠юддддддддддадддддддддддддддадддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/

Function MATRKSC9( cChaveNF, oTree, cAddString, nLevel, nMaxLevel, lRemito,cNumPed,aTree, cTreeID)

LOCAL cPedido   	:= ""
LOCAL cItemPed  	:= ""
LOCAL cSeqLib		:= ""
LOCAL cRemito	  	:= ""
LOCAL cItemRem		:= ""
LOCAL cSeekREM		:= ""  	//Chave de pesquisa do Remito
LOCAL cSeekNFS		:= ""  	//Chave de pesquisa da Nota Fiscal
LOCAL nRecAnt     := 0
LOCAL cSerieRem   := ""
LOCAL cCliente    := ""
LOCAL cLoja       := ""
LOCAL cProduto    := ""
Local cChave      := ""
Local cNrSerItRem := ""
Local cNomeArq   := ""
Local cIndexKey1 := ""
Local cIndexKey2 := ""
LOCAL cAlQrySD2  := ""

DEFAULT cTreeID   := "000001"
//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Separa os componentes da query                               Ё
//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
cPedido     := Left  ( cChaveNF,  Len( SC9->C9_PEDIDO ) )
cItemPed	:= SubStr( cChaveNF,  Len( cPedido ) + 1, Len( SC9->C9_ITEM ) )
cSeqLib		:= SubStr( cChaveNF,  Len( cPedido ) + Len( cItemPed ) + 1, Len( SC9->C9_SEQUEN ) )
If cPaisLoc<>"BRA"
	cRemito  :=SubStr( cChaveNF,  Len( cPedido ) + Len( cItemPed ) + Len( cSeqLib ) + 1, Len( SC9->C9_REMITO ) )
	cSerieRem:=SubStr( cChaveNF,  Len( cPedido ) + Len( cItemPed ) + Len( cSeqLib ) + Len( cRemito )+1,Len( SC9->C9_SERIREM ) )
	cCliente :=SubStr( cChaveNF,  Len( cPedido ) + Len( cItemPed ) + Len( cSeqLib ) + Len( cRemito )+ Len( SC9->C9_SERIREM )+1, Len( SC9->C9_CLIENTE ) )
	cLoja    :=SubStr( cChaveNF,  Len( cPedido ) + Len( cItemPed ) + Len( cSeqLib ) + Len( cRemito )+ Len( SC9->C9_SERIREM )+ Len( SC9->C9_CLIENTE )+1, Len( SC9->C9_LOJA ) )
	cProduto :=SubStr( cChaveNF,  Len( cPedido ) + Len( cItemPed ) + Len( cSeqLib ) + Len( cRemito )+ Len( SC9->C9_SERIREM )+ Len( SC9->C9_CLIENTE )+ Len( SC9->C9_LOJA )+1,Len( SC9->C9_PRODUTO ) )
	cItemRem	:=SubStr( cChaveNF,  Len( cPedido ) + Len( cItemPed ) + Len( cSeqLib ) + Len( cRemito )+ Len( SC9->C9_SERIREM )+ Len( SC9->C9_CLIENTE )+ Len( SC9->C9_LOJA )+Len( SC9->C9_PRODUTO )+1,Len(SC9->C9_ITEMREM) )
EndIf

cNrSerItRem :=cRemito+cSerieRem+cItemRem

If nLevel <= nMaxLevel .And. ValType( aTree ) == "A"
	AAdd(aTree,{cpedido,cItemPed,cSeqLib})
EndIf

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Alimenta os Remitos deste pedido / item - Localizacoes  Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
If cPaisLoc <>"BRA"
	If nLevel <= nMaxLevel
		If !Empty(cNrSerItRem)
			aStruTRB := {}
			AADD(aStruTRB,{"D2_FILIAL" ,"C",TamSX3("D2_FILIAL")[1] ,TamSX3("D2_FILIAL")[2]})
			AADD(aStruTRB,{"D2_DOC"    ,"C",TamSX3("D2_DOC")[1]    ,TamSX3("D2_DOC")[2]})
			AADD(aStruTRB,{"D2_ITEM"   ,"C",TamSX3("D2_ITEM")[1]   ,TamSX3("D2_ITEM")[2]})
			AADD(aStruTRB,{"D2_SERIE"  ,"C",TamSX3("D2_SERIE")[1]  ,TamSX3("D2_SERIE")[2]})
			AADD(aStruTRB,{"D2_CLIENTE","C",TamSX3("D2_CLIENTE")[1],TamSX3("D2_CLIENTE")[2]})
			AADD(aStruTRB,{"D2_LOJA"   ,"C",TamSX3("D2_LOJA")[1]   ,TamSX3("D2_LOJA")[2]})
			AADD(aStruTRB,{"D2_COD"    ,"C",TamSX3("D2_COD")[1]    ,TamSX3("D2_COD")[2]})
			AADD(aStruTRB,{"D2_REMITO" ,"C",TamSX3("D2_REMITO")[1] ,TamSX3("D2_REMITO")[2]})
			AADD(aStruTRB,{"D2_ITEMREM","C",TamSX3("D2_ITEMREM")[1],TamSX3("D2_ITEMREM")[2]})
			AADD(aStruTRB,{"D2_SERIREM","C",TamSX3("D2_SERIREM")[1],TamSX3("D2_SERIREM")[2]})
			AADD(aStruTRB,{"D2_PEDIDO" ,"C",TamSX3("D2_PEDIDO")[1] ,TamSX3("D2_PEDIDO")[2]})
			AADD(aStruTRB,{"D2_ITEMPV" ,"C",TamSX3("D2_ITEMPV")[1] ,TamSX3("D2_ITEMPV")[2]})
			AADD(aStruTRB,{"D2_TIPODOC","C",TamSX3("D2_TIPODOC")[1],TamSX3("D2_TIPODOC")[2]})
			
			lQuery := .T.
			
			cNomeArq := CriaTrab( aStruTRB )
			
			cIndexKey1 := "D2_FILIAL+D2_DOC+D2_SERIE+D2_ITEM"
			cIndexKey2 := "D2_FILIAL+D2_LOJA+D2_REMITO+D2_ITEMREM+D2_SERIREM"
			DbUseArea(.T.,__LocalDriver,cNomeArq,"TRB",.T.,.F.)
			OrdCreate(cNomeArq,Substr(cNomeArq,2,Len(cNomeArq))+"1",cIndexKey1,{|| cIndexKey1 },.F.)
			OrdCreate(cNomeArq,Substr(cNomeArq,2,Len(cNomeArq))+"2",cIndexKey2,{|| cIndexKey2 },.F.)
			
			//VERIFICA SE EXISTE REMITO PARA O PEDIDO  E NF PARA O REMITO
			cAlQrySD2 := "MTRKSC6SD2"
			cQuery := ""
			cQuery += "SELECT D2_FILIAL, D2_DOC, D2_ITEM, D2_SERIE, D2_CLIENTE, D2_LOJA,  D2_COD, D2_REMITO, D2_ITEMREM, D2_SERIREM, D2_PEDIDO, D2_ITEMPV, D2_TIPODOC "
			cQuery += "FROM " + RetSqlName( "SD2" ) + " "
			cQuery += "WHERE "
			cQuery += "D2_FILIAL='" + xFilial( "SD2" ) + "' AND "
			cQuery += "D2_PEDIDO='" + cPedido          + "' AND "
			cQuery += "D2_ITEMPV='" + cItemPed         + "' AND "
			cQuery += "D2_DOC='" + cRemito   + "' AND "
			cQuery += "D2_SERIE='" + cSerieRem   + "' AND "
			cQuery += "D2_ITEM='" + cItemRem   + "' AND "
			cQuery += "D2_TIPODOC>='" + "50"   + "' AND "
			cQuery += "D_E_L_E_T_=' ' "
			cQuery += " UNION ALL "
			cQuery += "SELECT D2_FILIAL, D2_DOC, D2_ITEM, D2_SERIE, D2_CLIENTE, D2_LOJA,  D2_COD, D2_REMITO, D2_ITEMREM, D2_SERIREM, D2_PEDIDO, D2_ITEMPV, D2_TIPODOC "
			cQuery += "FROM " + RetSqlName( "SD2" ) + " "
			cQuery += "WHERE "
			cQuery += "D2_FILIAL='" + xFilial( "SD2" ) + "' AND "
			cQuery += "D2_REMITO='" + cRemito   + "' AND "
			cQuery += "D2_SERIREM='" + cSerieRem   + "' AND "
			cQuery += "D2_ITEMREM='" + cItemRem   + "' AND "
			cQuery += "D2_TIPODOC<'" + "50"   + "' AND "
			cQuery += "D_E_L_E_T_=' ' "
			
			cQuery += " ORDER BY "+ SqlOrder(cIndexKey1)
			
			Processa({|lEnd| SqlToTrb(cQuery, aStruTRB, 'TRB' )},,STR0049)
			
			TRB->( DbSetOrder( 2 ) )
			TRB->( DbGoTop())
			While ! TRB->( Eof() )
				
				If TRB->D2_SERIE<>cSerieRem
					TRB->( dbSkip() )
					Loop
				EndIf
				
				oTree:TreeSeek( Pad( "SC6-" + cNumPed, 50 )+cTreeID )
				cImageSD2 := MaEntImage( "SD2", 1 )
				MATRKSD2( TRB->D2_DOC + TRB->D2_SERIE + TRB->D2_CLIENTE +TRB->D2_LOJA + TRB->D2_COD +;
				TRB->D2_ITEM,@oTree, , @nLevel, nMaxLevel,,cTreeID )
				cChave:=TRB->D2_DOC + TRB->D2_SERIE + TRB->D2_CLIENTE +TRB->D2_LOJA + TRB->D2_COD +TRB->D2_ITEM
				nRecAnt := TRB->( Recno() ) //GUARDA POSICIONAMENTO NO TRB
				
				//VERIFICA NO TRB SE EXISTE NF PARA O REMITO
				TRB->( DbSetOrder( 1 ) )     //  FILIAL+LOJA+REMITO+ITEMREMITO+SERIEREMITO
				TRB->( DbGoTop())
				cSeekNFS := xFilial( "TRB" ) + TRB->D2_LOJA + TRB->D2_DOC + TRB->D2_ITEM + TRB->D2_SERIE
				
				If TRB->(dbSeek( cSeekNFS ))
					
					nLevel++
					
					While !TRB->( Eof() ) .And. cSeekNFS == xFilial("TRB")+TRB->D2_LOJA+TRB->D2_REMITO+;
						TRB->D2_ITEMREM+TRB->D2_SERIREM
						
						If TRB->D2_TIPODOC >="50"
							TRB->( dbSkip() )
							Loop
						EndIf
						
						oTree:TreeSeek( Pad( "SD2-" + cChave, 50 )+cTreeID )
						cImageSD2 := MaEntImage( "SD2", 1 )
						
						MATRKSD2( TRB->D2_DOC + TRB->D2_SERIE + TRB->D2_CLIENTE +TRB->D2_LOJA +TRB->D2_COD +;
						TRB->D2_ITEM,@oTree, , @nLevel, nMaxLevel,,cTreeID )
						
						TRB->( DbSetOrder( 2 ) )
						TRB->( dbSkip() )
						
					End
					
					nLevel--
				EndIf
				
				//Reposiciona o TRB
				TRB->( DbSetOrder( 1 ) )
				TRB->( MsGoto( nRecAnt ) )
				TRB->( dbSkip() )
			End
			
			//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
			//Ё Exclui a area de trabalho da query                           Ё
			//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
			dbSelectArea( "TRB" )
			dbCloseArea()
			cNomeArq += ".DBF"
			FErase( cNomeArq += ".DBF" )
			FErase( cNomeArq + OrdBagExt() )
		EndIf
			
			// VERIFICA SE EXISTE NFISCAL SEM REMITO PARA O PEDIDO NO SD2
			dbSelectArea( "SD2" )
			cAlQrySD2 := "MTRKSC6SD2"
			cQuery := ""
			cQuery += "SELECT D2_DOC, D2_SERIE, D2_CLIENTE, D2_LOJA, D2_ITEM, D2_COD "
			cQuery += "FROM " + RetSqlName( "SD2" ) + " "
			cQuery += "WHERE "
			cQuery += "D2_FILIAL='" + xFilial( "SD2" ) + "' AND "
			cQuery += "D2_PEDIDO='" + cPedido          + "' AND "
			cQuery += "D2_ITEMPV='" + cItemPed         + "' AND "
			cQuery += "D2_REMITO='" + Space(Len(cRemito))   + "' AND "
			cQuery += "D2_TIPODOC<'" + "50"   + "' AND "
			cQuery += "D_E_L_E_T_=' ' "
			cQuery += "ORDER BY D2_DOC, D2_SERIE, D2_ITEM"
			cQuery := ChangeQuery( cQuery )
			
			dbUseArea( .T., "TOPCONN", TcGenQry( , , cQuery ), cAlQrySD2, .F., .T. )
			
			nLevel--
			
			While !( cAlQrySD2 )->( Eof() )
				oTree:TreeSeek( Pad( "SC6-" + cNumPed, 50 )+cTreeID )
				cImageSD2 := MaEntImage( "SD2", 1 )
				MATRKSD2( ( cAlQrySD2 )->D2_DOC + ( cAlQrySD2 )->D2_SERIE + ( cAlQrySD2 )->D2_CLIENTE +;
				( cAlQrySD2 )->D2_LOJA + ( cAlQrySD2 )->D2_COD +;
				( cAlQrySD2 )->D2_ITEM, @oTree, , @nLevel, nMaxLevel,,cTreeID )
				( cAlQrySD2 )->( dbSkip() )
			End
			
			nLevel++
			//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
			//Ё Exclui a area de trabalho da query                           Ё
			//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
			dbSelectArea( cAlQrySD2 )
			dbCloseArea()
			dbSelectArea( "SD2" )
	EndIf
EndIf
Return()

/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFuncao    Ё MATRKABC Ё Autor Ё Eduardo Riera         Ё Data Ё11/06/2002Ё╠╠
╠╠цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o Ё Monta as pastas das despesas financeiras                   Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁSintaxe   Ё MATRKABC( ExpC1, @ExpO1, [ ExpC2 ], @ExpN1, [ ExpN2 ] )    Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁRetorno   Ё Nenhum                                                     Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁParametrosЁ ExpC1 -> Chave de pesquisa                                 Ё╠╠
╠╠Ё          Ё ExpO1 -> Objeto Tree                                       Ё╠╠
╠╠Ё          Ё ExpC2 -> String a adicionar ao texto do item ( tree )      Ё╠╠
╠╠Ё          Ё ExpN1 -> Nivel                                             Ё╠╠
╠╠Ё          Ё ExpN2 -> Nivel maximo                                      Ё╠╠
╠╠цддддддддддедддддддддддддддбдддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё   DATA   Ё Programador   ЁManutencao Efetuada                         Ё╠╠
╠╠цддддддддддедддддддддддддддедддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё          Ё               Ё                                            Ё╠╠
╠╠юддддддддддадддддддддддддддадддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/

Function MATRKABC( cKeyDesp, oTree, cAddString, nLevel, nMaxLevel, lItem, cTreeID )

LOCAL cImageABC := ""
LOCAL cImageSE2 := ""

DEFAULT nMaxLevel := 1000000
DEFAULT cTreeID   := "000001"

cAddString := If( ValType( cAddString ) == "C", cAddString, "" )
nLevel++
If nLevel <= nMaxLevel
	
	ABC->( DbSetOrder( 1 ) )
	If ABC->( DbSeek( xFilial( "ABC" ) + cKeyDesp ) )
		
		cImageABC := MaEntImage( "ABC", 1 )
		
		oTree:AddItem( Pad( STR0040+ABC->ABC_ITEM+")", 100 ), Pad( "ABC-" + cKeyDesp, 50 )+cTreeID,cImageABC,cImageABC,,,2) //"Despesa Finaceira ("
		
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Cria os orcamentos criados pelos laudos                                Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		If !Empty( ABC->ABC_NUMERO )
			nLevel++
			If nLevel <= nMaxLevel
				cImageABC := MaEntImage( "SE2", 1 )
				oTree:TreeSeek( Pad( "ABC-" + cKeyDesp, 50 )+cTreeID )
				SE2->( DbSetOrder( 1 ) )
				If SE2->( DbSeek( xFilial( "SE2" ) + ABC->ABC_PREFIX + ABC->ABC_NUMERO + ABC->ABC_PARCEL + ABC->ABC_TIPO + ABC->ABC_CODFOR + ABC->ABC_LOJFOR ) )
					oTree:AddItem( Pad( STR0041+RetTitle("ABC_NUMERO")+": "+ABC->ABC_PREFIX + ABC->ABC_NUMERO + ABC->ABC_PARCEL + ABC->ABC_TIPO + RetTitle("ABC_CODFOR")+": " + ABC->ABC_CODFOR + ABC->ABC_LOJFOR, 100 ), Pad( "SE2-" + ABC->ABC_PREFIX + ABC->ABC_NUMERO + ABC->ABC_PARCEL + ABC->ABC_TIPO + ABC->ABC_CODFOR + ABC->ABC_LOJFOR, 50 )+cTreeID,cImageSE2,cImageSE2,,,2) //"Contas a Pagar - "
				EndIf
			EndIf
			nLevel--
		EndIf
	EndIf
	
EndIf

nLevel--

Return

/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFuncao    Ё MATRKSD1 Ё Autor Ё Aline Correa do Vale  Ё Data Ё05/06/2003Ё╠╠
╠╠цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o Ё Monta as pastas de itens de NF de Entrada                  Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁSintaxe   Ё MATRKSD1( ExpC1, @ExpO1, [ ExpC2 ], @ExpN1, [ ExpN2 ] )    Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁRetorno   Ё Nenhum                                                     Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁParametrosЁ ExpC1 -> Chave de pesquisa                                 Ё╠╠
╠╠Ё          Ё ExpO1 -> Objeto Tree                                       Ё╠╠
╠╠Ё          Ё ExpC2 -> String a adicionar ao texto do item ( tree )      Ё╠╠
╠╠Ё          Ё ExpN1 -> Nivel                                             Ё╠╠
╠╠Ё          Ё ExpN2 -> Nivel maximo                                      Ё╠╠
╠╠цддддддддддедддддддддддддддбдддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё   DATA   Ё Programador   ЁManutencao Efetuada                         Ё╠╠
╠╠цддддддддддедддддддддддддддедддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё          Ё               Ё                                            Ё╠╠
╠╠юддддддддддадддддддддддддддадддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/

Function MATRKSD1( cKeyNF, oTree, cAddString, nLevel, nMaxLevel, lItem, cTreeID )

LOCAL cImageSD1 := ""
LOCAL cDoc      := ""
LOCAL cSerie    := ""
LOCAL cItem     := ""
LOCAL cPic      := ""
LOCAL cTrkSeek  := ""
LOCAL lFilEnt  := TRKFILENT()

DEFAULT nMaxLevel := 1000000
DEFAULT cTreeID   := "000001"

nLevel++

If nLevel <= nMaxLevel
	
	SD1->( DbSetOrder( 1 ) )
	If lFilEnt
		cTrkSeek:= cKeyNF
	Else
		cTrkSeek:= xFilial( 'SD1' ) + cKeyNF
	EndIf

	If SD1->( DbSeek (cTrkSeek) )
		
		cPic      := "@R "
		
		cDoc      := Substr( cKeyNF,TamSX3("D1_FILIAL")[1]+1, Len( SD1->D1_DOC ) )
		cPic      += Replicate( "X", Len( cDoc ) ) + "/"
		cSerie    := SubStr( cKeyNF, Len( cDoc ) + TamSX3("D1_FILIAL")[1]+1, Len( SD1->D1_SERIE ) )
		cPic      += Replicate( "X", Len( cSerie ) )	 + "/"
		cItem     := Right( cKeyNF, Len( SD1->D1_ITEM ) )
		cPic      += Replicate( "X", Len( cItem ) )
		
		cImageSD1 := MaEntImage( "SD1", 1 )
		
		cAddString := If( ValType( cAddString ) == "C", cAddString, "" )
		
		If cPaisLoc <> "BRA"
			If ISRemito(1,"SD1->D1_TIPODOC")
				if lFilEnt
					cKeyNF:= SubStr(cKeyNF,len(xFilial("SD1"))+1,len(cKeyNF))
				EndIf
				MaTrkSCM(cKeyNF,oTree,cAddString,nLevel,nMaxLevel,.T.,cTreeID)
			Else
				If Empty(SD1->D1_REMITO)
					oTree:AddItem( Pad( STR0038 + Transform( cDoc + cSerie + ; //"Nota fiscal/Serie/Item - "
					cItem, cPic ) + cAddString, 100 ), Pad( "SD1-" + Subs(cKeyNF,len(xFilial('SD1'))+1,len(cKeynf)), 50 )+cTreeID,cImageSD1,cImageSD1,,,nLevel)
					If Ascan(_aFatLoc,cKeyNF)==0
						Aadd(_aFatLoc,cKeyNF)
					Endif
				Endif
			Endif
		Else
			oTree:AddItem( Pad( STR0038 + Transform( cDoc + cSerie + ; //"Nota fiscal/Serie/Item - "
			cItem, cPic ) + cAddString, 100 ), Pad( "SD1-" + cKeyNF, 50 )+cTreeID,cImageSD1,cImageSD1,,,nLevel)
		EndIf
		
	EndIf
	
EndIf

nLevel--

Return(.T.)

/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFuncao    Ё MATRKSF1 Ё Autor Ё Aline Correa do Vale  Ё Data Ё05/06/2003Ё╠╠
╠╠цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o Ё Monta as pastas da nota fiscal de entrada ( cabecalho )    Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁSintaxe   Ё MATRKSF1( ExpC1, @ExpO1, [ ExpC2 ], @ExpN1, ExpN2, ExpL1)  Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁRetorno   Ё Nenhum                                                     Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁParametrosЁ ExpC1 -> Chave de pesquisa                                 Ё╠╠
╠╠Ё          Ё ExpO1 -> Objeto Tree                                       Ё╠╠
╠╠Ё          Ё ExpC2 -> String a adicionar ao texto do item ( tree )      Ё╠╠
╠╠Ё          Ё ExpN1 -> Nivel                                             Ё╠╠
╠╠Ё          Ё ExpN2 -> Nivel maximo                                      Ё╠╠
╠╠Ё          Ё ExpL1 -> Indica se deve expandir os itens ou cabecalhos    Ё╠╠
╠╠цддддддддддедддддддддддддддбдддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё   DATA   Ё Programador   ЁManutencao Efetuada                         Ё╠╠
╠╠цддддддддддедддддддддддддддедддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё          Ё               Ё                                            Ё╠╠
╠╠юддддддддддадддддддддддддддадддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/

Function MATRKSF1( cChaveNF, oTree, cAddString, nLevel, nMaxLevel, lItem, cTreeID )

LOCAL cFornece  := ""
LOCAL cLoja     := ""
LOCAL cDoc      := ""
LOCAL cSerie    := ""
LOCAL cImageSE2 := ""
LOCAL cImageSF1 := ""
LOCAL cTrkSeek	:= ""
LOCAL lFilEnt	:= TRKFILENT()	
LOCAL cQuery    := ""
LOCAL cAliasQry := ""

DEFAULT nMaxLevel := 1000000
DEFAULT lItem     := (cPaisLoc=="BRA") 
DEFAULT cTreeID   := "000001"

SF1->( DbSetOrder( 1 ) )
If lFilEnt
	cTrkSeek:= Left(cChaveNF,Len(SF1->(F1_FILIAL+F1_DOC+F1_SERIE+F1_FORNECE+F1_LOJA)))
Else	
	cTrkSeek:= xFilial( "SF1" ) + Left(cChaveNF,Len(SF1->(F1_DOC+F1_SERIE+F1_FORNECE+F1_LOJA)))
EndIf 

If SF1->( DbSeek (cTrkSeek) )
	//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//Ё Separa os componentes da query                               Ё
	//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
	If lFilEnt
		cDoc     := SubStr( cChaveNF,TamSx3("F1_FILIAL")[1]+1,Len( SF1->F1_DOC ) )
		cSerie   := SubStr( cChaveNF, Len( cDoc ) + TamSx3("F1_FILIAL")[1]+1, Len( SF1->F1_SERIE ) )
		cFornece := SubStr( cChaveNF, Len( cDoc ) + Len( cSerie ) + TamSx3("F1_FILIAL")[1]+1, Len( SF1->F1_FORNECE ) )
		cLoja    := SubStr( cChaveNF, Len( cDoc ) + Len( cSerie ) + Len( cFornece ) + TamSx3("F1_FILIAL")[1]+1, Len( SF1->F1_LOJA ) )
	Else
		cDoc     := Left( cChaveNF,  Len( SF1->F1_DOC ) )
		cSerie   := SubStr( cChaveNF, Len( cDoc ) + 1, Len( SF1->F1_SERIE ) )
		cFornece := SubStr( cChaveNF, Len( cDoc ) + Len( cSerie ) + 1, Len( SF1->F1_FORNECE ) )
		cLoja    := SubStr( cChaveNF, Len( cDoc ) + Len( cSerie ) + Len( cFornece ) + 1, Len( SF1->F1_LOJA ) )
	EndIf
	
	nLevel++
	
	If nLevel <= nMaxLevel
		
		cAddString := If( ValType( cAddString ) == "C", cAddString, "" )
		
		cImageSF1 := MaEntImage( "SF1", 1 )
		
		If cPaisLoc <> "BRA"
			If ISRemito(1,"SF1->F1_TIPODOC")
				MaTrkSCM(cDoc+cSerie+cFornece+cLoja,oTree,cAddString,nLevel,nMaxLevel,.F.,cTreeID)
			Else
				If !oTree:TreeSeek(Pad("SF1-"+cChaveNF,50)+cTreeID)
					oTree:AddItem( Pad( STR0056 + cDoc + "/" + cSerie + ;   //"Nota fiscal de entrada / Serie - "
					cAddString, 100 ), Pad( "SF1-" + cChaveNF, 50 )+cTreeID, cImageSF1, cImageSF1,,,nLevel)
				Endif
			Endif
		Else
			oTree:AddItem( Pad( STR0056 + cDoc + "/" + cSerie + ;   //"Nota fiscal de entrada / Serie - "
			cAddString, 100 ), Pad( "SF1-" + cChaveNF , 50 )+cTreeID, cImageSF1, cImageSF1,,,nLevel)
		EndIf
		
		If lItem
			
			//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
			//Ё Alimenta os itens deste pedido                               Ё
			//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
			
			cAliasQry := GetNextAlias()
			
			cQuery := ""
			
			If lFilEnt				
				cQuery += "SELECT D1_FILIAL,D1_DOC,D1_SERIE,D1_ITEM,D1_FORNECE,D1_LOJA "
   			Else
				cQuery += "SELECT D1_DOC,D1_SERIE,D1_ITEM,D1_FORNECE,D1_LOJA "
                EndIf
				cQuery += "FROM " + RetSqlName( "SD1" ) + " "
				cQuery += "WHERE "
				cQuery += "D1_FILIAL='" + xFilial( "SD1" ) + "' AND "
				cQuery += "D1_DOC='"    + cDoc     + "' AND "
				cQuery += "D1_SERIE='"  + cSerie   + "' AND " 
				cQuery += "D1_FORNECE='"+ cFornece + "' AND " 
				cQuery += "D1_LOJA='"   + cLoja    + "' AND " 
				cQuery += "D_E_L_E_T_=' '" 
			
			cQuery := ChangeQuery( cQuery )
			
			dbUseArea( .T., "TOPCONN", TcGenQry( , , cQuery ), cAliasQry, .F., .T. )
			
			oTree:TreeSeek( Pad( "SD1-" + cChaveNF , 50 )+cTreeID )
			
			cImageSD1 := MaEntImage( "SD1", 1 )
			
			While !( cAliasQry )->( Eof() )
				
				If cPaisLoc <> "BRA"  .AND. ISRemito(1,"SF1->F1_TIPODOC")
					//"Remito/Serie/Item - "
					oTree:AddItem( Pad( GetDescRem() + ( cAliasQry )->D1_DOC + "/" + ( cAliasQry )->D1_SERIE + "/" + ( cAliasQry )->D1_ITEM + ;
					cAddString, 100 ), Pad( "SD1-" + ( cAliasQry )->D1_DOC + ( cAliasQry )->D1_SERIE + ( cAliasQry )->D1_FORNECE + ;
					( cAliasQry )->D1_LOJA + ( cAliasQry )->D1_ITEM, 50 )+cTreeID,cImageSD1,cImageSD1,,,nLevel)
				Else
					//"N.F./Serie/Item - "
					If lFilEnt
						oTree:AddItem( Pad( STR0018 +( cAliasQry )->D1_DOC + "/" + ( cAliasQry )->D1_SERIE + "/" + ( cAliasQry )->D1_ITEM + ;
						cAddString, 100 ), Pad( "SD1-" + ( cAliasQry )->D1_FILIAL + ( cAliasQry )->D1_DOC + ( cAliasQry )->D1_SERIE + ( cAliasQry )->D1_FORNECE + ;
						( cAliasQry )->D1_LOJA + ( cAliasQry )->D1_ITEM, 50 )+cTreeID,cImageSD1,cImageSD1,,,nLevel)
					Else
						oTree:AddItem( Pad( STR0018 +( cAliasQry )->D1_DOC + "/" + ( cAliasQry )->D1_SERIE + "/" + ( cAliasQry )->D1_ITEM + ;
						cAddString, 100 ), Pad( "SD1-" + ( cAliasQry )->D1_DOC + ( cAliasQry )->D1_SERIE + ( cAliasQry )->D1_FORNECE + ;
						( cAliasQry )->D1_LOJA + ( cAliasQry )->D1_ITEM, 50 )+cTreeID,cImageSD1,cImageSD1,,,nLevel)						
					EndIf
				EndIf
				
				( cAliasQry )->( dbSkip() )
			End
			
			//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
			//Ё Exclui a area de trabalho da query                           Ё
			//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
			dbSelectArea( cAliasQry )
			dbCloseArea()
			
			dbSelectArea( "SD1" )
				
		Else
			
			//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
			//Ё Alimenta os titulos desta NF                                 Ё
			//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
			
			nLevel++
			
			If nLevel <= nMaxLevel
				
				cAliasQry := GetNextAlias()
				
				cQuery := ""
				
				If lFilEnt
					cQuery += "SELECT E2_FILIAL,E2_PREFIXO,E2_NUM,E2_PARCELA,E2_FORNECE,E2_LOJA,E2_TIPO "
					cQuery += "FROM " + RetSqlName( "SE2" ) + " "
					cQuery += "WHERE "
					If FWModeAccess("SF1") == "E" .And. FWModeAccess("SE2") == "E"
						cQuery += "E2_FILIAL='" + Substr(cChaveNF,1,TamSx3("E2_FILIAL")[1]) + "' AND "
					Else
						cQuery += "E2_FILIAL='" + xFilial("SE2") + "' AND "						
					EndIf
				Else					
					cQuery += "SELECT E2_PREFIXO,E2_NUM,E2_PARCELA,E2_FORNECE,E2_LOJA,E2_TIPO "
					cQuery += "FROM " + RetSqlName( "SE2" ) + " "
					cQuery += "WHERE "
					cQuery += "E2_FILIAL='" + xFilial( "SE2" ) + "' AND "
				EndIf
				cQuery += "E2_NUM='"    + cDoc	             + "' AND "
				cQuery += "E2_PREFIXO='"+&(SuperGetMv("MV_2DUPREF"))+"' AND "
				cQuery += "E2_FORNECE='"+ cFornece         + "' AND "
				cQuery += "E2_LOJA='"   + cLoja            + "' AND "
				cQuery += "D_E_L_E_T_=' ' "
				
				cQuery := ChangeQuery( cQuery )					
				
				dbUseArea( .T., "TOPCONN", TcGenQry( , , cQuery ), cAliasQry, .F., .T. )
				
				oTree:TreeSeek( Pad( "SF1-" + cChaveNF , 50 )+cTreeID )
				
				cImageSE2 := MaEntImage( "SE2", 1 )
				
				While !( cAliasQry )->( Eof() )
					
					dbSelectArea( cAliasQry )
					cKey := Pad( "SE2-" + E2_PREFIXO + E2_NUM + E2_PARCELA + E2_FORNECE + E2_LOJA + E2_TIPO, 50 )
					
					If cPaisLoc<>"BRA"
						If !oTree:TreeSeek(cKey)
							If lFilEnt
								oTree:AddItem( Pad( STR0113 +; //"Titulo - Fornecedor/Loja/Prefixo/Numero/Parcela/Tipo - "
								E2_FORNECE + "/" + E2_LOJA + "/" + E2_PREFIXO + "/" + E2_NUM + "/" + E2_PARCELA + "/" + E2_TIPO, 100 ),;
								Pad( "SE2-" + E2_FILIAL + E2_FORNECE + E2_LOJA + E2_PREFIXO + E2_NUM + E2_PARCELA + E2_TIPO, 50 )+cTreeID, cImageSE2 ,cImageSE2,,,nLevel)
							Else
								oTree:AddItem( Pad( STR0113 +; //"Titulo - Fornecedor/Loja/Prefixo/Numero/Parcela/Tipo - "
								E2_FORNECE + "/" + E2_LOJA + "/" + E2_PREFIXO + "/" + E2_NUM + "/" + E2_PARCELA + "/" + E2_TIPO, 100 ),;
								Pad( "SE2-" + E2_FORNECE + E2_LOJA + E2_PREFIXO + E2_NUM + E2_PARCELA + E2_TIPO, 50 )+cTreeID, cImageSE2 ,cImageSE2,,,nLevel)								
							EndIf
						Endif
					Else
						If lFilEnt
							oTree:AddItem( Pad( STR0113 +; //"Titulo - Fornecedor/Loja/Prefixo/Numero/Parcela/Tipo - "
							E2_FORNECE + "/" + E2_LOJA + "/" + E2_PREFIXO + "/" + E2_NUM + "/" + E2_PARCELA + "/" + E2_TIPO, 100 ),;
							Pad( "SE2-" + E2_FILIAL + E2_FORNECE + E2_LOJA + E2_PREFIXO + E2_NUM + E2_PARCELA + E2_TIPO, 50 )+cTreeID, cImageSE2 ,cImageSE2,,,nLevel)
						Else	
							oTree:AddItem( Pad( STR0113 +; //"Titulo - Fornecedor/Loja/Prefixo/Numero/Parcela/Tipo - "
							E2_FORNECE + "/" + E2_LOJA + "/" + E2_PREFIXO + "/" + E2_NUM + "/" + E2_PARCELA + "/" + E2_TIPO, 100 ),;
							Pad( "SE2-" + E2_FORNECE + E2_LOJA + E2_PREFIXO + E2_NUM + E2_PARCELA + E2_TIPO, 50 )+cTreeID, cImageSE2 ,cImageSE2,,,nLevel)
						EndIf
					Endif
					
					(cAliasQry )->( dbSkip() )
					
				End
				
				//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
				//Ё Exclui a area de trabalho da query                           Ё
				//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
				dbSelectArea( cAliasQry )
				dbCloseArea()
				
				dbSelectArea( "SE2" )
				
			EndIf
			
			nLevel--
			
		EndIf
		
	EndIf
	nLevel--
EndIf

/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFuncao    Ё MATRKSC7 Ё Autor Ё Aline Correa do Vale  Ё Data Ё05/06/2003Ё╠╠
╠╠цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o Ё Monta as pastas de pedidos de compra                       Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁSintaxe   Ё MATRKSC7( ExpC1, @ExpO1, [ ExpC2 ], @ExpN1, [ ExpN2 ] )    Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁRetorno   Ё Nenhum                                                     Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁParametrosЁ ExpC1 -> Chave de pesquisa                                 Ё╠╠
╠╠Ё          Ё ExpO1 -> Objeto Tree                                       Ё╠╠
╠╠Ё          Ё ExpC2 -> String a adicionar ao texto do item ( tree )      Ё╠╠
╠╠Ё          Ё ExpN1 -> Nivel                                             Ё╠╠
╠╠Ё          Ё ExpN2 -> Nivel maximo                                      Ё╠╠
╠╠Ё          Ё ExpN3 -> Tipo - 1 - Pedido / 2 - Autorizacao de entrega    Ё╠╠
╠╠цддддддддддедддддддддддддддбдддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё   DATA   Ё Programador   ЁManutencao Efetuada                         Ё╠╠
╠╠цддддддддддедддддддддддддддедддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё          Ё               Ё                                            Ё╠╠
╠╠юддддддддддадддддддддддддддадддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/

Function MATRKSC7( cNumPed, oTree, cAddString, nLevel, nMaxLevel, lItem, cTreeID, nTipo )

Local cPedido   := ""
Local cItem     := ""
Local cImageSC7 := ""
Local cImageSCR := ""
Local cFilent   := ""
Local cFilSC7   := ""
Local cTrkSeek  := ""
LOCAL lFilEnt	:= TRKFILENT()	
Local cQuery    := ""
Local cAliasQry := ""
Local cImageSD1 := ""

DEFAULT nMaxLevel := 1000000
DEFAULT nTipo     := 1 
DEFAULT cTreeID   := "000001"

If lFilEnt
	SC7->( DbSetOrder( 14 ) )
	cTrkSeek:= cNumPed
Else
	SC7->( DbSetOrder( 1 ) )
	cTrkSeek:= xFilial( "SC7" ) + cNumPed
EndIf

If SC7->( DbSeek (cTrkSeek) )

	If lFilEnt
		cFilSC7   := SC7->C7_FILIAL
		If FwModeAccess("SC7") == "E" .And. FwModeAccess("SD1") == "E"
			cFilEnt   := Substr( cNumPed,1,TamSx3("C7_FILIAL")[1]) 
		Else 
			cFilEnt	  := xFilial("SD1")
		EndIf
	EndIf                                                       
	cPedido   := Substr( cNumPed,TamSx3("C7_FILIAL")[1]+1, Len( SD1->D1_PEDIDO ) ) // Left( cNumPed, Len( SD1->D1_PEDIDO ) )
	cItem     := Right( cNumPed, Len( SD1->D1_ITEMPC ) )
	cImageSC7 := MaEntImage( "SC7", 1 )
	
	nLevel++
	
	If nLevel <= nMaxLevel
		
		cAddString := If( ValType( cAddString ) == "C", cAddString, "" )
		
		If cPaisLoc=="BRA"
			If lFilEnt
				oTree:AddItem( Pad( If(nTipo==1,STR0058,STR0067) + Transform( Substr(cNumPed,TamSx3("C7_FILIAL")[1]+1,10) , "@r XXXXXX/XXXX" ) + ;  //"Pedido/Item - "###"Autorizacao de Entrega/Item - "
				cAddString, 100 ), Pad( "SC7-" + cNumPed , 50 )+cTreeID,cImageSC7,cImageSC7,,,nLevel)
				oTree:TreeSeek( Pad( "SC7-" + cNumPed , 50 )+cTreeID )
			Else
				oTree:AddItem( Pad( If(nTipo==1,STR0058,STR0067) + Transform(Substr(cNumPed,TamSx3("C7_FILIAL")[1]+1,10),  "@r XXXXXX/XXXX" ) + ;  //"Pedido/Item - "###"Autorizacao de Entrega/Item - "
				cAddString, 100 ), Pad( "SC7-" + cNumPed, 50 )+cTreeID,cImageSC7,cImageSC7,,,nLevel)
				oTree:TreeSeek( Pad( "SC7-" + cNumPed, 50 )+cTreeID )
			Endif			
		Endif
		
		nLevel ++

		If nLevel <= nMaxLevel
			
			nLevel--
	
			If cPaisLoc<>"BRA"
				MaTrkSC7Loc(cNumPed,oTree,cAddString,nLevel,nMaxLevel,.T.,cTreeID)
			Else
				//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
				//Ё Alimenta os itens de notas fiscais deste pedido / item       Ё
				//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
				
				cAliasQry := GetNextAlias()
				
				cQuery := ""
				
				If lFilEnt					
					cQuery += "SELECT D1_FILIAL, D1_COD, D1_DOC, D1_SERIE, D1_FORNECE, D1_LOJA, D1_ITEM "
					cQuery += "FROM " + RetSqlName( "SD1" ) + " "
					cQuery += "WHERE "
					cQuery += "D1_FILIAL='" + iif(FWModeAccess("SD1") == "C",xFilial("SD1"),cFilEnt)+"' AND "
					cQuery += "D1_PEDIDO='" + cPedido          + "' AND "
					cQuery += "D1_ITEMPC='" + cItem            + "' AND "
					cQuery += "D_E_L_E_T_=' ' "
					cQuery += "ORDER BY D1_FILIAL, D1_DOC, D1_SERIE, D1_ITEM"
				Else
					cQuery += "SELECT D1_COD, D1_DOC, D1_SERIE, D1_FORNECE, D1_LOJA, D1_ITEM "
					cQuery += "FROM " + RetSqlName( "SD1" ) + " "
					cQuery += "WHERE "
					cQuery += "D1_FILIAL='" + xFilial( "SD1" ) + "' AND "
					cQuery += "D1_PEDIDO='" + cPedido          + "' AND "
					cQuery += "D1_ITEMPC='" + cItem            + "' AND "
					cQuery += "D_E_L_E_T_=' ' "
					cQuery += "ORDER BY D1_DOC, D1_SERIE, D1_ITEM"
				EndIf	
				
				cQuery := ChangeQuery( cQuery )
				
				dbUseArea( .T., "TOPCONN", TcGenQry( , , cQuery ), cAliasQry, .F., .T. )
				
				oTree:TreeSeek( Pad( "SC7-" + cNumPed , 50 )+cTreeID )
				
				cImageSD1 := MaEntImage( "SD1", 1 )
				
				While !( cAliasQry )->( Eof() )
					If lFilEnt	
						MATRKSD1( ( cAliasQry )->D1_FILIAL + ( cAliasQry )->D1_DOC + ( cAliasQry )->D1_SERIE + ( cAliasQry )->D1_FORNECE + ( cAliasQry )->D1_LOJA + ( cAliasQry )->D1_COD + ( cAliasQry )->D1_ITEM, @oTree, , @nLevel, nMaxLevel,,cTreeID )
                    Else
						MATRKSD1( ( cAliasQry )->D1_DOC + ( cAliasQry )->D1_SERIE + ( cAliasQry )->D1_FORNECE + ( cAliasQry )->D1_LOJA + ( cAliasQry )->D1_COD + ( cAliasQry )->D1_ITEM, @oTree, , @nLevel, nMaxLevel,,cTreeID )
                        EndIf
					oTree:TreeSeek( Pad( "SC7-" + cNumPed , 50 )+ cTreeID )
					
					( cAliasQry )->( dbSkip() )
				End
				
				//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
				//Ё Exclui a area de trabalho da query                           Ё
				//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
				dbSelectArea( cAliasQry )
				dbCloseArea()
				
				dbSelectArea( "SD1" )
			EndIf
	

			//здддддддддддддддддддддддддддддддддддддддддддддддддд©
			//Ё Alimenta as liberacoes deste pedido / item       Ё
			//юдддддддддддддддддддддддддддддддддддддддддддддддддды
			
			cAliasQry := GetNextAlias()
			
			cQuery := ""
			
			//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
			//Ё Testa a existencia dos campos CR_SEQUEN,CR_REMITO,CR_SERIREM,CR_ITEMREM,CR_FORNECE,CR_LOJA,CR_PRODUTO Ё
			//Ё para executar o select pois estes campos nao foram incluidos no RELEASE II da versao FASE 3 do Atusx. Ё
			//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды					
			If cPaisLoc<>"BRA"
				cQuery += "SELECT CR_NUM, CR_SEQUEN, CR_REMITO, CR_SERIREM, CR_FORNECE, CR_LOJA,CR_PRODUTO, CR_ITEMREM "
			Else
				cQuery += "SELECT CR_NUM"
			EndIf
			cQuery += " FROM " + RetSqlName( "SCR" ) + " "
			cQuery += " WHERE "
		    If lFilEnt           
				cQuery += "CR_FILIAL='"+ iif(FWModeAccess("SCR") == "C",xFilial("SCR"),cFilSC7)+"' AND "
			Else				
				cQuery += "CR_FILIAL='" + xFilial( "SCR" ) + "' AND "
		    EndIf
			cQuery += "CR_TIPO='PC' AND "
			cQuery += "CR_NUM='"    + cPedido + "' AND "
			cQuery += "D_E_L_E_T_=' ' "
			cQuery += "ORDER BY CR_NUM"
			
			cQuery := ChangeQuery( cQuery )
			
			dbUseArea( .T., "TOPCONN", TcGenQry( , , cQuery ), cAliasQry, .F., .T. )
			
			If lFilEnt
				oTree:TreeSeek( Pad( "SC7-" + Substr(cNumPed,1,TamSx3("C7_FILIAL")[1]+10), 50 )+cTreeID )
			Else					
				oTree:TreeSeek( Pad( "SC7-" + cNumPed, 50 )+cTreeID )				
			EndIf
			
			cImageSCR := MaEntImage( "SCR", 1 )
			
			If lFilEnt
				If !( cAliasQry )->( Eof() )
					oTree:TreeSeek( Pad( "SC7-" +  Substr(cNumPed,1,TamSx3("C7_FILIAL")[1]+10), 50 )+cTreeID )
					MATRKSCR(iif(FWModeAccess("SCR") == "C",xFilial("SCR"),cFilSC7)+"PC" + ( cAliasQry )->CR_NUM , @oTree, , @nLevel, nMaxLevel, NIL, cTreeID )
				EndIf
			Else				
				While  !( cAliasQry )->( Eof() )
					
					oTree:TreeSeek( Pad( "SC7-" + cNumPed, 50 )+cTreeID )

					//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
					//Ё Testa a existencia dos campos CR_SEQUEN,CR_REMITO,CR_SERIREM,CR_ITEMREM,CR_FORNECE,CR_LOJA,CR_PRODUTO Ё
					//Ё para executar MTRKSCR  pois estes campos nao foram incluidos no RELEASE II da versao FASE 3 do Atusx. Ё
					//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды					
					If cPaisLoc<>"BRA" 
						// verificar se tem diferenca da liberacao para outros paises
						MATRKSCR(( cAliasQry )->CR_NUM + ( cAliasQry )->CR_SEQUEN+( cAliasQry )->CR_REMITO+( cAliasQry )->CR_SERIREM+( cAliasQry )->CR_FORNECE+( cAliasQry )->CR_LOJA+( cAliasQry )->CR_PRODUTO+( cAliasQry )->CR_ITEMREM , @oTree, , @nLevel, nMaxLevel,,cTreeID)
					Else
						MATRKSCR( "PC" + ( cAliasQry )->CR_NUM, @oTree, , @nLevel, nMaxLevel, NIL, cTreeID )
					EndIf
					
					( cAliasQry )->( dbSkip() )
				End
			EndIf				
			//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
			//Ё Exclui a area de trabalho da query                           Ё
			//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
			dbSelectArea( cAliasQry )
			dbCloseArea()
			
			dbSelectArea( "SCR" )
				
		EndIf
		
	EndIf

	nLevel--
EndIf

/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFuncao    Ё MATRKSC1 Ё Autor Ё Aline Correa do Vale  Ё Data Ё09/06/2003Ё╠╠
╠╠цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o Ё Monta as pastas de solicitacoes de compra                  Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁSintaxe   Ё MATRKSC1( ExpC1, @ExpO1, [ ExpC2 ], @ExpN1, [ ExpN2 ] )    Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁRetorno   Ё Nenhum                                                     Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁParametrosЁ ExpC1 -> Chave de pesquisa                                 Ё╠╠
╠╠Ё          Ё ExpO1 -> Objeto Tree                                       Ё╠╠
╠╠Ё          Ё ExpC2 -> String a adicionar ao texto do item ( tree )      Ё╠╠
╠╠Ё          Ё ExpN1 -> Nivel                                             Ё╠╠
╠╠Ё          Ё ExpN2 -> Nivel maximo                                      Ё╠╠
╠╠цддддддддддедддддддддддддддбдддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё   DATA   Ё Programador   ЁManutencao Efetuada                         Ё╠╠
╠╠цддддддддддедддддддддддддддедддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё          Ё               Ё                                            Ё╠╠
╠╠юддддддддддадддддддддддддддадддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/

Function MATRKSC1( cNumSC, oTree, cAddString, nLevel, nMaxLevel, lItem, cTreeID )

Local	cImageSC1	:= ""
Local	cTrkSeek	:= ""
Local	cFil 		:= ""
Local	cProdSc	:= ""
Local	cSC  		:= ""
Local	cItSc		:= ""
Local aAreaSC1
Local lFilEnt	:= TRKFILENT()

DEFAULT nMaxLevel := 1000000
DEFAULT cTreeID   := "000001"

SC1->( DbSetOrder( 1 ) ) 
If lFilEnt
   cTrkSeek:= cNumSC
Else 
   cTrkSeek:= xFilial( "SC1" ) + cNumSC
EndIf

If SC1->( DbSeek (cTrkSeek) )
	
	nLevel++
	
	If nLevel <= nMaxLevel
		
		cAddString := If( ValType( cAddString ) == "C", cAddString, "" )
		cImageSC1  := MaEntImage( "SC1", 1 )
		oTree:AddItem( Pad( STR0054 + SC1->C1_FILIAL +"/"+ SC1->C1_NUM +"/"+ SC1->C1_ITEM ,100 ), Pad( "SC1-" + cNumSC, 50 )+cTreeID,cImageSC1,cImageSC1,,,2)
		oTree:TreeSeek( Pad( "SC1-" + cNumSC , 50 )+ cTreeID )
		
		nLevel++
		cFil 	:= SC1->C1_FISCORI
		cProdSc:= SC1->C1_PRODUTO
		cSC  	:= SC1->C1_SCORI
		cItSc	:= SC1->C1_ITSCORI
		SC1->( DbSetOrder( 2 ) )
	
		aAreaSC1:= SC1->(GetArea())
	
		Do While SC1->( DbSeek ( cFil+cProdSc+cSC+cItSc ) )
			oTree:AddItem( Pad( "SC Origem : " + STR0054 + cFil +"/"+ cSC  +"/"+ cItSc ,100 ), Pad( "SC1-" + cFil+cSC+cItSc, 50 )+cTreeID,cImageSC1,cImageSC1,,,2)
			oTree:TreeSeek( Pad( "SC1-" + cFil+cSC+cItSc, 50 ) )
			cFil 	:= SC1->C1_FISCORI
			cProdSc:= SC1->C1_PRODUTO
			cSC  	:= SC1->C1_SCORI
			cItSc  := SC1->C1_ITSCORI
		EndDo
	
		RestArea(aAreaSC1)
		
		oTree:TreeSeek( Pad( "SC1-" + cNumSC , 50 )+ cTreeID )
		
		cFil 	:= SC1->C1_FILIAL
		cProdSc:= SC1->C1_PRODUTO
		cSC  	:= SC1->C1_NUM
		cItSc	:= SC1->C1_ITEM
		SC1->( DbSetOrder( 11 ) )
	
		Do While SC1->( DbSeek ( cFil+cSC+cItSc+cProdSc ) )
			cFil 	:= SC1->C1_FILIAL
			cProdSc:= SC1->C1_PRODUTO
			cSC  	:= SC1->C1_NUM
			cItSc	:= SC1->C1_ITEM
		
			oTree:AddItem( Pad( "SC Centr. : " + STR0054 + cFil +"/"+ cSC  +"/"+ cItSc ,100 ), Pad( "SC1-" + cFil+cSC+cItSc, 50 )+cTreeID,cImageSC1,cImageSC1,,,2)
			oTree:TreeSeek( Pad( "SC1-" + cFil+cSC+cItSc, 50 ) )
		EndDo		
	
		RestArea(aAreaSC1)
		nLevel--
			
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Analisa destino                                              Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		Do Case
			Case !Empty( SC1->C1_COTACAO ) .AND. SC1->C1_COTACAO <> "XXXXXX" .AND. SC1->C1_COTACAO <> "IMPORX" .AND. SC1->C1_COTACAO <> "IMPORT"
				
				cAliasQry := GetNextAlias()
				
				cQuery := ""
				If lFilEnt
					cQuery += "SELECT C8_FILIAL, C8_NUM, C8_FORNECE, C8_LOJA, C8_ITEM, C8_PRODUTO FROM " + RetSqlName( "SC8" ) + " "
					cQuery += "WHERE "
					If FwModeAccess("SC1") == "E" .And. FwModeAccess("SC8") == "E"
						cQuery += "C8_FILIAL='"  + SC1->C1_FILIAL   + "' AND " 
					Else
						cQuery += "C8_FILIAL='"  + xFilial( "SC8" )   + "' AND " 						
					EndIf
				Else
					cQuery += "SELECT C8_NUM, C8_FORNECE, C8_LOJA, C8_ITEM, C8_PRODUTO FROM " + RetSqlName( "SC8" ) + " "
					cQuery += "WHERE "
					cQuery += "C8_FILIAL='"  + xFilial( "SC8" ) + "' AND "
				EndIf										
					cQuery += "C8_PRODUTO='" + SC1->C1_PRODUTO  + "' AND "
					cQuery += "C8_NUM='"     + SC1->C1_COTACAO  + "' AND "
					If Empty(SC1->C1_FLAGGCT)
						cQuery += "C8_NUMPED='"  + SC1->C1_PEDIDO   + "' AND "
						cQuery += "C8_ITEMPED='" + SC1->C1_ITEMPED  + "' AND "
					EndIf					
					cQuery += "D_E_L_E_T_=' '"
				
				cQuery := ChangeQuery( cQuery )
				
				dbUseArea( .T., "TOPCONN", TcGenQry( ,,cQuery ), cAliasQry, .F., .T. )
				
				If !( cAliasQry )->( Eof() )
					If lFilEnt
						oTree:TreeSeek( Pad( "SC1-" + cNumSC , 50 )+cTreeID )
						MATRKSC8( ( cAliasQry )->(C8_FILIAL + C8_NUM + C8_PRODUTO + C8_FORNECE + C8_LOJA), @oTree, , @nLevel, nMaxLevel,,cTreeID ) 
					Else
						oTree:TreeSeek( Pad( "SC1-" + cNumSC, 50 )+cTreeID )
						MATRKSC8( ( cAliasQry )->(C8_NUM + C8_PRODUTO + C8_FORNECE + C8_LOJA), @oTree, , @nLevel, nMaxLevel,,cTreeID ) 
					EndIf
				EndIf
				
			Case !Empty( SC1->C1_PEDIDO )
				
				cAliasQry := GetNextAlias()
				
				cQuery := ""
				
				If lFilEnt 
					cQuery += "SELECT C7_FILIAL, C7_FILENT, C7_NUM, C7_ITEM "
					cQuery += "  FROM " + RetSqlName( "SC7" ) + " "
					cQuery += " WHERE " 												
   					    cQuery += "  C7_FILIAL = '"+iif(!FWModeAccess("SC7") == "E",SC1->C1_FILIAL,xFilial("SC7"))+"' AND "
				Else						
					cQuery += "SELECT C7_NUM, C7_ITEM "
					cQuery += "  FROM " + RetSqlName( "SC7" ) + " "
					cQuery += " WHERE "
					cQuery += " C7_FILIAL='" + xFilial( "SC7" ) + "' AND "					
			    EndIf
			    
  				    cQuery += "C7_NUM='"    + SC1->C1_PEDIDO   + "' AND "
			    cQuery += "C7_ITEM='"   + SC1->C1_ITEMPED  + "' AND "
			    cQuery += "D_E_L_E_T_=' ' "
			    cQuery += "ORDER BY C7_NUM, C7_ITEM"
				
				cQuery := ChangeQuery( cQuery )
				
				dbUseArea( .T., "TOPCONN", TcGenQry( , , cQuery ), cAliasQry, .F., .T. )
				
				If lFilEnt					
					oTree:TreeSeek( Pad( "SC7-" + ( cAliasQry )->C7_FILENT + ( cAliasQry )->C7_NUM, 50 )+cTreeID )
					
					If !( cAliasQry )->( Eof() )
						MATRKSC7( ( cAliasQry )->C7_FILENT + ( cAliasQry )->C7_NUM + ( cAliasQry )->C7_ITEM, @oTree, , @nLevel, nMaxLevel,,cTreeID, 1 )
						( cAliasQry )->( dbSkip() )
					EndIf
				Else
					oTree:TreeSeek( Pad( "SC7-" + SC7->C7_NUM, 50 )+cTreeID )
					
					If !( cAliasQry )->( Eof() )
						MATRKSC7( ( cAliasQry )->C7_NUM + ( cAliasQry )->C7_ITEM, @oTree, , @nLevel, nMaxLevel,,cTreeID, 1 )
						( cAliasQry )->( dbSkip() )
					EndIf
				EndIf
				
				//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
				//Ё Exclui a area de trabalho da query                           Ё
				//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
				dbSelectArea( cAliasQry )
				dbCloseArea()
				
				dbSelectArea( "SC7" )
				
			Otherwise 	

				//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
				//Ё Verifica se foi usado em uma ou mais planilhas               Ё
				//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды

				CNB->( DbSetOrder( 2 ) ) 
				If CNB->( DbSeek( xFilial( "CNB" ) + SC1->C1_NUM + SC1->C1_ITEM ) )
					oTree:TreeSeek( Pad( "SC1-" + cNumSC , 50 )+cTreeID )
					MATRKCNB( CNB->CNB_CONTRA + CNB->CNB_REVISA + CNB->CNB_NUMERO + CNB->CNB_ITEM, @oTree, , @nLevel, nMaxLevel,,cTreeID, 1 )
				EndIf 

		EndCase	
	EndIf
	
	nLevel--
EndIf

Return( .T. )

/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFuncao    Ё MATRKCNB Ё Autor Ё Sergio Silveira       Ё Data Ё21/03/2006Ё╠╠
╠╠цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o Ё Monta as pastas de planilhas de contratos                  Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁSintaxe   Ё MATRKCNB( ExpC1, @ExpO1, [ ExpC2 ], @ExpN1, [ ExpN2 ] )    Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁRetorno   Ё Nenhum                                                     Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁParametrosЁ ExpC1 -> Chave de pesquisa                                 Ё╠╠
╠╠Ё          Ё ExpO1 -> Objeto Tree                                       Ё╠╠
╠╠Ё          Ё ExpC2 -> String a adicionar ao texto do item ( tree )      Ё╠╠
╠╠Ё          Ё ExpN1 -> Nivel                                             Ё╠╠
╠╠Ё          Ё ExpN2 -> Nivel maximo                                      Ё╠╠
╠╠цддддддддддедддддддддддддддбдддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё   DATA   Ё Programador   ЁManutencao Efetuada                         Ё╠╠
╠╠цддддддддддедддддддддддддддедддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё          Ё               Ё                                            Ё╠╠
╠╠юддддддддддадддддддддддддддадддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/

Function MATRKCNB( cKey, oTree, cAddString, nLevel, nMaxLevel, lItem, cTreeID )

Local cImageCNB := ""

DEFAULT nMaxLevel := 1000000
DEFAULT cTreeID   := "000001"

CNB->( DbSetOrder( 1 ) )
If CNB->( DbSeek( xFilial( "CNB" ) + cKey ) )
	
	nLevel++
	
	If nLevel <= nMaxLevel
	
		cContrato := Left( cKey, Len( CNB->CNB_CONTRA ) ) 
		cRevisa   := SubStr( cKey, Len( CNB->CNB_CONTRA ) + 1, Len( CNB->CNB_REVISA ) ) 	                                                      
		cNumero   := SubStr( cKey, Len( CNB->CNB_CONTRA ) + Len( CNB->CNB_REVISA ) + 1, Len( CNB->CNB_NUMERO ) )
		cItem     := Right( cKey, Len( CNB->CNB_ITEM ) ) 
		
		cAddString := If( ValType( cAddString ) == "C", cAddString, "" )
		cImageCNB  := MaEntImage( "CNB", 1 )
		
		oTree:AddItem( Pad( STR0110 + Transform(cKey,"@R XXXXXXXXXXXXXXX/XXX/XXXXXX/XXX") + ; // "Planilha : Contrato / Revisao / Numero / Item - " 
		cAddString, 100 ), Pad( "CNB-" + cKey, 50 )+cTreeID,cImageCNB,cImageCNB,,,nLevel)
		oTree:TreeSeek( Pad( "CNB-" + cKey, 50 )+ cTreeID )
		
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Analisa destino                                              Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Verifica se a planilha possui medicao                        Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		
		cAliasQry := GetNextAlias()
		
		CNE->( DbSetOrder( 1 ) ) 
		
		cQuery := ""
		
		cQuery += "SELECT CNE_CONTRA,CNE_REVISA,CNE_NUMERO,CNE_NUMMED,CNE_ITEM "
		cQuery += "FROM " + RetSqlName( "CNE" ) + " "
		cQuery += "WHERE "
		cQuery += "CNE_CONTRA='"   + cContrato + "' AND "
		cQuery += "CNE_REVISA='"   + cRevisa   + "' AND "
		cQuery += "CNE_NUMERO='"   + cNumero   + "' AND "
		cQuery += "CNE_ITEM='"     + cItem     + "' AND "		
		cQuery += "D_E_L_E_T_=' ' "
		cQuery += "ORDER BY " + SqlOrder( CNE->( IndexKey() ) )
		
		cQuery := ChangeQuery( cQuery )
		
		dbUseArea( .T., "TOPCONN", TcGenQry( , , cQuery ), cAliasQry, .F., .T. )
		
		oTree:TreeSeek( Pad( "CNB-" + cKey, 50 )+cTreeID )	                                                         
	                                
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Rastreia as medicoes da planilha                             Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		While !( cAliasQry )->( Eof() )    
		
			oTree:TreeSeek( Pad( "CNB-" + cKey, 50 )+cTreeID )
		
			MATRKCNE( ( cAliasQry )->CNE_CONTRA + ( cAliasQry )->CNE_REVISA + ( cAliasQry )->CNE_NUMERO + ( cAliasQry )->CNE_NUMMED + ( cAliasQry )->CNE_ITEM, @oTree, , @nLevel, nMaxLevel,,cTreeID, 1 )
			( cAliasQry )->( dbSkip() ) 			
		End
		
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Exclui a area de trabalho da query                           Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		dbSelectArea( cAliasQry )
		dbCloseArea()
		
		dbSelectArea( "CNE" )
		
	EndIf
	
	nLevel--
EndIf

Return( .T. )


/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFuncao    Ё MATRKCNE Ё Autor Ё Sergio Silveira       Ё Data Ё21/03/2006Ё╠╠
╠╠цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o Ё Monta as pastas de medicoes de contratos                   Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁSintaxe   Ё MATRKCNE( ExpC1, @ExpO1, [ ExpC2 ], @ExpN1, [ ExpN2 ] )    Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁRetorno   Ё Nenhum                                                     Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁParametrosЁ ExpC1 -> Chave de pesquisa                                 Ё╠╠
╠╠Ё          Ё ExpO1 -> Objeto Tree                                       Ё╠╠
╠╠Ё          Ё ExpC2 -> String a adicionar ao texto do item ( tree )      Ё╠╠
╠╠Ё          Ё ExpN1 -> Nivel                                             Ё╠╠
╠╠Ё          Ё ExpN2 -> Nivel maximo                                      Ё╠╠
╠╠цддддддддддедддддддддддддддбдддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё   DATA   Ё Programador   ЁManutencao Efetuada                         Ё╠╠
╠╠цддддддддддедддддддддддддддедддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё          Ё               Ё                                            Ё╠╠
╠╠юддддддддддадддддддддддддддадддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/

Function MATRKCNE( cKey, oTree, cAddString, nLevel, nMaxLevel, lItem, cTreeID )

LOCAL cImageCNE  := ""

LOCAL cNumMed    := ""
LOCAL cItem      := ""
LOCAL cContrato  := ""
LOCAL cRevisa    := ""
LOCAL cPlanilha  := ""
LOCAL lFilEnt	 := TRKFILENT()

LOCAL cQuery     := ""
LOCAL cAliasQry  := ""
LOCAL cAliasQry2 := ""

DEFAULT nMaxLevel := 1000000
DEFAULT cTreeID   := "000001"

cContrato := Left( cKey, Len( CNE->CNE_CONTRA ) )
cRevisa   := SubStr( cKey, Len( CNE->CNE_CONTRA ) + 1, Len( CNE->CNE_REVISA ) )
cPlanilha := SubStr( cKey, Len( CNE->CNE_CONTRA ) + Len( CNE->CNE_REVISA ) + 1, Len( CNE->CNE_NUMERO ) )
cNumMed   := SubStr( cKey, Len( CNE->CNE_CONTRA ) + Len( CNE->CNE_REVISA ) + Len( CNE->CNE_NUMERO ) + 1, Len( CNE->CNE_NUMMED ))
cItem     := Right( cKey, Len( CNE->CNE_ITEM ) )

CNE->( DbSetOrder( 1 ) ) 

cAliasQry := GetNextAlias() 

cQuery := ""

If lFilEnt
	cQuery += "SELECT CNE.CNE_FILIAL,CNE.CNE_PEDIDO,CNE.CNE_ITEM,CND.CND_CLIENT " 
Else
	cQuery += "SELECT CNE.CNE_PEDIDO,CNE.CNE_ITEM,CND.CND_CLIENT "
EndIf
cQuery += "FROM " + RetSqlName( "CNE" ) + " CNE , "+RetSQLName( "CND" )+" CND "
cQuery += "WHERE "
cQuery += "CNE.CNE_FILIAL = '"+xFilial("CNE")+"' AND "
cQuery += "CND.CND_FILIAL = '"+xFilial("CND")+"' AND "
cQuery += "CND.CND_NUMMED = CNE.CNE_NUMMED AND "
cQuery += "CND.CND_CONTRA = CNE.CNE_CONTRA AND "
cQuery += "CNE.CNE_NUMMED='" + cNumMed + "' AND "
cQuery += "CNE.CNE_ITEM='"   + cItem   + "' AND "
cQuery += "CNE.D_E_L_E_T_=' ' "

cQuery := ChangeQuery( cQuery )

dbUseArea( .T., "TOPCONN", TcGenQry( , , cQuery ), cAliasQry, .F., .T. )

If !( cAliasQry )->( Eof() )
	
	nLevel++
	
	If nLevel <= nMaxLevel
		
		cAddString := If( ValType( cAddString ) == "C", cAddString, "" )
		cImageCNE  := MaEntImage( "CNE", 1 )
		
		oTree:AddItem( Pad( STR0111 + cNumMed + "/" + cItem + cAddString ,100 ),; // "Medicao / Item - "
							 Pad( "CNE-" + cKey, 50 )+cTreeID,cImageCNE,cImageCNE,,,nLevel)
		oTree:TreeSeek( Pad( "CNE-" + cKey, 50 )+ cTreeID )
		
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Analisa destino                                              Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Verifica os pedidos de compra gerados                        Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		
		oTree:TreeSeek( Pad( "CNE-" + cKey, 50 )+cTreeID )
		
		If !Empty( ( cAliasQry )->CNE_PEDIDO ) 
			cAliasQry2 := GetNextAlias() 

			If Empty( ( cAliasQry )->CND_CLIENT )

				//здддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
				//Ё Identifica o item do pedido de compra                  Ё
				//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддды			
				cQuery := "SELECT SC7.C7_ITEM FROM " + RetSQLName( "SC7" ) + " SC7 WHERE "
				cQuery += "SC7.C7_FILIAL = '" + xFilial("SC7") + "' AND "
				cQuery += "SC7.C7_NUM = '"    + ( cAliasQry )->CNE_PEDIDO + "' AND "
				cQuery += "SC7.C7_ITEMED = '" + ( cAliasQry )->CNE_ITEM + "' AND "
				cQuery += "SC7.D_E_L_E_T_ = ' '"
			
				cQuery := ChangeQuery( cQuery )
				
				dbUseArea( .T., "TOPCONN", TcGenQry( , , cQuery ), cAliasQry2, .F., .T. )


				//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
				//Ё Atualiza arvore do pedido de compra                          Ё
				//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
      		If !( cAliasQry2 )->(Eof())
				If lFilEnt
					MATRKSC7( PadR( ( cAliasQry )->CNE_FILIAL + ( cAliasQry )->CNE_PEDIDO + ( cAliasQry2 )->C7_ITEM, Len( SC7->C7_NUM + SC7->C7_ITEM ) ) , @oTree, , @nLevel, nMaxLevel,,cTreeID, 1 )
				Else
					MATRKSC7( PadR( ( cAliasQry )->CNE_PEDIDO + ( cAliasQry2 )->C7_ITEM, Len( SC7->C7_NUM + SC7->C7_ITEM ) ) , @oTree, , @nLevel, nMaxLevel,,cTreeID, 1 )					
				EndIf
            EndIf
			Else

				//здддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
				//Ё Identifica o item do pedido de compra                  Ё
				//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддды			
				cQuery := "SELECT SC6.C6_ITEM FROM " + RetSQLName( "SC6" ) + " SC6 WHERE "
				cQuery += "SC6.C6_FILIAL = '" + xFilial("SC6") + "' AND "
				cQuery += "SC6.C6_NUM = '"    + ( cAliasQry )->CNE_PEDIDO + "' AND "
				cQuery += "SC6.C6_ITEMED = '" + ( cAliasQry )->CNE_ITEM + "' AND "
				cQuery += "SC6.D_E_L_E_T_ = ' '"
			
				cQuery := ChangeQuery( cQuery )
				
				dbUseArea( .T., "TOPCONN", TcGenQry( , , cQuery ), cAliasQry2, .F., .T. )

				//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
				//Ё Atualiza arvore do pedido de venda                           Ё
				//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
      		If !( cAliasQry2 )->(Eof())
					MATRKSC6( PadR( ( cAliasQry )->CNE_PEDIDO + ( cAliasQry2 )->C6_ITEM, Len( SC6->C6_NUM + SC6->C6_ITEM ) ) , @oTree, , @nLevel, nMaxLevel,,cTreeID, 1 )
				EndIf
			EndIf
			//здддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
			//Ё Finaliza alias do pedido de compra/venda               Ё
			//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддды			
			( cAliasQry2 )->( dbCloseArea() )
		EndIf
		
	EndIf
	
	nLevel--
EndIf      

//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Exclui a area de trabalho da query                           Ё
//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
dbSelectArea( cAliasQry )
dbCloseArea()

dbSelectArea( "CNE" )

Return( .T. )


/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFuncao    Ё MATRKSC3 Ё Autor Ё Aline Correa do Vale  Ё Data Ё16/06/2003Ё╠╠
╠╠цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o Ё Monta as pastas de contrato de parceria                    Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁSintaxe   Ё MATRKSC3( ExpC1, @ExpO1, [ ExpC2 ], @ExpN1, [ ExpN2 ] )    Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁRetorno   Ё Nenhum                                                     Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁParametrosЁ ExpC1 -> Chave de pesquisa                                 Ё╠╠
╠╠Ё          Ё ExpO1 -> Objeto Tree                                       Ё╠╠
╠╠Ё          Ё ExpC2 -> String a adicionar ao texto do item ( tree )      Ё╠╠
╠╠Ё          Ё ExpN1 -> Nivel                                             Ё╠╠
╠╠Ё          Ё ExpN2 -> Nivel maximo                                      Ё╠╠
╠╠цддддддддддедддддддддддддддбдддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё   DATA   Ё Programador   ЁManutencao Efetuada                         Ё╠╠
╠╠цддддддддддедддддддддддддддедддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё          Ё               Ё                                            Ё╠╠
╠╠юддддддддддадддддддддддддддадддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/

Function MATRKSC3( cNumSC, oTree, cAddString, nLevel, nMaxLevel, lItem, cTreeID )

Local cTrkSeek	:= ""
Local lFilEnt	:= TRKFILENT()

DEFAULT nMaxLevel := 1000000

SC3->( DbSetOrder( 1 ) )     

If lFilEnt
	cTrkSeek:= cNumSC
Else	
	cTrkSeek:= xFilial( "SC3" ) + cNumSC
EndIf

If SC3->( DbSeek( cTrkSeek ) )
	
	nLevel++
	
	If nLevel <= nMaxLevel
		
		cAddString := If( ValType( cAddString ) == "C", cAddString, "" )
		cImageSC3  := MaEntImage( "SC3", 1 )
		
		oTree:AddItem( Pad( STR0064 + Transform(IIF(Len(cNumSC)>10,Substr(cNumSC,TamSx3("C3_FILIAL")[1]+1,10),cNumSC),"@R XXXXXX/XXXX") + ; // "Contrato/Item - "
		cAddString, 100 ), Pad( "SC3-" + cNumSC, 50 )+cTreeID,cImageSC3,cImageSC3,,,nLevel)
		oTree:TreeSeek( Pad( "SC3-" + cNumSC, 50 )+cTreeID )

		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Analisa destino                                              Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		If SC3->C3_QUJE > 0
			
			cAliasQry := GetNextAlias()
			
			cQuery := ""
			If lFilEnt				
 				cQuery += "SELECT C7_FILENT,C7_NUMSC,C7_FORNECE,C7_LOJA,C7_NUM,C7_ITEM FROM " + RetSqlName( "SC7" ) + " "
				cQuery += "WHERE "
				cQuery += "C7_FILIAL='"  + SC3->C3_FILIAL   + "' AND "
   			Else
 				cQuery += "SELECT C7_NUMSC,C7_FORNECE,C7_LOJA,C7_NUM,C7_ITEM FROM " + RetSqlName( "SC7" ) + " "
				cQuery += "WHERE "
				cQuery += "C7_FILIAL='"  + xFilial( "SC7" ) + "' AND "
                EndIf
				cQuery += "C7_PRODUTO='" + SC3->C3_PRODUTO  + "' AND "
				cQuery += "C7_NUMSC='"   + SC3->C3_NUM      + "' AND "
				cQuery += "C7_ITEMSC='"  + SC3->C3_ITEM     + "' AND "
				cQuery += "C7_TIPO=2 AND "				
				cQuery += "D_E_L_E_T_=' '"
			
			cQuery := ChangeQuery( cQuery )
			
			dbUseArea( .T., "TOPCONN", TcGenQry( ,,cQuery ), cAliasQry, .F., .T. )
			
			If lFilEnt				
				While !( cAliasQry )->( Eof() )
					MaTrkSC7( ( cAliasQry )->(C7_FILENT+C7_NUM+C7_ITEM), @oTree, , @nLevel, nMaxLevel,,cTreeID, 2 )
					( cAliasQry )->( dbSkip() )
				End 
    		Else
				While !( cAliasQry )->( Eof() )
					MaTrkSC7( ( cAliasQry )->(C7_NUM+C7_ITEM), @oTree, , @nLevel, nMaxLevel,,cTreeID, 2 )
					( cAliasQry )->( dbSkip() )
				End
			EndIf
			
			( cAliasQRY )->( dbCloseArea() ) 
			
			dbSelectArea( "SC7" ) 

		EndIf		
	EndIf
	
	nLevel--
EndIf

Return( .T. )


/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFuncao    Ё MATRKSCR Ё Autor Ё Aline Correa do Vale  Ё Data Ё09/06/2003Ё╠╠
╠╠цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o Ё Monta as pastas de liberacao de pedido de compra           Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁSintaxe   Ё MATRKSCR( ExpC1, @ExpO1, [ ExpC2 ], @ExpN1, [ ExpN2 ] )    Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁRetorno   Ё Nenhum                                                     Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁParametrosЁ ExpCR -> Chave de pesquisa                                 Ё╠╠
╠╠Ё          Ё ExpO1 -> Objeto Tree                                       Ё╠╠
╠╠Ё          Ё ExpC2 -> String a adicionar ao texto do item ( tree )      Ё╠╠
╠╠Ё          Ё ExpN1 -> Nivel                                             Ё╠╠
╠╠Ё          Ё ExpN2 -> Nivel maximo                                      Ё╠╠
╠╠цддддддддддедддддддддддддддбдддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё   DATA   Ё Programador   ЁManutencao Efetuada                         Ё╠╠
╠╠цддддддддддедддддддддддддддедддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё          Ё               Ё                                            Ё╠╠
╠╠юддддддддддадддддддддддддддадддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/

Function MATRKSCR( cNumPed, oTree, cAddString, nLevel, nMaxLevel, lItem, cTreeID )

Local cImageSCR   := ""  
Local lFilEnt	  := TRKFILENT()
Local cSeekSCR    := IIF(lFilEnt,cNumPed,xFilial( "SCR" ) + cNumPed)
DEFAULT nMaxLevel := 1000000
DEFAULT cTreeID   := "000001"

SCR->( DbSetOrder( 1 ) )
If SCR->( DbSeek( cSeekScr ) )
	
	nLevel++

	If lFilEnt
		While !SCR->( Eof() ) .AND. cSeekScr == SCR->CR_FILIAL + SCR->CR_TIPO +Left(SCR->CR_NUM,Len(SCR->(CR_NUM)))
			
			If nLevel <= nMaxLevel
				
				cAddString := If( ValType( cAddString ) == "C", cAddString, "" )
				cImageSCR  := MaEntImage( "SCR", 1 )
				
				oTree:AddItem( Pad( STR0025 +" - "+ Transform( Substr(cNumPed,TamSx3("CR_FILIAL")[1]+1,8) ,"@R XX/XXXXXXXXXX") + ; // "Liberacao"
				cAddString, 100 ), Pad( "SCR-" + Substr(cNumPed,1,10) + SCR->CR_USER, 50 )+cTreeID,cImageSCR,cImageSCR,,,nLevel)
				
			EndIf
			SCR->(dbSkip())
		EndDo
		oTree:TreeSeek( Pad( "SCR-" +  Substr(cNumPed,1,10) , 50 )+cTreeID )  
	Else	
		While !SCR->( Eof() ) .And. cSeekScr == SCR->CR_FILIAL + SCR->CR_TIPO +Left(SCR->CR_NUM,Len(SC7->(C7_NUM)))
			
			If nLevel <= nMaxLevel
				
				cAddString := If( ValType( cAddString ) == "C", cAddString, "" )
				cImageSCR  := MaEntImage( "SCR", 1 )
				
				oTree:AddItem( Pad( STR0025 +" - "+ Transform(cNumPed,"@R XX/XXXXXXXXXX") + ; // "Liberacao"
				cAddString, 100 ), Pad( "SCR-" + cNumPed, 50 )+cTreeID,cImageSCR,cImageSCR,,,nLevel)
				
			EndIf
			SCR->(dbSkip())
		End
		oTree:TreeSeek( Pad( "SCR-" + cNumPed, 50 )+cTreeID )
	EndIf
	
	nLevel--
	
EndIf

Return( .T. )

/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFuncao    ЁMaTrkSC1H Ё Autor Ё Aline Correa do Vale  Ё Data Ё13/06/2003Ё╠╠
╠╠цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o Ё Monta as pastas de solicitacoes de compra simulando Header Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁSintaxe   Ё MaTrkSC1H( ExpC1, @ExpO1, [ ExpC2 ], @ExpN1, [ ExpN2 ] )   Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁRetorno   Ё Nenhum                                                     Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁParametrosЁ ExpC1 -> Chave de pesquisa                                 Ё╠╠
╠╠Ё          Ё ExpO1 -> Objeto Tree                                       Ё╠╠
╠╠Ё          Ё ExpC2 -> String a adicionar ao texto do item ( tree )      Ё╠╠
╠╠Ё          Ё ExpN1 -> Nivel                                             Ё╠╠
╠╠Ё          Ё ExpN2 -> Nivel maximo                                      Ё╠╠
╠╠Ё          Ё ExpL1 -> Indica se exibe os itens                          Ё╠╠
╠╠юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/

Function MaTrkSC1H( cNumSC, oTree, cAddString, nLevel, nMaxLevel, lItem, cTreeID )

Local cImageSC1  := ""                  
Local cCotNValid := Replicate( "X", Len( SC1->C1_COTACAO ) ) 
Local cAliasSC1  := "SC1"
Local cFilialSC1 := ""  
Local cTrkSeek	 := ""
Local lFilEnt	 := TRKFILENT()
Local nLoop    := 0 

Local aNumCot    := {} 
Local cQuery     := "" 
Local cAliasQRY  := ""
Local cAliasCNB  := ""

DEFAULT nMaxLevel := 1000000
DEFAULT lItem     := .T. 
DEFAULT cTreeID   := "000001"

SC1->( DbSetOrder( 1 ) )
If lFilEnt
	cTrkSeek:= cNumSC
Else
	cTrkSeek:= xFilial( "SC1" ) + cNumSC
EndIf

If SC1->( DbSeek( cTrkSeek ) )

	cFilialSC1 := SC1->C1_FILIAL

	nLevel++
	
	If nLevel <= nMaxLevel
		
		cAddString := If( ValType( cAddString ) == "C", cAddString, "" )
		cImageSC1  := MaEntImage( "SC1", 1 )
		
		oTree:AddItem( Pad( STR0053 + Transform(IIF(Len(cNumSC)>6, Substr(cNumSC,TamSx3("C1_FILIAL")[1]+1,6),cNumSC),"@R XXXXXX") + ; // "Solicitacao - "
		cAddString, 100 ), Pad( "SC1-" + cNumSC , 50 )+cTreeID,cImageSC1,cImageSC1,,,nLevel)
		oTree:TreeSeek( Pad( "SC1-" + cNumSC , 50 )+cTreeID )
		
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Analisa destino                                              Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды

		cAliasQry := GetNextAlias()
		
		cQuery := ""
		If lFilEnt
			cQuery += "SELECT C7_FILENT,C7_NUM FROM " + RetSqlName( "SC7" ) + " "
			cQuery += "WHERE "
			
			cQuery += "  C7_FILIAL = '"+iif(!FWModeAccess("SC7") == "E",SC1->C1_FILIAL,xFilial("SC7"))+"' AND "
			cQuery += "C7_NUMSC='" + SC1->C1_NUM  + "' AND "
			
			cQuery += "( C7_NUMCOT='" + Space( Len( SC7->C7_NUMCOT ) ) + "' OR "
			cQuery += "C7_NUMCOT='"   + cCotNValid                      + "' ) AND "
			
			cQuery += "C7_TIPO=1 AND " 
			cQuery += "D_E_L_E_T_=' ' "
			cQuery += "GROUP BY C7_FILENT,C7_NUM "
			cQuery += "ORDER BY C7_FILENT,C7_NUM "
			
			cQuery := ChangeQuery( cQuery )
			
			dbUseArea( .T., "TOPCONN", TcGenQry( ,,cQuery ), cAliasQry, .F., .T. )
		
			While !( cAliasQry )->( Eof() )
				MaTrkSC7H( ( cAliasQry )->C7_FILENT + ( cAliasQry )->(C7_NUM), @oTree, , @nLevel, nMaxLevel, lItem, cTreeID, 1 )
				( cAliasQry )->( dbSkip() )
			End
		Else
			cQuery += "SELECT C7_FILIAL,C7_NUM FROM " + RetSqlName( "SC7" ) + " "
			cQuery += "WHERE "
			cQuery += "C7_FILIAL='"  + xFilial( "SC7" ) + "' AND "
			cQuery += "C7_NUMSC='" + SC1->C1_NUM  + "' AND "
			
			cQuery += "( C7_NUMCOT='" + Space( Len( SC7->C7_NUMCOT ) ) + "' OR "
			cQuery += "C7_NUMCOT='"   + cCotNValid                      + "' ) AND "
			
			cQuery += "C7_TIPO=1 AND " 
			cQuery += "D_E_L_E_T_=' ' "
			cQuery += "GROUP BY C7_FILIAL,C7_NUM "
			cQuery += "ORDER BY C7_FILIAL,C7_NUM "
			
			cQuery := ChangeQuery( cQuery )
			
			dbUseArea( .T., "TOPCONN", TcGenQry( ,,cQuery ), cAliasQry, .F., .T. )
		
			While !( cAliasQry )->( Eof() )
				MaTrkSC7H( ( cAliasQry )->(C7_NUM), @oTree, , @nLevel, nMaxLevel, lItem, cTreeID, 1 )
				( cAliasQry )->( dbSkip() )
			End
	 	EndIf
		(cAliasQry)->(dbCloseArea())
		dbSelectArea("SC7")

		cAliasSC1 := GetNextAlias()
		
		cQuery := ""
		
		cQuery += "SELECT C1_FILIAL, C1_COTACAO, C1_NUM FROM " + RetSqlName( "SC1" ) + " "
		cQuery += "WHERE "
		If lFilEnt
			cQuery += "C1_FILIAL='"  + cFilialSC1      + "' AND "     
			cQuery += "C1_NUM='"     + Substr(cNumSC,TamSx3("C1_FILIAL")[1]+1,6) + "' AND " 
		Else		
			cQuery += "C1_FILIAL='"  + xFilial( "SC1" ) + "' AND "
			cQuery += "C1_NUM='"     + cNumSC           + "' AND "
        EndIf
		cQuery += "C1_COTACAO<>'" + cCotNValid       + "' AND " 
		cQuery += "C1_COTACAO<>'" + Space( Len( SC1->C1_COTACAO ) ) + "' AND " 			
		cQuery += "D_E_L_E_T_=' ' "
		
		cQuery += "GROUP BY C1_FILIAL, C1_COTACAO, C1_NUM ORDER BY C1_FILIAL,C1_COTACAO, C1_NUM" 
		
		cQuery := ChangeQuery( cQuery )
		
		dbUseArea( .T., "TOPCONN", TcGenQry( ,,cQuery ), cAliasSC1, .F., .T. )
			
		aNumCot := {} 
		
		If lFilEnt		
			While !( cAliasSC1 )->( Eof() ) .AND. ( cAliasSC1 )->C1_FILIAL + ( cAliasSC1 )->C1_NUM == cFilialSC1 + Substr(cNumSC,TamSx3("C1_FILIAL")[1]+1,6)  
			
				If ( cAliasSC1 )->C1_COTACAO <> cCotNValid .AND. ( cAliasSC1 )->C1_COTACAO <> Space( Len( SC1->C1_COTACAO ) ) 				
					If Empty( AScan( aNumCot, { |x| x == ( cAliasSC1 )->C1_FILIAL + ( cAliasSC1 )->C1_COTACAO } ) ) 
						If FwModeAccess("SC1") == "E" .And. FwModeAccess("SC8") == "E"
							AAdd( aNumCot,( cAliasSC1 )->C1_FILIAL + ( cAliasSC1 )->C1_COTACAO ) 
						Else
							AAdd( aNumCot,xFilial("SC8") + ( cAliasSC1 )->C1_COTACAO ) 
						EndIf
					EndIf 	
				EndIf 
	
				( cAliasSC1 )->( dbskip() )		
					
			End 
		Else
			While !( cAliasSC1 )->( Eof() ) .And. ( cAliasSC1 )->C1_FILIAL + ( cAliasSC1 )->C1_NUM == xFilial( "SC1" ) + cNumSC 
			
				If ( cAliasSC1 )->C1_COTACAO <> cCotNValid .And. ( cAliasSC1 )->C1_COTACAO <> Space( Len( SC1->C1_COTACAO ) ) 				
					If Empty( AScan( aNumCot, { |x| x == ( cAliasSC1 )->C1_COTACAO } ) ) 
						AAdd( aNumCot, ( cAliasSC1 )->C1_COTACAO ) 
					EndIf 	
				EndIf 
	
				( cAliasSC1 )->( dbskip() )		
					
			End 
        EndIf
                                                              
		( cAliasSC1 )->( dbCloseArea() )
		dbSelectArea( "SC1" ) 

		For nLoop := 1 To Len( aNumCot ) 
			MaTrkSC8H( aNumCot[ nLoop ], @oTree, , @nLevel, nMaxLevel, lItem, cTreeID )		
		Next nLoop 
		
        If A103GCDisp()

			//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
			//Ё Localiza as planilhas desta solicitacao ( apenas SQL )       Ё
			//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
			
			cAliasCNB := GetNextAlias()
			
			cQuery := ""
			
			cQuery += "SELECT CNB_CONTRA, CNB_REVISA, CNB_NUMERO FROM " + RetSqlName( "CNB" ) + " "
			cQuery += "WHERE "
			cQuery += "CNB_FILORI='"  + xFilial( "CNB" )   + "' AND "
			cQuery += "CNB_NUMSC='"   + Substr(cNumSC,TamSx3("CNB_NUMSC")[1]+1,6) + "' AND "
			cQuery += "D_E_L_E_T_=' ' "
			cQuery += "GROUP BY CNB_CONTRA, CNB_REVISA, CNB_NUMERO ORDER BY CNB_CONTRA,CNB_REVISA,CNB_NUMERO"
			
			cQuery := ChangeQuery( cQuery )
			
			dbUseArea( .T., "TOPCONN", TcGenQry( ,,cQuery ), cAliasCNB, .F., .T. )
					                                                                           
			While !( cAliasCNB )->( Eof() ) 					                             	
				MaTrkCNA( ( cAliasCNB )->CNB_CONTRA + ( cAliasCNB )->CNB_REVISA + ( cAliasCNB )->CNB_NUMERO, @oTree, , @nLevel, nMaxLevel, lItem, cTreeID )
				oTree:TreeSeek( Pad( "SC1-" + cNumSC , 50 )+cTreeID )				
				( cAliasCNB )->( dbSkip() ) 
			End 							
			
			( cAliasCNB )->( dbCloseArea() ) 
			dbSelectArea( "CNB" ) 
				
        EndIf

	EndIf
	
	nLevel--
EndIf

Return( .T. )


/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFuncao    ЁMaTrkSC8H Ё Autor Ё Aline Correa do Vale  Ё Data Ё13/06/2003Ё╠╠
╠╠цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o Ё Monta as pastas de solicitacoes de compra simulando Header Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁSintaxe   Ё MaTrkSC1H( ExpC1, @ExpO1, [ ExpC2 ], @ExpN1, [ ExpN2 ] )   Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁRetorno   Ё Nenhum                                                     Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁParametrosЁ ExpC1 -> Chave de pesquisa                                 Ё╠╠
╠╠Ё          Ё ExpO1 -> Objeto Tree                                       Ё╠╠
╠╠Ё          Ё ExpC2 -> String a adicionar ao texto do item ( tree )      Ё╠╠
╠╠Ё          Ё ExpN1 -> Nivel                                             Ё╠╠
╠╠Ё          Ё ExpN2 -> Nivel maximo                                      Ё╠╠
╠╠юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/

Function MaTrkSC8H( cNumCot, oTree, cAddString, nLevel, nMaxLevel, lItem, cTreeID )

Local cImageSC8 := ""
Local cTrkSeek	:= ""
Local lFilEnt	:= TRKFILENT()
Local nLoop     := 0

DEFAULT nMaxLevel := 1000000
DEFAULT lItem     := .T. 
DEFAULT cTreeID   := "000001" 

SC8->( DbSetOrder( 1 ) ) 
If lFilEnt
	cTrkSeek:= cNumCot
Else
	cTrkSeek:= xFilial( "SC8" ) + cNumCot
EndIf

If SC8->( DbSeek (cTrkSeek) ) 
	
	nLevel++
	
	If nLevel <= nMaxLevel
		
		cAddString := If( ValType( cAddString ) == "C", cAddString, "" )
		cImageSC8  := MaEntImage( "SC8", 1 )         
		
		If !oTree:TreeSeek( Pad( "SC8-" + cNumCot , 50 )+cTreeID )
		
			oTree:AddItem( Pad( STR0065  + Transform(IIF(Len(cNumCot)>6,Substr(cNumCot,TamSx3("C8_FILIAL")[1]+1,6),cNumCot),"@R XXXXXX") + ; // "Cotacao - "
			cAddString, 100 ), Pad( "SC8-" + cNumCot , 50 )+cTreeID,cImageSC8,cImageSC8,,,nLevel)
			oTree:TreeSeek( Pad( "SC8-" + cNumCot , 50 )+cTreeID )
	
			cAliasSC8 := GetNextAlias()
			
			cQuery := ""
			If SC8->C8_TPDOC == '1'
				If lFilEnt				
			 		cQuery += "SELECT C8_FILIAL,C8_FILENT,C8_NUMPED,C8_NUM FROM " + RetSqlName( "SC8" ) + " "
					cQuery += "WHERE "
					cQuery += "C8_FILIAL='"  + Substr(cNumCot,1,TamSx3("C8_FILIAL")[1]) + "' AND "
					cQuery += "C8_NUM='"     + Substr(cNumCot,Len(SC8->C8_FILIAL)+1,6) + "' AND "
					cQuery += "C8_NUMPED<>'" + Replicate( "X", Len( SC8->C8_NUMPED ) ) + "' AND "
					cQuery += "C8_NUMPED<>'" + Space( Len( SC8->C8_NUMPED ) ) + "' AND "
					cQuery += "D_E_L_E_T_=' '"
					cQuery += "GROUP BY C8_FILIAL,C8_FILENT,C8_NUMPED,C8_NUM ORDER BY C8_FILIAL,C8_NUMPED,C8_NUM"    
				Else					
			 		cQuery += "SELECT C8_FILIAL,C8_NUMPED,C8_NUM FROM " + RetSqlName( "SC8" ) + " "
					cQuery += "WHERE "
					cQuery += "C8_FILIAL='"  + xFilial( "SC8" ) + "' AND "
					cQuery += "C8_NUM='"     + cNumCot          + "' AND "
					cQuery += "C8_NUMPED<>'" + Replicate( "X", Len( SC8->C8_NUMPED ) ) + "' AND "
					cQuery += "C8_NUMPED<>'" + Space( Len( SC8->C8_NUMPED ) ) + "' AND "
					cQuery += "D_E_L_E_T_=' '"
					cQuery += "GROUP BY C8_FILIAL,C8_NUMPED,C8_NUM ORDER BY C8_FILIAL,C8_NUMPED,C8_NUM" 
				EndIf
				cQuery := ChangeQuery( cQuery )
			
				dbUseArea( .T., "TOPCONN", TcGenQry( ,,cQuery ), cAliasSC8, .F., .T. )
			Else
				If lFilEnt				
			 		cQuery += "SELECT C8_FILIAL,C8_FILENT,C8_NUMCON,C8_NUM FROM " + RetSqlName( "SC8" ) + " "
					cQuery += "WHERE "
					cQuery += "C8_FILIAL='"  + Substr(cNumCot,1,TamSx3("C8_FILIAL")[1]) + "' AND "
					cQuery += "C8_NUM='"     + Substr(cNumCot,Len(SC8->C8_FILIAL)+1,6) + "' AND "
					cQuery += "C8_NUMCON<>'" + Replicate( "X", Len( SC8->C8_NUMCON ) ) + "' AND "
					cQuery += "C8_NUMCON<>'" + Space( Len( SC8->C8_NUMCON ) ) + "' AND "
					cQuery += "D_E_L_E_T_=' '"
					cQuery += "GROUP BY C8_FILIAL,C8_FILENT,C8_NUMCON,C8_NUM ORDER BY C8_FILIAL,C8_NUMCON,C8_NUM"    
				Else					
			 		cQuery += "SELECT C8_FILIAL,C8_NUMCON,C8_NUM FROM " + RetSqlName( "SC8" ) + " "
					cQuery += "WHERE "
					cQuery += "C8_FILIAL='"  + xFilial( "SC8" ) + "' AND "
					cQuery += "C8_NUM='"     + cNumCot          + "' AND "
					cQuery += "C8_NUMCON<>'" + Replicate( "X", Len( SC8->C8_NUMCON ) ) + "' AND "
					cQuery += "C8_NUMCON<>'" + Space( Len( SC8->C8_NUMCON ) ) + "' AND "
					cQuery += "D_E_L_E_T_=' '"
					cQuery += "GROUP BY C8_FILIAL,C8_NUMCON,C8_NUM ORDER BY C8_FILIAL,C8_NUMCON,C8_NUM" 
				EndIf
			Endif			
			cQuery := ChangeQuery( cQuery )
			
			dbUseArea( .T., "TOPCONN", TcGenQry( ,,cQuery ), cAliasSC8, .F., .T. )
				
	       If SC8->C8_TPDOC == '1'     
				aPedidos := {} 
			
				If lFilEnt		
					While !( cAliasSC8 )->( Eof() ) .AND. ( cAliasSC8 )->C8_FILIAL + ( cAliasSC8 )->C8_NUM == cNumCot
				          
						If ( cAliasSC8 )->C8_NUMPED <> Replicate( "X", Len( SC8->C8_NUMPED ) ) .AND. ;
								( cAliasSC8 )->( C8_NUMPED ) <> Space( Len( SC8->C8_NUMPED ) )
							If Empty( AScan( aPedidos, ( cAliasSC8 )->C8_FILENT + ( cAliasSC8 )->C8_NUMPED ) ) 				
								AAdd( aPedidos, ( cAliasSC8 )->C8_FILENT + ( cAliasSC8 )->C8_NUMPED )
							EndIf 
						EndIf 			                                                                                                                  
						
						( cAliasSC8 )->( dbSkip() ) 
						
					End
		  		Else
					While !( cAliasSC8 )->( Eof() ) .And. ( cAliasSC8 )->C8_FILIAL + ( cAliasSC8 )->C8_NUM == xFilial( "SC8" ) + cNumCot
				          
						If ( cAliasSC8 )->C8_NUMPED <> Replicate( "X", Len( SC8->C8_NUMPED ) ) .AND. ;
								( cAliasSC8 )->( C8_NUMPED ) <> Space( Len( SC8->C8_NUMPED ) )
							If Empty( AScan( aPedidos, ( cAliasSC8 )->C8_NUMPED ) ) 				
								AAdd( aPedidos, ( cAliasSC8 )->C8_NUMPED )
							EndIf 
						EndIf 			                                                                                                                  
						
						( cAliasSC8 )->( dbSkip() ) 
						
					End
				EndIf
					
			
				( cAliasSC8 )->( dbCloseArea() ) 
				dbSelectArea( "SC8" ) 
				
				For nLoop := 1 To Len( aPedidos )
					MaTrkSC7H( aPedidos[ nLoop ], @oTree, , @nLevel, nMaxLevel, lItem,cTreeID,  1 )
					oTree:TreeSeek( Pad( "SC8-" + cNumCot , 50 )+cTreeID )
				Next nLoop
			Else
				aContratos := {} 
				
				If lFilEnt		
					While !( cAliasSC8 )->( Eof() ) .AND. ( cAliasSC8 )->C8_FILIAL + ( cAliasSC8 )->C8_NUM == cNumCot
				          
						If ( cAliasSC8 )->C8_NUMCON <> Replicate( "X", Len( SC8->C8_NUMCON ) ) .AND. ;
								( cAliasSC8 )->( C8_NUMCON ) <> Space( Len( SC8->C8_NUMCON ) )
							If Empty( AScan( aContratos, ( cAliasSC8 )->C8_FILENT + ( cAliasSC8 )->C8_NUMCON ) ) 				
								AAdd( aContratos, ( cAliasSC8 )->C8_NUMCON )
							EndIf 
						EndIf 			                                                                                                                  
						
						( cAliasSC8 )->( dbSkip() ) 
						
					End
		  		Else
					While !( cAliasSC8 )->( Eof() ) .And. ( cAliasSC8 )->C8_FILIAL + ( cAliasSC8 )->C8_NUM == xFilial( "SC8" ) + cNumCot
				          
						If ( cAliasSC8 )->C8_NUMCON <> Replicate( "X", Len( SC8->C8_NUMCON ) ) .AND. ;
								( cAliasSC8 )->( C8_NUMCON ) <> Space( Len( SC8->C8_NUMCON ) )
							If Empty( AScan( aContratos, ( cAliasSC8 )->C8_NUMCON ) ) 				
								AAdd( aContratos, ( cAliasSC8 )->C8_NUMCON )
							EndIf 
						EndIf 			                                                                                                                  
						
						( cAliasSC8 )->( dbSkip() ) 
						
					End
				EndIf
				( cAliasSC8 )->( dbCloseArea() ) 
				dbSelectArea( "SC8" )
				
				For nLoop := 1 To Len( aContratos )
					MaTrkCN9H( aContratos[ nLoop ], @oTree, , @nLevel, nMaxLevel, lItem,cTreeID,  1 )
					oTree:TreeSeek( Pad( "SC8-" + cNumCot , 50 )+cTreeID )
				Next nLoop
				
			Endif
		EndIf	
			
	EndIf
		
	nLevel--
EndIf

Return( .T. )

/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFuncao    ЁMaTrkSC3H Ё Autor Ё Aline Correa do Vale  Ё Data Ё13/06/2003Ё╠╠
╠╠цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o Ё Monta as pastas de solicitacoes de compra simulando Header Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁSintaxe   Ё MaTrkSC3H( ExpC1, @ExpO1, [ ExpC2 ], @ExpN1, [ ExpN2 ] )   Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁRetorno   Ё Nenhum                                                     Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁParametrosЁ ExpC1 -> Chave de pesquisa                                 Ё╠╠
╠╠Ё          Ё ExpO1 -> Objeto Tree                                       Ё╠╠
╠╠Ё          Ё ExpC2 -> String a adicionar ao texto do item ( tree )      Ё╠╠
╠╠Ё          Ё ExpN1 -> Nivel                                             Ё╠╠
╠╠Ё          Ё ExpN2 -> Nivel maximo                                      Ё╠╠
╠╠юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/

Function MaTrkSC3H( cNumCont, oTree, cAddString, nLevel, nMaxLevel, lItem, cTreeID )

Local cImageSC3  := ""                  
Local cTrkSeek   := ""  
Local lFilEnt	 := TRKFILENT()

Local cQuery     := "" 
Local cAliasQRY  := ""

DEFAULT nMaxLevel := 1000000
DEFAULT lItem     := .T. 
DEFAULT cTreeID   := "000001" 

SC3->( DbSetOrder( 1 ) )
If lFilEnt
	cTrkSeek:= cNumCont
Else 
  	cTrkSeek:= xFilial( "SC3" ) + cNumCont
EndIf

If SC3->( DbSeek (cTrkSeek) )
	
	nLevel++
	
	If nLevel <= nMaxLevel
		
		cAddString := If( ValType( cAddString ) == "C", cAddString, "" )
		cImageSC3  := MaEntImage( "SC3", 1 )
		
		oTree:AddItem( Pad( STR0066 + Transform(IIF(Len(cNumCont)>6, Substr(cNumCont,TamSx3("C3_FILIAL")[1]+1,6),cNumCont),"@R XXXXXX") + ; // "Contrato - "
		cAddString, 100 ), Pad( "SC3-" + cNumCont, 50 )+cTreeID,cImageSC3,cImageSC3,,,nLevel)
		oTree:TreeSeek( Pad( "SC3-" + cNumCont, 50 )+cTreeID )
		
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Analisa destino                                              Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды

		cAliasQry := GetNextAlias()
		
		cQuery := ""
		
		If lFilEnt			
			cQuery += "SELECT C7_FILENT,C7_NUM FROM " + RetSqlName( "SC7" ) + " "
			cQuery += "WHERE "
			cQuery += "C7_FILIAL='"  + SC3->C3_FILIAL + "' AND "
			cQuery += "C7_NUMSC='" + SC3->C3_NUM  + "' AND "
			cQuery += "C7_TIPO=2 AND " 
			cQuery += "D_E_L_E_T_=' ' "
			cQuery += "GROUP BY C7_FILENT,C7_NUM "
			cQuery += "ORDER BY C7_FILENT,C7_NUM "
			
			cQuery := ChangeQuery( cQuery )
			
			dbUseArea( .T., "TOPCONN", TcGenQry( ,,cQuery ), cAliasQry, .F., .T. )
		
			While !( cAliasQry )->( Eof() )
				MaTrkSC7H( ( cAliasQry )->(C7_FILENT)+( cAliasQry )->(C7_NUM), @oTree, , @nLevel, nMaxLevel, lItem, cTreeID, 2 )
				( cAliasQry )->( dbSkip() )
			End    
		Else
			cQuery += "SELECT C7_NUM FROM " + RetSqlName( "SC7" ) + " "
			cQuery += "WHERE "
			cQuery += "C7_FILIAL='"  + xFilial( "SC7" ) + "' AND "
			cQuery += "C7_NUMSC='" + SC3->C3_NUM  + "' AND "
			cQuery += "C7_TIPO=2 AND " 
			cQuery += "D_E_L_E_T_=' ' "
			cQuery += "GROUP BY C7_NUM "
			cQuery += "ORDER BY C7_NUM "
			
			cQuery := ChangeQuery( cQuery )
			
			dbUseArea( .T., "TOPCONN", TcGenQry( ,,cQuery ), cAliasQry, .F., .T. )
		
			While !( cAliasQry )->( Eof() )
				MaTrkSC7H( ( cAliasQry )->(C7_NUM), @oTree, , @nLevel, nMaxLevel, lItem, cTreeID, 2 )
				( cAliasQry )->( dbSkip() )
			End
            EndIf
		
		(cAliasQry)->(dbCloseArea())
		dbSelectArea("SC7")
			
	EndIf
	
	nLevel--
EndIf

Return( .T. )

/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFuncao    ЁMaTrkSC7H Ё Autor Ё Aline Correa do Vale  Ё Data Ё13/06/2003Ё╠╠
╠╠цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o Ё Monta as pastas de pedidos de compra de Header             Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁSintaxe   Ё MaTrkSC7H( ExpC1, @ExpO1, [ ExpC2 ], @ExpN1, [ ExpN2 ] )   Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁRetorno   Ё Nenhum                                                     Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁParametrosЁ ExpC1 -> Chave de pesquisa                                 Ё╠╠
╠╠Ё          Ё ExpO1 -> Objeto Tree                                       Ё╠╠
╠╠Ё          Ё ExpC2 -> String a adicionar ao texto do item ( tree )      Ё╠╠
╠╠Ё          Ё ExpN1 -> Nivel                                             Ё╠╠
╠╠Ё          Ё ExpN2 -> Nivel maximo                                      Ё╠╠
╠╠Ё          Ё ExpL1 -> Exibe itens                                       Ё╠╠
╠╠Ё          Ё ExpN3 -> Tipo 1-Pedido / 2-Autorizacao de entrega          Ё╠╠
╠╠юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/

Function MaTrkSC7H( cNumPed, oTree, cAddString, nLevel, nMaxLevel,lItem,cTreeID, nTipo )

Local cPedido   := ""
Local cItem     := ""
Local cImageSC7 := ""
Local cTrkSeek	:= ""
Local lFilEnt	:= TRKFILENT()
Local cImageSD1 := ""          
Local cQuery    := ""
Local cAliasQry := ""

DEFAULT nMaxLevel := 1000000
DEFAULT lItem     := .T.  
DEFAULT nTipo     := 1 
DEFAULT cTreeID   := "000001" 

If lFilEnt
	SC7->( DbSetOrder( 14 ) )
	If Len(cNumPed) <> Len(xFilial("SC7")+SD1->D1_PEDIDO)    
		cTrkSeek:= xFilial("SC7")+cNumPed
		cPedido   := cNumPed
	Else
	cTrkSeek:= cNumPed
	cPedido   := Substr( cNumPed,TamSx3("D1_FILIAL")[1]+1, Len( SD1->D1_PEDIDO ) )
	EndIf
Else
	SC7->( DbSetOrder( 1 ) )
	cTrkSeek:= cNumPed
	cPedido   := Right( cNumPed, Len( SD1->D1_PEDIDO ) )
EndIf
            
If SC7->( DbSeek (cTrkSeek) )
	cItem     := Right( cNumPed, Len( SD1->D1_ITEMPC ) )
	cImageSC7 := MaEntImage( "SC7", 1 )
	
	nLevel++
	
	If nLevel <= nMaxLevel
		
		cAddString := If( ValType( cAddString ) == "C", cAddString, "" )

		If cPaisLoc<>"BRA"
			MaTrkSC7Loc(cNumPed,oTree,cAddString,nLevel,nMaxLevel,.F.,cTreeID)
			nLevel--
		Else

			If !oTree:AddItem( Pad( If(nTipo==1,STR0057,STR0068) + " - " + Transform(IIF(Len(cNumPed)>6, Substr(cNumPed,TamSx3("C7_FILIAL")[1]+1,6),cNumPed), "@r XXXXXX" ) + ;  //"Pedido de Compra"###"Autorizacao de Entrega"
				cAddString, 100 ), Pad( "SC7-" + cNumPed , 50 )+cTreeID,cImageSC7,cImageSC7,,,nLevel)
				oTree:TreeSeek( Pad( "SC7-" + cNumPed , 50 )+cTreeID )
			
				//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
				//Ё Alimenta os itens de notas fiscais deste pedido / item       Ё
				//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
				
				cAliasQry := GetNextAlias()
				
				cQuery := ""
				If lFilEnt 
					cQuery += "SELECT D1_FILIAL,D1_DOC,D1_SERIE,D1_FORNECE,D1_LOJA,D1_TIPO "
					cQuery += "FROM " + RetSqlName( "SD1" ) + " "
					cQuery += "WHERE "
					IF FWModeAccess("SD1") == "C"					
						cQuery += "D1_FILIAL='" +IIF(FWModeAccess("SD1")=="C",xFilial("SD1"),SC7->C7_FILENT) + "' AND "
					Else 
						cQuery += "D1_FILIAL='" + xFilial("SD1") + "' AND "						
					EndIf
					cQuery += "D1_PEDIDO='" + cPedido          + "' AND "
					cQuery += "D_E_L_E_T_=' ' "
					cQuery += "GROUP BY D1_FILIAL,D1_DOC,D1_SERIE,D1_FORNECE,D1_LOJA,D1_TIPO "									
					cQuery += "ORDER BY D1_FILIAL,D1_DOC,D1_SERIE,D1_FORNECE,D1_LOJA,D1_TIPO"
					
					cQuery := ChangeQuery( cQuery )
					
					dbUseArea( .T., "TOPCONN", TcGenQry( , , cQuery ), cAliasQry, .F., .T. )
					
					oTree:TreeSeek( Pad( "SC7-" + cNumPed , 50 )+cTreeID )
					
					cImageSD1 := MaEntImage( "SF1", 1 )
					(cAliasQry) -> (dbGoTop())
					While !( cAliasQry )->( Eof() )
						
						MATRKSF1( ( cAliasQry )->D1_FILIAL + ( cAliasQry )->D1_DOC + ( cAliasQry )->D1_SERIE + ( cAliasQry )->D1_FORNECE + ( cAliasQry )->D1_LOJA + ( cAliasQry )->D1_TIPO, @oTree, , @nLevel, nMaxLevel, lItem,cTreeID )
						oTree:TreeSeek( Pad( "SC7-" + cNumPed , 50 )+cTreeID )
						
						( cAliasQry )->( dbSkip() )
					End  
				Else
					cQuery += "SELECT D1_DOC,D1_SERIE,D1_FORNECE,D1_LOJA,D1_TIPO "
					cQuery += "FROM " + RetSqlName( "SD1" ) + " "
					cQuery += "WHERE "
					cQuery += "D1_FILIAL='" + xFilial( "SD1" ) + "' AND "
					cQuery += "D1_PEDIDO='" + cPedido          + "' AND "
					cQuery += "D_E_L_E_T_=' ' "
					cQuery += "GROUP BY D1_DOC,D1_SERIE,D1_FORNECE,D1_LOJA,D1_TIPO "									
					cQuery += "ORDER BY D1_DOC,D1_SERIE,D1_FORNECE,D1_LOJA,D1_TIPO"
					
					cQuery := ChangeQuery( cQuery )
					
					dbUseArea( .T., "TOPCONN", TcGenQry( , , cQuery ), cAliasQry, .F., .T. )
					
					oTree:TreeSeek( Pad( "SC7-" + cNumPed, 50 )+cTreeID )
					
					cImageSD1 := MaEntImage( "SF1", 1 )
					(cAliasQry) -> (dbGoTop())
					While !( cAliasQry )->( Eof() )
						
						MATRKSF1( ( cAliasQry )->D1_DOC + ( cAliasQry )->D1_SERIE + ( cAliasQry )->D1_FORNECE + ( cAliasQry )->D1_LOJA + ( cAliasQry )->D1_TIPO, @oTree, , @nLevel, nMaxLevel, lItem,cTreeID )
						oTree:TreeSeek( Pad( "SC7-" + cNumPed, 50 )+cTreeID )
						
						( cAliasQry )->( dbSkip() )
					End
				 EndIf
				//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
				//Ё Exclui a area de trabalho da query                           Ё
				//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
				dbSelectArea( cAliasQry )
				dbCloseArea()
				
				dbSelectArea( "SD1" )
				
			EndIf 				
				
		EndIf

	EndIf

	nLevel--
EndIf

Return 


/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFuncao    ЁMaTrkCN9  Ё Autor Ё Sergio Silveira       Ё Data Ё22/03/2006Ё╠╠
╠╠цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o Ё Monta as pastas de cabecalho do contrato                   Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁSintaxe   Ё MaTrkCNA( ExpC1, @ExpO1, [ ExpC2 ], @ExpN1, [ ExpN2 ] )    Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁRetorno   Ё Nenhum                                                     Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁParametrosЁ ExpC1 -> Chave de pesquisa                                 Ё╠╠
╠╠Ё          Ё ExpO1 -> Objeto Tree                                       Ё╠╠
╠╠Ё          Ё ExpC2 -> String a adicionar ao texto do item ( tree )      Ё╠╠
╠╠Ё          Ё ExpN1 -> Nivel                                             Ё╠╠
╠╠Ё          Ё ExpN2 -> Nivel maximo                                      Ё╠╠
╠╠Ё          Ё ExpL1 -> Exibe itens                                       Ё╠╠
╠╠Ё          Ё ExpN3 -> Tipo 1-Pedido / 2-Autorizacao de entrega          Ё╠╠
╠╠юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/

Function MaTrkCN9( cKey, oTree, cAddString, nLevel, nMaxLevel,lItem,cTreeID, nTipo )

LOCAL cContrato := ""
LOCAL cRevisa   := ""
Local lFixo     := .T.
 
LOCAL cImageCN9 := ""            

LOCAL cQuery    := ""
LOCAL cAliasQry := ""

DEFAULT nMaxLevel := 1000000
DEFAULT lItem     := .T.  
DEFAULT nTipo     := 1 
DEFAULT cTreeID   := "000001" 

CN9->( DbSetOrder( 1 ) )
If CN9->( DbSeek( xFilial( "CN9" ) + cKey ) )
	
	cContrato := Left( cKey, Len( CN9->CN9_NUMERO ) )
	cRevisa   := SubStr( cKey, Len( CN9->CN9_NUMERO ) + 1, Len( CN9->CN9_REVISA ) )
	
	CN1->( DbSetOrder(1) )
	If CN1->( DbSeek( xFilial("CN1") + CN9->CN9_TPCTO ) )
	   	lFixo := Empty( CN1->CN1_CTRFIX ) .OR. (CN1->CN1_CTRFIX == "1")
	EndIf
	
	cImageCN9 := MaEntImage( "CN9", 1 )
	
	nLevel++
	
	If nLevel <= nMaxLevel
		
		cAddString := If( ValType( cAddString ) == "C", cAddString, "" )

		If !oTree:AddItem( Pad( STR0107 + cContrato + "/" + cRevisa + ;  // "Contrato / Revisao - "
			cAddString, 100 ), Pad( "CN9-" + cKey, 50 )+cTreeID,cImageCN9,cImageCN9,,,nLevel)
			oTree:TreeSeek( Pad( "CN9-" + cKey, 50 )+cTreeID )
		
			//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
			//Ё Alimenta as planilhas deste contrato                         Ё
			//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
				
			cAliasQry := GetNextAlias()
			
			cQuery := ""       
			
			If lFixo
				CNB->( DbSetOrder( 1 ) ) 
				
				cQuery += "SELECT CNB_CONTRA,CNB_REVISA,CNB_NUMERO,CNB_ITEM "
				cQuery += "FROM " + RetSqlName( "CNB" ) + " "
				cQuery += "WHERE "
				cQuery += "CNB_FILIAL='" + xFilial( "CNB" ) + "' AND "
				cQuery += "CNB_CONTRA='" + cContrato        + "' AND "
				cQuery += "CNB_REVISA='" + cRevisa          + "' AND "
				cQuery += "D_E_L_E_T_=' ' "
				cQuery += "ORDER BY " + SqlOrder( CNB->( IndexKey() ) )
				
				cQuery := ChangeQuery( cQuery )
				
				dbUseArea( .T., "TOPCONN", TcGenQry( , , cQuery ), cAliasQry, .F., .T. )
				
				oTree:TreeSeek( Pad( "CN9-" + cKey, 50 )+cTreeID )
				
				(cAliasQry) -> (dbGoTop())
				While !( cAliasQry )->( Eof() )
					
					MATRKCNB( ( cAliasQry )->CNB_CONTRA + ( cAliasQry )->CNB_REVISA + ( cAliasQry )->CNB_NUMERO + ( cAliasQry )->CNB_ITEM, @oTree, , @nLevel, nMaxLevel, lItem,cTreeID )
					oTree:TreeSeek( Pad( "CN9-" + cKey, 50 )+cTreeID )
					
					( cAliasQry )->( dbSkip() )
					
				End
			Else
				CNE->( DbSetOrder( 1 ) ) 
				
				cQuery += "SELECT CNE_CONTRA,CNE_REVISA,CNE_NUMERO,CNE_NUMMED,CNE_ITEM "
				cQuery += "FROM " + RetSqlName( "CNE" ) + " "
				cQuery += "WHERE "
				cQuery += "CNE_FILIAL='" + xFilial( "CNE" ) + "' AND "
				cQuery += "CNE_CONTRA='" + cContrato        + "' AND "
				cQuery += "CNE_REVISA='" + cRevisa          + "' AND "
				cQuery += "D_E_L_E_T_=' ' "
				cQuery += "ORDER BY " + SqlOrder( CNE->( IndexKey() ) )
				
				cQuery := ChangeQuery( cQuery )
				
				dbUseArea( .T., "TOPCONN", TcGenQry( , , cQuery ), cAliasQry, .F., .T. )
				
				oTree:TreeSeek( Pad( "CN9-" + cKey, 50 )+cTreeID )
				
				(cAliasQry) -> (dbGoTop())
				While !( cAliasQry )->( Eof() )

					MATRKCNE( ( cAliasQry )->CNE_CONTRA + ( cAliasQry )->CNE_REVISA + ( cAliasQry )->CNE_NUMERO + ( cAliasQry )->CNE_NUMMED + ( cAliasQry )->CNE_ITEM, @oTree, , @nLevel, nMaxLevel, lItem,cTreeID )
					oTree:TreeSeek( Pad( "CN9-" + cKey, 50 )+cTreeID )
					
					( cAliasQry )->( dbSkip() )
					
				End			
			EndIf
			
			//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
			//Ё Exclui a area de trabalho da query                           Ё
			//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
			dbSelectArea( cAliasQry )
			dbCloseArea()
			
			If lFixo
				dbSelectArea( "CNB" )
			Else
				dbSelectArea( "CNE" )
			EndIf
		
		EndIf 				

	EndIf

	nLevel--
EndIf

Return  

/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFuncao    ЁMaTrkCN9H Ё Autor Ё Sergio Silveira       Ё Data Ё22/03/2006Ё╠╠
╠╠цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o Ё Monta as pastas de cabecalho do contrato ( estrut. header )Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁSintaxe   Ё MaTrkCN9H( ExpC1, @ExpO1, [ ExpC2 ], @ExpN1, [ ExpN2 ] )   Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁRetorno   Ё Nenhum                                                     Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁParametrosЁ ExpC1 -> Chave de pesquisa                                 Ё╠╠
╠╠Ё          Ё ExpO1 -> Objeto Tree                                       Ё╠╠
╠╠Ё          Ё ExpC2 -> String a adicionar ao texto do item ( tree )      Ё╠╠
╠╠Ё          Ё ExpN1 -> Nivel                                             Ё╠╠
╠╠Ё          Ё ExpN2 -> Nivel maximo                                      Ё╠╠
╠╠Ё          Ё ExpL1 -> Exibe itens                                       Ё╠╠
╠╠Ё          Ё ExpN3 -> Tipo 1-Pedido / 2-Autorizacao de entrega          Ё╠╠
╠╠юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/

Function MaTrkCN9H( cKey, oTree, cAddString, nLevel, nMaxLevel,lItem,cTreeID, nTipo )

LOCAL cContrato := ""
LOCAL cRevisa   := ""
LOCAL lFixo     := .T.
 
LOCAL cImageCN9 := ""            

LOCAL cQuery    := ""
LOCAL cAliasQry := ""

DEFAULT nMaxLevel := 1000000
DEFAULT lItem     := .T.  
DEFAULT nTipo     := 1 
DEFAULT cTreeID   := "000001" 

CN9->( DbSetOrder( 1 ) )
If CN9->( DbSeek( xFilial( "CN9" ) + cKey ) )
	
	cContrato := Left( cKey, Len( CN9->CN9_NUMERO ) )
	cRevisa   := SubStr( cKey, Len( CN9->CN9_NUMERO ) + 1, Len( CN9->CN9_REVISA ) )

	CN1->( DbSetOrder(1) )
	If CN1->( DbSeek( xFilial("CN1") + CN9->CN9_TPCTO ) )
		lFixo := Empty( CN1->CN1_CTRFIX ) .OR. CN1->CN1_CTRFIX == "1"
	EndIf
	
	cImageCN9 := MaEntImage( "CN9", 1 )
	
	nLevel++
	
	If nLevel <= nMaxLevel
		
		cAddString := If( ValType( cAddString ) == "C", cAddString, "" )

		If !oTree:AddItem( Pad( STR0107 + cContrato + "/" + cRevisa + ;  // "Contrato / Revisao - "
			cAddString, 100 ), Pad( "N9H-" + cKey, 50 )+cTreeID,cImageCN9,cImageCN9,,,nLevel)
			oTree:TreeSeek( Pad( "N9H-" + cKey, 50 )+cTreeID )
		
			//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
			//Ё Alimenta as planilhas deste contrato                         Ё
			//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
				
			cAliasQry := GetNextAlias()
			
			cQuery := ""       
			
			If lFixo
				CNA->( DbSetOrder( 1 ) ) 
				
				cQuery += "SELECT CNA_CONTRA,CNA_REVISA,CNA_NUMERO "
				cQuery += "FROM " + RetSqlName( "CNA" ) + " "
				cQuery += "WHERE "
				cQuery += "CNA_FILIAL='" + xFilial( "CNA" ) + "' AND "
				cQuery += "CNA_CONTRA='" + cContrato        + "' AND "
				cQuery += "CNA_REVISA='" + cRevisa          + "' AND "
				cQuery += "D_E_L_E_T_=' ' "
				cQuery += "ORDER BY " + SqlOrder( CNA->( IndexKey() ) )
				
				cQuery := ChangeQuery( cQuery )
				
				dbUseArea( .T., "TOPCONN", TcGenQry( , , cQuery ), cAliasQry, .F., .T. )
				
				oTree:TreeSeek( Pad( "CN9-" + cKey, 50 )+cTreeID )
				
				(cAliasQry) -> (dbGoTop())
				While !( cAliasQry )->( Eof() )
					
					MATRKCNA( ( cAliasQry )->CNA_CONTRA + ( cAliasQry )->CNA_REVISA + ( cAliasQry )->CNA_NUMERO, @oTree, , @nLevel, nMaxLevel, lItem,cTreeID )
					oTree:TreeSeek( Pad( "N9H-" + cKey, 50 )+cTreeID )
					
					( cAliasQry )->( dbSkip() )
					
				End
			Else
				CND->( DbSetOrder( 1 ) ) 
				
				cQuery += "SELECT CND_CONTRA,CND_REVISA,CND_NUMERO,CND_NUMMED "
				cQuery += "FROM " + RetSqlName( "CND" ) + " "
				cQuery += "WHERE "
				cQuery += "CND_FILIAL='" + xFilial( "CND" ) + "' AND "
				cQuery += "CND_CONTRA='" + cContrato        + "' AND "
				cQuery += "CND_REVISA='" + cRevisa          + "' AND "
				cQuery += "D_E_L_E_T_=' ' "
				cQuery += "ORDER BY " + SqlOrder( CND->( IndexKey() ) )
				
				cQuery := ChangeQuery( cQuery )
				
				dbUseArea( .T., "TOPCONN", TcGenQry( , , cQuery ), cAliasQry, .F., .T. )
				
				oTree:TreeSeek( Pad( "CN9-" + cKey, 50 )+cTreeID )
				
				(cAliasQry) -> (dbGoTop())
				While !( cAliasQry )->( Eof() )
					
					MATRKCND( ( cAliasQry )->CND_CONTRA + ( cAliasQry )->CND_REVISA + ( cAliasQry )->CND_NUMERO + ( cAliasQry )->CND_NUMMED, @oTree, , @nLevel, nMaxLevel, lItem,cTreeID )
					oTree:TreeSeek( Pad( "N9H-" + cKey, 50 )+cTreeID )
					
					( cAliasQry )->( dbSkip() )
					
				End
			EndIf
			
			//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
			//Ё Exclui a area de trabalho da query                           Ё
			//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
			dbSelectArea( cAliasQry )
			dbCloseArea()
			
			If lFixo
				dbSelectArea( "CNA" )
			Else
				dbSelectArea( "CND" )
			EndIf
		
		EndIf 				

	EndIf

	nLevel--
EndIf

Return  



/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFuncao    ЁMaTrkCNA  Ё Autor Ё Sergio Silveira       Ё Data Ё22/03/2006Ё╠╠
╠╠цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o Ё Monta as pastas de cabecalho de planilhas                  Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁSintaxe   Ё MaTrkCNA( ExpC1, @ExpO1, [ ExpC2 ], @ExpN1, [ ExpN2 ] )    Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁRetorno   Ё Nenhum                                                     Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁParametrosЁ ExpC1 -> Chave de pesquisa                                 Ё╠╠
╠╠Ё          Ё ExpO1 -> Objeto Tree                                       Ё╠╠
╠╠Ё          Ё ExpC2 -> String a adicionar ao texto do item ( tree )      Ё╠╠
╠╠Ё          Ё ExpN1 -> Nivel                                             Ё╠╠
╠╠Ё          Ё ExpN2 -> Nivel maximo                                      Ё╠╠
╠╠Ё          Ё ExpL1 -> Exibe itens                                       Ё╠╠
╠╠Ё          Ё ExpN3 -> Tipo 1-Pedido / 2-Autorizacao de entrega          Ё╠╠
╠╠юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/

Function MaTrkCNA( cPlanilha, oTree, cAddString, nLevel, nMaxLevel,lItem,cTreeID, nTipo )

LOCAL cContrato := ""
LOCAL cRevisa   := ""
LOCAL cNumero   := ""
LOCAL cImageCNA := ""            

LOCAL cQuery    := ""
LOCAL cAliasQry := ""

DEFAULT nMaxLevel := 1000000
DEFAULT lItem     := .T.  
DEFAULT nTipo     := 1 
DEFAULT cTreeID   := "000001" 

CNA->( DbSetOrder( 1 ) )
If CNA->( DbSeek( xFilial( "CNA" ) + cPlanilha ) )
	
	cContrato := Left( cPlanilha, Len( CNA->CNA_CONTRA ) )
	cRevisa   := SubStr( cPlanilha, Len( CNA->CNA_CONTRA ) + 1, Len( CNA->CNA_REVISA ) )
	cNumero   := Right( cPlanilha, Len( CNA->CNA_NUMERO ) )	
	
	cImageCNA := MaEntImage( "CNA", 1 )
	
	nLevel++
	
	If nLevel <= nMaxLevel
		
		cAddString := If( ValType( cAddString ) == "C", cAddString, "" )

		If !oTree:AddItem( Pad( STR0108 + cContrato + "/" + cRevisa + "/" + cNumero + ;  // "Planilha : Contrato / Revisao / Numero - "
			cAddString, 100 ), Pad( "CNA-" + cPlanilha, 50 )+cTreeID,cImageCNA,cImageCNA,,,nLevel)
			oTree:TreeSeek( Pad( "CNA-" + cPlanilha, 50 )+cTreeID )
		
			//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
			//Ё Alimenta os itens de notas fiscais deste pedido / item       Ё
			//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
				
			cAliasQry := GetNextAlias()
			
			cQuery := ""       
			
			CND->( DbSetOrder( 1 ) ) 
			
			cQuery += "SELECT CND_CONTRA,CND_REVISA,CND_NUMERO,CND_NUMMED "
			cQuery += "FROM " + RetSqlName( "CND" ) + " "
			cQuery += "WHERE "
			cQuery += "CND_FILIAL='" + xFilial( "CND" ) + "' AND "
			cQuery += "CND_CONTRA='" + cContrato        + "' AND "
			cQuery += "CND_REVISA='" + cRevisa          + "' AND "
			cQuery += "CND_NUMERO='" + cNumero          + "' AND "			
			cQuery += "D_E_L_E_T_=' ' "
			cQuery += "ORDER BY " + SqlOrder( CND->( IndexKey() ) )
			
			cQuery := ChangeQuery( cQuery )
			
			dbUseArea( .T., "TOPCONN", TcGenQry( , , cQuery ), cAliasQry, .F., .T. )
			
			oTree:TreeSeek( Pad( "CNA-" + cPlanilha, 50 )+cTreeID )
			
			(cAliasQry) -> (dbGoTop())
			While !( cAliasQry )->( Eof() )
				
				MATRKCND( ( cAliasQry )->CND_CONTRA + ( cAliasQry )->CND_REVISA + ( cAliasQry )->CND_NUMERO + ( cAliasQry )->CND_NUMMED, @oTree, , @nLevel, nMaxLevel, lItem,cTreeID )
				oTree:TreeSeek( Pad( "CNA-" + cPlanilha, 50 )+cTreeID )				
				
				( cAliasQry )->( dbSkip() )
				
			End
			
			//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
			//Ё Exclui a area de trabalho da query                           Ё
			//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
			dbSelectArea( cAliasQry )
			dbCloseArea()
			
			dbSelectArea( "CNA" )
		
		EndIf 				

	EndIf

	nLevel--
EndIf

Return  
  
/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFuncao    ЁMaTrkCND  Ё Autor Ё Sergio Silveira       Ё Data Ё22/03/2006Ё╠╠
╠╠цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o Ё Monta as pastas de cabecalho de planilhas                  Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁSintaxe   Ё MaTrkCND( ExpC1, @ExpO1, [ ExpC2 ], @ExpN1, [ ExpN2 ] )    Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁRetorno   Ё Nenhum                                                     Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁParametrosЁ ExpC1 -> Chave de pesquisa                                 Ё╠╠
╠╠Ё          Ё ExpO1 -> Objeto Tree                                       Ё╠╠
╠╠Ё          Ё ExpC2 -> String a adicionar ao texto do item ( tree )      Ё╠╠
╠╠Ё          Ё ExpN1 -> Nivel                                             Ё╠╠
╠╠Ё          Ё ExpN2 -> Nivel maximo                                      Ё╠╠
╠╠Ё          Ё ExpL1 -> Exibe itens                                       Ё╠╠
╠╠Ё          Ё ExpN3 -> Tipo 1-Pedido / 2-Autorizacao de entrega          Ё╠╠
╠╠юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/

Function MaTrkCND( cMedicao, oTree, cAddString, nLevel, nMaxLevel,lItem,cTreeID, nTipo )

LOCAL cContrato := ""
LOCAL cRevisa   := ""
LOCAL cNumero   := ""
LOCAL cPlanilha := ""
LOCAL cImageCND := ""            
LOCAL cQuery    := ""
LOCAL cAliasQry := ""    
LOCAl lFilEnt	:= TRKFILENT()

DEFAULT nMaxLevel := 1000000
DEFAULT lItem     := .T.  
DEFAULT nTipo     := 1 
DEFAULT cTreeID   := "000001" 

CND->( DbSetOrder( 1 ) )
If CND->( DbSeek( xFilial( "CND" ) + cMedicao ) )
	
	cContrato := Left( cMedicao, Len( CND->CND_CONTRA ) )
	cRevisa   := SubStr( cMedicao, Len( CND->CND_CONTRA ) + 1, Len( CND->CND_REVISA ) )
	cPlanilha := SubStr( cMedicao, Len( CND->CND_CONTRA ) + Len( CND->CND_REVISA ) + 1, Len( CND->CND_NUMERO ) )
	cNumero   := Right( cMedicao, Len( CND->CND_NUMMED ) )	
	
	cImageCND := MaEntImage( "CND", 1 )
	
	nLevel++
	
	If nLevel <= nMaxLevel
		
		cAddString := If( ValType( cAddString ) == "C", cAddString, "" )

		If !oTree:AddItem( Pad( STR0109 + cNumero + ;  // "Medicao - "
			cAddString, 100 ), Pad( "CND-" + cMedicao, 50 )+cTreeID,cImageCND,cImageCND,,,nLevel)
			oTree:TreeSeek( Pad( "CND-" + cMedicao, 50 )+cTreeID )
		
			//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
			//Ё Alimenta os pedidos de compra desta medicao                  Ё
			//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
				
			cAliasQry := GetNextAlias()
			
			cQuery := ""       

			//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
			//Ё Verifica especie da medicao compra / venda                   Ё
			//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды			
			If Empty( CND->CND_CLIENT )

				SC7->( DbSetOrder( 1 ) ) 
			
				If lFilEnt			
					cQuery += "SELECT C7_FILENT,C7_NUM "
					cQuery += "FROM " + RetSqlName( "SC7" ) + " "
					cQuery += "WHERE "
					cQuery += "C7_FILIAL='"  + xFilial( "SC7" ) + "' AND "
					cQuery += "C7_PLANILH='" + cPlanilha        + "' AND "
					cQuery += "C7_MEDICAO='" + cNumero          + "' AND "
					cQuery += "D_E_L_E_T_=' ' "
					cQuery += "GROUP BY C7_FILENT,C7_NUM " 
					cQuery += "ORDER BY C7_FILENT,C7_NUM" 
	            Else
					cQuery += "SELECT C7_NUM "
					cQuery += "FROM " + RetSqlName( "SC7" ) + " "
					cQuery += "WHERE "
					cQuery += "C7_FILIAL='"  + xFilial( "SC7" ) + "' AND "
					cQuery += "C7_PLANILH='" + cPlanilha        + "' AND "
					cQuery += "C7_MEDICAO='" + cNumero          + "' AND "
					cQuery += "D_E_L_E_T_=' ' "
					cQuery += "GROUP BY C7_NUM " 
					cQuery += "ORDER BY C7_NUM" 
                EndIf

   		Else

				SC5->( DbSetOrder( 1 ) ) 

				cQuery += "SELECT C5_NUM "
				cQuery += "FROM " + RetSqlName( "SC5" ) + " "
				cQuery += "WHERE "
				cQuery += "C5_FILIAL='"  + xFilial( "SC5" ) + "' AND "
				cQuery += "C5_MDPLANI='" + cPlanilha        + "' AND "
				cQuery += "C5_MDNUMED='" + cNumero          + "' AND "
				cQuery += "D_E_L_E_T_=' ' "
				cQuery += "ORDER BY C5_NUM" 

			EndIf
				
			cQuery := ChangeQuery( cQuery )
		
			dbUseArea( .T., "TOPCONN", TcGenQry( , , cQuery ), cAliasQry, .F., .T. )
			
			oTree:TreeSeek( Pad( "CND-" + cMedicao, 50 )+cTreeID )
			
			cImageCND := MaEntImage( "CND", 1 )
			
			If lFilEnt
				(cAliasQry) -> (dbGoTop())
				While !( cAliasQry )->( Eof() )
					
					If Empty( CND->CND_CLIENT )
						MATRKSC7H(  ( cAliasQry )->C7_FILENT + ( cAliasQry )->C7_NUM, @oTree, , @nLevel, nMaxLevel, lItem,cTreeID )
					Else
						MATRKSC5( ( cAliasQry )->C5_NUM, @oTree, , @nLevel, nMaxLevel, lItem,cTreeID )
					EndIf
					oTree:TreeSeek( Pad( "CND-" + cMedicao, 50 )+cTreeID )
					
					( cAliasQry )->( dbSkip() )
					
				End  
			Else			
				(cAliasQry) -> (dbGoTop())
				While !( cAliasQry )->( Eof() )
					
					If Empty( CND->CND_CLIENT )
						MATRKSC7H( ( cAliasQry )->C7_NUM, @oTree, , @nLevel, nMaxLevel, lItem,cTreeID )
					Else
						MATRKSC5( ( cAliasQry )->C5_NUM, @oTree, , @nLevel, nMaxLevel, lItem,cTreeID )
					EndIf
					oTree:TreeSeek( Pad( "CND-" + cMedicao, 50 )+cTreeID )
					
					( cAliasQry )->( dbSkip() )
					
				End
			EndIf			
			//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
			//Ё Exclui a area de trabalho da query                           Ё
			//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
			dbSelectArea( cAliasQry )
			dbCloseArea()
			
			If Empty( CND->CND_CLIENT )
				dbSelectArea( "SC7" )
			Else
				dbSelectArea( "SC5" )
			EndIf
		
		EndIf 				

	EndIf

	nLevel--
EndIf

Return  


/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠иммммммммммяммммммммммкмммммммяммммммммммммммммммммкммммммяммммммммммммм╩╠╠
╠╠╨Programa  ЁMaTrackSCM╨Autor  ЁMarcello            ╨Fecha Ё 01/08/2004  ╨╠╠
╠╠лммммммммммьммммммммммймммммммоммммммммммммммммммммйммммммоммммммммммммм╧╠╠
╠╠╨Desc.     Ё                                                            ╨╠╠
╠╠╨          Ё                                                            ╨╠╠
╠╠лммммммммммьмммммммммммммммммммммммммммммммммммммммммммммммммммммммммммм╧╠╠
╠╠╨Uso       Ё AP8                                                        ╨╠╠
╠╠хммммммммммомммммммммммммммммммммммммммммммммммммммммммммммммммммммммммм╪╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/
Function MaTrkSCM(cChaveNF,oTree,cAddString,nLevel,nMaxLevel,lItem,cTreeID,aFat)
LOCAL cForn  		:= ""
LOCAL cLoja     	:= ""
LOCAL cRemito   	:= ""
LOCAL cItemRem  	:= ""
LOCAL cSerieRem		:= ""
LOCAL cImageSCM 	:= ""
LOCAL cImageSD1 	:= ""
LOCAL cChave		:= ""
LOCAL aSD1			:= {}
LOCAL aArea			:= {}
LOCAL nLevelRem		:= 0
LOCAL lFat			:= .F.
LOCAL lPedido		:= (Type("lPc_LOC_")=="L")
LOCAL lFilEnt		:= TRKFILENT()
LOCAL cQuery    	:= ""
LOCAL cAliasQry 	:= ""
DEFAULT nMaxLevel	:= 1000000
DEFAULT lItem	 	:= .T.
DEFAULT cTreeID     := "000001" 

lFat:=(ValType(aFat)=="A").And.(Len(aFat) > 0)
//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Separa os componentes da query                               Ё
//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
cRemito	 	:= Left(cChaveNF,Len(SD1->D1_DOC))
cItemRem 	:= Right(cChaveNF,Len(SD1->D1_ITEM))
cSerieRem  	:= SubStr(cChaveNF,Len(cRemito)+1,Len(SD1->D1_SERIE))
cForn		:= Substr(cChaveNF,Len(cRemito)+Len(cSerieRem)+1,Len(SD1->D1_FORNECE))
cLoja		:= Substr(cChaveNF,Len(cRemito)+Len(cSerieRem)+Len(cForn)+1,Len(SD1->D1_LOJA))
nLevelRem	:= If(lPedido,nLevel+1,nLevel)
If nLevelRem <= nMaxLevel
	cAddString := If( ValType( cAddString ) == "C", cAddString, "" )
	cImageSCM := MaEntImage( "SCM", 1 )
	cImageSD1 := MaEntImage( "SD1", 1 )
	If lPedido
		If !lItem
			If !(oTree:TreeSeek(Pad("SCM-CABECALHO",50)+cTreeID))
				nLevelRem--
				oTree:AddItem(Pad(GetDescRem(),100),Pad( "SCM-CABECALHO",50)+cTreeID,cImageSCM,cImageSCM,,,nLevelRem)
				oTree:TreeSeek(Pad("SCM-CABECALHO",50)+cTreeID)
				nLevelRem++	
			Endif
			If Ascan(_aRemLoc,cChaveNF)>0
				Aadd(_aRemLoc,cChaveNF)
				oTree:AddItem( Pad( GetDescRem() + If(lItem,STR0048,"/"+Alltrim(RetTitle("D1_SERIREM"))+" - ") + Transform( cRemito + "/" + cSerieRem + ;
					If(lItem,"/"+cItemRem,""), "@!" ) + cAddString, 100 ), Pad( "SD1-" + cChaveNF, 50 )+cTreeID,cImageSCM,cImageSCM,,,nLevelRem)
				oTree:TreeSeek(Pad( "SD1-" + cChaveNF, 50 )+cTreeID)
			Endif
		Else
			oTree:AddItem( Pad( GetDescRem() + If(lItem,STR0048,"/"+Alltrim(RetTitle("D1_SERIREM"))+" - ") + Transform( cRemito + "/" + cSerieRem + ;
				If(lItem,"/"+cItemRem,""), "@!" ) + cAddString, 100 ), Pad( "SD1-" + cChaveNF, 50 )+cTreeID,cImageSCM,cImageSCM,,,nLevelRem)
			oTree:TreeSeek(Pad( "SD1-" + cChaveNF, 50 )+cTreeID)
			If Ascan(_aRemLoc,cChaveNF)==0
				Aadd(_aRemLoc,cChaveNF)
			Endif
		Endif
	Else
		If !(oTree:TreeSeek(Pad("SD1-"+cSerieRem+cRemito,50)+cTreeID))
			oTree:AddItem(Pad(GetDescRem()+" - "+cRemito+"/"+cSerieRem ,100),Pad("SD1-"+cSerieRem+cRemito,50)+cTreeID,cImageSCM,cImageSCM,,,nLevelRem)
			oTree:TreeSeek(Pad("SD1-"+cSerieRem+cRemito,50)+cTreeID)
			nLevelRem++	
		Endif
		If lItem
			oTree:AddItem( Pad( GetDescRem() + STR0048 +" - " + Transform( cRemito + "/" + cSerieRem + ;
				"/"+cItemRem, "@!" ) + cAddString, 100 ), Pad( "SD1-" + cChaveNF, 50 )+cTreeID,cImageSCM,cImageSCM,,,nLevelRem)
			oTree:TreeSeek(Pad( "SD1-" + cChaveNF, 50 )+cTreeID)
		Endif
	Endif
	//здддддддддддддддддддддддддддддддддддд©
	//Ё Alimenta os itens deste Remito     Ё
	//юдддддддддддддддддддддддддддддддддддды
	aArea:=GetArea()

	cAliasQry := GetNextAlias()
	cQuery := ""
	cQuery += "SELECT  D1_FILIAL, D1_DOC, D1_SERIE , D1_ITEM, D1_COD, D1_TIPO, D1_FORNECE, D1_LOJA, D1_REMITO, D1_SERIREM "
	cQuery += "FROM " + RetSqlName( "SD1" ) + " "
	cQuery += "WHERE "
	cQuery += "D1_FILIAL='"		+ xFilial( "SD1" ) 	+ "' AND "
	cQuery += "D1_FORNECE='"	+ cForn				+ "' AND "
	cQuery += "D1_LOJA='" 		+ cLoja       		+ "' AND "
	cQuery += "D1_REMITO='"		+ cRemito       	+ "' AND "
	If lItem
		cQuery += "D1_ITEMREM='"	+ cItemRem       	+ "' AND "
	Endif
	cQuery += "D1_SERIREM='"	+ cSerieRem			+ "' AND " 
	cQuery += "D_E_L_E_T_=' '"
	cQuery := ChangeQuery( cQuery )
	dbUseArea( .T., "TOPCONN", TcGenQry( , , cQuery ), cAliasQry, .F., .T. )
	If lItem
		cChaveRem:=xFilial("SD1")+cForn+cLoja+cSerieRem+cRemito+cItemRem
	Else
		cChaveRem:=xFilial("SD1")+cForn+cLoja+cSerieRem+cRemito
	Endif
	While !( cAliasQry )->( Eof() )
		oTree:TreeSeek( Pad( "SD1-" + cChaveRem, 50 )+cTreeID )
		If lItem
			oTree:AddItem(Pad(STR0038+Transform(D1_DOC+"/"+D1_SERIE+"/"+D1_ITEM,"@!")+cAddString,100),Pad( "SD1-"+D1_DOC+D1_SERIE+D1_FORNECE+D1_LOJA+D1_COD+D1_ITEM,50)+cTreeID,cImageSD1,cImageSD1,,,nLevelRem)
			DbSkip()
		Else
			If lFat
               		cChave:=D1_DOC+D1_SERIE+D1_FORNECE+D1_LOJA
               		If Ascan(aFat,cChave)==0
                		Aadd(aFat,cChave)
                	Endif
			Else
				aSD1:=GetArea()
				nLevelRem--
				If lFilEnt
					MaTrkSF1(D1_FILIAL+D1_DOC+D1_SERIE+D1_FORNECE+D1_LOJA,@oTree,,@nLevelRem,nMaxLevel,.F.,cTreeID)
				Else
					MaTrkSF1(D1_DOC+D1_SERIE+D1_FORNECE+D1_LOJA,@oTree,,@nLevelRem,nMaxLevel,.F.,cTreeID)
                    EndIf
				RestArea(aSD1)
			Endif
			While D1_FILIAL+D1_FORNECE+D1_LOJA+D1_SERIREM+D1_REMITO==cChaveRem
				DbSkip()
			End
		Endif
	End
	//зддддддддддддддддддддддддддддддддддддддддд©
	//Ё Exclui a area de trabalho da query      Ё
	//юддддддддддддддддддддддддддддддддддддддддды
	dbSelectArea( cAliasQry )
	dbCloseArea()
	RestArea(aArea)
EndIf
Return

/*
ээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠иммммммммммямммммммммммкмммммммяммммммммммммммммммммкммммммяммммммммммммм╩╠╠
╠╠╨Programa  ЁMATRKSC7LOC╨Autor  ЁMarcello            ╨Fecha Ё 09/01/2004  ╨╠╠
╠╠лммммммммммьмммммммммммймммммммоммммммммммммммммммммйммммммоммммммммммммм╧╠╠
╠╠╨Desc.     Ё                                                             ╨╠╠
╠╠╨          Ё                                                             ╨╠╠
╠╠лммммммммммьммммммммммммммммммммммммммммммммммммммммммммммммммммммммммммм╧╠╠
╠╠╨Uso       Ё AP                                                          ╨╠╠
╠╠хммммммммммоммммммммммммммммммммммммммммммммммммммммммммммммммммммммммммм╪╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/
Function MaTrkSC7Loc(cNumPed,oTree,cAddString,nLevel,nMaxLevel,lItem,cTreeID)
Local cPedido:="",cItem:="",cAliasQry:=""
Local cQuery:="",cCond:="",cChave:=""
Local cImageSD1:="",cImageSCM:="",cImageSC7:=""
Local cTrkSeek:= ""
Local lFilEnt:= TRKFILENT()
Local nLevelPC:=0,nG:=0
Local aArea:={},aSD1:={},aFat:={}
PRIVATE lPc_LOC_:=.T.

DEFAULT lItem:=.T.
DEFAULT cTreeID := "000001"
If lFilEnt
	SC7->( DbSetOrder( 14 ) )
	cTrkSeek:= cNumPed
Else
	SC7->( DbSetOrder( 1 ) )
	cTrkSeek:= xFilial("SC7")+cNumPed
EndIf

If SC7->(DbSeek (cTrkSeek) )

	cImageSCM:=MaEntImage("SCM",1)
	cImageSC7:=MaEntImage("SC7",1)
	cImageSD1:=MaEntImage("SD1",1)
	cPedido:=Substr(cNumPed,TamSx3("C7_FILIAL")[1]+1,Len(SD1->D1_PEDIDO))
	cItem:=Right(cNumPed,Len(SD1->D1_ITEMPC))
	nLevelPC:=nLevel
	If nLevelPC<=nMaxLevel
		If !(oTree:TreeSeek(Pad("SC7-"+ Substr(cNumPed,1,8) ,50)+cTreeID))
			oTree:AddItem( Pad( STR0057 + cPedido + cAddString, 100 ),;
			Pad("SC7-"+Substr(cNumPed,1,8),50)+cTreeID,cImageSC7,cImageSC7,,,nLevelPC)
		Endif
		nLevelPC++
	    If lItem
		    oTree:TreeSeek(Pad("SC7-"+Substr(cNumPed,1,8) ,50)+cTreeID)
			oTree:AddItem( Pad( STR0058 + Transform(IIF(Len(cNumPed)>10,Substr(cNumPed,TamSx3("C7_FILIAL")[1]+1,10),cNumPed), "@r XXXXXX/XXXX" ) + ;  //"Pedido/Item - "
			cAddString, 100 ), Pad( "SC7-" + cNumPed, 50 )+cTreeID,cImageSC7,cImageSC7,,,nLevelPC)
			oTree:TreeSeek(Pad("SC7-"+cNumPed,50 )+cTreeID )
	    Endif
	Endif
	If nLevelPC<=nMaxLevel
		cQuery := ""
		cCond:=""
		aArea:=GetArea()

		cAliasQry := GetNextAlias()
		If lFilEnt
			cQuery += "SELECT D1_FILIAL, D1_COD, D1_DOC, D1_SERIE, D1_FORNECE, D1_LOJA, D1_ITEM, D1_TIPO, D1_REMITO, D1_TIPODOC " 
			cQuery += "FROM " + RetSqlName( "SD1" ) + " "
			cQuery += "WHERE "
			cQuery += "D1_FILIAL='" + Substr( cNumPed,1,TamSx3("D1_FILIAL")[1]) + "' AND "
		Else
			cQuery += "SELECT D1_COD, D1_DOC, D1_SERIE, D1_FORNECE, D1_LOJA, D1_ITEM, D1_TIPO, D1_REMITO, D1_TIPODOC "
			cQuery += "FROM " + RetSqlName( "SD1" ) + " "
			cQuery += "WHERE "
			cQuery += "D1_FILIAL='" + xFilial( "SD1" ) + "' AND "			
	  	EndIf
		cQuery += "D1_PEDIDO='" + cPedido               + "' AND "
		If lItem
			cQuery += "D1_ITEMPC='" + cItem            + "' AND "
		Endif
		cQuery += "D_E_L_E_T_=' ' "
		cQuery += "ORDER BY D1_DOC, D1_SERIE, D1_FORNECE, D1_LOJA "
		cQuery := ChangeQuery( cQuery )
		dbUseArea( .T., "TOPCONN", TcGenQry( , , cQuery ), cAliasQry, .F., .T. )
		(cAliasQry) -> (dbGoTop())

		If lFilEnt
			While !(Eof())
				oTree:TreeSeek( Pad( "SC7-" + cNumPed, 50 )+cTreeID )
				cSeekSD1 :=D1_FILIAL+D1_DOC+D1_SERIE+D1_FORNECE+D1_LOJA
				aSD1:=GetArea()
				If lItem
					MATRKSD1(D1_FILIAL+D1_DOC+D1_SERIE+D1_FORNECE+D1_LOJA+D1_COD+D1_ITEM,@oTree,,@nLevelPC,nMaxLevel,,cTreeID)
				Else
					If ISRemito(1,cAliasQry+"->D1_TIPODOC")
						MaTrkSCM(D1_DOC+D1_SERIE+D1_FORNECE+D1_LOJA,oTree,cAddString,nLevelPC-1,nMaxLevel,.F.,cTreeID,aFat)
					Else
						If Empty(D1_REMITO)
							cChave:=D1_FILIAL+D1_DOC+D1_SERIE+D1_FORNECE+D1_LOJA
							If Ascan(aFat,cChave)==0
								Aadd(aFat,cChave)
							Endif
						Endif
					Endif
				Endif
				RestArea(aSD1)
				While cSeekSD1==D1_FILIAL+D1_DOC+D1_SERIE+D1_FORNECE+D1_LOJA
					DbSkip()
				End
			End
		Else
			While !(Eof())
				oTree:TreeSeek( Pad( "SC7-" + cNumPed, 50 )+cTreeID )
				cSeekSD1 :=D1_DOC+D1_SERIE+D1_FORNECE+D1_LOJA
				aSD1:=GetArea()
				If lItem
					MATRKSD1(D1_DOC+D1_SERIE+D1_FORNECE+D1_LOJA+D1_COD+D1_ITEM,@oTree,,@nLevelPC,nMaxLevel,,cTreeID)
				Else
					If ISRemito(1,cAliasQry+"->D1_TIPODOC")
						MaTrkSCM(D1_DOC+D1_SERIE+D1_FORNECE+D1_LOJA,oTree,cAddString,nLevelPC-1,nMaxLevel,.F.,cTreeID,aFat)
					Else
						If Empty(D1_REMITO)
							cChave:=D1_DOC+D1_SERIE+D1_FORNECE+D1_LOJA
							If Ascan(aFat,cChave)==0
								Aadd(aFat,cChave)
							Endif
						Endif
					Endif
				Endif
				RestArea(aSD1)
				While cSeekSD1==D1_DOC+D1_SERIE+D1_FORNECE+D1_LOJA
					DbSkip()
				End
			End
		EndIf
		nLevelPC--
		If !lItem .And. Len(afat)<>0
			If !(oTree:TreeSeek(Pad("SC7-FATURAS",50)+cTreeID))
				oTree:TreeSeek(Pad("SC7-"+cPedido,50)+cTreeID)
				oTree:AddItem(Pad("Facturas",100 ),Pad("SC7-FATURAS",50)+cTreeID,cImageSD1,cImageSD1,,,nLevelPC)
			Endif
		Endif
		For nG:=1 To Len(aFat)
			If !oTree:TreeSeek(Pad("SF1-"+aFat[nG],50)+cTreeID) .AND. Ascan(_aFatLoc,afat[nG])<>0
				oTree:TreeSeek(Pad("SC7-FATURAS",50)+cTreeID)
				MaTrkSF1(aFat[nG],@oTree,,@nLevelPC,nMaxLevel,.F.,cTreeID)
			Endif
		Next

		dbSelectArea( cAliasQry )
		dbCloseArea()
		dbSelectArea( "SD1" )

	EndIf
EndIf
Return

/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFuncao    Ё MATRKADB Ё Autor Ё Kleber Dias Gomes     Ё Data Ё23/11/2005Ё╠╠
╠╠цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o Ё Monta as pastas dos itens de contrato de parceria          Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁSintaxe   Ё MATRKADB( ExpC1, @ExpO1, [ ExpC2 ], @ExpN1, [ ExpN2 ] )    Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁRetorno   Ё Nenhum                                                     Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁParametrosЁ ExpC1 -> Chave de pesquisa                                 Ё╠╠
╠╠Ё          Ё ExpO1 -> Objeto Tree                                       Ё╠╠
╠╠Ё          Ё ExpC2 -> String a adicionar ao texto do item ( tree )      Ё╠╠
╠╠Ё          Ё ExpN1 -> Nivel                                             Ё╠╠
╠╠Ё          Ё ExpN2 -> Nivel maximo                                      Ё╠╠
╠╠цддддддддддедддддддддддддддбдддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё   DATA   Ё Programador   ЁManutencao Efetuada                         Ё╠╠
╠╠цддддддддддедддддддддддддддедддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё          Ё               Ё                                            Ё╠╠
╠╠юддддддддддадддддддддддддддадддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/

Function MATRKADB( cNumCtr, oTree, cAddString, nLevel, nMaxLevel, lItem,cTreeID )

LOCAL cImageADB:= ""
LOCAL cQuery   := ""
LOCAL cAliasQry:= ""

DEFAULT nMaxLevel := 1000000
DEFAULT cTreeID   := "000001"

cAddString := If( ValType( cAddString ) == "C", cAddString, "" )

ADB->( DbSetOrder( 1 ) )
If ADB->( DbSeek( xFilial( "ADB" ) + cNumCtr ) )
	
	nLevel++
	
	If nLevel <= nMaxLevel
		
		cImageADB := MaEntImage( "ADB", 1 )
		
		oTree:AddItem( Pad( STR0023 + Transform( cNumCtr, "@R 999999/99" ) + ; //"Contrato parceria / Item - "
		If( !Empty( cAddString ), " - " + STR0006 + cAddString, "" ),100), Pad( "ADB-" + cNumCtr, 50 )+cTreeID, cImageADB, cImageADB ,,,nLevel) //" - Cliente : "
		
		oTree:TreeSeek( Pad( "ADB-" + cNumCtr, 50 )+cTreeID )
		
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Se existem itens de pedidos , cria as ocorrencias                      Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Obtem o alias devido a recursividade                                   Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		cAliasQry := GetNextAlias()
		
		cQuery := ""
		cQuery += "SELECT C6_NUM, C6_ITEM FROM "+RetSqlName("SC6")+" SC6 "
		cQuery += "WHERE "
		cQuery += "C6_FILIAL='"  + xFilial( "SC6" ) + "' AND "
		cQuery += "C6_CONTRAT='" + ADB->ADB_NUMCTR  + "' AND "
		cQuery += "C6_ITEMCON='" + ADB->ADB_ITEM    + "' AND "
		cQuery += "D_E_L_E_T_<>'*' "
		cQuery += "ORDER BY C6_NUM, C6_ITEM"
		
		cQuery := ChangeQuery( cQuery )
		
		dbUseArea( .T., "TOPCONN", TcGenQry( , , cQuery ), cAliasQry, .F., .T. )
		
		While !( cAliasQry )->( Eof() )
			MATRKSC6( ( cAliasQry )->C6_NUM + ( cAliasQry )->C6_ITEM, @oTree, , @nLevel, nMaxLevel,,cTreeID)
			( cAliasQry )->( dbSkip() )
			oTree:TreeSeek( Pad( "ADB-" + cNumCtr, 50 )+cTreeID )
		End
		
		( cAliasQRY )->( dbCloseArea() )
		dbSelectArea( "SC6" )
			
	EndIf
	
	nLevel--
	
EndIf

Return( .T. )

/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFuncao    Ё MATRKDAI Ё Autor Ё Kleber Dias Gomes     Ё Data Ё09/01/2006Ё╠╠
╠╠цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o Ё Monta as pastas dos itens da carga do pedido.              Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁSintaxe   Ё MATRKDAI( ExpC1, @ExpO1, [ ExpC2 ], @ExpN1, [ ExpN2 ] )    Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁRetorno   Ё Nenhum                                                     Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁParametrosЁ ExpC1 -> Chave de pesquisa                                 Ё╠╠
╠╠Ё          Ё ExpO1 -> Objeto Tree                                       Ё╠╠
╠╠Ё          Ё ExpC2 -> String a adicionar ao texto do item ( tree )      Ё╠╠
╠╠Ё          Ё ExpN1 -> Nivel                                             Ё╠╠
╠╠Ё          Ё ExpN2 -> Nivel maximo                                      Ё╠╠
╠╠цддддддддддедддддддддддддддбдддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё   DATA   Ё Programador   ЁManutencao Efetuada                         Ё╠╠
╠╠цддддддддддедддддддддддддддедддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё          Ё               Ё                                            Ё╠╠
╠╠юддддддддддадддддддддддддддадддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/

Function MATRKDAI( cItCarga, oTree, cAddString, nLevel, nMaxLevel, lItem,cTreeID )

LOCAL cImageDAI:= ""

DEFAULT nMaxLevel := 1000000
DEFAULT cTreeID   := "000001"

cAddString := If( ValType( cAddString ) == "C", cAddString, "" )

DAI->( DbSetOrder( 1 ) )
If DAI->( DbSeek( xFilial( "DAI" ) + cItCarga ) )
	
	nLevel++
	
	If nLevel <= nMaxLevel
		
		cImageDAI := MaEntImage( "DAI", 1 )
		
		oTree:AddItem( Pad( STR0069 + Transform( DAI->DAI_COD+DAI->DAI_SEQCAR, "@R 999999/99" ),100),; //"Carga / Seq.Carga - "
		Pad( "DAI-" + cItCarga, 50 )+cTreeID, cImageDAI, cImageDAI ,,,nLevel)
		oTree:TreeSeek( Pad( "DAI-" + cItCarga, 50 )+cTreeID )
	EndIf
	
	nLevel--
	
EndIf

Return( .T. )

/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFuncao    Ё MATRKQI2 Ё Autor Ё Cicero Odilio Cruz    Ё Data Ё16/12/2005Ё╠╠
╠╠цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o Ё Monta as pastas da FNC baseado MATRKSA1                    Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁSintaxe   Ё MATRKQI2( ExpC1, @ExpO1, [ ExpC2 ], @ExpN1, ExpN2, ExpL1)  Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁRetorno   Ё .T.                                                        Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁParametrosЁ ExpC1 -> Chave de pesquisa                                 Ё╠╠
╠╠Ё          Ё ExpO1 -> Objeto Tree                                       Ё╠╠
╠╠Ё          Ё ExpC2 -> String a adicionar ao texto do item ( tree )      Ё╠╠
╠╠Ё          Ё ExpN1 -> Nivel                                             Ё╠╠
╠╠Ё          Ё ExpN2 -> Nivel maximo                                      Ё╠╠
╠╠Ё          Ё ExpL1 -> Indica se deve expandir os itens ou cabecalhos    Ё╠╠
╠╠цддддддддддедддддддддддддддбдддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁAnalista  Ё Data/Bops/Ver ЁManutencao Efetuada                         Ё╠╠
╠╠цддддддддддеддддддддбддддддбдддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁCicero C. Ё03/12/05Ё8.11  Ё-Incluida a Integracao com o Controle de    Ё╠╠
╠╠Ё          Ё89415   Ё      ЁNao-Conformidades                           Ё╠╠
╠╠юддддддддддадддддддддддддддадддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/

Function MATRKQI2( cCodigo, oTree, cAddString, nLevel, nMaxLevel, lItem, cTreeID, cMod, cChAnt )

Local cImageQI2 := "" 			// Figura no Tree

Default nMaxLevel := 3 			// Nivel Maximo default
Default cTreeID   := "000001"	// Id  do Tree                                         
Default cMod      := "TMK" 		// Define  o Modulo de Origem
Default cChAnt	  := ""			// Chave Auxiliar

oTree:Hide()
cImageQI2  := MaEntImage( "QI2", 1 ) // Busco a Figura  referenta  a Tabela de Nao Conformidades

Do Case
Case (cMod == "TMK")
	//здддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//ЁObtenho as Fichas de NЦo Conformidades por AtendimentoЁ
	//юдддддддддддддддддддддддддддддддддддддддддддддддддддддды
	DbSelectarea("SUD")
	DbSetOrder(1)		
	If DbSeek( xFilial( "SUD" ) + cCodigo ) 
		//зддддддддддддд©
		//ЁExibo as FNCsЁ
		//юддддддддддддды
		While SUD->( !Eof() .AND. SUC->(xFilial())+SUC->UC_CODIGO == SUD->(xFilial()) + SUD->UD_CODIGO )
			nLevel++
			oTree:TreeSeek( Pad( "SUC-" + SUD->UD_CODIGO, 50 ))
		  	If !Empty(SUD->UD_CODFNC)
				oTree:AddItem( Pad( STR0071 + SUD->UD_CODFNC + STR0072 +; // "Codigo da Ficha: " ### " Revisao: " 
				               SUD->UD_FNCREV, 100 ) , Pad( "QI2-" + SUD->UD_CODFNC+SUD->UD_FNCREV, 50 ), cImageQI2 , cImageQI2 ,;
				               NIL                    , NIL                                , nLevel    )
				//здддддддддддддддддддддддддддддддддддддддддддддддддддддд©
				//Ё Chamo a funcao que  monta  a estrutura de uma Ficha  Ё
				//юдддддддддддддддддддддддддддддддддддддддддддддддддддддды
				TMKSTRUFNC( SUD->UD_CODFNC+SUD->UD_FNCREV , @oTree , NIL , @nLevel ,;
				            nMaxLevel , NIL , cTreeID )
				oTree:TreeSeek( Pad( "SUC-" + SUD->UD_CODIGO, 50 ))
				oTree:TreeSeek( Pad( "QI2-" + SUD->UD_CODFNC+SUD->UD_FNCREV, 50 ))
				oTree:SetFocus()                                   
				oTree:PTCollapse()
			EndIf
			SUD->( dbSkip() )
			nLevel--
		End   
	Endif                         
	oTree:TreeSeek( Pad( "SUC-" + SUD->UD_CODIGO, 50 ))
	oTree:SetFocus()                                   
	oTree:PTCollapse()
	oTree:Refresh()
	oTree:Show()
OtherWise
	nLevel++
	oTree:AddItem( Pad( STR0071 + SubStr(cCodigo,1,TamSx3("AB2_CODFNC")[1]) + STR0072 +; // "Codigo da Ficha: " ### " Revisao: " 
	               SubStr(cCodigo,TamSx3("AB2_CODFNC")[1]+1,Len(cCodigo)-TamSx3("AB2_CODFNC")[1]), 100 ) , Pad( "QI2-" + cCodigo, 50 ), cImageQI2 , cImageQI2 ,;
	               NIL                    , NIL                                , nLevel    )
	//здддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//Ё Chamo a funcao que  monta  a estrutura de uma Ficha  Ё
	//юдддддддддддддддддддддддддддддддддддддддддддддддддддддды
	TMKSTRUFNC( cCodigo , @oTree , NIL , @nLevel ,;
	            nMaxLevel , NIL , cTreeID )
	oTree:TreeSeek( Pad( cChAnt , 50 ) )
	oTree:TreeSeek( Pad( "QI2-" + cCodigo, 50 ))
	oTree:SetFocus()                                   
	oTree:PTCollapse()
	nLevel--  
	oTree:TreeSeek( Pad( cChAnt , 50 ) )
	oTree:SetFocus()                                   
	oTree:PTCollapse()
	oTree:Refresh()
	oTree:Show()	
EndCase
Return( .T. )


/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFuncao    ЁTMKSTRUFNCЁ Autor Ё Cicero Odilio Cruz    Ё Data Ё16/12/2005Ё╠╠
╠╠цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o Ё Monta a strutura da FNC (Nao respeita nivel por se entenderЁ╠╠
╠╠Ё          Ё que o que qdo se tratar de FNC sera feito um Folow-up e naoЁ╠╠
╠╠Ё          Ё um Tracker)                                                Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁSintaxe   Ё MATRKQI2( ExpC1, @ExpO1, [ ExpC2 ], @ExpN1, ExpN2, ExpL1)  Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁRetorno   Ё .T.                                                        Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁParametrosЁ ExpC1 -> Chave de pesquisa                                 Ё╠╠
╠╠Ё          Ё ExpO1 -> Objeto Tree                                       Ё╠╠
╠╠Ё          Ё ExpC2 -> String a adicionar ao texto do item ( tree )      Ё╠╠
╠╠Ё          Ё ExpN1 -> Nivel                                             Ё╠╠
╠╠Ё          Ё ExpN2 -> Nivel maximo                                      Ё╠╠
╠╠Ё          Ё ExpL1 -> Indica se deve expandir os itens ou cabecalhos    Ё╠╠
╠╠цддддддддддедддддддддддддддбдддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁAnalista  Ё Data/Bops/Ver ЁManutencao Efetuada                         Ё╠╠
╠╠цддддддддддеддддддддбддддддбдддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁCicero C. Ё03/12/05Ё8.11  Ё-Incluida a Integracao com o Controle de    Ё╠╠
╠╠Ё          Ё89415   Ё      ЁNao-Conformidades                           Ё╠╠
╠╠юддддддддддадддддддддддддддадддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/

Function TMKSTRUFNC( cCodigo  , oTree, cAddString, nLevel,;
                     nMaxLevel, lItem, cTreeID )

Local cMotRev := StrTran(AllTrim(MSMM(QI2->QI2_MOTREV)),chr(13)+chr(10),"")	// Motivo da Revisao da FNC
Local aStatus  := {"  0%"," 25%"," 50%"," 75%","100%"} 						// Array Status da Etapa
Local aTipQI6 := {} 															// Array Tipo Causa
Local aTipCau := {} 															// Array Cauza Raiz
Local nX := 0 																	// Contador                   

//зддддддддддддддддддддддддддддддддддддддддддддддддд©
//ЁArray  com o status da Ficha de NЦo-Conformidade Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддды
Local aQI2Sit := {	STR0101,;										// "Registrada"
					STR0102,;										// "Em Analise"
                   	STR0103,;										// "Procede"					
                   	STR0104,;										// "Nao Procede"
                   	STR0105} 										// "Cancelada"

QNCCBOX("QI6_TIPO" , @aTipQI6) // Carrego o array Tipo da Causa
QNCCBOX("QI6_RAIZ" , @aTipCau) // Carrego o array Causa raiz

nLevel++

QI2->(DbSetOrder(2))

//зддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Indicadores ultilizados na estrutura da FNC Ё
//юддддддддддддддддддддддддддддддддддддддддддддды
cIUser  := MaEntImage( "FNC00", 1 ) // Usuario
cIDesc  := MaEntImage( "FNC01", 1 ) // Descricao 
cIPln   := MaEntImage( "FNC02", 1 ) // Plano de Acao
cIEtap  := MaEntImage( "FNC03", 1 ) // Etapas
cIPraz  := MaEntImage( "FNC04", 1 ) // Calendario
cICaus  := MaEntImage( "FNC05", 1 ) // Causas
cIPln1  := MaEntImage( "FNC06", 1 ) // Causa Raiz
cIPln2  := MaEntImage( "FNC07", 1 ) // Causa
cIPln3  := MaEntImage( "FNC08", 1 ) // Documentos
cIPln4  := MaEntImage( "FNC09", 1 ) // Custos
cIGrou  := MaEntImage( "FNC10", 1 ) // Grupo de Usuarios
cIDet   := MaEntImage( "FNC11", 1 ) // Grupo de Usuarios

//здддддддддддддд©
//Ё Dados da FNC Ё
//юдддддддддддддды
If QI2->(dbSeek(xFilial("QI2")+cCodigo))      
	
	oTree:TreeSeek( Pad( "QI2-" + cCodigo, 50 ))
	oTree:AddItem( PADR(STR0098,100) , Pad( "DETFNC-" + cCodigo, 50 ) , cIDet , cIDet ,; // "Detalhes"
	               NIL                               , NIL , nLevel ) 	
	oTree:TreeSeek( Pad( "DETFNC-" + cCodigo, 50 ))
	oTree:AddItem( PADR(STR0073+": "+QI2->QI2_DESCR,100) , NIL , NIL   , NIL ,; // "Descricao"
	               NIL                                                , NIL , nLevel ) 
	oTree:AddItem( PADR(STR0099+aQI2SIT[Val(QI2->QI2_STATUS)]+"-"+STR0100+IIF(Empty(QI2->QI2_CONREA),"Em Analise","Baixada");   // "Situacao: " ### " Status : " ### "Em Analise" ### "Baixada"
	               ,100), NIL , NIL   , NIL ,; // "Status"
	               NIL   , NIL , NIL ) 
	oTree:TreeSeek( Pad( "DETFNC-" + cCodigo, 50 ))  
	oTree:SetFocus()                                   
	oTree:PTCollapse()       
	
	oTree:TreeSeek( Pad( "QI2-" + cCodigo, 50 ))
	oTree:AddItem( PADR(STR0074+QI2->QI2_FILMAT+"-"+QI2->QI2_MAT+" "+; // "Usuario Originador: "
	               QA_NUSR(QI2->QI2_FILMAT,QI2->QI2_MAT),100), Pad( "QI2-" +"00"+QI2->QI2_MAT+cCodigo, 50 ) , cIUser , cIUser ,;
	               NIL                                         , NIL                                                   , nLevel ) 
	oTree:AddItem( PADR(STR0075+QI2->QI2_FILRES+"-"+QI2->QI2_MATRES+" "+; // "Usuario Responsavel: "
	               QA_NUSR(QI2->QI2_FILRES,QI2->QI2_MATRES),100), Pad( "QI2-" +"01"+QI2->QI2_MATRES+cCodigo, 50 ) , cIUser , cIUser ,;
	               NIL                                            , NIL                                                      , nLevel )
	oTree:AddItem( PADR(STR0106,100), Pad( "DETA-" + cCodigo, 50 ) , cIDesc , cIDesc ,; // "Descricao Detalhada"
	               NIL , NIL , nLevel )	 
	cChave := Pad( "DETA-" + cCodigo, 50 )
	TRKMEMOTREE( @oTree  , AllTrim(MSMM(QI2->QI2_DDETA)) , 80 , NIL ,;
	             @nLevel , cChave )    
	
	If !Empty(QI2->QI2_DISPOS)
		oTree:TreeSeek( Pad( "QI2-" + cCodigo, 50 ))
		oTree:AddItem( PADR(STR0076,100) , Pad( "DISP-" + cCodigo, 50 ) , cIDesc , cIDesc ,; // "Disposicao"
		               NIL                                , NIL                                  , nLevel )	
		cChave := Pad( "DISP-" + cCodigo, 50 )
		TRKMEMOTREE( @oTree  , AllTrim(MSMM(QI2->QI2_DISPOS)) , 80 , NIL ,;
		             @nLevel , cChave)  
	Endif         
	
	If !Empty(cMotRev)                                     
		oTree:TreeSeek( Pad( "QI2-" + cCodigo, 50 ))
		oTree:AddItem( PADR(STR0077,100), Pad( "MOTI-" + cCodigo, 50 ),cIDesc,cIDesc,,,nLevel)	// "Motivo da Revisao"
		cChave := Pad( "MOTI-" + cCodigo, 50 )
		TRKMEMOTREE( @oTree  , cMotRev , 80 , NIL ,;
		             @nLevel , cChave)  
	Endif         

	If !Empty(QI2->QI2_CODACA)
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Plano de Acao e sua Estrutura                                            Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		QI3->(DbSetOrder(2))
		If QI3->(DBSeek(xFilial("QI3")+QI2->QI2_CODACA+QI2->QI2_REVACA))
		oTree:TreeSeek( Pad( "QI2-" + cCodigo, 50 ))
		oTree:AddItem( STR0078+PADR(TransForm(QI2->QI2_CODACA,"@R ######/####")+"-"+; // "Plano de Acao No. "
		                QI2->QI2_REVACA,100) , Pad( "QI3-" + QI2->QI2_CODACA+QI2->QI2_REVACA, 50 ) , cIPln , cIPln ,;
		                NIL                    , NIL                                                  , nLevel ) 
		If !Empty(QI3->QI3_MOTREV)
			oTree:TreeSeek( Pad( "QI3-" + QI2->QI2_CODACA+QI2->QI2_REVACA, 50 ) )
			oTree:AddItem( PADR(STR0077,100) , Pad( "MOTI-" + QI2->QI2_CODACA+QI2->QI2_REVACA, 50 ) , cIDesc , cIDesc ,; // "Motivo da Revisao"
			               NIL                                       , NIL                                                   , nLevel ) 
			cChave :=  Pad( "MOTI-" + QI2->QI2_CODACA+QI2->QI2_REVACA, 50 )
			TRKMEMOTREE( @oTree  , AllTrim(MSMM(QI3->QI3_MOTREV)) , 80 , NIL ,;
			             @nLevel , cChave)  
		Endif

		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Etapas do Plano de Acao                                                  Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		DbSelectArea("QI5")
		If dbSeek(xFilial("QI5")+QI2->QI2_CODACA+QI2->QI2_REVACA)
			oTree:TreeSeek( Pad( "QI3-" + QI2->QI2_CODACA+QI2->QI2_REVACA, 50 ) )
			oTree:AddItem( STR0079+PADR(TransForm(QI2->QI2_CODACA,"@R ######/####")+"-"+; // "Etapas do Plano de Acao No. "
			               QI2->QI2_REVACA,100), Pad( "ETP-" + QI2->QI2_CODACA+QI2->QI2_REVACA, 50 ), cIEtap , cIEtap,;
			               NIL                   , NIL                                                 , nLevel )
			nI := 1
			While !Eof() .AND. xFilial("QI5")+QI5->QI5_CODIGO+QI5->QI5_REV == xFilial("QI2")+QI2->QI2_CODACA+QI2->QI2_REVACA
				oTree:TreeSeek( Pad( "ETP-" + QI2->QI2_CODACA+QI2->QI2_REVACA, 50 ))
				cDescComp := AllTrim(MSMM(QI5->QI5_DESCCO))
				cDescObs  := AllTrim(MSMM(QI5->QI5_DESCOB))
				oTree:AddItem( PADR(QI5->QI5_TPACAO +"-"+Alltrim(FQNCDSX5("QD",QI5->QI5_TPACAO))+" "+aStatus[SuperVal(QI5->QI5_STATUS)+1],100),;
				               PAD( "ETP-" + QI2->QI2_CODACA+QI2->QI2_REVACA+QI5->QI5_TPACAO+STRZERO(nI,2), 50 ),;
				               If(QI5->QI5_STATUS=="4","CHECKED","UNCHECKED"),;
				               If(QI5->QI5_STATUS=="4","CHECKED","UNCHECKED"),;
				               NIL ,;
				               NIL ,;
				               nLevel )	
				oTree:TreeSeek( Pad( "ETP-" + QI2->QI2_CODACA+QI2->QI2_REVACA+QI5->QI5_TPACAO+STRZERO(nI,2), 50 ))
				oTree:AddItem( QI5->QI5_FILMAT+"-"+QI5->QI5_MAT+" "+AllTrim(QA_NUSR(QI5->QI5_FILMAT,QI5->QI5_MAT)), NIL , cIUser , cIUser ,;
				               NIL                                                                                   , NIL , nLevel )			
				oTree:AddItem( STR0080+DTOC(QI5->QI5_PRAZO)+" "+STR0081+DTOC(QI5->QI5_REALIZ), NIL , cIPraz , cIPraz ,; // "Prazo Execucao: " ### "Data Realizacao: "
				               NIL                                                                                               , NIL , nLevel ) 
				oTree:AddItem( STR0082+AllTrim(QI5->QI5_DESCRE), NIL , cIDesc , cIDesc ,; // "Descricao Resumida: "
				               NIL                                                        , NIL , nLevel ) 			
				If !Empty(cDescComp)
					cChave := Pad( "ETP-" + QI2->QI2_CODACA+QI2->QI2_REVACA+QI5->QI5_TPACAO+STRZERO(nI,2), 50 )
					TRKMEMOTREE( @oTree  , STR0083+AllTrim(cDescComp) , 90     , NIL ,; // "Descricao Completa: "
					             @nLevel , cChave                                                , cIDesc )  
				Endif
				If !Empty(cDescObs)
					cChave := Pad( "ETP-" + QI2->QI2_CODACA+QI2->QI2_REVACA+QI5->QI5_TPACAO+STRZERO(nI,2), 50 )
					TRKMEMOTREE( @oTree  , STR0084+AllTrim(cDescObs) , 90    , NIL ,; // "Observacao: "
					             @nLevel , cChave                                       ,cIDesc )   
				Endif
				dbSkip()   
				oTree:TreeSeek( Pad( "ETP-" + QI2->QI2_CODACA+QI2->QI2_REVACA+QI5->QI5_TPACAO+STRZERO(nI,2), 50 ))  
				oTree:SetFocus()                                   
				oTree:PTCollapse() 
				nI++
			End
		EndIF     
		oTree:TreeSeek( Pad( "ETP-" + QI2->QI2_CODACA+QI2->QI2_REVACA, 50 ))  
		oTree:SetFocus()                                   
		oTree:PTCollapse()        
			
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Causas do Plano de Acao                                                  Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		DbSelectArea("QI6")
		If dbSeek(xFilial("QI6")+QI2->QI2_CODACA+QI2->QI2_REVACA)	
			oTree:TreeSeek( Pad( "QI3-" + QI2->QI2_CODACA+QI2->QI2_REVACA, 50 ) )
			oTree:AddItem( STR0085, Pad( "CAU-" + cCodigo, 50 ) , cICaus , cICaus ,; // "Causas"
			               NIL                 , NIL                                 , nLevel )  
			oTree:TreeSeek( Pad( "CAU-" + cCodigo, 50 ) )
			While !Eof() .AND. xFilial("QI6")+QI6->QI6_CODIGO+QI6->QI6_REV == xFilial("QI2")+QI2->QI2_CODACA+QI2->QI2_REVACA
				cDescCausa := AllTrim(MSMM(QI6->QI6_DESCR))
				oTree:AddItem( STR0086+aTipQI6[Val(QI6->QI6_TIPO)]+Space(10)+STR0087+;	// "Tipo de Causa: " ### "Causa Raiz?"
				               aTipCau[Val(QI6->QI6_RAIZ)] , NIL , cIPln1 , cIPln1,;
				               NIL                           , NIL , nLevel )
				oTree:AddItem( STR0088+FQNCNTAB("1",QI6->QI6_CAUSA), NIL , cIPln2 , cIPln2,; // "Causa: "
				               NIL                                                , NIL , nLevel ) 
				oTree:AddItem( STR0089+AllTrim(QI6->QI6_METODO), NIL , cIPln2 , cIPln2 ,; // "Metodo Utilizado: "
				               NIL                                                      , NIL , nLevel ) 	
				If !Empty(cDescCausa)
					cChave := Pad( "CAU-" + cCodigo, 50 )
					TRKMEMOTREE(@oTree  , STR0090+AllTrim(cDescCausa) , 100    , NIL ,; // "Descricao da Causa: "
					            @nLevel , cChave                                                 , cIDesc )  
				Endif
				dbSkip()
			End
	    EndIf
	
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Documentos do Plano de Acao                                              Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		DbSelectArea("QI7")
		If dbSeek(xFilial("QI7")+QI2->QI2_CODACA+QI2->QI2_REVACA)
			nX:=0
			oTree:TreeSeek( Pad( "QI3-" + QI2->QI2_CODACA+QI2->QI2_REVACA, 50 ) )
			oTree:AddItem( STR0091 , Pad( "DOC-" + cCodigo, 50 ) , cIPln3 , cIPln3 ,; // "Documentos"
			               NIL                       , NIL                                 , nLevel )
			While !Eof() .AND. xFilial("QI7")+QI7->QI7_CODIGO+QI7->QI7_REV == xFilial("QI7")+QI2->QI2_CODACA+QI2->QI2_REVACA
				nX++
				oTree:TreeSeek( Pad( "DOC-" + cCodigo, 50 ))
				oTree:AddItem( PADR(QI7->QI7_DOC+"-"+QI7->QI7_RV,100),;
				               Pad( "TDO-" +QI2->QI2_CODACA+QI2->QI2_REVACA+QI7->QI7_DOC+"-"+QI7->QI7_RV+str(nX), 50 ), cIDesc ,;
				               cIDesc , NIL , NIL , nLevel) 			
				oTree:TreeSeek( Pad( "TDO-" +QI2->QI2_CODACA+QI2->QI2_REVACA+QI7->QI7_DOC+"-"+QI7->QI7_RV+str(nX), 50 ))
				oTree:AddItem( PADR(STR0092+QI7->QI7_TPDOC+"-"+FQNCDSX5("QC",QI7->QI7_TPDOC),100) , NIL , NIL    , NIL ,; //"Tipo de Documento: "
				               NIL                                                                                           , NIL , nLevel ) 
				                	
				If QDH->(dbSeek(If(FWModeAccess("QDH")=="C",xFilial("QDH"),QI7->QI7_FILIAL)+PADR(QI7->QI7_DOC,16)+QI7->QI7_RV))
					oTree:AddItem( PADR(STR0093+QDH->QDH_TITULO,100), NIL , NIL    , NIL ,;
					               NIL                                              , NIL , nLevel )	// "Titulo: " 			
				Else
					oTree:AddItem( PADR(STR0093+STR0094,100), NIL , NIL    , NIL ,; // "Titulo: " ### "Documento Externo"
					               NIL                                                 , NIL , nLevel )	
				Endif
				dbSkip()
			End       
			oTree:TreeSeek( Pad( "DOC-" + cCodigo, 50 ))
			oTree:SetFocus()                                   
			oTree:PTCollapse()
		EndIf
	
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Custos do Plano de Acao                                                  Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		DbSelectArea("QI8")
		If dbSeek(xFilial("QI8")+QI2->QI2_CODACA+QI2->QI2_REVACA)
			oTree:TreeSeek( Pad( "QI3-" + QI2->QI2_CODACA+QI2->QI2_REVACA, 50 ) )
			oTree:AddItem( PADR(STR0095,100), Pad( "BUD-" + cCodigo, 50 ), cIPln4 , cIPln4,; // "Custos"
			               NIL                , NIL                                , nLevel ) 
			oTree:TreeSeek( Pad( "BUD-" + cCodigo, 50 ) )
			While !Eof() .AND. xFilial("QI8")+QI8->QI8_CODIGO+QI8->QI8_REV == xFilial("QI8")+QI2->QI2_CODACA+QI2->QI2_REVACA
				oTree:AddItem( STR0073+": "+Padr(FQNCDSX5("QB",QI8->QI8_CUSTO),30)+STR0096+; // "Descricao: " ### " Valor Custo "
				               AllTrim(Transform(QI8->QI8_VLCUST,"@E 999,999,999.99")) , NIL , cIDesc , cIDesc ,;
				               NIL                                                       , NIL , nLevel )	 			
				dbSkip()
			End
		EndIf
	
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Equipes                                                                  Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		DbSelectArea("QI4")
		If dbSeek(xFilial("QI4")+QI2->QI2_CODACA+QI2->QI2_REVACA)
			oTree:TreeSeek( Pad( "QI3-" + QI2->QI2_CODACA+QI2->QI2_REVACA, 50 ) )
			oTree:AddItem( PADR(STR0097,100) , Pad( "EQU-" + cCodigo, 50 ) , cIGrou, cIGrou,;
			               NIL                  , NIL                                 , nLevel) // "Equipes"
			oTree:TreeSeek( Pad( "EQU-" + cCodigo, 50 ) )
			While !Eof() .AND. xFilial("QI4")+QI4->QI4_CODIGO+QI4->QI4_REV == xFilial("QI4")+QI2->QI2_CODACA+QI2->QI2_REVACA
				oTree:AddItem( QA_NUSR(QI4->QI4_FILMAT,QI4->QI4_MAT), NIL , cIUser , cIUser,;
				               NIL                                   , NIL , nLevel ) 
				dbSkip()
			End
	    EndIf
	EndIf
	oTree:TreeSeek( Pad( "QI3-" + QI2->QI2_CODACA+QI2->QI2_REVACA, 50 ) )
	oTree:SetFocus()                                   
	oTree:PTCollapse()
EndIf
EndIf
nLevel--
oTree:TreeSeek( Pad( "QI2-" + cCodigo, 50 ))
oTree:SetFocus()                                   
oTree:PTCollapse()
oTree:Show()
Return( .T. )


/*/
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддддбдддддддбдддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFun┤┘o    ЁTRKMEMOTREE Ё Autor Ё Cicero Odilio Cruz  Ё Data Ё 20/12/05 Ё╠╠
╠╠цддддддддддеддддддддддддадддддддадддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o Ё Programa para adicionar linha no Tree                      Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁSintaxe   Ё TRKMEMOTREE(oTree,cTexto,nTam,lResource)                   Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё Uso      Ё Generico                                                   Ё╠╠
╠╠цддддддддддедддддддддддддддбдддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁAnalista  Ё Data/Bops/Ver ЁManutencao Efetuada                         Ё╠╠
╠╠цддддддддддеддддддддбддддддбдддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁCicero C. Ё03/12/05Ё8.11  Ё-Incluida a Integracao com o Controle de    Ё╠╠
╠╠Ё          Ё89415   Ё      ЁNao-Conformidades                           Ё╠╠
╠╠юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
/*/
Function TRKMEMOTREE( oTree , cTexto, nTam, lResource,; 
                      nLevel, cChave, cBMP)
Local   nT   := 0 						//Contador
Local   aTextos := {} 					// Array onde sera adicionado o conteЗdo do Memo
Default lResource := .T. 				// Indica  se a primeira linha tem uma figura
Default cBMP := ""   					// Nome da Figura

nLevel++

Q_MemoArray( cTexto , @aTextos , 80)    // Funcao do TMK que  converte  MEMO em Array

For nT :=1 TO Len(aTextos)
	If nT == 1 .AND. lResource           
		oTree:TreeSeek( cChave )     
		oTree:AddItem( aTextos[nT], NIL, cBMP   , cBMP,;
		               NIL         , NIL, nLevel )
	Else
		oTree:TreeSeek( cChave )
		oTree:AddItem( aTextos[nT], NIL, NIL   , NIL,;
		               NIL         , NIL, nLevel)
	Endif
Next nT

oTree:TreeSeek(cChave)
oTree:SetFocus()
oTree:PTCollapse()

nLevel--
Return Nil

/*/
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддддбдддддддбдддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFun┤┘o    ЁTRKFILENT	  Ё Autor Ё Turibio Miranda	    Ё Data |30/03/2010Ё╠╠
╠╠цддддддддддеддддддддддддадддддддадддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o Ё Funcao para verificar se utiliza filial de entrega         Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁSintaxe   Ё TRKFILENT()								                  Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё Uso      Ё Generico                                                   Ё╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
/*/
Static Function TRKFILENT()
Local lFilEnt	:= .T.
Local lTrkFilPe	:= ExistBlock("TRKFILEN")
    
// NЦo utiliza o conceito de filial de entrega se as 3 tabelas principais (SC1, SC7, SC8) forem compartilhadas
If FWModeAccess("SC1")=="C" .And. FWModeAccess("SC7")=="C" .And. FWModeAccess("SC8")=="C" .And. lTrkFilPe
	lFilEnt:= .F.
EndIf

Return lFilEnt

/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFuncao    Ё MATRKADY Ё Autor Ё Totvs                 Ё Data Ё17/05/2011Ё╠╠
╠╠цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o Ё Monta as pastas dos itens de orcamento                     Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁSintaxe   Ё MATRKADY( ExpC1, @ExpO1, [ ExpC2 ], @ExpN1, [ ExpN2 ] )    Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁRetorno   Ё Nenhum                                                     Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁParametrosЁ ExpC1 -> Chave de pesquisa                                 Ё╠╠
╠╠Ё          Ё ExpO1 -> Objeto Tree                                       Ё╠╠
╠╠Ё          Ё ExpC2 -> String a adicionar ao texto do item ( tree )      Ё╠╠
╠╠Ё          Ё ExpN1 -> Nivel                                             Ё╠╠
╠╠Ё          Ё ExpN2 -> Nivel maximo                                      Ё╠╠
╠╠юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/
Function MATRKADY( cPropos, oTree, cAddString, nLevel, nMaxLevel, lItem, cTreeID )
Local cImageSCK 	:= ""
Local cPedido		:= ""
Local aPedidos		:= {}

DEFAULT nMaxLevel	:= 1000000 
DEFAULT cTreeID		:= "000001"

cAddString := If( ValType( cAddString ) == "C", cAddString, "" )

ADY->( DbSetOrder( 1 ) )
If ADY->( DbSeek( xFilial( "ADY" ) + cPropos ) )

	nLevel++
	If nLevel <= nMaxLevel

		cImageSCK := MaEntImage( "ADY", 1 )

		oTree:AddItem( Pad( STR0118 + cPropos + cAddString, 100 ),;  //"Proposta Comercial - "
		Pad( "ADY-" + cPropos, 50 )+cTreeID, cImageSCK,cImageSCK,,,nLevel)
		oTree:TreeSeek( Pad( "ADY-" + cPropos, 50 )+cTreeID )

		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Orcamentos                                                   Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		DbSelectArea( "SCJ" )
		SCJ->( DbSetOrder( 4 ) )
		If SCJ->( DbSeek( xFilial( "SCJ" ) + cPropos ) )
			oTree:TreeSeek( Pad( "ADY-" + cPropos, 50 )+cTreeID )
			cImageSCK := MaEntImage( "SCJ", 1 )
			oTree:AddItem( Pad( STR0015 + Transform( cPropos, "@R XXXXXX/XX" ), 100 ), Pad( "SCJ-" + cPropos, 50 )+cTreeID, cImageSCK,cImageSCK,,,nLevel) //"Orcamento - "
		EndIf

		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Contrato de Manutencao                                       Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		oTree:TreeSeek( Pad( "ADY-" + cPropos, 50 )+cTreeID )

		DbSelectArea( "AAH" )
		AAH->( DbSetOrder( 6 ) )
		If AAH->( DbSeek( xFilial( "AAH" ) + cPropos ) )
			cImageSCK := MaEntImage( "AAH", 1 )
			oTree:AddItem( Pad( STR0119 + " - " + AAH->AAH_CONTRT, 100 ), Pad( "AAH-" + AAH->AAH_CONTRT, 50 )+cTreeID, cImageSCK,cImageSCK,,,nLevel) //"Contrato de ManutenГЦo"

			While AAH->( !Eof() ) .AND. AAH->AAH_FILIAL + AAH->AAH_PROPOS == xFilial( "AAH" ) + cPropos
				oTree:TreeSeek( Pad( "AAH-" + AAH->AAH_CONTRT, 50 ) + cTreeID )

				cImageSCK := MaEntImage( "AAA", 1 )
				oTree:AddItem( Pad( STR0120 + AAH->AAH_CODGRP, 100 ), Pad( "AAA-" + AAH->AAH_CODGRP, 50 )+cTreeID, cImageSCK,cImageSCK,,,nLevel) //"Grupo de Cobertura - "

				AAH->( DbSkip() )
			End
		EndIf

		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Contrato de Prest. Servico                                   Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		oTree:TreeSeek( Pad( "ADY-" + cPropos, 50 )+cTreeID )

		DbSelectArea( "AAM" )
		AAM->( DbSetOrder( 3 ) )
		If AAM->( DbSeek( xFilial( "AAM" ) + cPropos ) )
			cImageSCK := MaEntImage( "AAM", 1 )
			oTree:AddItem( Pad( STR0121 + AAM->AAM_CONTRT, 100 ), Pad( "AAM-" + AAM->AAM_CONTRT, 50 )+cTreeID, cImageSCK,cImageSCK,,,nLevel) //"Contrato de Prestacao de Servicos - "

			While AAM->( !Eof() ) .AND. AAM->AAM_FILIAL + AAM->AAM_PROPOS == xFilial( "AAM" ) + cPropos
				DbSelectArea( "AAN" )
				AAN->( DbSetOrder( 1 ) )
				AAN->( DbSeek( xFilial( "AAN" ) + AAM->AAM_CONTRT ) )
				While AAN->( !Eof() ) .AND. AAN->( AAN_FILIAL + AAN_CONTRT ) == xFilial( "AAN" ) + AAM->AAM_CONTRT
					cPedido := AAN->AAN_ULTPED
					If !Empty( cPedido ) .AND. aScan( aPedidos, { |x| x = cPedido } ) == 0
						aAdd( aPedidos, cPedido )
						oTree:TreeSeek( Pad( "AAM-" + AAM->AAM_CONTRT, 50 ) + cTreeID )

						cImageSCK := MaEntImage( "SC5", 1 )
						oTree:AddItem( Pad( STR0122 + cPedido, 100 ), Pad( "SC5-" + cPedido, 50 )+cTreeID, cImageSCK,cImageSCK,,,nLevel) //"Pedido de Venda - "
					EndIf

					AAN->( DbSkip() )
				End

				AAM->( DbSkip() )
			End
		EndIf
	EndIf

	nLevel--
EndIf

Return .T.